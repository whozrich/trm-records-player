<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TRM Records</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --bg-black: #000000;
            --card-grey: #121212;
            --accent-green: #1db954;
            --text-main: #ffffff;
            --text-dim: #b3b3b3;
            --glow: 0 0 15px rgba(29, 185, 84, 0.6);
        }

        body, html {
            margin: 0; padding: 0;
            background-color: var(--bg-black);
            color: var(--text-main);
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            overflow-x: hidden; height: 100%;
        }

        /* --- FIXED SCROLLBAR --- */
        #content-view { 
            padding-bottom: 180px; 
            height: 100vh; 
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch; 
            scroll-behavior: smooth;
        }
        #content-view::-webkit-scrollbar { width: 6px; display: block !important; }
        #content-view::-webkit-scrollbar-track { background: #000; }
        #content-view::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        
        .standard-padding { padding: 20px; min-height: 101%; }

        /* --- ICON ANIMATIONS --- */
        .material-icons {
            transition: transform 0.1s ease, filter 0.1s ease;
            cursor: pointer;
            user-select: none;
        }
        .material-icons:active {
            transform: scale(0.85);
            filter: brightness(1.5);
        }

        /* --- FEATURED BANNER --- */
        .featured-banner {
            position: relative; height: 220px; margin: 15px; border-radius: 12px;
            overflow: hidden; display: flex; align-items: flex-end; padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); background: #111;
        }
        .featured-banner img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; filter: brightness(0.7); }
        .featured-content { position: relative; z-index: 2; }

        /* --- HOME GRID --- */
        .mobile-home-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .track-tile { background: var(--card-grey); border-radius: 8px; overflow: hidden; position: relative; }
        .track-tile img { width: 100%; aspect-ratio: 1; object-fit: cover; }
        .tile-content { padding: 10px; }
        .tile-title { display: block; font-weight: bold; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tile-label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; }

        /* --- PROGRESS BARS --- */
        .progress-container { width: 100%; height: 4px; background: #444; border-radius: 2px; position: relative; cursor: pointer; }
        .progress-fill { height: 100%; background: var(--accent-green); width: 0%; border-radius: 2px; box-shadow: 0 0 10px var(--accent-green); }

        /* --- NAVIGATION --- */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; height: 75px;
            background: rgba(0,0,0,0.95); display: flex;
            justify-content: space-around; align-items: center;
            border-top: 1px solid #222; z-index: 1000;
        }
        .nav-item { color: var(--text-dim); text-align: center; font-size: 10px; cursor: pointer; flex: 1; transition: 0.2s; }
        .nav-item.active { color: white; text-shadow: var(--glow); }
        .nav-item .material-icons { display: block; font-size: 28px; margin-bottom: 2px; }

        /* --- MINI PLAYER --- */
        #mini-player {
            position: fixed; bottom: 85px; left: 10px; right: 10px;
            background: #282828; border-radius: 8px;
            display: none; flex-direction: column; z-index: 900;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); overflow: hidden;
        }
        .mini-main { display: flex; align-items: center; padding: 8px; }
        #mini-player img { width: 45px; height: 45px; border-radius: 4px; margin-right: 12px; }

        /* --- FULL SCREEN PLAYER --- */
        #full-player {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, #333, #000);
            z-index: 2000; display: none; flex-direction: column;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.1, 0.7, 0.1, 1);
        }
        #full-player.active { display: flex; transform: translateY(0); }
        .fp-header { padding: 40px 20px 20px; display: flex; justify-content: space-between; align-items: center; }
        .fp-art { width: 85%; aspect-ratio: 1; margin: 20px auto; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .fp-meta { padding: 20px 30px; }
        #fp-artist { 
            color: var(--accent-green); 
            margin: 5px 0; 
            font-size: 18px; 
            text-shadow: 0 0 10px rgba(29, 185, 84, 0.5);
            cursor: pointer;
            display: inline-block;
        }
        
        .fp-controls { display: flex; justify-content: space-around; align-items: center; padding: 20px; margin-top: auto; padding-bottom: 60px; }
        .play-btn-lg { background: white; color: black; border-radius: 50%; width: 75px; height: 75px; display: flex; align-items: center; justify-content: center; }
        .play-btn-lg:active { transform: scale(0.9); }

        /* --- TABS --- */
        .lib-tabs { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid #222; }
        .tab { padding: 10px 0; color: var(--text-dim); cursor: pointer; font-weight: bold; }
        .tab.active { color: var(--accent-green); border-bottom: 2px solid var(--accent-green); }

        .glow-active { color: var(--accent-green) !important; filter: drop-shadow(0 0 8px var(--accent-green)) !important; }
        .track-row.disabled { opacity: 0.3; pointer-events: none; }
        .track-row.active-track { color: var(--accent-green); }
        .view-animate { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="content-view">
        <div style="padding: 100px 20px; text-align: center; color: var(--text-dim);">Loading TRM...</div>
    </div>

    <div id="mini-player" onclick="openFullPlayer()">
        <div class="mini-main">
            <img id="m-art" src="">
            <div style="flex:1; overflow:hidden;">
                <div id="m-title" style="font-weight:bold; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div>
                <div id="m-artist" style="font-size:12px; color:var(--text-dim);"></div>
            </div>
            <span class="material-icons" id="m-play-btn" onclick="event.stopPropagation(); togglePlay();" style="font-size:35px; padding:5px;">play_arrow</span>
        </div>
        <div class="progress-container" onclick="event.stopPropagation(); seek(event, this)">
            <div id="mini-progress" class="progress-fill"></div>
        </div>
    </div>

    <div id="full-player">
        <div class="fp-header">
            <span class="material-icons" onclick="closeFullPlayer()">expand_more</span>
            <span style="font-size:11px; font-weight:bold; letter-spacing:1px;">NOW PLAYING</span>
            <span class="material-icons" id="m-fav-btn" onclick="handleLikeClick()">favorite_border</span>
        </div>
        <img id="fp-art" class="fp-art" src="">
        <div class="fp-meta">
            <h1 id="fp-title" style="margin:0; font-size:24px;"></h1>
            <p id="fp-artist" onclick="goToCurrentArtist()"></p>
        </div>

        <div style="padding: 0 30px;">
            <div class="progress-container" onclick="seek(event, this)" style="height: 6px;">
                <div id="fp-progress" class="progress-fill"></div>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-dim); margin-top: 8px;">
                <span id="time-cur">0:00</span>
                <span id="time-dur">0:00</span>
            </div>
        </div>

        <div class="fp-controls">
            <span class="material-icons" id="ctrl-shuffle" style="font-size:30px;" onclick="toggleShuffle()">shuffle</span>
            <span class="material-icons" style="font-size:45px;" onclick="prevTrack()">skip_previous</span>
            <div class="play-btn-lg" onclick="togglePlay()">
                <span class="material-icons" id="fp-play-btn" style="font-size:50px;">play_arrow</span>
            </div>
            <span class="material-icons" style="font-size:45px;" onclick="nextTrack()">skip_next</span>
            <span class="material-icons" id="ctrl-repeat" style="font-size:30px;" onclick="toggleLoop()">repeat</span>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" id="nav-home" onclick="window.viewHome()">
            <span class="material-icons">home</span>Home
        </div>
        <div class="nav-item" id="nav-search" onclick="window.viewSearch()">
            <span class="material-icons">search</span>Search
        </div>
        <div class="nav-item" id="nav-lib" onclick="window.viewLikedSongs()">
            <span class="material-icons">library_music</span>Library
        </div>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const S_URL = 'https://sxagulxljpzftqfnllhv.supabase.co';
        const S_KEY = 'sb_publishable_GG1VzWph8ZCK2hCyZugMfA_qR6LZcRn';
        const supabaseClient = supabase.createClient(S_URL, S_KEY);

        window.ALBUMS = [];
        window.TRACKS = {};
        window.ARTISTS = {};
        let currentTrackId = null;
        let currentArtistId = null;
        let isShuffle = false;
        let isRepeat = false;
        const audio = new Audio();
        const contentView = document.getElementById('content-view');

        const STORAGE = {
            getLikes: () => JSON.parse(localStorage.getItem('trm_likes') || '[]'),
            getRecent: () => JSON.parse(localStorage.getItem('trm_recent') || '[]'),
            toggleLike: (id) => {
                let likes = STORAGE.getLikes();
                likes = likes.includes(id) ? likes.filter(x => x !== id) : [...likes, id];
                localStorage.setItem('trm_likes', JSON.stringify(likes));
                return likes.includes(id);
            },
            addRecent: (id) => {
                let recent = STORAGE.getRecent().filter(x => x !== id);
                recent.unshift(id);
                localStorage.setItem('trm_recent', JSON.stringify(recent.slice(0, 20)));
            }
        };

       async function init() {
    try {
        const { data: artists } = await supabaseClient.from('artists').select('*');
        artists?.forEach(a => window.ARTISTS[a.id] = a);

        const { data: albumsData } = await supabaseClient.from('albums').select('*');
        const { data: tracksData } = await supabaseClient.from('tracks').select('*');

        // Helper to sort albums by date
        const parseDate = (str) => {
            if (!str || str === 'RELEASED') return 0;
            const cleanDate = str.replace(/(\d+)(st|nd|rd|th)/, "$1");
            const timestamp = Date.parse(cleanDate);
            return isNaN(timestamp) ? 0 : timestamp;
        };

        window.ALBUMS = (albumsData || []).sort((a, b) => parseDate(b.full_release_date) - parseDate(a.full_release_date));

        // Create a quick lookup map for tracks
        const trackLookup = {};
        tracksData?.forEach(t => { trackLookup[t.id] = t; });

        // ARRAY IS LAW: Map tracks to albums based strictly on the JSONB array order
        window.TRACKS = {};
        window.ALBUMS.forEach(alb => {
            const manualOrder = alb.track_ids || []; 
            // Filter out any IDs that might not exist in the tracks table
            window.TRACKS[alb.id] = manualOrder
                .map(id => trackLookup[id])
                .filter(Boolean); 
        });

        window.viewHome();
        handleDeepLinking();
    } catch (err) { 
        console.error("Init Error:", err); 
        contentView.innerHTML = `<div class="standard-padding">Error loading database.</div>`;
    }
}

        function resetScroll() { contentView.scrollTo(0, 0); }

        window.viewHome = () => {
            window.currentViewId = 'home';
            resetScroll();
            setNav(0);
            if (window.ALBUMS.length === 0) return;
            const featured = window.ALBUMS.find(a => a.is_featured && !a.hidden) || window.ALBUMS[0];
            const publicAlbs = window.ALBUMS.filter(a => !a.hidden);
            
            let html = `
                <div class="featured-banner view-animate" onclick="viewAlbum('${featured.id}')">
                    <img src="${featured.art_url}">
                    <div class="featured-content">
                        <div style="background:var(--accent-green); color:black; font-size:10px; font-weight:bold; padding:2px 6px; border-radius:4px; display:inline-block; margin-bottom:5px;">FEATURED</div>
                        <h1 style="margin:0;">${featured.name}</h1>
                    </div>
                </div>
                <div class="standard-padding">
                    <h2 style="margin-top:0;">Catalogue</h2>
                    <div class="mobile-home-grid">`;
            
            publicAlbs.forEach(a => {
                html += `
                    <div class="track-tile" onclick="viewAlbum('${a.id}')">
                        <img src="${a.art_url}" style="${a.coming_soon ? 'opacity:0.5; filter:grayscale(1)' : ''}">
                        <div class="tile-content">
                            <span class="tile-title">${a.name}</span>
                            <span class="tile-label" style="color:${a.coming_soon ? '#ff4444' : '#888'}">
                                ${a.coming_soon ? 'COMING SOON' : (a.type || 'ALBUM')}
                            </span>
                        </div>
                    </div>`;
            });
            contentView.innerHTML = html + `</div></div>`;
        };

        window.viewArtist = (id) => {
            window.currentViewId = 'artist';
            resetScroll();
            const artist = window.ARTISTS[id];
            const artistAlbs = window.ALBUMS.filter(a => a.artist_id == id && !a.hidden);

            let html = `
                <div class="view-animate">
                    <div style="height:280px; position:relative; overflow:hidden;">
                        <img src="${artist.banner_url || ''}" style="width:100%; height:100%; object-fit:cover; filter:brightness(0.6);">
                        <span class="material-icons" onclick="viewHome()" style="position:absolute; top:40px; left:20px; z-index:10; background:rgba(0,0,0,0.5); border-radius:50%; padding:5px;">chevron_left</span>
                        <div style="position:absolute; bottom:20px; left:20px; right:20px; z-index:2;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <h1 style="font-size:36px; margin:0;">${artist.name}</h1>
                                ${artist.is_verified ? '<span class="material-icons" style="color:#3897f0; font-size:24px;">verified</span>' : ''}
                            </div>
                            <p style="color:var(--text-dim); margin:5px 0; font-size:14px; line-height:1.4;">${artist.bio || 'Official TRM Artist'}</p>
                        </div>
                    </div>
                    <div class="standard-padding">
                        <h2 style="margin-top:0;">Discography</h2>
                        <div class="mobile-home-grid">
                            ${artistAlbs.map(a => `
                                <div class="track-tile" onclick="viewAlbum('${a.id}')">
                                    <img src="${a.art_url}">
                                    <div class="tile-content">
                                        <span class="tile-title">${a.name}</span>
                                        <span class="tile-label">${a.type || 'ALBUM'}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>`;
            contentView.innerHTML = html;
        };

window.viewAlbum = (id) => {
    window.currentViewId = 'album';
    contentView.scrollTo(0, 0);
    const alb = window.ALBUMS.find(a => a.id === id);
    if (!alb) return;

    const tks = window.TRACKS[id] || [];
    const artist = window.ARTISTS[alb.artist_id] || { name: "TRM Records" };
    const isSingle = alb.type === 'Single' || tks.length === 1;

    let html = `
    <div class="view-animate">
        <div style="padding: 40px 20px 20px; text-align:center; position: relative;">
            <span class="material-icons" onclick="viewHome()" style="position: absolute; left: 20px; top: 40px;">chevron_left</span>
            <img src="${alb.art_url}" style="width:220px; aspect-ratio:1; border-radius:12px; box-shadow:0 15px 40px rgba(0,0,0,0.6); object-fit: cover;">
            <h1 style="margin:20px 0 5px 0; font-size: 28px; font-weight: 900;">${alb.name}</h1>
            <div style="display:flex; align-items:center; justify-content:center; gap:15px; margin-top:5px;">
                <p style="color:var(--accent-green); font-weight: bold; margin:0;" onclick="viewArtist('${alb.artist_id}')">${artist.name}</p>
                <button class="share-circle" onclick="copyAlbumLink('${alb.id}')" style="background:rgba(255,255,255,0.1); border:none; color:white; width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                     <span class="material-icons" style="font-size:18px;">share</span>
                </button>
            </div>
        </div>
        <div class="standard-padding" style="padding-top: 10px;">
            ${tks.map((t, i) => {
                // PARITY RULE: Track is playable if ANY of its parent albums are released
                const parentIds = t.album_id ? t.album_id.split(',').map(s => s.trim()) : [];
                const isPlayable = parentIds.some(aid => {
                    const other = window.ALBUMS.find(a => a.id == aid);
                    return other && !other.coming_soon;
                });

                // Sequential Numbering based on array index
                const trackNumber = i + 1;
                const displayTitle = isPlayable ? t.title : `Track ${trackNumber}`;
                const isActive = currentTrackId === t.id;

                return `
                <div class="track-row ${!isPlayable ? 'disabled' : ''} ${isActive ? 'active-track' : ''}" 
                     style="display:flex; align-items: center; padding:15px 0; border-bottom:1px solid #111; ${!isPlayable ? 'opacity:0.3; pointer-events:none;' : ''}" 
                     ${isPlayable ? `onclick="playTrack('${t.id}', true, '${alb.id}')"` : ''}>
                    <span style="width:35px; font-size: 14px; color:${isActive ? 'var(--accent-green)' : '#555'};">${isActive ? 'â–¶' : trackNumber}</span>
                    <div style="flex:1;">
                        <div style="font-weight:bold; font-size: 15px;">${displayTitle}</div>
                        <div style="font-size:12px; opacity:0.6;">${artist.name}</div>
                    </div>
                    <div style="font-size: 12px; color: #555;">${isPlayable ? (t.duration || '0:00') : '??:??'}</div>
                </div>`;
            }).join('')}
        </div>
    </div>`;
    contentView.innerHTML = html;
};

window.playTrack = (trackId, autoPlay = true, explicitAlbumId = null) => {
    // Find the track object from the global pool
    const allTracks = Object.values(window.TRACKS).flat();
    const track = allTracks.find(t => t.id === trackId);
    if (!track) return;

    // Determine which album context to use for art/artist
    const parentIds = track.album_id.split(',').map(s => s.trim());
    const playableAlbum = window.ALBUMS.find(a => parentIds.includes(a.id) && !a.coming_soon);
    if (!playableAlbum) return;

    const targetAlbum = explicitAlbumId ? window.ALBUMS.find(a => a.id == explicitAlbumId) : playableAlbum;

    currentTrackId = trackId;
    currentArtistId = targetAlbum.artist_id;
    audio.src = track.url;
    STORAGE.addRecent(trackId);
    
    if (autoPlay) {
        audio.play().catch(e => console.log("Playback blocked by browser. User interaction required."));
    }

    // UI Updates
    document.getElementById('mini-player').style.display = 'flex';
    document.getElementById('m-title').innerText = track.title;
    document.getElementById('fp-title').innerText = track.title;
    document.getElementById('m-art').src = targetAlbum.art_url;
    document.getElementById('fp-art').src = targetAlbum.art_url;
    
    const artistName = window.ARTISTS[targetAlbum.artist_id]?.name || "TRM";
    document.getElementById('m-artist').innerText = artistName;
    document.getElementById('fp-artist').innerText = artistName;
    
    document.getElementById('m-play-btn').innerText = 'pause';
    document.getElementById('fp-play-btn').innerText = 'pause';
    
    updateFpFavIcon();

    // Refresh current view to update the "active" row highlight
    if(window.currentViewId === 'album') viewAlbum(targetAlbum.id);
    if(window.currentViewId === 'library') viewLikedSongs(window.lastActiveTab || 'liked');
};

        window.goToCurrentArtist = () => {
            if (currentArtistId) {
                closeFullPlayer();
                viewArtist(currentArtistId);
            }
        };

        window.viewSearch = () => {
            window.currentViewId = 'search';
            resetScroll();
            setNav(1);
            contentView.innerHTML = `
                <div class="standard-padding view-animate">
                    <h2>Search</h2>
                    <input type="text" id="mSearch" placeholder="Artists, Albums, or Songs" 
                           style="width:100%; padding:15px; background:#222; border:none; border-radius:8px; color:white; outline:none;"
                           oninput="runSearch(this.value)">
                    <div id="mResults" style="margin-top:20px;"></div>
                </div>`;
        };

        window.runSearch = (q) => {
            const res = document.getElementById('mResults');
            if (!q) { res.innerHTML = ''; return; }
            const query = q.toLowerCase();
            const albMatch = window.ALBUMS.filter(a => a.name.toLowerCase().includes(query) && !a.hidden);
            const artMatch = Object.values(window.ARTISTS).filter(a => a.name.toLowerCase().includes(query));
            const trkMatch = Object.values(window.TRACKS).flat().filter(t => t.title.toLowerCase().includes(query));
            let html = '';
            artMatch.forEach(a => html += `<div style="display:flex; align-items:center; margin-bottom:15px;" onclick="viewArtist('${a.id}')"><img src="${a.banner_url || ''}" style="width:50px; height:50px; border-radius:50%; object-fit:cover; margin-right:15px;"><div><div style="font-weight:bold; display:flex; align-items:center; gap:4px;">${a.name} ${a.is_verified ? '<span class="material-icons" style="font-size:14px; color:#3897f0;">verified</span>' : ''}</div><div style="font-size:12px; color:var(--accent-green);">ARTIST</div></div></div>`);
            albMatch.forEach(a => html += `<div style="display:flex; align-items:center; margin-bottom:15px;" onclick="viewAlbum('${a.id}')"><img src="${a.art_url}" style="width:50px; height:50px; border-radius:4px; margin-right:15px;"><div><div style="font-weight:bold;">${a.name}</div><div style="font-size:12px; color:#666;">${a.type || 'ALBUM'}</div></div></div>`);
            trkMatch.forEach(t => html += `<div style="display:flex; align-items:center; margin-bottom:15px;" onclick="playTrack('${t.id}')"><div style="width:50px; height:50px; border-radius:4px; background:#222; margin-right:15px; display:flex; align-items:center; justify-content:center;"><span class="material-icons">music_note</span></div><div><div style="font-weight:bold;">${t.title}</div><div style="font-size:12px; color:#666;">SONG</div></div></div>`);
            res.innerHTML = html;
        };

        window.viewLikedSongs = (activeTab = 'liked') => {
            window.currentViewId = 'library';
            resetScroll();
            setNav(2);
            const ids = activeTab === 'liked' ? STORAGE.getLikes() : STORAGE.getRecent();
            const allTracks = Object.values(window.TRACKS).flat();
            const filtered = activeTab === 'liked' 
                ? allTracks.filter(t => ids.includes(t.id)) 
                : ids.map(id => allTracks.find(t => t.id === id)).filter(Boolean);

            let html = `
                <div class="standard-padding view-animate">
                    <h2>Library</h2>
                    <div class="lib-tabs">
                        <div class="tab ${activeTab === 'liked' ? 'active' : ''}" onclick="viewLikedSongs('liked')">Liked Songs</div>
                        <div class="tab ${activeTab === 'recent' ? 'active' : ''}" onclick="viewLikedSongs('recent')">Recently Played</div>
                    </div>
                    <div id="lib-content">`;
            
            if(filtered.length === 0) html += `<p style="color:#666;">Nothing to show here yet.</p>`;
            else filtered.forEach(t => { 
                const aids = t.album_id.split(',').map(s => s.trim());
                const alb = window.ALBUMS.find(a => aids.includes(a.id)) || {};
                const artName = window.ARTISTS[alb.artist_id]?.name || "TRM";
                html += `
                <div class="track-row ${currentTrackId === t.id ? 'active-track' : ''}" 
                     style="display:flex; padding:15px 0; border-bottom:1px solid #111;" 
                     onclick="playTrack('${t.id}')">
                    <div style="flex:1;">
                        <div style="font-weight:bold;">${t.title}</div>
                        <div style="font-size:12px; color:var(--text-dim);">${artName}</div>
                    </div>
                </div>`; 
            });
            contentView.innerHTML = html + `</div></div>`;
        };

        window.togglePlay = () => {
            if (!audio.src) return;
            if (audio.paused) audio.play(); else audio.pause();
            const icon = audio.paused ? 'play_arrow' : 'pause';
            document.getElementById('m-play-btn').innerText = icon;
            document.getElementById('fp-play-btn').innerText = icon;
        };

        audio.ontimeupdate = () => {
            if (!audio.duration) return;
            const per = (audio.currentTime / audio.duration) * 100;
            document.getElementById('mini-progress').style.width = per + '%';
            document.getElementById('fp-progress').style.width = per + '%';
            document.getElementById('time-cur').innerText = formatTime(audio.currentTime);
            document.getElementById('time-dur').innerText = formatTime(audio.duration);
        };

        function formatTime(sec) {
            const m = Math.floor(sec / 60);
            const s = Math.floor(sec % 60);
            return `${m}:${s < 10 ? '0' : ''}${s}`;
        }

        window.seek = (e, el) => {
            const rect = el.getBoundingClientRect();
            const per = (e.clientX - rect.left) / rect.width;
            audio.currentTime = per * audio.duration;
        };

        window.handleLikeClick = () => { if(!currentTrackId) return; STORAGE.toggleLike(currentTrackId); updateFpFavIcon(); };
        
        function updateFpFavIcon() { 
            const isLiked = STORAGE.getLikes().includes(currentTrackId); 
            const icon = document.getElementById('m-fav-btn'); 
            icon.innerText = isLiked ? 'favorite' : 'favorite_border'; 
            if(isLiked) icon.classList.add('glow-active'); else icon.classList.remove('glow-active');
        }

        window.toggleShuffle = () => { isShuffle = !isShuffle; document.getElementById('ctrl-shuffle').classList.toggle('glow-active', isShuffle); };
        window.toggleLoop = () => { isRepeat = !isRepeat; audio.loop = isRepeat; document.getElementById('ctrl-repeat').classList.toggle('glow-active', isRepeat); };
        
        function setNav(idx) { const ids = ['nav-home', 'nav-search', 'nav-lib']; ids.forEach((id, i) => { const el = document.getElementById(id); if(el) el.classList.toggle('active', i === idx); }); }
        function openFullPlayer() { const fp = document.getElementById('full-player'); fp.style.display = 'flex'; setTimeout(() => fp.classList.add('active'), 10); }
        function closeFullPlayer() { document.getElementById('full-player').classList.remove('active'); setTimeout(() => document.getElementById('full-player').style.display = 'none', 400); }
        function handleDeepLinking() { const params = new URLSearchParams(window.location.search); const albId = params.get('album'); if (albId) viewAlbum(albId); }

        window.nextTrack = () => {
            const allTracks = Object.values(window.TRACKS).flat().filter(t => {
                const aids = t.album_id.split(',').map(s => s.trim());
                return window.ALBUMS.some(a => aids.includes(a.id) && !a.coming_soon);
            });
            if (allTracks.length === 0) return;
            let nextIdx;
            if (isShuffle) {
                nextIdx = Math.floor(Math.random() * allTracks.length);
            } else {
                const currentIdx = allTracks.findIndex(t => t.id === currentTrackId);
                nextIdx = (currentIdx + 1) % allTracks.length;
            }
            playTrack(allTracks[nextIdx].id);
        };

        window.prevTrack = () => {
            if (audio.currentTime > 3) { audio.currentTime = 0; return; }
            const allTracks = Object.values(window.TRACKS).flat().filter(t => {
                const aids = t.album_id.split(',').map(s => s.trim());
                return window.ALBUMS.some(a => aids.includes(a.id) && !a.coming_soon);
            });
            const currentIdx = allTracks.findIndex(t => t.id === currentTrackId);
            let prevIdx = (currentIdx - 1 + allTracks.length) % allTracks.length;
            playTrack(allTracks[prevIdx].id);
        };

        audio.onended = () => { if (!isRepeat) nextTrack(); };

        init();
    </script>
</body>
</html>