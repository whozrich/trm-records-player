<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TRM Records</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
:root {
    --bg-black: #000000;
    --ios-glass: rgba(20, 20, 20, 0.75);
    --ios-blur: blur(35px) saturate(180%);
    --ios-border: 0.5px solid rgba(255, 255, 255, 0.15);
    --accent-green: #00ff88;
    --text-main: #ffffff;
    --text-dim: rgba(255, 255, 255, 0.5);
    --squircle: 22%;
    --safe-pad: 24px;
}

body, html {
    margin: 0; padding: 0;
    background-color: var(--bg-black);
    color: var(--text-main);
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
    height: 100%; width: 100%; overflow: hidden;
}

#content-view { 
    height: 100%; width: 100%;
    overflow-y: auto; overflow-x: hidden;
    padding-bottom: 220px;
    -webkit-overflow-scrolling: touch; 
    scroll-behavior: smooth;
}

#content-view::-webkit-scrollbar {
    width: 0px; /* Most mobile apps hide the bar entirely for that clean look */
    background: transparent;
}

.standard-padding { 
    padding-left: var(--safe-pad); 
    padding-right: var(--safe-pad);
    padding-top: 20px;
}

.mobile-home-grid { 
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    gap: 16px; 
    padding: 0 var(--safe-pad); 
}

/* --- THE FLOATING NAV ISLAND --- */
.bottom-nav {
    position: fixed; 
    bottom: 30px; 
    left: 50%;
    transform: translateX(-50%); 
    width: calc(100% - 48px); 
    max-width: 400px; 
    height: 68px;
    background: var(--ios-glass);
    backdrop-filter: var(--ios-blur);
    -webkit-backdrop-filter: var(--ios-blur);
    display: flex;
    justify-content: space-around; 
    align-items: center;
    border: var(--ios-border);
    border-radius: 40px; 
    z-index: 1000;
    box-shadow: 0 20px 40px rgba(0,0,0,0.5);
    transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1), opacity 0.3s ease;
}

#mSearch {
    width: 100%;
    padding: 14px 16px;
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 14px;
    color: white;
    font-size: 16px;
    outline: none;
    transition: all 0.3s ease;
    box-sizing: border-box;
}

#mSearch:focus {
    background: rgba(255, 255, 255, 0.12);
    border-color: var(--accent-green);
    box-shadow: 0 0 15px rgba(0, 255, 136, 0.2);
}

.search-section-label {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text-dim);
    margin: 25px 0 15px 0;
    font-weight: 800;
}

.result-item {
    display: flex;
    align-items: center;
    padding: 10px;
    margin: 0 -10px; /* Offset padding for tap effect */
    border-radius: 12px;
    transition: background 0.2s;
}

.result-item:active {
    background: rgba(255, 255, 255, 0.1);
}

.nav-item { color: var(--text-dim); transition: 0.3s; flex: 1; text-align: center; font-size: 10px; font-weight: 600; }
.nav-item.active { color: white; transform: translateY(-2px); }
.nav-item .material-icons { display: block; font-size: 24px; margin-bottom: 2px; }

.accent-glow, #fp-artist, .active-track, .play-indicator {
    color: var(--accent-green) !important;
    text-shadow: 0 0 15px rgba(0, 255, 136, 0.6);
}

/* --- THE MINI PLAYER (FLOATING CARD) --- */
#mini-player {
    position: fixed; 
    bottom: 110px;
    left: var(--safe-pad); 
    right: var(--safe-pad);
    background: var(--ios-glass);
    backdrop-filter: var(--ios-blur);
    -webkit-backdrop-filter: var(--ios-blur);
    border: var(--ios-border);
    border-radius: 24px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.6);
    z-index: 999;
    display: none; 
    flex-direction: column;
    overflow: hidden; /* CRITICAL: Clips the progress bar to the rounded corners */
    
    /* Smooth iOS Spring Animation */
    transition: 
        transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1), 
        bottom 0.5s cubic-bezier(0.19, 1, 0.22, 1), 
        opacity 0.4s ease;
}

.no-transition {
    transition: none !important;
}

#mini-player.nav-is-hidden { bottom: 30px !important; }

.nav-hidden {
    transform: translate(-50%, 150px) !important;
    opacity: 0;
}

.mini-hidden {
    opacity: 0 !important;
    transform: translateY(200px) !important;
}

.mini-active {
    display: flex !important;
    opacity: 1 !important;
    animation: ios-pop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes ios-pop {
    0% { transform: scale(0.9) translateY(20px); opacity: 0; }
    100% { transform: scale(1) translateY(0); opacity: 1; }
}

#m-art {
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.paused #m-art {
    transform: scale(0.85);
    filter: grayscale(0.5);
}

.mini-main { display: flex; align-items: center; padding: 10px 15px; }
#mini-player img { width: 45px; height: 45px; border-radius: 8px; margin-right: 12px; }

/* --- FULL SCREEN PLAYER (MODAL) --- */
#full-player {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #000;
    z-index: 2000; display: none; flex-direction: column;
    transform: translateY(100%); transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
}

#full-player.active { display: flex; transform: translateY(0); }

/* --- THE DYNAMIC GLOW BACKGROUND --- */
.bg-glow {
    position: absolute; inset: 0;
    background: radial-gradient(circle at top left, var(--accent-green), transparent 70%),
                radial-gradient(circle at bottom right, #333, transparent 70%);
    opacity: 0.3;
    filter: blur(80px);
    z-index: -1;
}

/* --- CATALOGUE GRID --- */
.mobile-home-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 0 20px; }
.track-tile { border-radius: var(--squircle); overflow: hidden; background: transparent; }
.track-tile img { 
    width: 100%; aspect-ratio: 1; object-fit: cover; 
    border-radius: var(--squircle);
    box-shadow: 0 10px 20px rgba(0,0,0,0.3);
}
.tile-content { padding: 10px 5px; }

/* --- PROGRESS BAR (SLEEK) --- */
.progress-container { 
    width: 100%; 
    height: 3px; /* Thin hairline look */
    background: rgba(255, 255, 255, 0.1); 
    position: absolute;
    bottom: 0; /* Pins it to the very bottom edge */
    left: 0;
    cursor: pointer;
}

.progress-fill { 
    height: 100%; 
    background: var(--accent-green); 
    box-shadow: 0 0 8px var(--accent-green); /* Adds that "active" glow */
    transition: width 0.1s linear; 
}

.material-icons.glow-green {
    color: var(--accent-green) !important;
    filter: drop-shadow(0 0 8px rgba(0, 255, 136, 0.8));
}

.material-icons { font-family: 'Material Icons'; font-weight: normal; font-style: normal; display: inline-block; line-height: 1; text-transform: none; letter-spacing: normal; word-wrap: normal; white-space: nowrap; direction: ltr; -webkit-font-smoothing: antialiased; }
        .material-icons:active {
            transform: scale(0.85);
            filter: brightness(1.5);
        }

        /* --- FEATURED BANNER --- */
        .featured-banner {
            position: relative; height: 220px; margin: 15px; border-radius: 12px;
            overflow: hidden; display: flex; align-items: flex-end; padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); background: #111;
        }
        .featured-banner img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; filter: brightness(0.7); }
        .featured-content { position: relative; z-index: 2; }

        /* --- HOME GRID --- */
        .mobile-home-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .track-tile { background: var(--card-grey); border-radius: 8px; overflow: hidden; position: relative; }
        .track-tile img { width: 100%; aspect-ratio: 1; object-fit: cover; }
        .tile-content { padding: 10px; }
        .tile-title { display: block; font-weight: bold; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tile-label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; }

        /* --- PROGRESS BARS --- */
        .progress-container { width: 100%; height: 4px; background: #444; border-radius: 2px; position: relative; cursor: pointer; }
        .progress-fill { height: 100%; background: var(--accent-green); width: 0%; border-radius: 2px; box-shadow: 0 0 10px var(--accent-green); }

        /* --- NAVIGATION --- */
        .nav-item { color: var(--text-dim); text-align: center; font-size: 10px; cursor: pointer; flex: 1; transition: 0.2s; }
        .nav-item.active { color: white; text-shadow: var(--glow); }
        .nav-item .material-icons { display: block; font-size: 28px; margin-bottom: 2px; }

        /* --- FULL SCREEN PLAYER --- */
        #full-player {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, #333, #000);
            z-index: 2000; display: none; flex-direction: column;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.1, 0.7, 0.1, 1);
        }
        #full-player.active { display: flex; transform: translateY(0); }
        .fp-header { padding: 40px 20px 20px; display: flex; justify-content: space-between; align-items: center; }
        .fp-art { width: 85%; aspect-ratio: 1; margin: 20px auto; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .fp-meta { padding: 20px 30px; }
        #fp-artist { 
            color: var(--accent-green); 
            margin: 5px 0; 
            font-size: 18px; 
            text-shadow: 0 0 10px rgba(29, 185, 84, 0.5);
            cursor: pointer;
            display: inline-block;
        }

        #fp-bg-visual {
    position: absolute;
    inset: -10%; /* Extra overflow to prevent white edges during blur */
    z-index: -2;
    background-size: cover;
    background-position: center;
    filter: blur(80px) saturate(150%) brightness(0.5);
    opacity: 0.6;
    transition: background-image 0.8s ease-in-out;
}
        
        .fp-controls { display: flex; justify-content: space-around; align-items: center; padding: 20px; margin-top: auto; padding-bottom: 60px; }
        .play-btn-lg { background: white; color: black; border-radius: 50%; width: 75px; height: 75px; display: flex; align-items: center; justify-content: center; }
        .play-btn-lg:active { transform: scale(0.9); }

        .back-btn {
    width: 42px;
    height: 42px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.back-btn:active {
    transform: scale(0.9);
    background: rgba(255, 255, 255, 0.2);
}

        /* --- TABS --- */
        .lib-tabs { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid #222; }
        .tab { padding: 10px 0; color: var(--text-dim); cursor: pointer; font-weight: bold; }
        .tab.active { color: var(--accent-green); border-bottom: 2px solid var(--accent-green); }

        .glow-active { color: var(--accent-green) !important; filter: drop-shadow(0 0 8px var(--accent-green)) !important; }

        glow-active {
    color: var(--accent-green) !important;
    filter: drop-shadow(0 0 8px rgba(0, 255, 136, 0.8));
    transition: all 0.3s ease;
}
        .track-row.disabled { opacity: 0.3; pointer-events: none; }
        .track-row.active-track { color: var(--accent-green); }
        .view-animate { animation: fadeIn 0.3s ease-out; }

        /* Library Tab Container */
.library-tabs {
    display: flex;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 14px;
    padding: 4px;
    margin-bottom: 25px;
    border: var(--ios-border);
    position: relative;
}

.lib-tab {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px 0;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-dim);
    z-index: 2;
    transition: color 0.3s ease;
    cursor: pointer;
}

.lib-tab.active {
    color: #fff;
}

/* The Sliding Glow Indicator */
.tab-glow {
    position: absolute;
    height: calc(100% - 8px);
    width: calc(50% - 4px); /* Assuming 2 tabs */
    background: rgba(255, 255, 255, 0.15);
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
    border-radius: 11px;
    top: 4px;
    left: 4px;
    transition: transform 0.4s cubic-bezier(0.33, 1, 0.68, 1);
    z-index: 1;
}

.tab-2-active .tab-glow {
    transform: translateX(100%);
}

/* Track Art for Library Rows */
.lib-track-art {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    margin-right: 15px;
    object-fit: cover;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="content-view">
        <div style="padding: 100px 20px; text-align: center; color: var(--text-dim);">Loading TRM...</div>
    </div>

    <div id="mini-player" onclick="openFullPlayer()">
        <div class="mini-main">
            <img id="m-art" src="">
            <div style="flex:1; overflow:hidden;">
                <div id="m-title" style="font-weight:bold; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div>
                <div id="m-artist" style="font-size:12px; color:var(--text-dim);"></div>
            </div>
            <span class="material-icons" id="m-play-btn" onclick="event.stopPropagation(); togglePlay();" style="font-size:35px; padding:5px;">play_arrow</span>
        </div>
        <div class="progress-container" onclick="event.stopPropagation(); seek(event, this)">
            <div id="mini-progress" class="progress-fill"></div>
        </div>
    </div>

<div id="full-player">
    <div id="fp-bg-visual"></div>
    
    <div class="bg-glow" id="fp-glow"></div>

    <div class="fp-header">
        <div class="back-btn" onclick="closeFullPlayer()">
            <span class="material-icons" style="font-size:28px; color: white;">expand_more</span>
        </div>
        <span style="font-size:10px; font-weight:800; letter-spacing:2px; opacity: 0.5;">NOW PLAYING</span>
        <span class="material-icons" id="m-fav-btn" onclick="handleLikeClick()" style="font-size:26px;">favorite_border</span>
    </div>

    <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <img id="fp-art" class="fp-art" src="" style="width: 82%; border-radius: var(--squircle); box-shadow: 0 30px 60px rgba(0,0,0,0.7);">
    </div>

    <div class="fp-meta" style="padding: 0 40px;">
        <h1 id="fp-title" style="margin:0; font-size:28px; font-weight: 800; letter-spacing: -0.5px;"></h1>
        <p id="fp-artist" onclick="goToCurrentArtist()" style="margin: 5px 0 30px 0; font-size: 19px; font-weight: 500;"></p>
    </div>

    <div style="padding: 0 40px;">
        <div class="progress-container" onclick="seek(event, this)" style="height: 4px; background: rgba(255,255,255,0.2);">
            <div id="fp-progress" class="progress-fill" style="background: #fff; box-shadow: 0 0 15px rgba(255,255,255,0.6);"></div>
        </div>
        <div style="display: flex; justify-content: space-between; font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.4); margin-top: 12px;">
            <span id="time-cur">0:00</span>
            <span id="time-dur">0:00</span>
        </div>
    </div>

    <div class="fp-controls" style="padding: 40px; margin-bottom: 20px;">
        <span class="material-icons" id="ctrl-shuffle" style="font-size:24px; opacity:0.6;" onclick="toggleShuffle()">shuffle</span>
        <span class="material-icons" style="font-size:48px;" onclick="prevTrack()">skip_previous</span>
        <div class="play-btn-lg" onclick="togglePlay()" style="background: white; color: black; width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(255,255,255,0.2);">
            <span class="material-icons" id="fp-play-btn" style="font-size:45px;">play_arrow</span>
        </div>
        <span class="material-icons" style="font-size:48px;" onclick="nextTrack()">skip_next</span>
        <span class="material-icons" id="ctrl-repeat" style="font-size:24px; opacity:0.6;" onclick="toggleLoop()">repeat</span>
    </div>
</div>

    <nav class="bottom-nav">
        <div class="nav-item active" id="nav-home" onclick="window.viewHome()">
            <span class="material-icons">home</span>Home
        </div>
        <div class="nav-item" id="nav-search" onclick="window.viewSearch()">
            <span class="material-icons">search</span>Search
        </div>
        <div class="nav-item" id="nav-lib" onclick="window.viewLibrary()">
            <span class="material-icons">library_music</span>Library
        </div>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const S_URL = 'https://sxagulxljpzftqfnllhv.supabase.co';
        const S_KEY = 'sb_publishable_GG1VzWph8ZCK2hCyZugMfA_qR6LZcRn';
        const supabaseClient = supabase.createClient(S_URL, S_KEY);

        window.ALBUMS = [];
        window.TRACKS = {};
        window.ARTISTS = {};
        let currentTrackId = null;
        let currentArtistId = null;
        let isShuffle = false;
        let isRepeat = false;
        const audio = new Audio();
        const contentView = document.getElementById('content-view');

        const STORAGE = {
            getLikes: () => JSON.parse(localStorage.getItem('trm_likes') || '[]'),
            getRecent: () => JSON.parse(localStorage.getItem('trm_recent') || '[]'),
            toggleLike: (id) => {
                let likes = STORAGE.getLikes();
                likes = likes.includes(id) ? likes.filter(x => x !== id) : [...likes, id];
                localStorage.setItem('trm_likes', JSON.stringify(likes));
                return likes.includes(id);
            },
            addRecent: (id) => {
                let recent = STORAGE.getRecent().filter(x => x !== id);
                recent.unshift(id);
                localStorage.setItem('trm_recent', JSON.stringify(recent.slice(0, 20)));
            }
        };

       async function init() {
    try {
        const { data: artists } = await supabaseClient.from('artists').select('*');
        artists?.forEach(a => window.ARTISTS[a.id] = a);

        const { data: albumsData } = await supabaseClient.from('albums').select('*');
        const { data: tracksData } = await supabaseClient.from('tracks').select('*');

        // Helper to sort albums by date
        const parseDate = (str) => {
            if (!str || str === 'RELEASED') return 0;
            const cleanDate = str.replace(/(\d+)(st|nd|rd|th)/, "$1");
            const timestamp = Date.parse(cleanDate);
            return isNaN(timestamp) ? 0 : timestamp;
        };

        window.ALBUMS = (albumsData || []).sort((a, b) => parseDate(b.full_release_date) - parseDate(a.full_release_date));

        // Create a quick lookup map for tracks
        const trackLookup = {};
        tracksData?.forEach(t => { trackLookup[t.id] = t; });

        // ARRAY IS LAW: Map tracks to albums based strictly on the JSONB array order
        window.TRACKS = {};
        window.ALBUMS.forEach(alb => {
            const manualOrder = alb.track_ids || []; 
            // Filter out any IDs that might not exist in the tracks table
            window.TRACKS[alb.id] = manualOrder
                .map(id => trackLookup[id])
                .filter(Boolean); 
        });

        window.viewHome();
        handleDeepLinking();
    } catch (err) { 
        console.error("Init Error:", err); 
        contentView.innerHTML = `<div class="standard-padding">Error loading database.</div>`;
    }
}

        function resetScroll() { contentView.scrollTo(0, 0); }

        window.viewHome = () => {
            window.currentViewId = 'home';
            resetScroll();
            setNav(0);
            if (window.ALBUMS.length === 0) return;
            const featured = window.ALBUMS.find(a => a.is_featured && !a.hidden) || window.ALBUMS[0];
            const publicAlbs = window.ALBUMS.filter(a => !a.hidden);
            
            let html = `
                <div class="featured-banner view-animate" onclick="viewAlbum('${featured.id}')">
                    <img src="${featured.art_url}">
                    <div class="featured-content">
                        <div style="background:var(--accent-green); color:black; font-size:10px; font-weight:bold; padding:2px 6px; border-radius:4px; display:inline-block; margin-bottom:5px;">FEATURED</div>
                        <h1 style="margin:0;">${featured.name}</h1>
                    </div>
                </div>
                <div class="standard-padding">
                    <h2 style="margin-top:0;">Catalogue</h2>
                    <div class="mobile-home-grid">`;
            
            publicAlbs.forEach(a => {
                html += `
                    <div class="track-tile" onclick="viewAlbum('${a.id}')">
                        <img src="${a.art_url}" style="${a.coming_soon ? 'opacity:0.5; filter:grayscale(1)' : ''}">
                        <div class="tile-content">
                            <span class="tile-title">${a.name}</span>
                            <span class="tile-label" style="color:${a.coming_soon ? '#ff4444' : '#888'}">
                                ${a.coming_soon ? 'COMING SOON' : (a.type || 'ALBUM')}
                            </span>
                        </div>
                    </div>`;
            });
            contentView.innerHTML = html + `</div></div>`;
        };

window.toggleNavUI = (show) => {
    const navBar = document.querySelector('.bottom-nav');
    const miniPlayer = document.getElementById('mini-player');

    if (show) {
        navBar.classList.remove('nav-hidden');
        if (window.currentTrackId) miniPlayer.classList.remove('nav-is-hidden');
    } else {
        navBar.classList.add('nav-hidden');
        // If a song is playing, move the player down to the nav's spot
        if (window.currentTrackId) miniPlayer.classList.add('nav-is-hidden');
    }
};


        window.viewArtist = (id) => {
            window.currentViewId = 'artist';
            resetScroll();
            const artist = window.ARTISTS[id];
            const artistAlbs = window.ALBUMS.filter(a => a.artist_id == id && !a.hidden);

            let html = `
                <div class="view-animate">
                    <div style="height:280px; position:relative; overflow:hidden;">
                        <img src="${artist.banner_url || ''}" style="width:100%; height:100%; object-fit:cover; filter:brightness(0.6);">
                        <span class="material-icons" onclick="viewHome()" style="position:absolute; top:40px; left:20px; z-index:10; background:rgba(0,0,0,0.5); border-radius:50%; padding:5px;">chevron_left</span>
                        <div style="position:absolute; bottom:20px; left:20px; right:20px; z-index:2;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <h1 style="font-size:36px; margin:0;">${artist.name}</h1>
                                ${artist.is_verified ? '<span class="material-icons" style="color:#3897f0; font-size:24px;">verified</span>' : ''}
                            </div>
                            <p style="color:var(--text-dim); margin:5px 0; font-size:14px; line-height:1.4;">${artist.bio || 'Official TRM Artist'}</p>
                        </div>
                    </div>
                    <div class="standard-padding">
                        <h2 style="margin-top:0;">Discography</h2>
                        <div class="mobile-home-grid">
                            ${artistAlbs.map(a => `
                                <div class="track-tile" onclick="viewAlbum('${a.id}')">
                                    <img src="${a.art_url}">
                                    <div class="tile-content">
                                        <span class="tile-title">${a.name}</span>
                                        <span class="tile-label">${a.type || 'ALBUM'}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>`;
            contentView.innerHTML = html;
        };

window.viewAlbum = (id) => {
    window.currentViewId = 'album';
    contentView.scrollTo(0, 0);
    toggleNavUI(false); 

    const alb = window.ALBUMS.find(a => a.id === id);
    if (!alb) return;

    const tks = window.TRACKS[id] || [];
    const artist = window.ARTISTS[alb.artist_id] || { name: "TRM Records" };

    let html = `
    <div class="view-animate">
        <div style="padding: 40px var(--safe-pad) 20px; text-align:center; position: relative;">
            <span class="material-icons" onclick="viewHome(); toggleNavUI(true);" 
                  style="position: absolute; left: var(--safe-pad); top: 40px; background: rgba(255,255,255,0.1); border-radius: 50%; padding: 6px; font-size: 20px; cursor: pointer;">chevron_left</span>
            <img src="${alb.art_url}" style="width:240px; aspect-ratio:1; border-radius: var(--squircle); box-shadow: 0 20px 50px rgba(0,0,0,0.8); object-fit: cover;">
            <h1 style="margin:25px 0 5px 0; font-size: 30px; font-weight: 900; letter-spacing: -1px;">${alb.name}</h1>
            <div style="display:flex; align-items:center; justify-content:center; gap:12px;">
                <p style="color:var(--accent-green); font-weight: bold; margin:0; font-size: 17px; cursor: pointer;" onclick="viewArtist('${alb.artist_id}')">${artist.name}</p>
                <button onclick="copyAlbumLink('${alb.id}')" style="background:rgba(255,255,255,0.1); border:none; color:white; width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                     <span class="material-icons" style="font-size:16px;">share</span>
                </button>
            </div>
        </div>
        <div class="standard-padding">
            ${tks.map((t, i) => {
                // RESTORED PARITY RULE
                const parentIds = t.album_id ? t.album_id.split(',').map(s => s.trim()) : [];
                const isPlayable = parentIds.some(aid => {
                    const other = window.ALBUMS.find(a => a.id == aid);
                    return other && !other.coming_soon;
                });

                // RESTORED HIDDEN LOGIC
                if (t.hidden_name === true) return ''; 

                const trackNumber = i + 1;
                const displayTitle = isPlayable ? t.title : `Track ${trackNumber}`;
                const isActive = currentTrackId === t.id;

                return `
                <div class="track-row ${!isPlayable ? 'disabled' : ''} ${isActive ? 'active-track' : ''}" 
                     style="display:flex; align-items: center; padding:16px 0; border-bottom:1px solid rgba(255,255,255,0.05); ${!isPlayable ? 'opacity:0.3; pointer-events:none;' : ''}" 
                     ${isPlayable ? `onclick="playTrack('${t.id}', true, '${alb.id}')"` : ''}>
                    <span style="width:30px; font-size: 14px; font-weight: bold; color:${isActive ? 'var(--accent-green)' : 'rgba(255,255,255,0.2)'};">
                        ${isActive ? '▶' : trackNumber}
                    </span>
                    <div style="flex:1;">
                        <div style="font-weight:700; font-size: 16px; color:${isActive ? 'var(--accent-green)' : 'white'}">${displayTitle}</div>
                        <div style="font-size:13px; opacity:0.5;">${artist.name}</div>
                    </div>
                    <div style="font-size: 13px; opacity:0.4;">${isPlayable ? (t.duration || '0:00') : '??:??'}</div>
                </div>`;
            }).join('')}
        </div>
    </div>`;
    contentView.innerHTML = html;
};

window.playTrack = (trackId, autoPlay = true, explicitAlbumId = null) => {
    const allTracks = Object.values(window.TRACKS).flat();
    const track = allTracks.find(t => t.id === trackId);
    if (!track) return;

    const parentIds = track.album_id.split(',').map(s => s.trim());
    const playableAlbum = window.ALBUMS.find(a => parentIds.includes(a.id) && !a.coming_soon);
    if (!playableAlbum) return;

    const targetAlbum = explicitAlbumId ? window.ALBUMS.find(a => a.id == explicitAlbumId) : playableAlbum;

    currentTrackId = trackId;
    currentArtistId = targetAlbum.artist_id;
    audio.src = track.url;

    const miniPlayer = document.getElementById('mini-player');
    const navBar = document.querySelector('.bottom-nav');

    // UI Positioning
    miniPlayer.classList.add('no-transition');
    if (navBar && navBar.classList.contains('nav-hidden')) {
        miniPlayer.classList.add('nav-is-hidden');
    } else {
        miniPlayer.classList.remove('nav-is-hidden');
    }

    miniPlayer.style.display = 'flex';
    miniPlayer.classList.remove('mini-hidden', 'paused'); // 'paused' removed to expand art
    miniPlayer.classList.add('mini-active');

    void miniPlayer.offsetWidth;
    miniPlayer.classList.remove('no-transition');

    // Update Text and Images
    document.getElementById('m-title').innerText = track.title;
    document.getElementById('m-art').src = targetAlbum.art_url;
    document.getElementById('fp-title').innerText = track.title;
    document.getElementById('fp-art').src = targetAlbum.art_url;
    
    const artistName = window.ARTISTS[targetAlbum.artist_id]?.name || "TRM";
    document.getElementById('m-artist').innerText = artistName;
    document.getElementById('fp-artist').innerText = artistName;

    // Handle Play/Pause Icons
    document.getElementById('m-play-btn').innerText = 'pause';
    document.getElementById('fp-play-btn').innerText = 'pause';

    // SAFE UPDATE: DYNAMIC BACKGROUND
    const bgVisual = document.getElementById('fp-bg-visual');
    if (bgVisual) {
        bgVisual.style.backgroundImage = `url('${targetAlbum.art_url}')`;
        bgVisual.style.opacity = "0.7";
    }

    // SAFE UPDATE: GLOW
    const fpArtist = document.getElementById('fp-artist');
    if (fpArtist) {
        fpArtist.classList.add('accent-glow');
    }
    
    if (autoPlay) {
        audio.play().catch(e => console.log("Playback error"));
    }

    if(window.currentViewId === 'album') viewAlbum(targetAlbum.id);
    if(window.currentViewId === 'library') viewLibrary(window.lastActiveTab || 'liked');
};

        window.goToCurrentArtist = () => {
            if (currentArtistId) {
                closeFullPlayer();
                viewArtist(currentArtistId);
            }
        };

window.viewSearch = () => {
    window.currentViewId = 'search';
    contentView.scrollTo(0, 0);
    setNav(1); // Assuming 1 is Search index
    
    contentView.innerHTML = `
        <div class="standard-padding view-animate">
            <h1 style="font-size: 34px; font-weight: 800; margin-bottom: 20px; letter-spacing: -1px;">Search</h1>
            <div style="position: sticky; top: 0; background: var(--bg-black); padding: 10px 0; z-index: 10;">
                <input type="text" id="mSearch" placeholder="Artists, Albums, or Songs" 
                       oninput="runSearch(this.value)" autocomplete="off">
            </div>
            <div id="mResults"></div>
        </div>`;
    
    // Focus search bar automatically
    setTimeout(() => document.getElementById('mSearch').focus(), 100);
};

window.runSearch = (q) => {
    const res = document.getElementById('mResults');
    if (!q || q.trim().length < 1) { res.innerHTML = ''; return; }
    
    const query = q.toLowerCase();
    
    // 1. Artists
    const artMatch = Object.values(window.ARTISTS).filter(a => 
        a.name.toLowerCase().includes(query)
    );

    // 2. Albums: Must not be hidden
    const albMatch = window.ALBUMS.filter(a => 
        a.name.toLowerCase().includes(query) && a.hidden !== true
    );

    // 3. Tracks: Inherited Hiding Logic
    const trkMatch = [];
    Object.keys(window.TRACKS).forEach(albumId => {
        const album = window.ALBUMS.find(a => a.id === albumId);
        
        // Skip this entire album's tracks if the album itself is hidden
        if (album && album.hidden === true) return; 

        window.TRACKS[albumId].forEach(t => {
            const matchesQuery = t.title.toLowerCase().includes(query);
            
            // Track is only visible if it's NOT hidden AND its album is NOT hidden
            // (The album check is handled by the 'return' above, but we keep t.hidden_name here)
            if (matchesQuery && t.hidden_name !== true) {
                trkMatch.push({
                    ...t,
                    albumArt: album ? album.art_url : 'https://via.placeholder.com/150',
                    albumId: albumId,
                    artistName: window.ARTISTS[album?.artist_id]?.name || 'Unknown Artist'
                });
            }
        });
    });

    let html = '';

    // Render Artists
    if (artMatch.length > 0) {
        html += `<div class="search-section-label">Artists</div>`;
        artMatch.forEach(a => {
            html += `
            <div class="result-item" onclick="viewArtist('${a.id}')">
                <img src="${a.banner_url || 'https://via.placeholder.com/150'}" style="width:55px; height:55px; border-radius:50%; object-fit:cover; margin-right:15px; border: var(--ios-border);">
                <div>
                    <div style="font-weight:bold; font-size:17px;">${a.name}</div>
                    <div style="font-size:12px; color:var(--accent-green); font-weight:700;">ARTIST</div>
                </div>
            </div>`;
        });
    }

    // Render Albums
    if (albMatch.length > 0) {
        html += `<div class="search-section-label">Albums</div>`;
        albMatch.forEach(a => {
            html += `
            <div class="result-item" onclick="viewAlbum('${a.id}')">
                <img src="${a.art_url}" style="width:55px; height:55px; border-radius:12px; object-fit:cover; margin-right:15px;">
                <div>
                    <div style="font-weight:bold; font-size:17px;">${a.name}</div>
                    <div style="font-size:12px; color:var(--text-dim);">ALBUM</div>
                </div>
            </div>`;
        });
    }

    // Render Tracks
    if (trkMatch.length > 0) {
        html += `<div class="search-section-label">Songs</div>`;
        trkMatch.forEach(t => {
            html += `
            <div class="result-item" onclick="playTrack('${t.id}', true, '${t.albumId}')">
                <img src="${t.albumArt}" style="width:55px; height:55px; border-radius:8px; object-fit:cover; margin-right:15px;">
                <div style="flex:1;">
                    <div style="font-weight:bold; font-size:17px;">${t.title}</div>
                    <div style="font-size:12px; color:var(--text-dim);">SONG • ${t.artistName}</div>
                </div>
                <span class="material-icons" style="color:var(--text-dim); font-size:20px;">more_horiz</span>
            </div>`;
        });
    }

    res.innerHTML = html || `<div style="text-align:center; margin-top:50px; color:var(--text-dim);">No results for "${q}"</div>`;
};

window.handleDeepLinking = () => { 
    const params = new URLSearchParams(window.location.search); 
    const albId = params.get('album'); 
    if (albId) {
        // Adding a small delay ensures data is loaded before navigating
        setTimeout(() => viewAlbum(albId), 100);
    }
};

window.copyAlbumLink = (albumId) => {
    // Construct the URL (e.g., mysite.com/?album=123)
    const url = `${window.location.origin}${window.location.pathname}?album=${albumId}`;

    if (navigator.share) {
        // Use native mobile share sheet
        navigator.share({
            title: 'Check out this album',
            url: url
        }).catch(err => console.log('Error sharing', err));
    } else {
        // Fallback: Copy to clipboard
        navigator.clipboard.writeText(url).then(() => {
            // Optional: Replace with a pretty toast notification later
            alert("Link copied to clipboard!");
        });
    }
};

window.togglePlay = () => {
    // 1. If no song is loaded, do nothing
    if (!audio.src || audio.src === "" || audio.src.includes('null')) return;

    const mBtn = document.getElementById('m-play-btn');
    const fBtn = document.getElementById('fp-play-btn');
    const miniPlayer = document.getElementById('mini-player');

    // 2. The actual toggle logic
    if (audio.paused) {
        audio.play().catch(e => console.log("Play failed"));
        if (mBtn) mBtn.innerText = 'pause';
        if (fBtn) fBtn.innerText = 'pause';
        if (miniPlayer) miniPlayer.classList.remove('paused'); // Expands art
    } else {
        audio.pause();
        if (mBtn) mBtn.innerText = 'play_arrow';
        if (fBtn) fBtn.innerText = 'play_arrow';
        if (miniPlayer) miniPlayer.classList.add('paused'); // Shrinks art
    }
};

// --- PROGRESS & TIME LOGIC ---
audio.ontimeupdate = () => {
    if (!audio.duration) return;
    const per = (audio.currentTime / audio.duration) * 100;
    
    // Update both bars
    const mBar = document.getElementById('mini-progress');
    const fBar = document.getElementById('fp-progress');
    if (mBar) mBar.style.width = per + '%';
    if (fBar) fBar.style.width = per + '%';

    // Update timestamps
    document.getElementById('time-cur').innerText = formatTime(audio.currentTime);
    document.getElementById('time-dur').innerText = formatTime(audio.duration);
};

function formatTime(sec) {
    if (isNaN(sec)) return "0:00";
    const m = Math.floor(sec / 60);
    const s = Math.floor(sec % 60);
    return `${m}:${s < 10 ? '0' : ''}${s}`;
}

window.seek = (e, el) => {
    if (!audio.duration) return;
    const rect = el.getBoundingClientRect();
    const per = (e.clientX - rect.left) / rect.width;
    audio.currentTime = per * audio.duration;
};

// --- CONTROLS & UTILS ---
window.handleLikeClick = () => { 
    if(!currentTrackId) return; 
    STORAGE.toggleLike(currentTrackId); 
    updateFpFavIcon(); 
};

function updateFpFavIcon() { 
    const isLiked = STORAGE.getLikes().includes(currentTrackId); 
    const icon = document.getElementById('m-fav-btn'); 
    if (icon) {
        icon.innerText = isLiked ? 'favorite' : 'favorite_border'; 
        icon.classList.toggle('glow-active', isLiked);
    }
}

window.toggleShuffle = () => { 
    isShuffle = !isShuffle; 
    document.getElementById('ctrl-shuffle').classList.toggle('glow-active', isShuffle); 
};

window.toggleLoop = () => { 
    isRepeat = !isRepeat; 
    audio.loop = isRepeat; 
    document.getElementById('ctrl-repeat').classList.toggle('glow-active', isRepeat); 
};

function setNav(idx) { 
    const ids = ['nav-home', 'nav-search', 'nav-lib']; 
    ids.forEach((id, i) => { 
        const el = document.getElementById(id); 
        if(el) el.classList.toggle('active', i === idx); 
    }); 
}

function openFullPlayer() { 
    const fp = document.getElementById('full-player'); 
    fp.style.display = 'flex'; 
    setTimeout(() => fp.classList.add('active'), 10); 
}

function closeFullPlayer() { 
    document.getElementById('full-player').classList.remove('active'); 
    setTimeout(() => document.getElementById('full-player').style.display = 'none', 400); 
}

// --- TRACK NAVIGATION ---
window.nextTrack = () => {
    const allTracks = Object.values(window.TRACKS).flat().filter(t => {
        const aids = t.album_id.split(',').map(s => s.trim());
        return window.ALBUMS.some(a => aids.includes(a.id) && !a.coming_soon);
    });
    if (allTracks.length === 0) return;
    let nextIdx;
    if (isShuffle) {
        nextIdx = Math.floor(Math.random() * allTracks.length);
    } else {
        const currentIdx = allTracks.findIndex(t => t.id === currentTrackId);
        nextIdx = (currentIdx + 1) % allTracks.length;
    }
    playTrack(allTracks[nextIdx].id);
};

window.prevTrack = () => {
    if (audio.currentTime > 3) { audio.currentTime = 0; return; }
    const allTracks = Object.values(window.TRACKS).flat().filter(t => {
        const aids = t.album_id.split(',').map(s => s.trim());
        return window.ALBUMS.some(a => aids.includes(a.id) && !a.coming_soon);
    });
    const currentIdx = allTracks.findIndex(t => t.id === currentTrackId);
    let prevIdx = (currentIdx - 1 + allTracks.length) % allTracks.length;
    playTrack(allTracks[prevIdx].id);
};

audio.onended = () => { if (!isRepeat) nextTrack(); };

window.viewLibrary = (activeTab = 'liked') => {
    window.currentViewId = 'library';
    window.lastActiveTab = activeTab; 
    contentView.scrollTo(0, 0);
    setNav(2); 

    if (!window.TRACKS || Object.keys(window.TRACKS).length === 0) {
        contentView.innerHTML = `<div style="text-align:center; padding-top:100px; opacity:0.5;">Loading Data...</div>`;
        setTimeout(() => viewLibrary(activeTab), 200);
        return;
    }

    const ids = (activeTab === 'liked') ? STORAGE.getLikes() : STORAGE.getRecent();
    const allTracks = Object.values(window.TRACKS).flat();
    const uniqueTracks = Array.from(new Map(allTracks.map(t => [t.id, t])).values());
    
    // Filter logic: Only show songs if the album is NOT "Coming Soon"
    const displayTracks = (activeTab === 'liked')
        ? uniqueTracks.filter(t => {
            const isLiked = ids.includes(t.id);
            const parentAlbumIds = t.album_id.split(',').map(s => s.trim());
            const alb = window.ALBUMS.find(a => parentAlbumIds.includes(a.id));
            return isLiked && (alb && !alb.coming_soon);
        })
        : ids.map(id => uniqueTracks.find(t => t.id === id)).filter(t => {
            if (!t) return false;
            const parentAlbumIds = t.album_id.split(',').map(s => s.trim());
            const alb = window.ALBUMS.find(a => parentAlbumIds.includes(a.id));
            return alb && !alb.coming_soon;
        });

    let html = `
    <div class="standard-padding view-animate" style="padding-bottom: 120px;">
        <h1 style="font-size: 34px; font-weight: 900; margin-bottom: 5px;">Library</h1>
        
        <div class="library-tabs ${activeTab === 'recent' ? 'tab-2-active' : ''}">
            <div class="tab-indicator"></div>
            <div class="lib-tab ${activeTab === 'liked' ? 'active' : ''}" onclick="viewLibrary('liked')">
                <span class="material-icons">favorite</span> Liked
            </div>
            <div class="lib-tab ${activeTab === 'recent' ? 'active' : ''}" onclick="viewLibrary('recent')">
                <span class="material-icons">history</span> Recent
            </div>
        </div>

        <div id="library-list">
            ${displayTracks.length > 0 ? displayTracks.map(t => {
                const parentAlbumIds = t.album_id ? t.album_id.split(',').map(s => s.trim()) : [];
                const alb = window.ALBUMS.find(a => parentAlbumIds.includes(a.id));
                const art = alb ? alb.art_url : 'https://thumbs2.imgbox.com/14/a7/fI8ktNrC_t.png';
                const isLiked = STORAGE.getLikes().includes(t.id);

                return `
                <div class="result-item" 
                     onclick="playTrack('${t.id}')"
                     onmousedown="handleLongPressStart('${t.id}', 'track')" 
                     onmouseup="handleLongPressEnd()"
                     ontouchstart="handleLongPressStart('${t.id}', 'track')" 
                     ontouchend="handleLongPressEnd()"
                     style="display: flex; align-items: center; cursor: pointer; padding: 12px; border-radius: 16px; background: rgba(255,255,255,0.03); margin-bottom: 10px;">
                    
                    <img src="${art}" style="width: 55px; height: 55px; border-radius: 12px; margin-right: 15px; object-fit: cover; box-shadow: 0 4px 12px rgba(0,0,0,0.4);">
                    
                    <div style="flex: 1;">
                        <div style="font-weight: 800; font-size: 17px;">${t.title}</div>
                        <div style="font-size: 13px; color: var(--text-dim);">${window.ARTISTS[alb?.artist_id]?.name || 'Artist'}</div>
                    </div>
                    
                    <span class="material-icons" style="color: ${isLiked ? 'var(--accent-green)' : 'rgba(255,255,255,0.1)'}; font-size: 22px;">
                        ${isLiked ? 'check_circle' : 'radio_button_unchecked'}
                    </span>
                </div>`;
            }).join('') : `
                <div style="text-align:center; margin-top:100px; opacity: 0.3;">
                    <span class="material-icons" style="font-size: 60px;">library_music</span>
                    <p style="margin-top: 15px; font-weight: 600;">${activeTab === 'liked' ? 'No liked songs yet.' : 'Your history is empty.'}</p>
                </div>
            `}
        </div>
    </div>`;
    
    contentView.innerHTML = html;
};

// Variable to hold the timer state
let pressTimer;

window.handleLongPressStart = (id, type = 'album') => {
    // Clear any existing timer just in case
    clearTimeout(pressTimer);

    pressTimer = setTimeout(() => {
        if (type === 'track') {
            // Logic for a single track (from Library/Recent)
            STORAGE.toggleLike(id);
            if (navigator.vibrate) navigator.vibrate(40);
            
            // Refresh the library view if that's where we are
            if (window.currentViewId === 'library') {
                viewLibrary(window.lastActiveTab || 'liked');
            }
        } else {
            // Logic for an entire album
            bulkLikeAlbum(id);
            if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
        }
    }, 800); // 800ms is the standard "long press" duration
};

window.handleLongPressEnd = () => {
    // If the user lets go before 800ms, the timer is cancelled
    clearTimeout(pressTimer);
};

// Attach scroll listener to the ONLY scrollable container
contentView.addEventListener('scroll', () => {
    // LOCK: If we are on an album or artist page, keep the UI hidden regardless of scroll
    if (window.currentViewId === 'album' || window.currentViewId === 'artist') {
        toggleNavUI(false);
        return;
    }

    let scrollTop = contentView.scrollTop;
    if (scrollTop > 100) {
        if (scrollTop > lastScrollTop) {
            toggleNavUI(false); // Hide on Scroll Down
        } else {
            toggleNavUI(true);  // Show on Scroll Up
        }
    } else {
        toggleNavUI(true); // Always show at top of main pages
    }
    lastScrollTop = scrollTop <= 0 ? 0 : scrollTop; 
}, { passive: true });

        init();
    </script>
</body>
</html>