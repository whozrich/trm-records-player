<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TRM MUSIC PLAYER - MOBILE</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
:root {
    --bg-black: #000000;
    --ios-glass: rgba(20, 20, 20, 0.75);
--ios-blur: blur(15px) saturate(160%); /* Reduced blur depth for performance */
    --ios-border: 0.5px solid rgba(255, 255, 255, 0.15);
--accent-green: #00ff88;
    --text-main: #ffffff;
    --text-dim: rgba(255, 255, 255, 0.5);
    --squircle: 22%;
    --safe-pad: 24px;
}

body, html {
    margin: 0; padding: 0;
    background-color: var(--bg-black);
    color: var(--text-main);
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
    height: 100%; width: 100%; overflow: hidden;
}

#content-view { 
    height: 100%; width: 100%;
    overflow-y: auto; overflow-x: hidden;
    padding-bottom: 220px;
    -webkit-overflow-scrolling: touch; 
    scroll-behavior: smooth;
    touch-action: pan-y;
    overscroll-behavior-x: none;
}

#toast-container {
    position: fixed;
    bottom: 120px;
    left: 50%;
    transform: translateX(-50%);
    background: #1ed760;
    color: black;
    padding: 12px 24px;
    border-radius: 50px;
    font-weight: 800;
    font-size: 14px;
    z-index: 10000;
    display: flex;
    align-items: center;
    gap: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    animation: toastIn 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
}

@keyframes toastIn {
    from { bottom: 80px; opacity: 0; }
    to { bottom: 120px; opacity: 1; }
}

#content-view::-webkit-scrollbar {
    width: 0px; /* Most mobile apps hide the bar entirely for that clean look */
    background: transparent;
}

.standard-padding { 
    padding-left: var(--safe-pad); 
    padding-right: var(--safe-pad);
    padding-top: 20px;
}

.mobile-home-grid { 
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    gap: 16px; 
    padding: 0 var(--safe-pad); 
}

/* --- THE FLOATING NAV ISLAND --- */
.bottom-nav {
    position: fixed; 
    bottom: 30px; 
    /* Use left/right instead of left/transform for better stability on mobile */
    left: 24px;
    right: 24px;
    width: auto; /* Let left/right define the width */
    max-width: 400px; 
    margin: 0 auto; /* Centers the max-width container */
    height: 68px;
    background: var(--ios-glass);
    -webkit-backdrop-filter: var(--ios-blur);
    backdrop-filter: var(--ios-blur);
    display: flex;
    justify-content: space-around; 
    align-items: center;
    border: var(--ios-border);
    border-radius: 40px; 
    z-index: 998; /* Keep below mini-player */
    box-shadow: 0 20px 40px rgba(0,0,0,0.5);
    transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1), opacity 0.3s ease;
}

#mSearch {
    width: 100%;
    padding: 14px 16px;
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 14px;
    color: white;
    font-size: 16px;
    outline: none;
    transition: all 0.3s ease;
    box-sizing: border-box;
}

#mSearch:focus {
    background: rgba(255, 255, 255, 0.12);
    border-color: var(--accent-green);
    box-shadow: 0 0 15px rgba(0, 255, 136, 0.2);
}

.search-section-label {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text-dim);
    margin: 25px 0 15px 0;
    font-weight: 800;
}

.result-item {
    display: flex;
    align-items: center;
    padding: 10px;
    margin: 0 -10px; /* Offset padding for tap effect */
    border-radius: 12px;
    transition: background 0.2s;
}

.result-item:active {
    background: rgba(255, 255, 255, 0.1);
}

.nav-item { 
    color: var(--text-dim); 
    transition: 0.3s; 
    flex: 1; 
    text-align: center; 
    font-size: 9px; /* Slightly smaller for 4 items */
    font-weight: 600;
    min-width: 0; /* Prevents flex items from overflowing */
    white-space: nowrap;
}
.nav-item.active { color: white; transform: translateY(-2px); }
.nav-item .material-icons { display: block; font-size: 24px; margin-bottom: 2px; }

.accent-glow, #fp-artist, .play-indicator {
    color: var(--accent-green) !important;
    text-shadow: 0 0 15px rgba(0, 255, 136, 0.6);
}

/* --- THE MINI PLAYER (FLOATING CARD) --- */
#mini-player {
    position: fixed; 
    /* Default position (Upward, when nav is visible) */
    bottom: 110px; 
    left: var(--safe-pad); 
    right: var(--safe-pad);
    background: var(--ios-glass);
    -webkit-backdrop-filter: var(--ios-blur);
    backdrop-filter: var(--ios-blur);
    border: var(--ios-border);
    border-radius: 24px;
    z-index: 1000; /* Priority layer */
    display: none; 
    flex-direction: column;
overflow: hidden; /* This is necessary for the squircle shape */

    /* Hardware Acceleration to stop the iPhone lag */
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
    will-change: bottom, transform;

    transition: 
        transform 0.5s cubic-bezier(0.19, 1, 0.22, 1), 
        bottom 0.5s cubic-bezier(0.19, 1, 0.22, 1), 
        opacity 0.4s ease;
        
}

#mini-player, .bottom-nav {
    /* Force GPU rendering */
    -webkit-transform: translateZ(0);
    transform: translateZ(0); 
    /* Add this to prevent 'paint flashing' during animations */
    will-change: transform, bottom;
}

.no-transition {
    transition: none !important;
}

#mini-player.nav-is-hidden { 
    bottom: 30px !important; 
}
#mini-player.nav-visible {
    bottom: 110px; /* 30px (base) + 68px (nav height) + 12px (gap) */
}

.nav-hidden {
    transform: translateY(150px) !important;
    opacity: 0;
}

.mini-hidden {
    opacity: 0 !important;
    transform: translateY(200px) !important;
}

.mini-active {
    display: flex !important;
    opacity: 1 !important;
    animation: ios-pop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes ios-pop {
    0% { transform: scale(0.9) translateY(20px); opacity: 0; }
    100% { transform: scale(1) translateY(0); opacity: 1; }
}

#m-art {
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.paused #m-art {
    transform: scale(0.85);
    filter: grayscale(0.5);
}

.mini-main { display: flex; align-items: center; padding: 10px 15px; }
#mini-player img { width: 45px; height: 45px; border-radius: 8px; margin-right: 12px; }

/* --- FULL SCREEN PLAYER (MODAL) --- */
#full-player {
    display: flex; /* Always flex, control visibility with transform */
    visibility: hidden;
    pointer-events: none;
    transform: translate3d(0, 100%, 0);
    transition: transform 0.4s cubic-bezier(0.15, 0, 0.2, 1), visibility 0s 0.4s;
}

#full-player.active {
    visibility: visible;
    pointer-events: auto;
    transform: translate3d(0, 0, 0);
    transition: transform 0.4s cubic-bezier(0.15, 0, 0.2, 1);
}

/* --- THE DYNAMIC GLOW BACKGROUND --- */
.bg-glow {
    display: none; /* Turn this off if the full player is still stuttering */
}

/* --- CATALOGUE GRID --- */
.mobile-home-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 0 20px; }
.track-tile { border-radius: var(--squircle); overflow: hidden; background: transparent; }
.track-tile img { 
    width: 100%; aspect-ratio: 1; object-fit: cover; 
    border-radius: var(--squircle);
    box-shadow: 0 10px 20px rgba(0,0,0,0.3);
}
.tile-content { padding: 10px 5px; }

/* --- PROGRESS BAR (SLEEK) --- */
.progress-container {
    width: 100%;
    height: 6px !important; /* Force a visible thickness */
    background: rgba(255, 255, 255, 0.15) !important;
    position: absolute;
    bottom: 0; /* Pins it to the bottom */
    left: 0;
    z-index: 20; /* Ensure it sits on top of everything else */
}

.progress-fill {
    height: 100%;
    width: 0%; /* JS will update this */
    background: var(--accent-green) !important;
    box-shadow: 0 -2px 10px var(--accent-green); /* Glow points UP into the player */
    transition: width 0.1s linear;
    border-radius: 0 2px 2px 0;
}

/* Full player version - needs to be thicker and centered */
#full-player .progress-container {
    position: relative; /* Not pinned to bottom */
    margin: 20px 0;
    height: 4px;
    border-radius: 10px;
}

#mini-player .progress-container {
    bottom: 0;
    border-radius: 0 0 24px 24px; /* Matches the mini-player's bottom corners */
}

.material-icons.glow-green {
    color: var(--accent-green) !important;
    filter: drop-shadow(0 0 8px rgba(0, 255, 136, 0.8));
}

#mini-player, #full-player, .bottom-nav, .fp-art {
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    perspective: 1000;
    transform: translate3d(0,0,0); /* Forces Hardware Acceleration */
    will-change: transform, opacity;
}

.material-icons { font-family: 'Material Icons'; font-weight: normal; font-style: normal; display: inline-block; line-height: 1; text-transform: none; letter-spacing: normal; word-wrap: normal; white-space: nowrap; direction: ltr; -webkit-font-smoothing: antialiased; }
        .material-icons:active {
            transform: scale(0.85);
            filter: brightness(1.5);
        }

        /* --- FEATURED BANNER --- */
        .featured-banner {
            position: relative; height: 220px; margin: 15px; border-radius: 12px;
            overflow: hidden; display: flex; align-items: flex-end; padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); background: #111;
        }
        .featured-banner img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; filter: brightness(0.7); }
        .featured-content { position: relative; z-index: 2; }

        /* --- HOME GRID --- */
        .mobile-home-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .track-tile { background: var(--card-grey); border-radius: 8px; overflow: hidden; position: relative; }
        .track-tile img { width: 100%; aspect-ratio: 1; object-fit: cover; }
        .tile-content { padding: 10px; }
        .tile-title { display: block; font-weight: bold; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tile-label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; }

        /* --- PROGRESS BARS --- */
        .progress-container { width: 100%; height: 4px; background: #444; border-radius: 2px; position: relative; cursor: pointer; }
        .progress-fill { height: 100%; background: var(--accent-green); width: 0%; border-radius: 2px; box-shadow: 0 0 10px var(--accent-green); }

        /* --- NAVIGATION --- */
        .nav-item { color: var(--text-dim); text-align: center; font-size: 10px; cursor: pointer; flex: 1; transition: 0.2s; }
        .nav-item.active { color: white; text-shadow: var(--glow); }
        .nav-item .material-icons { display: block; font-size: 28px; margin-bottom: 2px; }

        /* --- FULL SCREEN PLAYER --- */
        #full-player {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, #333, #000);
            z-index: 2000; display: none; flex-direction: column;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.1, 0.7, 0.1, 1);
        }
        #full-player.active { display: flex; transform: translateY(0); }
        .fp-header { padding: 40px 20px 20px; display: flex; justify-content: space-between; align-items: center; }
        .fp-art { width: 85%; aspect-ratio: 1; margin: 20px auto; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .fp-meta { padding: 20px 30px; }
        #fp-artist { 
            color: var(--accent-green); 
            margin: 5px 0; 
            font-size: 18px; 
            text-shadow: 0 0 10px rgba(29, 185, 84, 0.5);
            cursor: pointer;
            display: inline-block;
        }

        #fp-progress {
    background: #ffffff !important;
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.6);
}

/* --- Default State (Not Playing) --- */
.track-row .track-title { color: white; }
.track-row .track-number { color: rgba(255,255,255,0.2); }
.track-row .track-artist { color: rgba(255,255,255,0.4); }
.track-row .track-duration { color: rgba(255,255,255,0.4); }

/* --- Active State (Now Playing) --- */

/* 1. Title, Number, and Duration go Full Accent Green */
.active-track .track-title,
.active-track .track-number,
.active-track .track-duration {
    color: var(--accent-green) !important;
}

/* 2. Artist gets the Tinted Green (Opacity 0.6) */
.active-track .track-artist {
    color: var(--accent-green) !important;
    opacity: 0.6 !important;
}

#fp-bg-visual {
    position: absolute;
    inset: 0;
    z-index: -2;
    background-size: cover;
    background-position: center;
    /* Use a simple overlay instead of a heavy blur if lag persists */
    filter: blur(40px) brightness(0.4); 
    opacity: 0.5;
    transition: background-image 0.5s ease;
}
        
        .fp-controls { display: flex; justify-content: space-around; align-items: center; padding: 20px; margin-top: auto; padding-bottom: 60px; }
        .play-btn-lg { background: white; color: black; border-radius: 50%; width: 75px; height: 75px; display: flex; align-items: center; justify-content: center; }
        .play-btn-lg:active { transform: scale(0.9); }

        .back-btn {
    width: 42px;
    height: 42px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.back-btn:active {
    transform: scale(0.9);
    background: rgba(255, 255, 255, 0.2);
}

        /* --- TABS --- */
        .lib-tabs { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid #222; }
        .tab { padding: 10px 0; color: var(--text-dim); cursor: pointer; font-weight: bold; }
        .tab.active { color: var(--accent-green); border-bottom: 2px solid var(--accent-green); }

        .glow-active { color: var(--accent-green) !important; filter: drop-shadow(0 0 8px var(--accent-green)) !important; }

        glow-active {
    color: var(--accent-green) !important;
    filter: drop-shadow(0 0 8px rgba(0, 255, 136, 0.8));
    transition: all 0.3s ease;
}
        .track-row.disabled { opacity: 0.3; pointer-events: none; }
        .view-animate { animation: fadeIn 0.3s ease-out; }

        /* The TRM Green Color Variable */
:root {
    --trm-green: #1DB954;
}

        /* Library Tab Container */
.library-tabs {
    display: flex;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 14px;
    padding: 4px;
    margin-bottom: 25px;
    border: var(--ios-border);
    position: relative;
}

.lib-tab {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px 0;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-dim);
    z-index: 2;
    transition: color 0.3s ease;
    cursor: pointer;
}

.lib-tab.active {
    color: #fff;
}

/* The Sliding Glow Indicator */
.tab-glow {
    position: absolute;
    height: calc(100% - 8px);
    width: calc(50% - 4px); /* Assuming 2 tabs */
    background: rgba(255, 255, 255, 0.15);
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
    border-radius: 11px;
    top: 4px;
    left: 4px;
    transition: transform 0.4s cubic-bezier(0.33, 1, 0.68, 1);
    z-index: 1;
}

.tab-2-active .tab-glow {
    transform: translateX(100%);
}

/* Track Art for Library Rows */
.lib-track-art {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    margin-right: 15px;
    object-fit: cover;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="content-view">
    <div style="padding: 100px 20px; text-align: center; color: var(--text-dim);">Loading TRM...</div>
</div>

<div id="mini-player" onclick="openFullPlayer()">
    <div class="mini-main">
        <img id="m-art" src="">
        <div style="flex:1; overflow:hidden;">
            <div id="m-title" style="font-weight:bold; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div>
            <div id="m-artist" style="font-size:12px; color:var(--text-dim);"></div>
        </div>
        <span class="material-icons" id="m-play-btn" onclick="event.stopPropagation(); togglePlay();" style="font-size:35px; padding:5px;">play_arrow</span>
    </div>
    <div class="progress-container" onclick="event.stopPropagation(); seek(event, this)">
        <div id="mini-progress" class="progress-fill"></div>
    </div>
</div>

<div id="full-player" style="display:none; flex-direction:column; background:#000; height:100vh; width:100vw; position:fixed; top:0; left:0; z-index:9999; overflow:hidden;">
    <div id="fp-bg-visual"></div>
    <div class="bg-glow" id="fp-glow"></div>

    <div class="fp-header" style="padding: 20px; display: flex; align-items: center; justify-content: space-between; z-index: 100;">
        <div class="back-btn" onclick="closeFullPlayer()">
            <span class="material-icons" style="font-size:32px; color: white;">expand_more</span>
        </div>
        <span style="font-size:10px; font-weight:800; letter-spacing:2px; opacity: 0.5; color: white;">NOW PLAYING</span>
        <span class="material-icons" id="fp-heart-icon" onclick="handleLikeClick()" style="font-size:26px; color: white;">favorite_border</span>
    </div>

    <div id="fp-scroll-container" style="flex: 1; overflow-y: auto; padding: 0 30px; scrollbar-width: none; z-index: 10;">
        <div style="padding: 5px 0; display: flex; justify-content: center;">
            <img id="fp-art" src="" style="width: 100%; aspect-ratio:1; object-fit: cover; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.6);">
        </div>

        <div class="fp-meta" style="margin: 20px 0;">
            <h1 id="fp-title" style="margin:0; font-size:28px; font-weight: 800; color: white; line-height: 1.1;"></h1>
            <p id="fp-artist" style="margin: 8px 0 0 0; font-size: 18px; font-weight: 500; color: var(--accent-green);"></p>
        </div>

        <div id="fp-lyrics-wrapper" onclick="openLyricsTab()" style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 40px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="font-size: 10px; font-weight: 900; color: rgba(255,255,255,0.4); letter-spacing: 1px;">LYRICS</div>
                    <div id="genius-badge-cont"></div> 
                </div>
                <div style="font-size: 10px; font-weight: 900; color: rgba(255,255,255,0.4); letter-spacing: 1px;">TAP TO EXPAND</div>
            </div>
            <div id="fp-lyrics-text" style="font-size: 20px; font-weight: 700; color: white; white-space: pre-wrap; line-height: 1.4; max-height: 150px; overflow: hidden;"></div>
        </div>
    </div> <div id="lyrics-tab" style="display:none; position:absolute; inset:0; z-index:200; background: rgba(0,0,0,0.95); backdrop-filter: blur(40px); flex-direction: column; padding: 60px 40px;">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h2 style="color: white; margin:0; font-weight: 900;">Lyrics</h2>
            <span class="material-icons" onclick="closeLyricsTab()" style="font-size: 32px; color: white; cursor: pointer;">close</span>
        </div>
        <div id="fp-lyrics-full" style="flex: 1; overflow-y: auto; font-size: 26px; font-weight: 900; line-height: 1.5; color: white; white-space: pre-wrap; padding-bottom: 100px;"></div>
    </div>

    <div id="fp-bottom-controls" style="padding: 20px 40px 60px 40px; background: linear-gradient(to top, #000 90%, transparent); z-index: 150;">
        <div class="progress-container" onclick="seek(event, this)" style="height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px;">
            <div id="fp-progress" class="progress-fill" style="background: #fff; box-shadow: 0 0 15px rgba(255,255,255,0.6);"></div>
        </div>
        <div style="display: flex; justify-content: space-between; font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.4); margin-top: 12px;">
            <span id="time-cur">0:00</span>
            <span id="time-dur">0:00</span>
        </div>

        <div class="fp-controls" style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px;">
            <span class="material-icons" id="ctrl-shuffle" style="font-size:24px; color: white; opacity:0.6;" onclick="toggleShuffle()">shuffle</span>
            <span class="material-icons" style="font-size:48px; color: white;" onclick="prevTrack()">skip_previous</span>
            <div class="play-btn-lg" onclick="togglePlay()" style="background: white; color: black; width: 75px; height: 75px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(255,255,255,0.2);">
                <span class="material-icons" id="fp-play-btn" style="font-size:45px;">play_arrow</span>
            </div>
            <span class="material-icons" style="font-size:48px; color: white;" onclick="nextTrack()">skip_next</span>
            <span class="material-icons" id="ctrl-repeat" style="font-size:24px; color: white; opacity:0.6;" onclick="toggleLoop()">repeat</span>
        </div>
    </div>
</div> <div id="app-container">
    <nav class="bottom-nav">
        <div class="nav-item active" id="nav-home" onclick="window.viewHome()">
            <span class="material-icons">home</span>Home
        </div>
        <div class="nav-item" id="nav-search" onclick="window.viewSearch()">
            <span class="material-icons">search</span>Search
        </div>
        <div class="nav-item" id="nav-lib" onclick="window.viewLibrary()">
            <span class="material-icons">favorite</span>Library
        </div>
        <div class="nav-item" id="nav-patch" onclick="window.openPatchNotes()">
            <span class="material-icons">new_releases</span>Patch Notes
        </div>
        <div class="nav-item" id="nav-acc" onclick="window.viewAccount()">
            <span class="material-icons">person</span>Account
        </div>
    </nav>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
// 1. Initialize Client
const S_URL = 'https://sxagulxljpzftqfnllhv.supabase.co';
const S_KEY = 'sb_publishable_GG1VzWph8ZCK2hCyZugMfA_qR6LZcRn';
window.supabaseClient = supabase.createClient(S_URL, S_KEY);

// Ensure the global object exists immediately so fetchUserLikes doesn't crash
window.USER_LIKES = { songs: [] }; 
window.INIT_COMPLETE = false;

const getCV = () => document.getElementById('content-view') || document.getElementById('contentView');

// 2. DEFINE THIS IMMEDIATELY
window.fetchUserLikes = async function() {
    console.log("Fetching user data...");
    const client = window.supabaseClient;
    if (!client) return;

    // Ensure the object exists here as a second layer of defense
    if (!window.USER_LIKES) window.USER_LIKES = { songs: [] };

    try {
        const { data: { session } } = await client.auth.getSession();
        if (!session) return;

        const { data, error } = await client
            .from('users')
            .select('liked_songs')
            .eq('id', session.user.id)
            .single();

        if (error) throw error;

        // Success: Update the array
        window.USER_LIKES.songs = data?.liked_songs || [];
        console.log("Sync Complete:", window.USER_LIKES.songs.length, "songs found.");

    } catch (err) {
        console.warn("User data sync failed, proceeding with empty library:", err.message);
        // Safely reset to empty array
        window.USER_LIKES.songs = []; 
    } finally {
        // UI Refresh logic
        if (window.currentViewId === 'account' && window.viewAccount) window.viewAccount();
        if (window.currentViewId === 'library' && window.viewLibrary) window.viewLibrary();
        
        // Hide loader if the rest of the app is also ready
        const loader = document.getElementById('loading-screen');
        if (loader && window.INIT_COMPLETE) {
            loader.style.opacity = '0';
            setTimeout(() => loader.style.display = 'none', 300);
        }
    }
};

// Run this in your init() function
// Add this at the VERY top of your script
window.audio = new Audio();

async function init() {
    console.log("Starting TRM MUSIC PLAYER Initializing...");
    const loader = document.getElementById('loading-screen');

    try {
        // Core Data Fetch
        const [
            { data: artists },
            { data: albumsData },
            { data: tracksData },
            { data: spotlightRows },
            { data: videosData }
        ] = await Promise.all([
            supabaseClient.from('artists').select('*'),
            supabaseClient.from('albums').select('*'),
            supabaseClient.from('tracks').select('*'),
            supabaseClient.from('spotlight').select('*').eq('active', true).limit(5),
            supabaseClient.from('videos').select('*') 
        ]);

        // 1. Setup Artists
        window.ARTISTS = {};
        artists?.forEach(a => window.ARTISTS[a.id] = a);

        // 2. Setup Spotlights
        window.SPOTLIGHTS = (spotlightRows || []).map(row => ({
            type: row.type, 
            orderId: row.id, 
            targetId: row.target_id, 
            url: row.url,
            customTitle: row.custom_title, 
            customSub: row.custom_sub
        }));

        // 3. Setup Albums (Corrected Parentheses for .map and .sort)
        window.ALBUMS = (albumsData || [])
            .map(alb => ({
                ...alb,
                coming_soon: typeof window.isAlbumComingSoon === 'function' ? window.isAlbumComingSoon(alb) : alb.coming_soon
            }))
            .sort((a, b) => (Date.parse(b.full_release_date) || 0) - (Date.parse(a.full_release_date) || 0));

// 4. Setup Tracks & Track Lookup
        const trackLookup = {};
        tracksData?.forEach(t => { trackLookup[t.id] = t; });
        videosData?.forEach(v => { trackLookup[v.id] = { ...v, isVideo: true, videoUrl: v.url }; });

        // This is what the UI is looking for!
        window.TRACKS = trackLookup; 

        // If you need the album-specific arrays for something else, 
        // store them in a different variable, like window.ALBUM_TRACKS
        window.ALBUM_TRACKS = {};
        window.ALBUMS.forEach(alb => {
            const manualOrder = alb.track_ids || []; 
            window.ALBUM_TRACKS[alb.id] = manualOrder.map(id => trackLookup[id]).filter(Boolean); 
        });

        // 5. User Sync
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) {
            const { data: userData } = await supabaseClient
                .from('users')
                .select('liked_songs')
                .eq('id', session.user.id)
                .single();
            window.USER_LIKES = { songs: userData?.liked_songs || [] };
        } else {
            window.USER_LIKES = { songs: [] };
        }

    } catch (err) { 
        console.error("Init Error:", err);
    } finally {
        window.INIT_COMPLETE = true;
        setTimeout(() => {
            if (typeof window.viewHome === 'function') {
                window.viewHome();
            }
            if (loader) {
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 300);
            }
            console.log("TRM MUSIC PLAYER finished loading.");
        }, 100);
    }
}

window.parseLyrics = (lyricsRaw) => {
    if (!lyricsRaw) return { html: "(No lyrics available)", hasGenius: false };

    const geniusMatch = lyricsRaw.match(/genius_(https?:\/\/[^\s\n]+)/i);

    if (geniusMatch) {
        const geniusUrl = geniusMatch[1];
        const cleanLyrics = lyricsRaw.replace(geniusMatch[0], '').trim();

        // We return an object now so the UI knows where to put the link
        const badgeHTML = `
            <div onclick="window.open('${geniusUrl}', '_blank'); event.stopPropagation();" 
                 style="display: flex; align-items: center; gap: 5px; background: rgba(255,255,100,0.1); padding: 4px 8px; border-radius: 6px; cursor: pointer; border: 1px solid rgba(255,255,100,0.2);">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/5b/Genius_logo_2014.svg" style="width: 12px; height: 12px;">
                <span style="color: #ffff64; font-size: 9px; font-weight: 900; letter-spacing: 0.5px;">GENIUS</span>
            </div>
        `;

        return { html: cleanLyrics, badge: badgeHTML };
    }

    return { html: lyricsRaw, badge: null };
};

window.viewHome = function() {
window.currentViewId = 'home';
    if (typeof window.updateNavUI === 'function') window.updateNavUI('nav-home');
    if (typeof resetScroll === 'function') resetScroll();
    if (typeof setNav === 'function') setNav(0);

    // 1. DATA PREP with Auto-Release Patch
    const publicCatalogue = (window.ALBUMS || []).filter(alb => !alb.hidden).map(alb => {
        // Force coming_soon to false if the release date has passed
        const isActuallyComingSoon = window.isAlbumComingSoon ? window.isAlbumComingSoon(alb) : alb.coming_soon;
        return {
            ...alb,
            coming_soon: isActuallyComingSoon
        };
    });

    // Numerical Sort: 1 is first, 2 is second.
    const spotlights = (window.SPOTLIGHTS || []).sort((a, b) => Number(a.orderId) - Number(b.orderId));
    
    const target = document.getElementById('content-view') || document.getElementById('contentView');
    if (!target) return;

    // 2. DYNAMIC RENDERER
const renderMobileSlide = (index) => {
    const s = spotlights[index];
    if (!s) return '';

    let displayImg = "";
    let displayTitle = s.customTitle || "";
    let tagText = "FEATURED";
    let action = "";

    if (s.type === "Release") {
        const alb = publicCatalogue.find(a => a.id === s.targetId);
        if (alb) {
            displayImg = alb.art_url;
            displayTitle = s.customTitle || alb.name;
            tagText = alb.coming_soon ? "COMING SOON" : "RELEASE";
            action = `viewAlbum('${s.targetId}')`;
        }
    } 
else if (s.type === "Artist") {
        let art = null;
        if (window.ARTISTS) {
            // 1. Try direct lookup first
            art = window.ARTISTS[s.targetId];

            // 2. Flexible lookup if direct hit fails (ignores hyphens/case)
            if (!art) {
                const cleanTarget = String(s.targetId).replace(/-/g, '').toLowerCase();
                art = Object.values(window.ARTISTS).find(a => 
                    String(a.id).replace(/-/g, '').toLowerCase() === cleanTarget
                );
            }
        }

        displayImg = art ? (art.banner_url || art.img_url) : ""; 
        displayTitle = s.customTitle || (art ? art.name : "Artist");
        tagText = "ARTIST SPOTLIGHT";
        // Use the found artist ID if available, otherwise fallback to the targetId
        action = `viewArtist('${art ? art.id : s.targetId}')`;
    }
    else if (s.type === "Track") {
        // 1. Get the track directly from the dictionary
        const trackData = window.TRACKS ? window.TRACKS[s.targetId] : null;

        if (trackData) {
            // 2. Find the correct album using the track's album_id string
            const parentIds = trackData.album_id ? trackData.album_id.split(',').map(id => id.trim()) : [];
            
            // Look for a public album first
            const parentAlbums = publicCatalogue.filter(a => parentIds.includes(a.id));
            const publicOnly = parentAlbums.filter(a => !a.coming_soon);
            
            const latestAlb = (publicOnly.length > 0) ? publicOnly[0] : parentAlbums[0];

            if (latestAlb) {
                displayImg = trackData.art_url || latestAlb.art_url;
                displayTitle = s.customTitle || trackData.title;
                tagText = "TRACK HIGHLIGHT"; 
                // Pass the album ID so playTrack knows which art context to use
                action = `viewAlbum('${latestAlb.id}'); setTimeout(() => { if(window.playTrack) window.playTrack('${s.targetId}', true, '${latestAlb.id}'); }, 500);`;
            }
        }
    } 
    else if (s.type === "Video") {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = s.url ? s.url.match(regExp) : null;
        const vidId = (match && match[2].length == 11) ? match[2] : null;
        displayImg = vidId ? `https://img.youtube.com/vi/${vidId}/maxresdefault.jpg` : "";
        tagText = "FEATURED VIDEO";
        action = `window.open('${s.url}', '_blank')`;
    }

    // Final fallback
    if (!displayImg && publicCatalogue[0]) displayImg = publicCatalogue[0].art_url;

    return `
    <div class="mobile-spotlight-card spotlight-anim" onclick="${action}">
        <div class="mobile-spotlight-bg" style="background-image: url('${displayImg}')"></div>
        <div class="mobile-spotlight-content">
            <span class="mobile-tag">${tagText}</span>
            <h1 class="mobile-title">${displayTitle.toUpperCase()}</h1>
            ${spotlights.length > 1 ? `
            <div class="mobile-pill-container">
                ${spotlights.map((_, i) => `
                    <div class="mobile-pill ${i === index ? 'active' : ''}"></div>
                `).join('')}
            </div>` : ''}
        </div>
    </div>`;
};

    // 2. NAVIGATION
    window.moveSpotlight = (dir) => {
        if (!spotlights.length) return;
        window.currentSpotlightIndex = ((window.currentSpotlightIndex || 0) + dir + spotlights.length) % spotlights.length;
        const slider = document.getElementById('spotlight-slider-inner');
        if (slider) {
            slider.innerHTML = renderMobileSlide(window.currentSpotlightIndex);
        }
    };

    // 3. INJECTION
    target.innerHTML = `
    <style>
        .spotlight-wrap { position: relative; margin: 15px; }
        .mobile-spotlight-card {
            position: relative; height: 260px; 
            border-radius: 16px; overflow: hidden; background: #000;
            display: flex; align-items: flex-end;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        .mobile-spotlight-bg {
            position: absolute; inset: 0; background-size: cover; background-position: center;
            filter: brightness(0.6); z-index: 1; transform: scale(1.05);
        }
        .mobile-spotlight-content { position: relative; z-index: 2; padding: 20px; width: 100%; }
        .mobile-tag { background: var(--accent-green); color: #000; font-size: 10px; font-weight: 900; padding: 4px 10px; border-radius: 4px; text-transform: uppercase; }
        .mobile-title { font-size: 32px; color: #fff; margin: 8px 0; font-weight: 900; letter-spacing: -1.2px; line-height: 0.85; }
        .mobile-pill-container { display: flex; gap: 5px; margin-top: 10px; }
        .mobile-pill { height: 4px; width: 12px; background: rgba(255,255,255,0.2); border-radius: 2px; transition: 0.3s; }
        .mobile-pill.active { width: 24px; background: var(--accent-green); }
        
        .m-nav {
            position: absolute; top: 50%; transform: translateY(-50%); z-index: 10;
            width: 32px; height: 32px; background: rgba(0,0,0,0.5); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: white;
            backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1);
        }
        .m-nav-prev { left: 10px; }
        .m-nav-next { right: 10px; }

        .spotlight-anim { animation: mSlideIn 0.3s ease-out; }
        @keyframes mSlideIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .mobile-home-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 0 15px 100px 15px; }
    </style>

    <div class="spotlight-wrap">
        ${spotlights.length > 1 ? `
            <div class="m-nav m-nav-prev" onclick="event.stopPropagation(); moveSpotlight(-1)"><span class="material-icons" style="font-size:18px;">chevron_left</span></div>
            <div class="m-nav m-nav-next" onclick="event.stopPropagation(); moveSpotlight(1)"><span class="material-icons" style="font-size:18px;">chevron_right</span></div>
        ` : ''}
        <div id="spotlight-slider-inner">
            ${renderMobileSlide(window.currentSpotlightIndex || 0)}
        </div>
    </div>

    <div style="padding: 10px 20px;">
        <h2 style="margin: 10px 0; font-weight: 900; font-size: 22px; letter-spacing: -0.5px; text-transform: uppercase;">Catalogue</h2>
    </div>
    
    <div class="mobile-home-grid">
        ${publicCatalogue.map(alb => {
            const releaseYear = alb.full_release_date ? String(alb.full_release_date).split(' ').pop() : '';
            const type = (alb.type || 'Release').toUpperCase();
            
            let statusHtml = "";
            if (alb.coming_soon) {
                statusHtml = `<span style="color:var(--accent-green);">COMING SOON</span>`;
            } else {
                statusHtml = releaseYear || 'RELEASE';
            }

            return `
                <div class="track-tile view-animate" onclick="viewAlbum('${alb.id}')">
                    <img src="${alb.art_url}" style="width:100%; aspect-ratio:1; border-radius:12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); ${alb.coming_soon ? 'opacity:0.4; filter:grayscale(1)' : ''}">
                    <div style="padding: 10px 2px;">
                        <div style="font-weight:800; color:#fff; font-size:14px; line-height:1.2; margin-bottom:4px; text-transform:uppercase;">${alb.name}</div>
                        <div style="color:#999; font-size:10px; font-weight:800; text-transform:uppercase; letter-spacing:0.5px;">
                            ${type} â€¢ ${statusHtml}
                        </div>
                    </div>
                </div>
            `;
        }).join('')}
    </div>`;

    // 4. TOUCH SWIPE (Enhanced)
    const wrap = document.querySelector('.spotlight-wrap');
    if (wrap) {
        let xDown = null;
        wrap.addEventListener('touchstart', e => xDown = e.touches[0].clientX, {passive: true});
        wrap.addEventListener('touchend', e => {
            if (!xDown) return;
            let xUp = e.changedTouches[0].clientX;
            if (xDown - xUp > 60) window.moveSpotlight(1);
            if (xDown - xUp < -60) window.moveSpotlight(-1);
            xDown = null;
        }, {passive: true});
    }

    if (window.spotlightInterval) clearInterval(window.spotlightInterval);
    if (spotlights.length > 1) {
        window.spotlightInterval = setInterval(() => window.moveSpotlight(1), 7000);
    }
};

// Update this within your existing player update loop or openFullPlayer
window.updateFullPlayerUI = function(track) {
    document.getElementById('fp-art').src = track.art_url;
    document.getElementById('fp-title').innerText = track.title;
    document.getElementById('fp-artist').innerText = track.artist;
    
    const lyrics = track.lyrics || "No lyrics available.";
    document.getElementById('fp-lyrics-snippet').innerText = lyrics;
    document.getElementById('fp-lyrics-full').innerText = lyrics;
};

window.toggleNavUI = (show) => {
    const navBar = document.querySelector('.bottom-nav');
    const miniPlayer = document.getElementById('mini-player');

    if (show) {
        navBar.classList.remove('nav-hidden');
        // If nav shows, move miniplayer UP
        miniPlayer.classList.remove('nav-is-hidden');
    } else {
        navBar.classList.add('nav-hidden');
        // If nav hides, move miniplayer DOWN
        miniPlayer.classList.add('nav-is-hidden');
    }
};

window.updateNavUI = (activeId) => {
    const navIds = ['nav-home', 'nav-search', 'nav-lib', 'nav-patch', 'nav-acc']; 
    
    // Clear any search-specific layout shifts
    document.body.classList.remove('is-searching', 'search-mode'); 

    navIds.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        
        // Reset all positioning properties to ensure alignment
        el.style.marginTop = "0px";
        el.style.display = "flex";
        el.style.flexDirection = "column";
        el.style.alignItems = "center";
        el.style.justifyContent = "center";

        if (id === activeId) {
            el.style.color = '#00ff88'; 
            el.style.opacity = '1';
            // Increase weight instead of scale to keep dimensions stable
            el.style.fontWeight = "900"; 
            // If you still want a scale, keep it tiny so it doesn't push the box
            el.style.transform = 'scale(1.05)'; 
        } else {
            el.style.color = 'white';
            el.style.opacity = '0.5';
            el.style.fontWeight = "normal";
            el.style.transform = 'scale(1)';
        }
    });
};

window.viewAccount = async function() {
    window.currentViewId = 'account';
    if (typeof window.updateNavUI === 'function') window.updateNavUI('nav-acc');
    
    const target = document.getElementById('content-view');
    const client = supabaseClient;
    const { data: { session } } = await client.auth.getSession();

if (typeof window.closeFullPlayer === 'function') {
        window.closeFullPlayer();
    }

    if (typeof window.toggleNavUI === 'function') {
        window.toggleNavUI(true);
    }

    if (typeof window.updateNavUI === 'function') {
        window.updateNavUI('nav-acc');
    }
    
    // Reset scroll so the login page starts at the top
    target.scrollTo(0, 0);

    // 1. GUEST STATE
    if (!session) {
        target.innerHTML = `
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:80vh; padding:40px; text-align:center;">
                <div style="width:120px; height:120px; background:#111; border-radius:50%; display:flex; align-items:center; justify-content:center; margin-bottom:30px; border: 2px dashed #333;">
                    <span class="material-icons" style="font-size:60px; color:#333;">person_outline</span>
                </div>
                <h1 style="color:white; font-weight:900; margin-bottom:10px; font-size:32px; letter-spacing:-1px;">YOUR PROFILE</h1>
                <p style="color:#666; margin-bottom:40px; font-weight:600;">Sign in to sync your library across devices.</p>
                
                <div style="display:flex; flex-direction:column; gap:15px; width:100%; max-width:300px;">
                    <button onclick="window.openAuthModal('login')" style="background:white; color:black; border:none; padding:18px; border-radius:40px; font-weight:900; cursor:pointer;">LOG IN</button>
                    <button onclick="window.openAuthModal('signup')" style="background:transparent; color:white; border:2px solid #333; padding:18px; border-radius:40px; font-weight:900; cursor:pointer;">CREATE ACCOUNT</button>
                </div>
            </div>
        `;
        return;
    }

    // 2. AUTHENTICATED STATE
    // Fetch both display_name and username from the users table
    const { data: profile } = await client
        .from('users')
        .select('display_name, username')
        .eq('id', session.user.id)
        .single();

    // Fallbacks if fields are empty
    const finalDisplayName = profile?.display_name || session.user.email.split('@')[0];
    const finalUsername = profile?.username ? `@${profile.username}` : session.user.email;
    
    const likedCount = window.USER_LIKES?.songs?.length || 0;

    target.innerHTML = `
        <div style="padding:60px 20px; animation: fadeIn 0.3s ease; max-width: 600px; margin: 0 auto;">
            
            <div style="display:flex; flex-direction:column; align-items:center; margin-bottom:50px;">
                <div style="width:110px; height:110px; background:linear-gradient(135deg, #00ff88, #00bdff); border-radius:50%; display:flex; align-items:center; justify-content:center; margin-bottom:25px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); position:relative;">
                    <span class="material-icons" style="font-size:55px; color:black;">person</span>
                    <div style="position:absolute; bottom:0; right:5px; background:#00ff88; width:25px; height:25px; border-radius:50%; border:3px solid black; display:flex; align-items:center; justify-content:center;">
                        <span class="material-icons" style="font-size:12px; color:black; font-weight:900;">check</span>
                    </div>
                </div>
                <h1 style="color:white; font-weight:900; margin:0; font-size:36px; letter-spacing:-1px; text-transform: uppercase;">${finalDisplayName}</h1>
                <p style="color:#00ff88; font-weight:800; font-size:14px; margin-top:5px; letter-spacing:0.5px; opacity:0.8;">${finalUsername.toLowerCase()}</p>
            </div>

            <div style="background:#111; padding:25px; border-radius:24px; text-align:center; border:1px solid #222; margin-bottom:30px;">
                <div style="color:white; font-size:32px; font-weight:900;">${likedCount}</div>
                <div style="color:#444; font-size:11px; font-weight:900; letter-spacing:2px; margin-top:5px;">LIKED SONGS</div>
            </div>

            <div style="display:flex; flex-direction:column; gap:12px;">
                <div onclick="window.handleLogout()" style="display:flex; align-items:center; gap:20px; padding:22px; background:rgba(255,50,50,0.05); border:1px solid rgba(255,50,50,0.1); border-radius:20px; color:#ff4444; cursor:pointer; transition: transform 0.1s ease;" onmousedown="this.style.transform='scale(0.98)'" onmouseup="this.style.transform='scale(1)'">
                    <span class="material-icons" style="font-size:28px;">logout</span>
                    <span style="flex:1; font-weight:900; font-size:16px;">LOGOUT</span>
                </div>
            </div>

            <div style="margin-top:80px; text-align:center; opacity:0.2;">
                <p style="color:white; font-size:10px; font-weight:900; letter-spacing:3px;">TRM MUSIC PLAYER v1.5.0</p>
            </div>
        </div>
    `;
};

window.openAuthModal = function(mode = 'login') {
    if (document.getElementById('auth-modal-root')) return;

    window.isSignUpMode = (mode === 'signup');

    const root = document.createElement('div');
    root.id = 'auth-modal-root';
    Object.assign(root.style, {
        position: 'fixed',
        inset: '0',
        zIndex: '10000',
        background: '#000', // Solid black for mobile focus
        display: 'flex',
        flexDirection: 'column',
        fontFamily: 'sans-serif'
    });

    const updateModalContent = () => {
        const title = window.isSignUpMode ? "CREATE ACCOUNT" : "WELCOME BACK";
        const subtitle = window.isSignUpMode ? "Join the community today." : "Log in to your account to continue.";
        const submitText = window.isSignUpMode ? "GET STARTED" : "LOG IN";
        const toggleText = window.isSignUpMode ? "Already have an account?" : "Don't have an account?";
        const toggleLink = window.isSignUpMode ? "Login" : "Sign Up";

        root.innerHTML = `
            <div style="padding: 20px; display: flex; align-items: center; justify-content: space-between;">
                <button onclick="window.closeAuthModal()" style="background:none; border:none; color:white; padding:10px;">
                    <span class="material-icons" style="font-size:32px;">close</span>
                </button>
                <span style="font-size:10px; font-weight:900; letter-spacing:2px; color:#444;">TRM MUSIC PLAYER</span>
                <div style="width:52px;"></div> </div>

            <div style="flex:1; padding:40px 30px; display:flex; flex-direction:column; justify-content: center;">
                <h2 style="color:white; font-size:42px; font-weight:900; margin:0; letter-spacing:-2px; line-height:0.9;">${title}</h2>
                <p style="color: #666; font-size: 16px; margin: 15px 0 40px 0; font-weight: 500;">${subtitle}</p>
                
                <div id="auth-form" style="display:flex; flex-direction:column; gap:12px;">
                    ${window.isSignUpMode ? `
                        <input type="text" id="modal-auth-username" placeholder="Username" style="background:#111; border:1px solid #222; padding:20px; border-radius:16px; color:white; outline:none; font-size:16px;">
                        <input type="text" id="modal-auth-display-name" placeholder="Display Name" style="background:#111; border:1px solid #222; padding:20px; border-radius:16px; color:white; outline:none; font-size:16px;">
                    ` : ''}
                    <input type="email" id="modal-auth-email" placeholder="Email Address" style="background:#111; border:1px solid #222; padding:20px; border-radius:16px; color:white; outline:none; font-size:16px;">
                    <input type="password" id="modal-auth-password" placeholder="Password" style="background:#111; border:1px solid #222; padding:20px; border-radius:16px; color:white; outline:none; font-size:16px;">
                    
                    <button id="auth-submit-btn" onclick="window.handleAuthSubmit()" style="background:#00ff88; color:black; font-weight:900; padding:20px; border-radius:16px; border:none; cursor:pointer; margin-top:10px; font-size:16px; letter-spacing:1px;">
                        ${submitText}
                    </button>
                    
                    <div id="auth-notification" style="font-size: 13px; text-align: center; min-height: 20px; margin-top: 10px; font-weight: 700;"></div>
                </div>

                <p style="text-align:center; margin-top:auto; padding-bottom:40px; font-size:14px; color:#444;">
                    ${toggleText} <span onclick="window.toggleAuthMode()" style="color:#00ff88; cursor:pointer; font-weight:900; text-decoration: underline;">${toggleLink}</span>
                </p>
            </div>
        `;
    };

    window.toggleAuthMode = () => {
        window.isSignUpMode = !window.isSignUpMode;
        updateModalContent();
    };

    updateModalContent();
    document.body.appendChild(root);
};

window.closeAuthModal = () => {
    const root = document.getElementById('auth-modal-root');
    if (root) root.remove();
};

window.handleAuthSubmit = async () => {
    // Ensure we are using the correct variable name defined in your setup
    const client = window.supabaseClient;

    const notification = document.getElementById('auth-notification');
    const submitBtn = document.getElementById('auth-submit-btn');

    // 1. Safety Check: If the client didn't initialize, stop the crash
    if (!client) {
        console.error("Supabase client not found.");
        notification.innerHTML = "SYSTEM ERROR: CLIENT MISSING";
        notification.style.color = "#ff4444";
        return;
    }

    // 2. Mobile UX: Blur inputs to hide the keyboard
    const inputs = document.querySelectorAll('#auth-modal-root input');
    inputs.forEach(input => input.blur());

    const email = document.getElementById('modal-auth-email').value.trim();
    const password = document.getElementById('modal-auth-password').value;

    const showMsg = (text, isError = true) => {
        notification.innerHTML = text.toUpperCase(); 
        notification.style.color = isError ? "#ff4444" : "#00ff88";
        submitBtn.style.opacity = "1";
        submitBtn.disabled = false;
        submitBtn.innerText = window.isSignUpMode ? "GET STARTED" : "LOG IN";
    };

    if (!email || password.length < 6) return showMsg("Valid email and 6+ chars required.");

    // 3. Prevent Double Taps
    submitBtn.style.opacity = "0.5";
    submitBtn.innerText = "WAIT...";
    submitBtn.disabled = true;

    try {
        if (window.isSignUpMode) {
            const username = document.getElementById('modal-auth-username').value.trim();
            const displayName = document.getElementById('modal-auth-display-name').value.trim();

            const { error } = await client.auth.signUp({
                email, 
                password,
                options: { 
                    data: { 
                        username: username, 
                        display_name: displayName 
                    } 
                }
            });
            
            if (error) throw error;
            showMsg("Check your email for a link!", false);
        } else {
            // Login Logic
            const { error } = await client.auth.signInWithPassword({ 
                email, 
                password 
            });
            
            if (error) throw error;
            
            // 4. Cleanup and Refresh
            window.closeAuthModal();
            
            // Immediately refresh the Account view to show the new profile
            if (window.viewAccount) {
                await window.viewAccount();
            }
            
            window.showToast("Logged in successfully");
        }
    } catch (err) {
        showMsg(err.message);
    }
};

window.supabaseClient.auth.onAuthStateChange((event, session) => {
    console.log("Auth Event:", event);
    
    if (session?.user) {
        // DO NOT use 'await' here. Let it run in the background.
        if (typeof window.fetchUserLikes === 'function') {
            window.fetchUserLikes(); 
        }
    } else if (event === 'SIGNED_OUT') {
        window.USER_LIKES = { songs: [] };
        if (window.viewHome) window.viewHome();
    }
});

setTimeout(() => {
    const loader = document.getElementById('loading-screen');
    if (loader && loader.style.display !== 'none') {
        console.error("App stuck in loading state. Forcing UI...");
        loader.style.opacity = '0';
        setTimeout(() => {
            loader.style.display = 'none';
            // Try to render something so the screen isn't empty
            if (typeof window.viewHome === 'function') window.viewHome();
        }, 300);
    }
}, 4000);

window.handleLogout = async function() {
    const { error } = await supabaseClient.auth.signOut();
    if (error) {
        window.showToast("Error logging out", "info");
    } else {
        window.USER_LIKES = { songs: [] }; // Clear local state
        window.showToast("Logged out successfully");
        window.viewHome(); // Redirect to home
    }
};

window.viewArtist = (id) => {
window.currentViewId = 'artist';
    const target = document.getElementById('content-view') || document.getElementById('contentView');
    if (!target) return;

    if (typeof toggleNavUI === 'function') toggleNavUI(false); 
    target.scrollTo(0, 0);

    const artist = window.ARTISTS[id] || { 
        name: "therichmusic", 
        bio: "", 
        is_verified: false,
        banner_url: "",
        featured_video_url: "",
        socials: [] 
    };

    const artistAlbs = window.ALBUMS.filter(a => a.artist_id == id && !a.hidden);

    // --- 1. DESKTOP FEATURE: SOCIALS & VIDEO LOGIC ---
const socialConfig = [
    { name: 'YouTube',   match: 'youtube.com',   icon: 'fab fa-youtube',   color: '#FF0000' },
    { name: 'Instagram', match: 'instagram.com', icon: 'fab fa-instagram', color: '#E1306C' },
    { name: 'Twitter',   match: 'twitter.com',   icon: 'fab fa-x-twitter', color: '#ffffff' },
    { name: 'Twitter',   match: 'x.com',         icon: 'fab fa-x-twitter', color: '#ffffff' },
    { name: 'TikTok',    match: 'tiktok.com',    icon: 'fab fa-tiktok',    color: '#ffffff' } // TikTok usually looks best in white on dark themes
];

const renderSocials = () => {
    if (!Array.isArray(artist.socials)) return '';
    let count = 0;
    return artist.socials.map(url => {
        if (count >= 4) return '';
        const platform = socialConfig.find(c => url.toLowerCase().includes(c.match));
        if (platform) {
            count++;
            return `
                <a href="${url}" target="_blank" style="text-decoration:none; color:${platform.color}; background:rgba(255,255,255,0.08); width:42px; height:42px; border-radius:10px; display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,0.1);">
                    <i class="${platform.icon}" style="font-size:20px;"></i>
                </a>`;
        }
        return '';
    }).join('');
};

    const getEmbedUrl = (url) => {
        if(!url) return null;
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? `https://www.youtube-nocookie.com/embed/${match[2]}?rel=0` : null;
    };
const embedUrl = getEmbedUrl(artist.featured_video_url);
    const albums = artistAlbs.filter(a => ['ALBUM', 'MIXTAPE'].includes((a.type || '').toUpperCase()));
    const singles = artistAlbs.filter(a => ['SINGLE', 'EP'].includes((a.type || '').toUpperCase()));
    const compilations = artistAlbs.filter(a => (a.type || '').toUpperCase() === 'COMPILATION');

    const renderGrid = (list) => {
        if (list.length === 0) return '';
        return `
            <div class="mobile-home-grid" style="margin-bottom: 30px;">
                ${list.map(a => `
                    <div class="track-tile" onclick="viewAlbum('${a.id}')" style="background: rgba(255,255,255,0.03); border-radius: 12px; overflow: hidden; border: 1px solid rgba(255,255,255,0.05);">
                        <div style="position: relative; line-height:0;">
                            <img src="${a.art_url}" style="width:100%; aspect-ratio:1; border-radius: 12px; object-fit:cover;">
                            ${a.coming_soon ? `<div style="position:absolute; top:12px; right:12px; background:var(--accent-green); color:black; font-size:12px; font-weight:900; padding:8px 10px; border-radius:12px;">SOON</div>` : ''}
                        </div>
                        <div class="tile-content" style="padding: 10px;">
                            <span class="tile-title" style="font-weight:800; font-size:13px; display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${a.name.toUpperCase()}</span>
                            <span class="tile-label" style="font-size:10px; color:rgba(255,255,255,0.4); font-weight:700;">${a.full_release_date ? a.full_release_date.split(' ').pop() : (a.type || 'RELEASE')}</span>
                        </div>
                    </div>
                `).join('')}
            </div>`;
    };

    // --- 3. FINAL UI RENDER ---
    let html = `
    <div class="view-animate" style="padding-bottom: 120px;">
        <div style="height:420px; position:relative; overflow:hidden; display: flex; align-items: flex-end;">
            <img src="${artist.banner_url || ''}" style="position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover;">
            <div style="position:absolute; inset:0; background: linear-gradient(to top, var(--bg-black) 5%, rgba(0,0,0,0.4) 60%, transparent 100%);"></div>
            
            <div onclick="viewHome(); toggleNavUI(true);" 
                 style="position: fixed; left: 20px; top: 40px; width: 40px; height: 40px; background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 100; border: 1px solid rgba(255,255,255,0.1);">
                <span class="material-icons" style="color: white;">chevron_left</span>
            </div>

            <div style="position:relative; padding: 30px 20px; width: 100%;">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom: 10px;">
                    ${artist.is_verified ? '<span style="background:#3897f0; color:white; font-size:10px; font-weight:900; padding:4px 10px; border-radius:20px; display:flex; align-items:center; gap:4px;"><span class="material-icons" style="font-size:12px;">verified</span> VERIFIED</span>' : ''}
                </div>
                <h1 style="font-size:48px; margin:0; font-weight:900; letter-spacing:-2px; line-height:0.9; text-transform:uppercase; color:white;">${artist.name}</h1>
                <p style="color:rgba(255,255,255,0.7); margin:15px 0 20px; font-size:14px; line-height:1.5; font-weight:500; max-width:90%;">
                    ${artist.bio || 'Official TRM Records Artist.'}
                </p>
                
                <div style="display: flex; gap: 10px;">
                    ${renderSocials()}
                </div>
            </div>
        </div>

        <div class="standard-padding" style="margin-top: 30px;">
            
            ${albums.length > 0 ? `
                <h3 style="text-transform:uppercase; letter-spacing:1px; font-size:12px; margin-bottom:15px; color:var(--accent-green); font-weight:900;">Albums & Mixtapes</h3>
                ${renderGrid(albums)}
            ` : ''}

            ${singles.length > 0 ? `
                <h3 style="text-transform:uppercase; letter-spacing:1px; font-size:12px; margin-bottom:15px; color:var(--accent-green); font-weight:900;">Singles & EPs</h3>
                ${renderGrid(singles)}
            ` : ''}

            ${embedUrl ? `
                <div style="margin: 40px 0;">
                    <h3 style="text-transform:uppercase; letter-spacing:1px; font-size:12px; margin-bottom:15px; color:rgba(255,255,255,0.4); font-weight:900;">Featured Video</h3>
                    <div style="position: relative; width: 100%; padding-top: 56.25%; border-radius: 12px; overflow: hidden; background:#000; border: 1px solid rgba(255,255,255,0.1);">
                        <iframe style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" src="${embedUrl}" frameborder="0" allowfullscreen></iframe>
                    </div>
                </div>
            ` : ''}

            ${compilations.length > 0 ? `
                <h3 style="text-transform:uppercase; letter-spacing:1px; font-size:12px; margin-bottom:15px; color:var(--accent-green); font-weight:900;">Compilations</h3>
                ${renderGrid(compilations)}
            ` : ''}

        </div>
    </div>`;

target.innerHTML = html; // Use the 'target' variable here
};

// Listen for when a song finishes naturally
audio.onended = () => {
    // 1. Try to play the next track
    const hasNext = window.nextTrack();
    
    // 2. If nextTrack returns false, the album is over
    if (!hasNext) {
        console.log("Album finished. Resetting state...");
        
        // Reset Logic
        audio.currentTime = 0;
        window.isPlaying = false;
        
        // UI Reset: Mini Player & Full Player buttons
        ['m-play-btn', 'fp-play-btn'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.innerText = 'play_arrow';
        });

        // UI Reset: Mini Player "paused" state
        const miniPlayer = document.getElementById('mini-player');
        if (miniPlayer) miniPlayer.classList.add('paused');

        // UI Reset: Clear the active green highlight in the list
        if (window.currentViewId === 'album') {
            document.querySelectorAll('.track-row').forEach(row => {
                row.classList.remove('active-track');
                const icon = row.querySelector('.track-play-icon');
                if (icon) icon.innerText = 'play_arrow';
            });
        }
        
        // Optional: Close full player on finish
        // if (window.isFullPlayerOpen) window.toggleFullPlayer(false);
    }
};

window.openVideoPlayer = function(input) {
    if (!input) return;
    
    // Extract YouTube ID from URL
    let videoId = '';
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
    const match = String(input).match(regExp);
    videoId = (match && match[2].length === 11) ? match[2] : input;

    const modalId = 'mobile-video-modal';
    const existing = document.getElementById(modalId);
    if (existing) existing.remove();

    const modal = document.createElement('div');
    modal.id = modalId;
    Object.assign(modal.style, {
        position: 'fixed', inset: '0', backgroundColor: 'black',
        zIndex: '10000', display: 'flex', alignItems: 'center', justifyContent: 'center'
    });

    modal.innerHTML = `
        <div style="position: absolute; top: 40px; right: 20px; z-index: 10001;">
            <button onclick="document.getElementById('${modalId}').remove()" 
                    style="background:var(--accent-green); color:black; border:none; padding:10px 20px; border-radius:30px; font-weight:900; text-transform:uppercase; font-size:12px;">
                Close Video
            </button>
        </div>
        <div style="width: 100%; aspect-ratio: 16/9;">
            <iframe width="100%" height="100%" 
                src="https://www.youtube.com/embed/${videoId}?autoplay=1&modestbranding=1&rel=0" 
                frameborder="0" allow="autoplay; encrypted-media" allowfullscreen>
            </iframe>
        </div>
    `;
    document.body.appendChild(modal);
};

window.viewAlbum = function(id, scrollToTop = true) {
    const contentView = document.getElementById('content-view') || document.getElementById('contentView');
    if (!contentView) return;

    const alb = window.ALBUMS.find(a => a.id == id);
    if (!alb) return window.viewHome();
    
    window.currentViewId = 'album';
    window.viewingAlbumId = id;
    if (typeof toggleNavUI === 'function') toggleNavUI(false); 

    const artist = window.ARTISTS[alb.artist_id] || { name: "therichmusic", id: "" };
    
    // 1. Get ALL tracks + DISC headers from the album data
    const tks = (alb.track_ids || []).map(tid => {
        if (typeof tid === 'string' && tid.startsWith('DISC_')) return tid;
        return window.TRACKS[tid] || null;
    }).filter(item => item !== null);

    // 2. Runtime Calculation (Playable tracks only)
    let totalSeconds = 0;
    let playableCount = 0;
    tks.forEach(t => {
        if (typeof t === 'string' || !t.duration) return;
        const parentIds = t.album_id ? t.album_id.split(',').map(s => s.trim()) : [];
        const isReleasedElsewhere = parentIds.some(aid => {
            const other = window.ALBUMS.find(a => a.id === aid);
            return other && !other.coming_soon;
        });
        if (!alb.coming_soon || isReleasedElsewhere) {
            const parts = t.duration.split(':').map(Number);
            totalSeconds += (parts[0] * 60) + (parts[1] || 0);
            playableCount++;
        }
    });

    const runtimeDisplay = `${Math.floor(totalSeconds / 60)} MIN ${totalSeconds % 60} SEC`;
    const isThisAlbumActive = (window.currentAlbumId === id);
    const playIcon = (isThisAlbumActive && !audio.paused) ? 'pause' : 'play_arrow';

    let html = `
    <div class="${scrollToTop ? 'view-animate' : ''}" style="padding-bottom: 140px; color: white;">
        <div style="padding: 60px 20px 30px; text-align:center; position: relative;">
            <div onclick="viewHome(); toggleNavUI(true);" style="position: absolute; left: 20px; top: 40px; width: 42px; height: 42px; background: rgba(0,0,0,0.7); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.1); z-index:10;">
                <span class="material-icons">chevron_left</span>
            </div>

            <img src="${alb.art_url}" style="width:240px; aspect-ratio:1; border-radius: 20px; box-shadow: 0 25px 50px rgba(0,0,0,0.8);">
            
            <h1 style="margin: 35px 0 12px; font-size: 38px; font-weight: 900; text-transform: uppercase;">${alb.name}</h1>
            <p style="color:var(--accent-green); font-weight: 900; font-size: 19px;" onclick="viewArtist('${alb.artist_id}')">${artist.name}</p>
            
            <div style="display:flex; align-items:center; justify-content:center; gap:20px; margin: 25px 0;">
                <button onclick="window.playAlbum('${alb.id}')" style="background:white; border:none; width:68px; height:68px; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                    <span id="main-album-icon" class="material-icons" style="font-size:44px; color:black;">${playIcon}</span>
                </button>
                ${alb.trailer_url ? `<button onclick="window.openVideoPlayer('${alb.trailer_url}')" style="background:#ff0000; border:none; color:white; width:54px; height:54px; border-radius:50%; display:flex; align-items:center; justify-content:center;"><span class="material-icons" style="font-size:30px;">smart_display</span></button>` : ''}
            </div>
            
            <div style="font-size: 11px; font-weight: 800; color: rgba(255,255,255,0.4); text-transform: uppercase;">
                ${playableCount} SONGS â€¢ ${runtimeDisplay} â€¢ ${alb.full_release_date || ''}
            </div>
        </div>

        <div style="padding: 0 20px;">`;

    let discTrackCounter = 0;
    html += tks.map((t) => {
        if (typeof t === 'string' && t.startsWith('DISC_')) {
            discTrackCounter = 0; 
            const label = t.replace('DISC_', '').replace(/_/g, ' ');
            return `<div style="padding: 30px 0 10px; color: var(--accent-green); font-size: 12px; font-weight: 900; text-transform: uppercase; letter-spacing: 2px;"><span class="material-icons" style="font-size: 16px; vertical-align: middle;">album</span> ${label}</div>`;
        }

        // Increment for EVERY track entry, regardless of playability
        discTrackCounter++;

        const isVideo = t.isVideo || (t.id && t.id.startsWith('video_'));
        const parentIds = t.album_id ? t.album_id.split(',').map(s => s.trim()) : [];
        const isReleasedElsewhere = parentIds.some(aid => {
            const other = window.ALBUMS.find(a => a.id === aid);
            return other && !other.coming_soon;
        });

        const isPlayable = !alb.coming_soon || isReleasedElsewhere || isVideo;
        const isActive = (window.currentTrackId === t.id); 

        return `
        <div class="track-row" data-id="${t.id}" 
             style="display:flex; align-items: center; padding: 16px 0; border-bottom: 1px solid rgba(255,255,255,0.05); opacity: ${isPlayable ? '1' : '0.3'};" 
             onclick="${isPlayable ? (isVideo ? `window.openVideoPlayer('${t.videoUrl}')` : `playTrack('${t.id}', true, '${alb.id}')`) : `showTRMToast('Coming Soon', '#ffcc00')`}">
            
            <div class="m-track-number" data-num="${discTrackCounter}" style="width: 38px; font-weight: 900; color: ${isActive ? 'var(--accent-green)' : 'inherit'}">
                ${isActive ? `<span class="material-icons" style="font-size:18px;">${!audio.paused ? 'volume_up' : 'pause'}</span>` : (isVideo ? '<span class="material-icons">play_circle</span>' : discTrackCounter)}
            </div>
            
            <div style="flex:1;">
                <div class="track-title-text" style="font-weight:800; text-transform: uppercase; color: ${isActive ? 'var(--accent-green)' : 'white'}">
                    ${isPlayable ? t.title : `TRACK ${discTrackCounter}`}
                </div>
                <div style="font-size:11px; opacity:0.5;">${isPlayable ? artist.name : 'COMING SOON'}</div>
            </div>
            
            <div style="font-size: 12px; opacity:0.4; color: ${isActive ? 'var(--accent-green)' : 'inherit'}">
                ${isPlayable ? (t.duration || '--:--') : '--:--'}
            </div>
        </div>`;
    }).join('');

    html += `</div></div>`;
    contentView.innerHTML = html;
    if (scrollToTop) contentView.scrollTop = 0;
    if (window.updatePlayIcons) window.updatePlayIcons(!audio.paused);
};

window.isAlbumComingSoon = (alb) => {
    if (alb.coming_soon === false) return false; 
    if (!alb.full_release_date) return true;

    const now = new Date();
    const dateStr = String(alb.full_release_date).trim();

    // Check if it's ONLY a year (e.g., "2026")
    if (/^\d{4}$/.test(dateStr)) {
        const releaseYear = parseInt(dateStr);
        const currentYear = now.getFullYear();
        
        // LOCK: If the releaseYear is 2026, it stays locked until 2027.
        // It only becomes public if the current year is strictly GREATER than the release year.
        return currentYear <= releaseYear;
    }

    // Otherwise, parse as a full date (e.g., "October 24, 2025")
    const cleanDate = dateStr.replace(/(\d+)(st|nd|rd|th)/, "$1");
    const releaseDate = new Date(cleanDate);
    
    if (isNaN(releaseDate.getTime())) return true; 
    return releaseDate > now;
};

window.updatePlayIcons = (playing) => {
    const iconText = playing ? 'pause' : 'play_arrow';

    // 1. Bottom Nav & Fullscreen Player Buttons
    ['m-play-btn', 'fp-play-btn'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerText = iconText;
    });

    // 2. Main Album Play Button (THE FIX FOR THE ALBUM PAGE)
    const mainIcon = document.getElementById('main-album-icon');
    if (mainIcon) {
        mainIcon.innerText = iconText;
    }

    // 3. Track List Highlighting (THE FIX FOR THE GREEN HIGHLIGHT)
    const trackRows = document.querySelectorAll('.track-row');
    trackRows.forEach(row => {
        const rowTrackId = row.getAttribute('data-id');
        const isCurrent = (rowTrackId === window.currentTrackId);
        
        // Find elements within the row
        const numContainer = row.querySelector('.m-track-number');
        const titleText = row.querySelector('.track-title-text');

        if (isCurrent) {
            // Apply CSS class for green color
            row.classList.add('active-track');
            
            // Force green for title/number (overriding inline styles)
            if (titleText) titleText.style.color = 'var(--accent-green)';
            if (numContainer) {
                numContainer.style.color = 'var(--accent-green)';
                // Change number to Volume/Pause icon
                numContainer.innerHTML = `<span class="material-icons" style="font-size:18px;">${playing ? 'volume_up' : 'pause'}</span>`;
            }
        } else {
            row.classList.remove('active-track');
            if (titleText) titleText.style.color = 'white';
            if (numContainer) {
                numContainer.style.color = 'inherit';
                // Restore the original number from the data-num attribute
                numContainer.innerText = numContainer.getAttribute('data-num') || '';
            }
        }
    });
};

window.playTrack = (trackId, autoPlay = true, explicitAlbumId = null) => {
    // Lookup track
    const track = window.TRACKS[trackId];
    if (!track) return;

    // Determine Album Context for Art
    const parentIds = track.album_id ? track.album_id.split(',').map(s => s.trim()) : [];
    const albId = explicitAlbumId || parentIds[0];
    const targetAlbum = window.ALBUMS.find(a => a.id == albId);
    
    // Resolve Art URL
    const finalArt = targetAlbum ? targetAlbum.art_url : 'https://via.placeholder.com/150';
    const artistName = window.ARTISTS[track.artist_id]?.name || "therichmusic";

    // Update States
    window.currentTrackId = trackId;
    window.currentAlbumId = albId;
    window.currentArtistId = track.artist_id; // Keep artist ID in sync for "View Artist" from player

    // Audio Logic
    if (audio.src !== track.url) {
        audio.src = track.url;
        audio.load();
    }
    if (autoPlay) {
        audio.play().then(() => {
            window.updatePlayIcons(true);
            if (window.updatePlayerUI) window.updatePlayerUI(); 
        }).catch(e => console.error("Playback Blocked", e));
    }

    // --- CRITICAL UI UPDATES ---
    
    // 1. Art Update
    ['m-art', 'fp-art', 'mini-art', 'm-art-bg'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.src = finalArt;
    });

    // 2. Text Update
    const texts = { 'm-title': track.title, 'fp-title': track.title, 'm-artist': artistName, 'fp-artist': artistName };
    for (const [id, val] of Object.entries(texts)) {
        const el = document.getElementById(id);
        if (el) el.innerText = val;
    }

    // 3. Lyrics & Genius Badge Update (THE FIX)
    const rawLyrics = track.lyrics || "(No lyrics available)";
    const lyricsData = (typeof window.parseLyrics === 'function') 
        ? window.parseLyrics(rawLyrics) 
        : { html: rawLyrics.replace(/\n/g, '<br>'), badge: '' };

    const lText = document.getElementById('fp-lyrics-text');
    const lFull = document.getElementById('fp-lyrics-full');
    const badgeCont = document.getElementById('genius-badge-cont');

    if (lText) lText.innerHTML = lyricsData.html;
    if (lFull) lFull.innerHTML = lyricsData.html;
    if (badgeCont) badgeCont.innerHTML = lyricsData.badge || '';

    // 4. Reset scroll for full player lyrics
    const scrollCont = document.getElementById('fp-scroll-container');
    if (scrollCont) scrollCont.scrollTop = 0;

    // 5. Mini-Player Visibility
    const miniPlayer = document.getElementById('mini-player');
    if (miniPlayer) {
        miniPlayer.style.setProperty('display', 'flex', 'important');
        miniPlayer.style.opacity = '1';
        miniPlayer.classList.add('mini-active');
        miniPlayer.classList.toggle('paused', !autoPlay);
    }

    // 6. Media Session
    if ('mediaSession' in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
            title: track.title,
            artist: artistName,
            album: targetAlbum ? targetAlbum.name : '',
            artwork: [{ src: finalArt, sizes: '512x512', type: 'image/png' }]
        });
    }

    // 7. Recent Plays Persistence
    const recent = JSON.parse(localStorage.getItem('trm_recent') || '[]');
    const newRecent = [trackId, ...recent.filter(x => x !== trackId)].slice(0, 20);
    localStorage.setItem('trm_recent', JSON.stringify(newRecent));

    window.updatePlayIcons(autoPlay);
};

// --- v1.4.0 DRAGGING SEEK (PROTECTED) ---
const initSeekListeners = () => {
    const seekBar = document.getElementById('fp-seek-container');
    
    // If the element isn't found, exit quietly instead of crashing
    if (!seekBar) return;

    seekBar.addEventListener('touchstart', (e) => {
        window.isDraggingSeek = true;
        // Disable transitions so the bar follows the finger instantly
        const progress = document.getElementById('fp-progress');
        if (progress) progress.style.transition = 'none';
    }, { passive: true });

    seekBar.addEventListener('touchmove', (e) => {
        const rect = seekBar.getBoundingClientRect();
        const touchX = e.touches[0].clientX - rect.left;
        let pct = Math.min(Math.max(touchX / rect.width, 0), 1);
        
        const progress = document.getElementById('fp-progress');
        const timeCur = document.getElementById('time-cur');

        if (progress) progress.style.width = (pct * 100) + '%';
        if (timeCur && !isNaN(audio.duration)) {
            timeCur.innerText = formatTime(pct * audio.duration);
        }
    }, { passive: true });

    seekBar.addEventListener('touchend', (e) => {
        window.isDraggingSeek = false;
        const progress = document.getElementById('fp-progress');
        
        if (progress && !isNaN(audio.duration)) {
            const pct = parseFloat(progress.style.width) / 100;
            audio.currentTime = pct * audio.duration;
            // Restore transition for smooth auto-progress
            progress.style.transition = 'width 0.1s linear';
        }
    }, { passive: true });
};

    // Add this inside window.playTrack
window.updatePlayerUI = () => {
    if (!window.audio) return;

    // Clear any existing loops to prevent "double speed" progress bars
    if (window.playerAnimationId) {
        cancelAnimationFrame(window.playerAnimationId);
    }

    const sync = () => {
        const curr = window.audio.currentTime;
        const dur = window.audio.duration;

        // 1. Only update if we have valid numbers
        if (!isNaN(dur) && dur > 0) {
            const percent = (curr / dur) * 100;
            
            // Update Progress Bars (Mini and Full)
            const miniBar = document.getElementById('mini-progress');
            const fullBar = document.getElementById('fp-progress');
            
            if (miniBar) miniBar.style.width = `${percent}%`;
            if (fullBar) fullBar.style.width = `${percent}%`;

            // Update Time Strings
            const curTimeEl = document.getElementById('time-cur');
            const durTimeEl = document.getElementById('time-dur');
            
            if (curTimeEl) curTimeEl.innerText = formatTime(curr);
            if (durTimeEl) durTimeEl.innerText = formatTime(dur);

            // 2. LOCKSCREEN SYNC: Only sync Media Session once per second
            if ('mediaSession' in navigator && Math.floor(curr) !== window.lastMediaSync) {
                navigator.mediaSession.setPositionState({
                    duration: dur,
                    playbackRate: window.audio.playbackRate,
                    position: curr
                });
                window.lastMediaSync = Math.floor(curr);
            }
        }

        // 3. Keep the loop going if playing
        if (!window.audio.paused) {
            window.playerAnimationId = requestAnimationFrame(sync);
        }
    };

    window.playerAnimationId = requestAnimationFrame(sync);
};

// Ensure your formatTime is solid
function formatTime(secs) {
    if (isNaN(secs)) return "0:00";
    const mins = Math.floor(secs / 60);
    const s = Math.floor(secs % 60);
    return `${mins}:${s < 10 ? '0' : ''}${s}`;
}
        window.goToCurrentArtist = () => {
            if (currentArtistId) {
                closeFullPlayer();
                viewArtist(currentArtistId);
            }
        };

window.viewSearch = () => {
if (window.currentViewId !== 'search')
    window.currentViewId = 'search';
    if (typeof window.updateNavUI === 'function') window.updateNavUI('nav-search');
    const target = document.getElementById('content-view') || document.getElementById('contentView');
    if (!target) return;

    target.scrollTo(0, 0);
    if (typeof setNav === 'function') setNav(1); 
    
    target.innerHTML = `
        <div class="standard-padding view-animate">
            <h1 style="font-size: 34px; font-weight: 800; margin-bottom: 20px; letter-spacing: -1px;">Search</h1>
            <div style="position: sticky; top: 0; background: var(--bg-black); padding: 10px 0; z-index: 10;">
                <input type="text" id="mSearch" placeholder="Artists, Albums, or Songs" 
                       oninput="runSearch(this.value)" autocomplete="off">
            </div>
            <div id="mResults"></div>
        </div>`;
    
    setTimeout(() => {
        const input = document.getElementById('mSearch');
        if (input) input.focus();
    }, 100);
};

window.runSearch = (q) => {
const res = document.getElementById('mResults');
    if (!q || q.trim().length < 1) { res.innerHTML = ''; return; }
    
    const query = q.toLowerCase();
    
    // 1. Artists
    const artMatch = Object.values(window.ARTISTS).filter(a => 
        a.name.toLowerCase().includes(query)
    );

    // 2. Albums: Must not be hidden
    const albMatch = window.ALBUMS.filter(a => 
        a.name.toLowerCase().includes(query) && a.hidden !== true
    );

    // 3. Tracks: Inherited Hiding Logic
    const trkMatch = [];
    // Convert dictionary to array for searching
    Object.values(window.TRACKS).forEach(t => {
        if (!t || t.hidden_name === true) return;
        
        const matchesQuery = t.title.toLowerCase().includes(query);
        if (matchesQuery) {
            // Find parent album for art and visibility check
            const parentIds = t.album_id ? t.album_id.split(',').map(s => s.trim()) : [];
            const album = window.ALBUMS.find(a => parentIds.includes(a.id));
            
            // Skip if the primary album is hidden
            if (album && album.hidden === true) return;

            trkMatch.push({
                ...t,
                albumArt: album ? album.art_url : 'https://via.placeholder.com/150',
                albumId: album ? album.id : parentIds[0],
                artistName: window.ARTISTS[t.artist_id]?.name || 'Unknown Artist'
            });
        }
    });

    let html = '';

    // Render Artists
    if (artMatch.length > 0) {
        html += `<div class="search-section-label">Artists</div>`;
        artMatch.forEach(a => {
            html += `
            <div class="result-item" onclick="viewArtist('${a.id}')">
                <img src="${a.banner_url || 'https://via.placeholder.com/150'}" style="width:55px; height:55px; border-radius:50%; object-fit:cover; margin-right:15px; border: var(--ios-border);">
                <div>
                    <div style="font-weight:bold; font-size:17px;">${a.name}</div>
                    <div style="font-size:12px; color:var(--accent-green); font-weight:700;">ARTIST</div>
                </div>
            </div>`;
        });
    }

    // Render Albums
    if (albMatch.length > 0) {
        html += `<div class="search-section-label">Albums</div>`;
        albMatch.forEach(a => {
            html += `
            <div class="result-item" onclick="viewAlbum('${a.id}')">
                <img src="${a.art_url}" style="width:55px; height:55px; border-radius:12px; object-fit:cover; margin-right:15px;">
                <div>
                    <div style="font-weight:bold; font-size:17px;">${a.name}</div>
                    <div style="font-size:12px; color:var(--text-dim);">ALBUM</div>
                </div>
            </div>`;
        });
    }

// Render Tracks
    if (trkMatch.length > 0) {
        html += `<div class="search-section-label">Songs</div>`;
        trkMatch.forEach(t => {
            html += `
            <div class="result-item" onclick="playTrack('${t.id}', true, '${t.albumId}')">
                <img src="${t.albumArt}" style="width:55px; height:55px; border-radius:8px; object-fit:cover; margin-right:15px;">
                <div style="flex:1;">
                    <div style="font-weight:bold; font-size:17px;">${t.title}</div>
                    <div style="font-size:12px; color:var(--text-dim);">SONG â€¢ ${t.artistName}</div>
                </div>
            </div>`;
        });
    }

    res.innerHTML = html || `<div style="text-align:center; margin-top:50px; color:var(--text-dim);">No results for "${q}"</div>`;
};

window.deepLinkCheckCount = 0;
window.handleDeepLinking = () => {
    let startTime = Date.now();
    const duration = 2000; // Spam for 2 seconds

    console.log("Deep Link: Background spam started...");

    const spamCheck = setInterval(() => {
        // 1. Check URL (Hash or Param)
        const urlParams = new URLSearchParams(window.location.search);
        let albId = urlParams.get('album') || window.location.hash.replace('#', '');

        // 2. Check if we've run out of time
        if (Date.now() - startTime > duration) {
            clearInterval(spamCheck);
            console.log("Deep Link: No ID found, stalling out.");
            return;
        }

        // 3. If we find an ID, try to process it
        if (albId) {
            // Ensure data is ready before proceeding
            if (window.ALBUMS && window.ALBUMS.length > 0) {
                const albumExists = window.ALBUMS.find(a => String(a.id) === String(albId));
                
                if (albumExists) {
                    clearInterval(spamCheck); // STOP SPAMMING
                    console.log("Deep Link: Found ID!", albId);
                    window.viewAlbum(albId);
                    
                    // Cleanup URL so refresh doesn't trigger it again
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
        }
    }, 100); // Check every 100ms

    // Bridge Listener (Keep this as a backup for the Fourthwall iframe message)
    const bridgeListener = (event) => {
        if (event.data && event.data.type === 'SET_ALBUM') {
            window.removeEventListener('message', bridgeListener);
            clearInterval(spamCheck); // Stop the spammer if the bridge wins
            window.viewAlbum(event.data.id);
        }
    };
    window.addEventListener('message', bridgeListener);
    
    // Cleanup bridge listener after 2 seconds too
    setTimeout(() => window.removeEventListener('message', bridgeListener), duration);
};

window.copyAlbumLink = (albumId) => {
    const alb = window.ALBUMS.find(a => a.id === albumId);
    const artist = window.ARTISTS[alb?.artist_id] || { name: "TRM Records" };
    
    // Aligned with Desktop baseUrl
    const baseUrl = "https://trm-brand-shop.fourthwall.com/pages/music-player"; 
    const shareUrl = `${baseUrl}#${albumId}`;

    const shareData = {
        title: alb ? alb.name.toUpperCase() : 'TRM Music',
        text: `Check out ${alb?.name} by ${artist.name} on TRM`,
        url: shareUrl
    };

    // Use Native Share if possible, fallback to Toast + Clipboard
    if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
        navigator.share(shareData).catch(err => {
            if (err.name !== "AbortError") copyToClipboardFallback(shareUrl);
        });
    } else {
        copyToClipboardFallback(shareUrl);
    }
};

// The Fallback function with a built-in "TRM Toast"
function copyToClipboardFallback(text) {
    const performCopy = () => {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            return navigator.clipboard.writeText(text);
        } else {
            // Older iOS fix
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            const successful = document.execCommand('copy');
            document.body.removeChild(textArea);
            return successful ? Promise.resolve() : Promise.reject();
        }
    };

    performCopy().then(() => {
        showTRMToast("Link copied to clipboard");
    }).catch(() => {
        showTRMToast("Failed to copy link", "#ff4444");
    });
}

window.playAlbum = function(albumId) {
    if (window.currentAlbumId === albumId && window.currentTrackId) {
        window.togglePlay();
        return;
    }

    const album = window.ALBUMS.find(a => a.id === albumId);
    // Use the ALBUM_TRACKS we set up in INIT
    const albumTracks = window.ALBUM_TRACKS?.[albumId] || [];

    if (albumTracks.length > 0) {
        const firstPlayable = albumTracks.find(t => {
            const parentIds = t.album_id ? t.album_id.split(',').map(s => s.trim()) : [];
            const isElsewhere = window.ALBUMS.some(a => parentIds.includes(a.id) && !a.coming_soon);
            return isElsewhere || (album && !album.coming_soon);
        });

        if (firstPlayable) {
            window.playTrack(firstPlayable.id, true, albumId);
            // Force icons to update for the whole album context
            setTimeout(() => window.updatePlayIcons(true), 50);
        }
    }
};

// Lightweight TRM-styled notification
function showTRMToast(msg, color = "var(--accent-green)") {
    // Remove existing toast if user spams the button
    const oldToast = document.getElementById('trm-toast');
    if (oldToast) oldToast.remove();

    const toast = document.createElement('div');
    toast.id = 'trm-toast';
    // Styling to match your RICH aesthetic
    Object.assign(toast.style, {
        position: 'fixed',
        bottom: '100px', // Sits above the mobile nav
        left: '50%',
        transform: 'translateX(-50%)',
        background: 'rgba(0,0,0,0.8)',
        backdropFilter: 'blur(10px)',
        webkitBackdropFilter: 'blur(10px)',
        color: 'white',
        padding: '12px 24px',
        borderRadius: '12px',
        fontSize: '13px',
        fontWeight: '800',
        zIndex: '1000000',
        border: `1px solid ${color}`,
        boxShadow: '0 10px 30px rgba(0,0,0,0.5)',
        textTransform: 'uppercase',
        letterSpacing: '1px',
        pointerEvents: 'none',
        transition: 'all 0.3s ease'
    });

    toast.innerText = msg;
    document.body.appendChild(toast);

    // Fade out and remove
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.bottom = '90px';
        setTimeout(() => toast.remove(), 300);
    }, 2500);
}

window.togglePlay = () => {
    if (!audio.src || audio.src === "" || audio.src.includes('null')) return;

    if (audio.paused) {
        audio.play().then(() => {
            window.isPlaying = true;
            window.updatePlayIcons(true);
        }).catch(e => console.log("Play failed"));
    } else {
        audio.pause();
        window.isPlaying = false;
        window.updatePlayIcons(false);
    }
};

// --- PROGRESS & TIME LOGIC ---
audio.ontimeupdate = function() {
    if (isNaN(audio.duration)) return;

    const percent = (audio.currentTime / audio.duration) * 100;
    
    // Update Mini Player Bar
    const miniBar = document.getElementById('mini-progress');
    if (miniBar) miniBar.style.width = percent + "%";

    // Update Full Player Bar
    const fpBar = document.getElementById('fp-progress');
    if (fpBar) fpBar.style.width = percent + "%";

    // Update Time Text
    const curTimeText = document.getElementById('time-cur');
    if (curTimeText) curTimeText.innerText = formatTime(audio.currentTime);
};

audio.onloadedmetadata = function() {
    const durText = document.getElementById('time-dur');
    if (durText) durText.innerText = formatTime(audio.duration);
};

audio.onplay = () => {
    if ('mediaSession' in navigator) {
        navigator.mediaSession.playbackState = "playing";
    }
};

audio.onpause = () => {
    if ('mediaSession' in navigator) {
        navigator.mediaSession.playbackState = "paused";
    }
};

function formatTime(sec) {
    if (isNaN(sec)) return "0:00";
    const m = Math.floor(sec / 60);
    const s = Math.floor(sec % 60);
    return `${m}:${s < 10 ? '0' : ''}${s}`;
}

window.seek = (e, el) => {
    if (!audio.duration) return;
    const rect = el.getBoundingClientRect();
    const per = (e.clientX - rect.left) / rect.width;
    audio.currentTime = per * audio.duration;
};

// --- CONTROLS & UTILS ---

window.toggleShuffle = () => { 
    isShuffle = !isShuffle; 
    document.getElementById('ctrl-shuffle').classList.toggle('glow-active', isShuffle); 
};

window.toggleLoop = () => { 
    isRepeat = !isRepeat; 
    audio.loop = isRepeat; 
    document.getElementById('ctrl-repeat').classList.toggle('glow-active', isRepeat); 
};

function setNav(idx) { 
    const ids = ['nav-home', 'nav-search', 'nav-lib']; 
    ids.forEach((id, i) => { 
        const el = document.getElementById(id); 
        if(el) el.classList.toggle('active', i === idx); 
    }); 
}

window.openFullPlayer = function() {
    const fp = document.getElementById('full-player');
    const mini = document.getElementById('mini-player');
    const scrollCont = document.getElementById('fp-scroll-container');
    
    let targetTrack = null;
    let albumArtFallback = "";
    let albumArtistId = ""; 
    
    if (window.ALBUMS) {
        for (const album of window.ALBUMS) {
            if (album.track_ids && album.track_ids.includes(window.currentTrackId)) {
                albumArtFallback = album.art_url;
                albumArtistId = album.artist_id; 
                const albumBucket = window.TRACKS ? window.TRACKS[album.id] : null; 
                if (albumBucket) {
                    targetTrack = Array.isArray(albumBucket) 
                        ? albumBucket.find(t => t.id === window.currentTrackId)
                        : albumBucket[window.currentTrackId];
                }
                break;
            }
        }
    }

    if (targetTrack) {
        document.getElementById('fp-title').innerText = targetTrack.title || "Unknown Track";
        const artistEl = document.getElementById('fp-artist');
        const artistName = targetTrack.artist || (window.ARTISTS[albumArtistId]?.name) || "therichmusic";
        artistEl.innerText = artistName;
        
        const artistId = targetTrack.artist_id || albumArtistId; 
        artistEl.onclick = () => {
            if (typeof window.viewArtist === 'function' && artistId) {
                closeFullPlayer();
                window.viewArtist(artistId);
            }
        };

        document.getElementById('fp-art').src = targetTrack.art_url || albumArtFallback || document.getElementById('m-art').src;

        // Unified Lyrics & Badge Injection
        const rawLyrics = targetTrack.lyrics || "(No lyrics available)";
        const lyricsData = window.parseLyrics(rawLyrics);
        
        const lText = document.getElementById('fp-lyrics-text');
        const lFull = document.getElementById('fp-lyrics-full');
        const badgeCont = document.getElementById('genius-badge-cont');
        
        if (lText) lText.innerHTML = lyricsData.html;
        if (lFull) lFull.innerHTML = lyricsData.html;
        if (badgeCont) badgeCont.innerHTML = lyricsData.badge || '';
    }

    window.updateFullPlayerLikeUI();

    if (scrollCont) scrollCont.scrollTop = 0;
    fp.style.display = 'flex';
    requestAnimationFrame(() => {
        fp.classList.add('active');
        setTimeout(() => {
            if(fp.classList.contains('active')) {
                mini.style.opacity = '0';
                mini.style.pointerEvents = 'none';
            }
        }, 500);
    });
};

// Lyrics Focus Tab Toggle
window.openLyricsTab = () => { 
    const tab = document.getElementById('lyrics-tab');
    if (tab) {
        tab.style.display = 'flex';
        // Ensure we target the correct scrollable container
        const fullLyricsCont = document.getElementById('fp-lyrics-full');
        if (fullLyricsCont) fullLyricsCont.scrollTop = 0;
    }
};

window.closeLyricsTab = () => { 
    const tab = document.getElementById('lyrics-tab');
    if (tab) tab.style.display = 'none'; 
};

window.openLyricsTab = () => { document.getElementById('lyrics-tab').style.display = 'flex'; };
window.closeLyricsTab = () => { document.getElementById('lyrics-tab').style.display = 'none'; };

function closeFullPlayer() {
    const fp = document.getElementById('full-player');
    const mini = document.getElementById('mini-player');
    
    fp.classList.remove('active');
    mini.style.opacity = '1';
    mini.style.pointerEvents = 'auto';
    
    // Hide display after transition finishes
    setTimeout(() => {
        if(!fp.classList.contains('active')) fp.style.display = 'none';
    }, 500);
}

window.nextTrack = () => {
    const album = window.ALBUMS.find(a => a.id === window.currentAlbumId);
    if (!album || !window.TRACKS[album.id]) return false;

    const trackList = window.TRACKS[album.id];
    let currentIndex = trackList.findIndex(t => t.id === window.currentTrackId);

    for (let i = currentIndex + 1; i < trackList.length; i++) {
        const t = trackList[i];
        
        const parentIds = t.album_id.split(',').map(s => s.trim());
        const isReleased = window.ALBUMS.some(a => parentIds.includes(a.id) && !a.coming_soon);

        if (isReleased) {
            window.playTrack(t.id, true, album.id);
            
            // --- ADD THIS LINE ---
            if (window.updateLyricsView) window.updateLyricsView(t.id); 
            
            return true;
        }
    }
    return false;
};

window.prevTrack = () => {
    if (audio.currentTime > 3) {
        audio.currentTime = 0;
        return;
    }

    const album = window.ALBUMS.find(a => a.id === window.currentAlbumId);
    if (!album || !window.TRACKS[album.id]) return;

    const trackList = window.TRACKS[album.id];
    let currentIndex = trackList.findIndex(t => t.id === window.currentTrackId);

    if (currentIndex > 0) {
        const prevT = trackList[currentIndex - 1];
        window.playTrack(prevT.id, true, album.id);
        
        // --- ADD THIS LINE ---
        if (window.updateLyricsView) window.updateLyricsView(prevT.id);
        
    } else {
        audio.currentTime = 0;
    }
};

window.toggleLike = async function(trackId) {
    if (!trackId) return;

    // 1. CHECK AUTH FIRST
    const { data: { session } } = await supabaseClient.auth.getSession();
    
    if (!session) {
        window.showAuthModal("Log in to like songs", "Build your personal collection by signing in to your account.");
        return;
    }

    const isCurrentlyLiked = window.USER_LIKES?.songs?.includes(trackId);
    let updatedLikes;
    
    if (isCurrentlyLiked) {
        updatedLikes = window.USER_LIKES.songs.filter(id => id !== trackId);
        window.showToast("Removed from Library", "undo", () => window.toggleLike(trackId));
    } else {
        updatedLikes = [...new Set([...(window.USER_LIKES?.songs || []), trackId])];
        window.showToast("Added to Liked Songs");
    }

    window.USER_LIKES.songs = updatedLikes;
    if (window.updateFullPlayerLikeUI) window.updateFullPlayerLikeUI();
    if (window.currentViewId === 'library') window.viewLibrary();

    try {
        await supabaseClient.from('users')
            .update({ liked_songs: updatedLikes })
            .eq('id', session.user.id);
    } catch (err) {
        console.error("Supabase Sync Error:", err);
    }
};

// Helper for the Auth Modal
window.showAuthModal = (title, message) => {
    // Check if modal already exists to prevent stacking
    if (document.getElementById('auth-modal')) return;

    const modal = document.createElement('div');
    modal.id = 'auth-modal';
    modal.style = `
        position: fixed; inset: 0; background: rgba(0,0,0,0.85); 
        backdrop-filter: blur(10px); z-index: 10000; 
        display: flex; align-items: center; justify-content: center;
        padding: 20px; animation: fadeIn 0.2s ease;
    `;

modal.innerHTML = `
    <div style="background: #111; border: 1px solid #222; padding: 30px; border-radius: 24px; width: 100%; max-width: 320px; text-align: center;">
        <span class="material-icons" style="font-size: 48px; color: #00ff88; margin-bottom: 15px;">lock</span>
        <h2 style="color: white; font-weight: 900; margin-bottom: 10px; font-size: 20px; text-transform: uppercase;">${title}</h2>
        <p style="color: #888; font-size: 14px; line-height: 1.4; margin-bottom: 25px;">${message}</p>
        
        <button onclick="window.viewAccount(); document.getElementById('auth-modal').remove();" 
                style="width: 100%; background: white; color: black; border: none; padding: 15px; border-radius: 12px; font-weight: 900; margin-bottom: 10px; cursor: pointer;">
            LOGIN
        </button>
        
        <button onclick="document.getElementById('auth-modal').remove();" 
                style="width: 100%; background: transparent; color: #666; border: none; padding: 10px; border-radius: 12px; font-weight: 700; font-size: 12px; cursor: pointer;">
            NOT NOW
        </button>
    </div>
`;

    document.body.appendChild(modal);
};

window.viewLibrary = async function() {
    window.currentViewId = 'library';
    if (typeof window.updateNavUI === 'function') window.updateNavUI('nav-lib');
    
    const target = document.getElementById('content-view') || document.getElementById('contentView');
    if (!target) return;
    if (typeof resetScroll === 'function') resetScroll();

    try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        
        if (!session) {
            target.innerHTML = `<div style="height: 80vh; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px;">
                <span class="material-icons" style="font-size: 64px; color: #222; margin-bottom: 20px;">favorite_border</span>
                <h2 style="color: white; font-weight: 900;">YOUR COLLECTION</h2>
                <p style="color: #666; margin-bottom: 30px;">Login to like your favorite songs.</p>
                <button onclick="window.viewAccount()" style="background: white; color: black; border: none; padding: 15px 40px; border-radius: 30px; font-weight: 900;">LOGIN</button>
            </div>`;
            return;
        }

        // Newest First Logic
        const likedTrackIds = (window.USER_LIKES && window.USER_LIKES.songs) ? [...new Set(window.USER_LIKES.songs)].reverse() : [];
        
        const likedTracks = [];
        likedTrackIds.forEach(id => {
            const foundTrack = window.TRACKS[id];
            if (foundTrack) {
                const firstAlbumId = foundTrack.album_id?.split(',')[0].trim();
                const parentAlbum = window.ALBUMS.find(a => a.id == firstAlbumId);
                likedTracks.push({ ...foundTrack, displayArt: parentAlbum?.art_url || '' });
            }
        });

        target.innerHTML = `
            <div style="max-width: 800px; margin: 0 auto; padding: 40px 20px; animation: fadeIn 0.3s ease;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;">
                    <div>
                        <span style="color: #00ff88; font-size: 10px; font-weight: 900; letter-spacing: 2px;">COLLECTION</span>
                        <h1 style="font-size: 48px; font-weight: 900; margin: 0; letter-spacing: -2px; color: white;">LIKED SONGS</h1>
                    </div>
                    ${likedTracks.length > 0 ? `
                        <button onclick="window.shuffleLibrary()" style="background: #00ff88; color: black; border: none; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 20px rgba(0,255,136,0.2);">
                            <span class="material-icons" style="font-size: 30px;">shuffle</span>
                        </button>
                    ` : ''}
                </div>

                <div id="library-list">
                    ${likedTracks.length > 0 ? likedTracks.map(t => `
                        <div class="track-row" data-id="${t.id}" style="display: flex; align-items: center; gap: 15px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 12px; margin-bottom: 8px;" onclick="playTrack('${t.id}')">
                            <img src="${t.displayArt}" style="width: 50px; height: 50px; border-radius: 6px; object-fit: cover;">
                            <div style="flex: 1;">
                                <div style="font-weight: 800; color: white; font-size: 14px;">${t.title}</div>
                                <div style="color: rgba(255,255,255,0.5); font-size: 11px;">${window.ARTISTS[t.artist_id]?.name || 'Artist'}</div>
                            </div>
                            <span class="material-icons" onclick="event.stopPropagation(); window.toggleLike('${t.id}')" style="color: #00ff88;">favorite</span>
                        </div>
                    `).join('') : `<div style="text-align: center; padding: 80px 0; opacity: 0.3;"><h2 style="font-size: 32px; font-weight: 900;">EMPTY</h2></div>`}
                </div>
            </div>`;
    } catch (e) { console.error("Library Load Error:", e); }
};

// Global Shuffle Helper
window.shuffleLibrary = () => {
    const ids = window.USER_LIKES.songs;
    if (!ids || ids.length === 0) return;
    const randomId = ids[Math.floor(Math.random() * ids.length)];
    window.playTrack(randomId, true);
};

window.handleLikeClick = async function() {
    const trackId = window.currentTrackId;
    if (!trackId) return;
    
    // We only call this ONCE. No extra logic here.
    if (typeof window.toggleLike === 'function') {
        await window.toggleLike(trackId);
    }
};

// Helper to keep the Full Player UI in sync
window.updateFullPlayerLikeUI = function() {
    const isLiked = window.USER_LIKES?.songs?.includes(window.currentTrackId);
    const fpHeart = document.getElementById('fp-heart-icon');
    if (fpHeart) {
        fpHeart.innerText = isLiked ? 'favorite' : 'favorite_border';
        fpHeart.style.color = isLiked ? '#00ff88' : 'white';
    }
};

// Make sure to call this whenever a track starts playing
// (Add this inside your playTrack function or transition logic)
window.updateFullPlayerLikeUI();

window.showToast = function(message, type = "info", undoAction = null) {
    // Remove existing toast if present
    const existing = document.getElementById('toast-container');
    if (existing) existing.remove();

    const toast = document.createElement('div');
    toast.id = 'toast-container';
    
    let html = `<span>${message.toUpperCase()}</span>`;
    
    if (type === "undo" && undoAction) {
        const undoBtn = document.createElement('button');
        undoBtn.innerText = "UNDO";
        undoBtn.style = "background:none; border:none; font-weight:900; color:black; text-decoration:underline; cursor:pointer; padding:0;";
        undoBtn.onclick = () => {
            undoAction();
            toast.remove();
        };
        toast.appendChild(undoBtn);
    }

    toast.innerHTML = html;
    if (type === "undo" && undoAction) {
        // Re-append the button logic if using innerHTML
        const btn = document.createElement('span');
        btn.innerHTML = "UNDO";
        btn.style = "margin-left:10px; text-decoration:underline; cursor:pointer;";
        btn.onclick = () => { undoAction(); toast.remove(); };
        toast.appendChild(btn);
    }

    document.body.appendChild(toast);
    setTimeout(() => { if(toast) toast.remove(); }, 4000);
};

// Add this helper to refresh the view immediately when liking/unliking inside the library
window.handleLikeToggle = (id) => {
    // 1. Update Data
    const isNowLiked = window.STORAGE.toggleLike(id);
    
    // 2. Update Full Player UI (if open)
    const fpHeart = document.getElementById('fp-heart-icon');
    if (fpHeart) {
        fpHeart.innerText = isNowLiked ? 'favorite' : 'favorite_border';
        fpHeart.style.color = isNowLiked ? 'var(--accent-green)' : 'white';
    }

    // 3. Update Library UI (if currently viewing library)
    if (window.currentViewId === 'library') {
        viewLibrary(window.lastActiveTab);
    }

    // 4. Haptic Feedback / Toast (Optional but good for iOS)
    if (window.showTRMToast) {
        window.showTRMToast(isNowLiked ? "Added to Library" : "Removed from Library");
    }
};

window.openPatchNotes = function() {
    const versionHistory = [
        {
            version: "v1.0.5",
            date: "February 14, 2026",
            notes: [
                "ðŸ‘¤ Accounts are here!",
                "ðŸ©· The library has returned, and now they're account-based, which means you can go on your Desktop and your likes are right there!",
                "ðŸ› ï¸ Note that we're also working on a bunch of other new features that will take time to set up! Go support us on Ko-Fi (Link Below)",
                "<a href='https://trm-brand-shop.fourthwall.com/music-player#rich-album' target='_blank' rel='noopener noreferrer' style='color:#00ff88; text-decoration:none;'>ðŸ’¿ I heard that something weird IS happening...</a>",
                "<a href='https://trm-brand-shop.fourthwall.com/blog' target='_blank' rel='noopener noreferrer' style='color:#00ff88; text-decoration:none;'>ðŸ“° Want to know more about your privacy (regarding accounts)? Well, we just pushed an article regarding on this very topic.</a>"
            ],
            actionButton: {
                text: "Support Us via Ko-Fi (WE are a one man team!)",
                url: "https://ko-fi.com/mybudshadow"
            }
        },
        {
            version: "v1.0.3.4",
            date: "February 12, 2026",
            notes: [
                "ðŸ“¸ Videos can now appear inside of releases!",
                "ðŸ’¿ A fan of multi-disc projects? Well they're here!",
                "ðŸŽ¸ Want a specific genre of music? You can now see them before listening to the release! (On the release page)",
                "And a whole other slew of small additions to make YOUR experience better here at the TRM MUSIC PLAYER.",
            ],
            actionButton: {
                text: "VISIT THE BRAND SHOP",
                url: "https://trm-brand-shop.fourthwall.com"
            }
        },
        {
            version: "v1.0.3.3",
            date: "February 11, 2026",
            notes: [
                "ðŸŒ‘ Woah, sorry for the blackout! A small error with a new feature we wanted to ship caused the error... sorry...",
                "â–¶ï¸ In other news, we've finally fixed the function to play releases.",
                "ðŸ”— Fixed social links, now they represent the actual brands",
                "ðŸ·ï¸ Don't worry, there's more coming...",
            ],
            actionButton: {
                text: "VISIT THE BRAND SHOP",
                url: "https://trm-brand-shop.fourthwall.com"
            }
        },
                {
            version: "v1.0.3.2",
            date: "February 11, 2026",
            notes: [
                "â¬†ï¸ Deployed a patch to fix the Spotlight!",
            ],
            actionButton: {
                text: "VISIT THE BRAND SHOP",
                url: "https://trm-brand-shop.fourthwall.com"
            }
        },
    {
            version: "v1.0.3.1",
            date: "February 10, 2026",
            notes: [
                "ðŸ› ï¸ Hammered out some bugs.",
                "ðŸ”— Copying links work now.",
                "âš™ï¸ Regarding v1.0.4: We'll be introducing a bunch of new features, such as a settings menu, light mode, and more.",
                "âš ï¸ Due to a bug we've temporarliy disabled the Library.",
            ],
            actionButton: {
                text: "VISIT THE BRAND SHOP",
                url: "https://trm-brand-shop.fourthwall.com"
            }
        },
    {
            version: "v1.0.3",
            date: "February 10, 2026",
            notes: [
                "ðŸ“± Mobile Optimization",
                "ðŸ”— Copying links should work like never before! (Finally... psst, unlike Desktop you can send them to your friends right from the app!)",
                "ðŸŽžï¸ Albums can now have featured videos, and so can your favorite artists!",
                "ðŸ“· Wanna follow your favorite artists everywhere? (Creep), well now you can with social links!",
                "ðŸ–Œï¸ We got a bit artistic and made some improvements to UI in general!",
                "ðŸ”„ï¸ I heard someone wanted to rotate their spotlight?",
                "ðŸ”¦ Oh, and from a friend... I heard Light Mode is coming next update... ðŸ‘€",
            ],
            actionButton: {
                text: "VISIT THE BRAND SHOP",
                url: "https://trm-brand-shop.fourthwall.com"
            }
        },
    ];

    if (document.getElementById('patch-modal-root')) return;

    const root = document.createElement('div');
    root.id = 'patch-modal-root';
    Object.assign(root.style, {
        position: 'fixed',
        inset: '0',
        zIndex: '999999',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        padding: '20px'
    });

    const current = versionHistory[0];

    root.innerHTML = `
        <div style="position: absolute; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);"></div>
        <div class="view-animate" style="position: relative; background: #0d0d0d; border: 1px solid #222; width: 100%; max-width: 400px; max-height: 85vh; border-radius: 28px; display: flex; flex-direction: column; color: white; box-shadow: 0 30px 60px rgba(0,0,0,0.5); overflow: hidden;">
            
            <div style="padding: 30px 30px 10px 30px;">
                <h2 style="font-size: 28px; font-weight: 900; margin: 0; letter-spacing: -1px; text-transform: uppercase;">Patch Notes</h2>
                <p style="color: var(--accent-green); font-weight: 800; font-size: 10px; margin: 5px 0 0 0; letter-spacing: 2px; text-transform: uppercase;">CURRENT VERSION ${current.version}</p>
            </div>

            <div style="flex: 1; overflow-y: auto; padding: 20px 30px; mask-image: linear-gradient(to bottom, transparent, black 5%, black 95%, transparent);">
                ${versionHistory.map(release => `
                    <div style="margin-bottom: 25px;">
                        <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 12px;">
                            <span style="font-weight: 900; font-size: 14px; color: white; opacity: 0.9;">${release.version}</span>
                            <span style="color: #444; font-size: 10px; font-weight: 700;">${release.date}</span>
                        </div>
                        <ul style="margin: 0; padding-left: 15px; color: #bbb; line-height: 1.5; font-size: 13px; font-weight: 500; list-style: disc;">
                            ${release.notes.map(note => `<li style="margin-bottom: 8px;">${note}</li>`).join('')}
                        </ul>
                    </div>
                `).join('')}
            </div>

            <div style="padding: 20px 30px 30px 30px; display: flex; flex-direction: column; gap: 10px; background: linear-gradient(to top, #0d0d0d 80%, transparent);">
                <button onclick="document.getElementById('patch-modal-root').remove()" style="width: 100%; background: #fff; color: #000; border: none; padding: 16px; border-radius: 14px; font-weight: 900; font-size: 13px; text-transform: uppercase; cursor: pointer;">
                    GOT IT
                </button>

                ${current.actionButton ? `
                    <a href="${current.actionButton.url}" target="_blank" style="width: 100%; background: rgba(255,255,255,0.05); color: #fff; border: 1px solid rgba(255,255,255,0.1); padding: 16px; border-radius: 14px; font-weight: 900; font-size: 12px; text-align: center; text-decoration: none; box-sizing: border-box;">
                        ${current.actionButton.text}
                    </a>
                ` : ''}
            </div>
        </div>
    `;

    document.body.appendChild(root);
};

// Variable to hold the timer state
let pressTimer;

window.handleLongPressStart = (id, type = 'album') => {
    // Clear any existing timer just in case
    clearTimeout(pressTimer);

    pressTimer = setTimeout(() => {
        if (type === 'track') {
            // Logic for a single track (from Library/Recent)
            STORAGE.toggleLike(id);
            if (navigator.vibrate) navigator.vibrate(40);
            
            // Refresh the library view if that's where we are
            if (window.currentViewId === 'library') {
                viewLibrary(window.lastActiveTab || 'liked');
            }
        } else {
            // Logic for an entire album
            bulkLikeAlbum(id);
            if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
        }
    }, 800); // 800ms is the standard "long press" duration
};

window.handleLongPressEnd = () => {
    // If the user lets go before 800ms, the timer is cancelled
    clearTimeout(pressTimer);
};

// Attach scroll listener to the ONLY scrollable container
// 1. Initialize the tracker variable if it doesn't exist
let lastScrollTop = 0;

// 2. Wrap the listener in a function or a check
const setupScrollListener = () => {
    // Safely find the element
    const cv = document.getElementById('content-view') || document.getElementById('contentView');
    
    if (!cv) {
        console.warn("Scroll Setup: contentView not found yet. Retrying...");
        return;
    }

    cv.addEventListener('scroll', () => {
        // LOCK: If we are on an album or artist page, keep the UI hidden
        if (window.currentViewId === 'album' || window.currentViewId === 'artist') {
            if (typeof toggleNavUI === 'function') toggleNavUI(false);
            return;
        }

        let scrollTop = cv.scrollTop;
        
        // Only trigger UI changes if we've moved significantly (better for mobile performance)
        if (Math.abs(lastScrollTop - scrollTop) <= 5) return;

        if (scrollTop > 100) {
            if (scrollTop > lastScrollTop) {
                if (typeof toggleNavUI === 'function') toggleNavUI(false); // Hide on Scroll Down
            } else {
                if (typeof toggleNavUI === 'function') toggleNavUI(true);  // Show on Scroll Up
            }
        } else {
            if (typeof toggleNavUI === 'function') toggleNavUI(true); // Always show at top
        }
        
        lastScrollTop = scrollTop <= 0 ? 0 : scrollTop; 
    }, { passive: true });
};

// 3. Execute the setup
setupScrollListener();

        init();
    </script>
</body>
</html>