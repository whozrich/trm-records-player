<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TRM Records</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
:root {
    --bg-black: #000000;
    --ios-glass: rgba(20, 20, 20, 0.75);
--ios-blur: blur(15px) saturate(160%); /* Reduced blur depth for performance */
    --ios-border: 0.5px solid rgba(255, 255, 255, 0.15);
--accent-green: #00ff88;
    --text-main: #ffffff;
    --text-dim: rgba(255, 255, 255, 0.5);
    --squircle: 22%;
    --safe-pad: 24px;
}

body, html {
    margin: 0; padding: 0;
    background-color: var(--bg-black);
    color: var(--text-main);
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
    height: 100%; width: 100%; overflow: hidden;
}

#content-view { 
    height: 100%; width: 100%;
    overflow-y: auto; overflow-x: hidden;
    padding-bottom: 220px;
    -webkit-overflow-scrolling: touch; 
    scroll-behavior: smooth;
}

#content-view::-webkit-scrollbar {
    width: 0px; /* Most mobile apps hide the bar entirely for that clean look */
    background: transparent;
}

.standard-padding { 
    padding-left: var(--safe-pad); 
    padding-right: var(--safe-pad);
    padding-top: 20px;
}

.mobile-home-grid { 
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    gap: 16px; 
    padding: 0 var(--safe-pad); 
}

/* --- THE FLOATING NAV ISLAND --- */
.bottom-nav {
    position: fixed; 
    bottom: 30px; 
    /* Use left/right instead of left/transform for better stability on mobile */
    left: 24px;
    right: 24px;
    width: auto; /* Let left/right define the width */
    max-width: 400px; 
    margin: 0 auto; /* Centers the max-width container */
    height: 68px;
    background: var(--ios-glass);
    -webkit-backdrop-filter: var(--ios-blur);
    backdrop-filter: var(--ios-blur);
    display: flex;
    justify-content: space-around; 
    align-items: center;
    border: var(--ios-border);
    border-radius: 40px; 
    z-index: 998; /* Keep below mini-player */
    box-shadow: 0 20px 40px rgba(0,0,0,0.5);
    transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1), opacity 0.3s ease;
}

#mSearch {
    width: 100%;
    padding: 14px 16px;
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 14px;
    color: white;
    font-size: 16px;
    outline: none;
    transition: all 0.3s ease;
    box-sizing: border-box;
}

#mSearch:focus {
    background: rgba(255, 255, 255, 0.12);
    border-color: var(--accent-green);
    box-shadow: 0 0 15px rgba(0, 255, 136, 0.2);
}

.search-section-label {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text-dim);
    margin: 25px 0 15px 0;
    font-weight: 800;
}

.result-item {
    display: flex;
    align-items: center;
    padding: 10px;
    margin: 0 -10px; /* Offset padding for tap effect */
    border-radius: 12px;
    transition: background 0.2s;
}

.result-item:active {
    background: rgba(255, 255, 255, 0.1);
}

.nav-item { color: var(--text-dim); transition: 0.3s; flex: 1; text-align: center; font-size: 10px; font-weight: 600; }
.nav-item.active { color: white; transform: translateY(-2px); }
.nav-item .material-icons { display: block; font-size: 24px; margin-bottom: 2px; }

.accent-glow, #fp-artist, .play-indicator {
    color: var(--accent-green) !important;
    text-shadow: 0 0 15px rgba(0, 255, 136, 0.6);
}

/* --- THE MINI PLAYER (FLOATING CARD) --- */
#mini-player {
    position: fixed; 
    /* Default position (Upward, when nav is visible) */
    bottom: 110px; 
    left: var(--safe-pad); 
    right: var(--safe-pad);
    background: var(--ios-glass);
    -webkit-backdrop-filter: var(--ios-blur);
    backdrop-filter: var(--ios-blur);
    border: var(--ios-border);
    border-radius: 24px;
    z-index: 1000; /* Priority layer */
    display: none; 
    flex-direction: column;
overflow: hidden; /* This is necessary for the squircle shape */

    /* Hardware Acceleration to stop the iPhone lag */
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
    will-change: bottom, transform;

    transition: 
        transform 0.5s cubic-bezier(0.19, 1, 0.22, 1), 
        bottom 0.5s cubic-bezier(0.19, 1, 0.22, 1), 
        opacity 0.4s ease;
        
}

#mini-player, .bottom-nav {
    /* Force GPU rendering */
    -webkit-transform: translateZ(0);
    transform: translateZ(0); 
    /* Add this to prevent 'paint flashing' during animations */
    will-change: transform, bottom;
}

.no-transition {
    transition: none !important;
}

#mini-player.nav-is-hidden { 
    bottom: 30px !important; 
}
#mini-player.nav-visible {
    bottom: 110px; /* 30px (base) + 68px (nav height) + 12px (gap) */
}

.nav-hidden {
    transform: translateY(150px) !important;
    opacity: 0;
}

.mini-hidden {
    opacity: 0 !important;
    transform: translateY(200px) !important;
}

.mini-active {
    display: flex !important;
    opacity: 1 !important;
    animation: ios-pop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes ios-pop {
    0% { transform: scale(0.9) translateY(20px); opacity: 0; }
    100% { transform: scale(1) translateY(0); opacity: 1; }
}

#m-art {
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.paused #m-art {
    transform: scale(0.85);
    filter: grayscale(0.5);
}

.mini-main { display: flex; align-items: center; padding: 10px 15px; }
#mini-player img { width: 45px; height: 45px; border-radius: 8px; margin-right: 12px; }

/* --- FULL SCREEN PLAYER (MODAL) --- */
#full-player {
    display: flex; /* Always flex, control visibility with transform */
    visibility: hidden;
    pointer-events: none;
    transform: translate3d(0, 100%, 0);
    transition: transform 0.4s cubic-bezier(0.15, 0, 0.2, 1), visibility 0s 0.4s;
}

#full-player.active {
    visibility: visible;
    pointer-events: auto;
    transform: translate3d(0, 0, 0);
    transition: transform 0.4s cubic-bezier(0.15, 0, 0.2, 1);
}

/* --- THE DYNAMIC GLOW BACKGROUND --- */
.bg-glow {
    display: none; /* Turn this off if the full player is still stuttering */
}

/* --- CATALOGUE GRID --- */
.mobile-home-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 0 20px; }
.track-tile { border-radius: var(--squircle); overflow: hidden; background: transparent; }
.track-tile img { 
    width: 100%; aspect-ratio: 1; object-fit: cover; 
    border-radius: var(--squircle);
    box-shadow: 0 10px 20px rgba(0,0,0,0.3);
}
.tile-content { padding: 10px 5px; }

/* --- PROGRESS BAR (SLEEK) --- */
.progress-container {
    width: 100%;
    height: 6px !important; /* Force a visible thickness */
    background: rgba(255, 255, 255, 0.15) !important;
    position: absolute;
    bottom: 0; /* Pins it to the bottom */
    left: 0;
    z-index: 20; /* Ensure it sits on top of everything else */
}

.progress-fill {
    height: 100%;
    width: 0%; /* JS will update this */
    background: var(--accent-green) !important;
    box-shadow: 0 -2px 10px var(--accent-green); /* Glow points UP into the player */
    transition: width 0.1s linear;
    border-radius: 0 2px 2px 0;
}

/* Full player version - needs to be thicker and centered */
#full-player .progress-container {
    position: relative; /* Not pinned to bottom */
    margin: 20px 0;
    height: 4px;
    border-radius: 10px;
}

#mini-player .progress-container {
    bottom: 0;
    border-radius: 0 0 24px 24px; /* Matches the mini-player's bottom corners */
}

.material-icons.glow-green {
    color: var(--accent-green) !important;
    filter: drop-shadow(0 0 8px rgba(0, 255, 136, 0.8));
}

#mini-player, #full-player, .bottom-nav, .fp-art {
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    perspective: 1000;
    transform: translate3d(0,0,0); /* Forces Hardware Acceleration */
    will-change: transform, opacity;
}

.material-icons { font-family: 'Material Icons'; font-weight: normal; font-style: normal; display: inline-block; line-height: 1; text-transform: none; letter-spacing: normal; word-wrap: normal; white-space: nowrap; direction: ltr; -webkit-font-smoothing: antialiased; }
        .material-icons:active {
            transform: scale(0.85);
            filter: brightness(1.5);
        }

        /* --- FEATURED BANNER --- */
        .featured-banner {
            position: relative; height: 220px; margin: 15px; border-radius: 12px;
            overflow: hidden; display: flex; align-items: flex-end; padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); background: #111;
        }
        .featured-banner img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; filter: brightness(0.7); }
        .featured-content { position: relative; z-index: 2; }

        /* --- HOME GRID --- */
        .mobile-home-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .track-tile { background: var(--card-grey); border-radius: 8px; overflow: hidden; position: relative; }
        .track-tile img { width: 100%; aspect-ratio: 1; object-fit: cover; }
        .tile-content { padding: 10px; }
        .tile-title { display: block; font-weight: bold; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tile-label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; }

        /* --- PROGRESS BARS --- */
        .progress-container { width: 100%; height: 4px; background: #444; border-radius: 2px; position: relative; cursor: pointer; }
        .progress-fill { height: 100%; background: var(--accent-green); width: 0%; border-radius: 2px; box-shadow: 0 0 10px var(--accent-green); }

        /* --- NAVIGATION --- */
        .nav-item { color: var(--text-dim); text-align: center; font-size: 10px; cursor: pointer; flex: 1; transition: 0.2s; }
        .nav-item.active { color: white; text-shadow: var(--glow); }
        .nav-item .material-icons { display: block; font-size: 28px; margin-bottom: 2px; }

        /* --- FULL SCREEN PLAYER --- */
        #full-player {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, #333, #000);
            z-index: 2000; display: none; flex-direction: column;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.1, 0.7, 0.1, 1);
        }
        #full-player.active { display: flex; transform: translateY(0); }
        .fp-header { padding: 40px 20px 20px; display: flex; justify-content: space-between; align-items: center; }
        .fp-art { width: 85%; aspect-ratio: 1; margin: 20px auto; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .fp-meta { padding: 20px 30px; }
        #fp-artist { 
            color: var(--accent-green); 
            margin: 5px 0; 
            font-size: 18px; 
            text-shadow: 0 0 10px rgba(29, 185, 84, 0.5);
            cursor: pointer;
            display: inline-block;
        }

        #fp-progress {
    background: #ffffff !important;
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.6);
}

/* --- Default State (Not Playing) --- */
.track-row .track-title { color: white; }
.track-row .track-number { color: rgba(255,255,255,0.2); }
.track-row .track-artist { color: rgba(255,255,255,0.4); }
.track-row .track-duration { color: rgba(255,255,255,0.4); }

/* --- Active State (Now Playing) --- */

/* 1. Title, Number, and Duration go Full Accent Green */
.active-track .track-title,
.active-track .track-number,
.active-track .track-duration {
    color: var(--accent-green) !important;
}

/* 2. Artist gets the Tinted Green (Opacity 0.6) */
.active-track .track-artist {
    color: var(--accent-green) !important;
    opacity: 0.6 !important;
}

#fp-bg-visual {
    position: absolute;
    inset: 0;
    z-index: -2;
    background-size: cover;
    background-position: center;
    /* Use a simple overlay instead of a heavy blur if lag persists */
    filter: blur(40px) brightness(0.4); 
    opacity: 0.5;
    transition: background-image 0.5s ease;
}
        
        .fp-controls { display: flex; justify-content: space-around; align-items: center; padding: 20px; margin-top: auto; padding-bottom: 60px; }
        .play-btn-lg { background: white; color: black; border-radius: 50%; width: 75px; height: 75px; display: flex; align-items: center; justify-content: center; }
        .play-btn-lg:active { transform: scale(0.9); }

        .back-btn {
    width: 42px;
    height: 42px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.back-btn:active {
    transform: scale(0.9);
    background: rgba(255, 255, 255, 0.2);
}

        /* --- TABS --- */
        .lib-tabs { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid #222; }
        .tab { padding: 10px 0; color: var(--text-dim); cursor: pointer; font-weight: bold; }
        .tab.active { color: var(--accent-green); border-bottom: 2px solid var(--accent-green); }

        .glow-active { color: var(--accent-green) !important; filter: drop-shadow(0 0 8px var(--accent-green)) !important; }

        glow-active {
    color: var(--accent-green) !important;
    filter: drop-shadow(0 0 8px rgba(0, 255, 136, 0.8));
    transition: all 0.3s ease;
}
        .track-row.disabled { opacity: 0.3; pointer-events: none; }
        .view-animate { animation: fadeIn 0.3s ease-out; }

        /* The TRM Green Color Variable */
:root {
    --trm-green: #1DB954;
}

        /* Library Tab Container */
.library-tabs {
    display: flex;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 14px;
    padding: 4px;
    margin-bottom: 25px;
    border: var(--ios-border);
    position: relative;
}

.lib-tab {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px 0;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-dim);
    z-index: 2;
    transition: color 0.3s ease;
    cursor: pointer;
}

.lib-tab.active {
    color: #fff;
}

/* The Sliding Glow Indicator */
.tab-glow {
    position: absolute;
    height: calc(100% - 8px);
    width: calc(50% - 4px); /* Assuming 2 tabs */
    background: rgba(255, 255, 255, 0.15);
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
    border-radius: 11px;
    top: 4px;
    left: 4px;
    transition: transform 0.4s cubic-bezier(0.33, 1, 0.68, 1);
    z-index: 1;
}

.tab-2-active .tab-glow {
    transform: translateX(100%);
}

/* Track Art for Library Rows */
.lib-track-art {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    margin-right: 15px;
    object-fit: cover;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="content-view">
        <div style="padding: 100px 20px; text-align: center; color: var(--text-dim);">Loading TRM...</div>
    </div>

    <div id="mini-player" onclick="openFullPlayer()">
        <div class="mini-main">
            <img id="m-art" src="">
            <div style="flex:1; overflow:hidden;">
                <div id="m-title" style="font-weight:bold; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div>
                <div id="m-artist" style="font-size:12px; color:var(--text-dim);"></div>
            </div>
            <span class="material-icons" id="m-play-btn" onclick="event.stopPropagation(); togglePlay();" style="font-size:35px; padding:5px;">play_arrow</span>
        </div>
        <div class="progress-container" onclick="event.stopPropagation(); seek(event, this)">
            <div id="mini-progress" class="progress-fill"></div>
        </div>
    </div>

    <div id="full-player" style="display:none; flex-direction:column; background:#000; height:100vh; width:100vw; position:fixed; top:0; left:0; z-index:9999; overflow:hidden;">
        <div id="fp-bg-visual"></div>
        <div class="bg-glow" id="fp-glow"></div>

        <div class="fp-header" style="padding: 20px; display: flex; align-items: center; justify-content: space-between; z-index: 100;">
            <div class="back-btn" onclick="closeFullPlayer()">
                <span class="material-icons" style="font-size:32px; color: white;">expand_more</span>
            </div>
            <span style="font-size:10px; font-weight:800; letter-spacing:2px; opacity: 0.5; color: white;">NOW PLAYING</span>
            <span class="material-icons" id="fp-heart-icon" onclick="handleLikeClick()" style="font-size:26px; color: white;">favorite_border</span>
        </div>

<div id="fp-scroll-container" style="flex: 1; overflow-y: auto; padding: 0 30px; scrollbar-width: none;">
    <div style="padding: 5px 0; display: flex; justify-content: center;">
        <img id="fp-art" src="" style="width: 100%; aspect-ratio:1; object-fit: cover; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.6);">
    </div>

    <div class="fp-meta" style="margin-bottom: 20px;">
        <h1 id="fp-title" style="margin:0; font-size:28px; font-weight: 800; color: white; line-height: 1;"></h1>
        <p id="fp-artist" style="margin: 5px 0 0 0; font-size: 18px; font-weight: 500; color: var(--accent-green);"></p>
    </div>

    <div id="fp-lyrics-wrapper" onclick="openLyricsTab()" style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 100px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
    <div style="font-size: 10px; font-weight: 900; color: rgba(255,255,255,0.4); letter-spacing: 1px;">
        LYRICS
    </div>
    <div style="font-size: 10px; font-weight: 900; color: rgba(255,255,255,0.4); letter-spacing: 1px;">
        TAP TO EXPAND
    </div>
</div>
        <div id="fp-lyrics-text" style="font-size: 22px; font-weight: 700; color: white; white-space: pre-wrap;"></div>
    </div>
</div>

        <div id="lyrics-tab" style="display:none; position:absolute; inset:0; z-index:200; background: rgba(0,0,0,0.9); backdrop-filter: blur(40px); flex-direction: column; padding: 60px 40px;">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="color: white; margin:0; font-weight: 900;">Lyrics</h2>
                <span class="material-icons" onclick="closeLyricsTab()" style="font-size: 32px; color: white; cursor: pointer;">close</span>
            </div>
            <div id="fp-lyrics-full" style="flex: 1; overflow-y: auto; font-size: 28px; font-weight: 900; line-height: 1.5; color: white; white-space: pre-wrap; padding-bottom: 100px;"></div>
        </div>

        <div id="fp-bottom-controls" style="padding: 20px 40px 60px 40px; background: linear-gradient(to top, #000 90%, transparent); z-index: 150;">
            <div class="progress-container" onclick="seek(event, this)" style="height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px;">
                <div id="fp-progress" class="progress-fill" style="background: #fff; box-shadow: 0 0 15px rgba(255,255,255,0.6);"></div>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.4); margin-top: 12px;">
                <span id="time-cur">0:00</span>
                <span id="time-dur">0:00</span>
            </div>

            <div class="fp-controls" style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px;">
                <span class="material-icons" id="ctrl-shuffle" style="font-size:24px; color: white; opacity:0.6;" onclick="toggleShuffle()">shuffle</span>
                <span class="material-icons" style="font-size:48px; color: white;" onclick="prevTrack()">skip_previous</span>
                <div class="play-btn-lg" onclick="togglePlay()" style="background: white; color: black; width: 75px; height: 75px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(255,255,255,0.2);">
                    <span class="material-icons" id="fp-play-btn" style="font-size:45px;">play_arrow</span>
                </div>
                <span class="material-icons" style="font-size:48px; color: white;" onclick="nextTrack()">skip_next</span>
                <span class="material-icons" id="ctrl-repeat" style="font-size:24px; color: white; opacity:0.6;" onclick="toggleLoop()">repeat</span>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" id="nav-home" onclick="window.viewHome()">
            <span class="material-icons">home</span>Home
        </div>
        <div class="nav-item" id="nav-search" onclick="window.viewSearch()">
            <span class="material-icons">search</span>Search
        </div>
        <div class="nav-item" id="nav-lib" onclick="window.openPatchNotes()">
            <span class="material-icons">new_releases</span>Patch Notes
        </div>
    </nav>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const S_URL = 'https://sxagulxljpzftqfnllhv.supabase.co';
        const S_KEY = 'sb_publishable_GG1VzWph8ZCK2hCyZugMfA_qR6LZcRn';
        const supabaseClient = supabase.createClient(S_URL, S_KEY);

        window.ALBUMS = [];
        window.TRACKS = {};
        window.ARTISTS = {};
        window.SPOTLIGHTS = []; // Added this
        let currentTrackId = null;
        let currentArtistId = null;
        let isShuffle = false;
        let isRepeat = false;
        const audio = new Audio();
        const contentView = document.getElementById('content-view');

        // UPDATED STORAGE: Added try/catch for iPhone Private Mode safety
        window.STORAGE = {
    getLikes: () => {
        try {
            const data = localStorage.getItem('trm_likes');
            return (data && data !== "undefined") ? JSON.parse(data) : [];
        } catch(e) { 
            console.error("Storage Get Error", e);
            return window._likesFallback || []; 
        }
    },
    getRecent: () => {
        try {
            const data = localStorage.getItem('trm_recent');
            return (data && data !== "undefined") ? JSON.parse(data) : [];
        } catch(e) { 
            return window._recentFallback || []; 
        }
    },
    toggleLike: (id) => {
        let likes = window.STORAGE.getLikes();
        likes = likes.includes(id) ? likes.filter(x => x !== id) : [...likes, id];
        try { 
            localStorage.setItem('trm_likes', JSON.stringify(likes)); 
            window._likesFallback = likes; // Always sync fallback
        } catch(e) { 
            window._likesFallback = likes; 
            console.warn("Local Storage Full or Restricted");
        }
        return likes.includes(id);
    },
    addRecent: (id) => {
        let recent = window.STORAGE.getRecent().filter(x => x !== id);
        recent.unshift(id);
        const sliced = recent.slice(0, 20);
        try { 
            localStorage.setItem('trm_recent', JSON.stringify(sliced)); 
            window._recentFallback = sliced;
        } catch(e) { 
            window._recentFallback = sliced; 
        }
    }
};

        async function init() {
    try {
        const [
            { data: artists },
            { data: albumsData },
            { data: tracksData },
            { data: spotlightRows }
        ] = await Promise.all([
            supabaseClient.from('artists').select('*'),
            supabaseClient.from('albums').select('*'),
            supabaseClient.from('tracks').select('*'),
            // We fetch them, but we will handle the final sorting in JavaScript
            supabaseClient.from('spotlight').select('*').eq('active', true).limit(5)
        ]);

        // 2. PROCESS ARTISTS
        artists?.forEach(a => window.ARTISTS[a.id] = a);

        // 3. PROCESS SPOTLIGHTS (FIXED MAPPING)
        window.SPOTLIGHTS = (spotlightRows || []).map(row => ({
            type: row.type,
            orderId: row.id,         // The PK (1, 2, 3) for sorting
            targetId: row.target_id, // The slug (lc-xavier) for links
            url: row.url,
            customTitle: row.custom_title,
            customSub: row.custom_sub
        }));

        // 4. PROCESS ALBUMS
        const parseDate = (str) => {
            if (!str || str === 'RELEASED') return 0;
            const cleanDate = str.replace(/(\d+)(st|nd|rd|th)/, "$1");
            const timestamp = Date.parse(cleanDate);
            return isNaN(timestamp) ? 0 : timestamp;
        };
        window.ALBUMS = (albumsData || []).sort((a, b) => parseDate(b.full_release_date) - parseDate(a.full_release_date));

        // 5. PROCESS TRACKS
        const trackLookup = {};
        tracksData?.forEach(t => { trackLookup[t.id] = t; });
        window.TRACKS = {};
        window.ALBUMS.forEach(alb => {
            const manualOrder = alb.track_ids || []; 
            window.TRACKS[alb.id] = manualOrder.map(id => trackLookup[id]).filter(Boolean); 
        });

        window.viewHome();
        if (typeof handleDeepLinking === 'function') handleDeepLinking();

    } catch (err) { 
        console.error("Init Error:", err); 
    }
}
        function resetScroll() { contentView.scrollTo(0, 0); }

window.viewHome = function() {
    window.currentViewId = 'home';
    if (typeof resetScroll === 'function') resetScroll();
    if (typeof setNav === 'function') setNav(0);

// 1. DATA PREP
// Inside window.viewHome...
const publicCatalogue = (window.ALBUMS || []).filter(alb => !alb.hidden);

// Numerical Sort: 1 is first, 2 is second.
const spotlights = (window.SPOTLIGHTS || []).sort((a, b) => Number(a.orderId) - Number(b.orderId));
    const target = document.getElementById('content-view') || document.getElementById('contentView');
    if (!target) return;

    // 1. DYNAMIC RENDERER
const renderMobileSlide = (index) => {
    const s = spotlights[index];
    if (!s) return '';

    let displayImg = "";
    let displayTitle = s.customTitle || "";
    let tagText = "FEATURED";
    let action = "";

    if (s.type === "Release") {
        const alb = publicCatalogue.find(a => a.id === s.targetId);
        if (alb) {
            displayImg = alb.art_url;
            displayTitle = s.customTitle || alb.name;
            tagText = alb.coming_soon ? "COMING SOON" : "RELEASE"; // Fixed Tag
            action = `viewAlbum('${s.targetId}')`;
        }
    } 
    else if (s.type === "Artist") {
        const art = window.ARTISTS ? window.ARTISTS[s.targetId] : null;
        // Fix: Use banner_url for the spotlight
        displayImg = art ? (art.banner_url || art.img_url) : ""; 
        displayTitle = s.customTitle || (art ? art.name : "Artist");
        tagText = "ARTIST SPOTLIGHT"; // Fixed Tag
        action = `viewArtist('${s.targetId}')`;
    } 
    else if (s.type === "Track") {
        const parentAlbums = publicCatalogue.filter(a => a.track_ids && a.track_ids.includes(s.targetId));
        const publicOnly = parentAlbums.filter(a => !a.coming_soon);
        
        // Priority: Newest Public -> Newest Overall
        const latestAlb = (publicOnly.length > 0) 
            ? publicOnly.sort((a, b) => new Date(b.full_release_date) - new Date(a.full_release_date))[0]
            : parentAlbums.sort((a, b) => new Date(b.full_release_date) - new Date(a.full_release_date))[0];

        let trackData = null;
        if (latestAlb && window.TRACKS[latestAlb.id]) {
            const bucket = window.TRACKS[latestAlb.id];
            trackData = Array.isArray(bucket) ? bucket.find(t => t.id === s.targetId) : bucket[s.targetId];
        }

        if (trackData && latestAlb) {
            displayImg = trackData.art_url || latestAlb.art_url;
            displayTitle = s.customTitle || trackData.title;
            tagText = "TRACK HIGHLIGHT"; // Fixed Tag
            action = `viewAlbum('${latestAlb.id}'); setTimeout(() => { if(window.playTrack) window.playTrack('${s.targetId}'); }, 500);`;
        }
        } else if (s.type === "Video") {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = s.url ? s.url.match(regExp) : null;
            const vidId = (match && match[2].length == 11) ? match[2] : null;
            displayImg = vidId ? `https://img.youtube.com/vi/${vidId}/maxresdefault.jpg` : "";
            tagText = "FEATURED VIDEO";
            action = `window.open('${s.url}', '_blank')`;
        }

        if (!displayImg && publicCatalogue[0]) displayImg = publicCatalogue[0].art_url;

        return `
        <div class="mobile-spotlight-card spotlight-anim" onclick="${action}">
            <div class="mobile-spotlight-bg" style="background-image: url('${displayImg}')"></div>
            <div class="mobile-spotlight-content">
                <span class="mobile-tag">${tagText}</span>
                <h1 class="mobile-title">${displayTitle.toUpperCase()}</h1>
                ${spotlights.length > 1 ? `
                <div class="mobile-pill-container">
                    ${spotlights.map((_, i) => `
                        <div class="mobile-pill ${i === index ? 'active' : ''}"></div>
                    `).join('')}
                </div>` : ''}
            </div>
        </div>`;
    };

    // 2. NAVIGATION
    window.moveSpotlight = (dir) => {
        if (!spotlights.length) return;
        window.currentSpotlightIndex = ((window.currentSpotlightIndex || 0) + dir + spotlights.length) % spotlights.length;
        const slider = document.getElementById('spotlight-slider-inner');
        if (slider) {
            slider.innerHTML = renderMobileSlide(window.currentSpotlightIndex);
        }
    };

    // 3. INJECTION
    target.innerHTML = `
    <style>
        .spotlight-wrap { position: relative; margin: 15px; }
        .mobile-spotlight-card {
            position: relative; height: 260px; 
            border-radius: 16px; overflow: hidden; background: #000;
            display: flex; align-items: flex-end;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        .mobile-spotlight-bg {
            position: absolute; inset: 0; background-size: cover; background-position: center;
            filter: brightness(0.6); z-index: 1; transform: scale(1.05);
        }
        .mobile-spotlight-content { position: relative; z-index: 2; padding: 20px; width: 100%; }
        .mobile-tag { background: var(--accent-green); color: #000; font-size: 10px; font-weight: 900; padding: 4px 10px; border-radius: 4px; text-transform: uppercase; }
        .mobile-title { font-size: 32px; color: #fff; margin: 8px 0; font-weight: 900; letter-spacing: -1.2px; line-height: 0.85; }
        .mobile-pill-container { display: flex; gap: 5px; margin-top: 10px; }
        .mobile-pill { height: 4px; width: 12px; background: rgba(255,255,255,0.2); border-radius: 2px; transition: 0.3s; }
        .mobile-pill.active { width: 24px; background: var(--accent-green); }
        
        .m-nav {
            position: absolute; top: 50%; transform: translateY(-50%); z-index: 10;
            width: 32px; height: 32px; background: rgba(0,0,0,0.5); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: white;
            backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1);
        }
        .m-nav-prev { left: 10px; }
        .m-nav-next { right: 10px; }

        .spotlight-anim { animation: mSlideIn 0.3s ease-out; }
        @keyframes mSlideIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .mobile-home-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 0 15px 100px 15px; }
    </style>

    <div class="spotlight-wrap">
        ${spotlights.length > 1 ? `
            <div class="m-nav m-nav-prev" onclick="event.stopPropagation(); moveSpotlight(-1)"><span class="material-icons" style="font-size:18px;">chevron_left</span></div>
            <div class="m-nav m-nav-next" onclick="event.stopPropagation(); moveSpotlight(1)"><span class="material-icons" style="font-size:18px;">chevron_right</span></div>
        ` : ''}
        <div id="spotlight-slider-inner">
            ${renderMobileSlide(window.currentSpotlightIndex || 0)}
        </div>
    </div>

    <div style="padding: 10px 20px;">
        <h2 style="margin: 10px 0; font-weight: 900; font-size: 22px; letter-spacing: -0.5px; text-transform: uppercase;">Catalogue</h2>
    </div>
    
    <div class="mobile-home-grid">
        ${publicCatalogue.map(alb => {
            // Logic for the dynamic label: "TYPE • YEAR" or "TYPE • COMING SOON"
            const releaseYear = alb.full_release_date ? String(alb.full_release_date).split(' ').pop() : '';
            const type = (alb.type || 'Release').toUpperCase();
            
            let statusHtml = "";
            if (alb.coming_soon) {
                statusHtml = `<span style="color:var(--accent-green);">COMING SOON</span>`;
            } else {
                statusHtml = releaseYear || 'RELEASE';
            }

            return `
                <div class="track-tile view-animate" onclick="viewAlbum('${alb.id}')">
                    <img src="${alb.art_url}" style="width:100%; aspect-ratio:1; border-radius:12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); ${alb.coming_soon ? 'opacity:0.4; filter:grayscale(1)' : ''}">
                    <div style="padding: 10px 2px;">
                        <div style="font-weight:800; color:#fff; font-size:14px; line-height:1.2; margin-bottom:4px; text-transform:uppercase;">${alb.name}</div>
                        <div style="color:#999; font-size:10px; font-weight:800; text-transform:uppercase; letter-spacing:0.5px;">
                            ${type} • ${statusHtml}
                        </div>
                    </div>
                </div>
            `;
        }).join('')}
    </div>`;

    // 4. TOUCH SWIPE (Enhanced)
    const wrap = document.querySelector('.spotlight-wrap');
    if (wrap) {
        let xDown = null;
        wrap.addEventListener('touchstart', e => xDown = e.touches[0].clientX, {passive: true});
        wrap.addEventListener('touchend', e => {
            if (!xDown) return;
            let xUp = e.changedTouches[0].clientX;
            if (xDown - xUp > 60) window.moveSpotlight(1);
            if (xDown - xUp < -60) window.moveSpotlight(-1);
            xDown = null;
        }, {passive: true});
    }

    if (window.spotlightInterval) clearInterval(window.spotlightInterval);
    if (spotlights.length > 1) {
        window.spotlightInterval = setInterval(() => window.moveSpotlight(1), 7000);
    }
};

// Update this within your existing player update loop or openFullPlayer
window.updateFullPlayerUI = function(track) {
    document.getElementById('fp-art').src = track.art_url;
    document.getElementById('fp-title').innerText = track.title;
    document.getElementById('fp-artist').innerText = track.artist;
    
    const lyrics = track.lyrics || "No lyrics available.";
    document.getElementById('fp-lyrics-snippet').innerText = lyrics;
    document.getElementById('fp-lyrics-full').innerText = lyrics;
};

window.toggleNavUI = (show) => {
    const navBar = document.querySelector('.bottom-nav');
    const miniPlayer = document.getElementById('mini-player');

    if (show) {
        navBar.classList.remove('nav-hidden');
        // If nav shows, move miniplayer UP
        miniPlayer.classList.remove('nav-is-hidden');
    } else {
        navBar.classList.add('nav-hidden');
        // If nav hides, move miniplayer DOWN
        miniPlayer.classList.add('nav-is-hidden');
    }
};


window.viewArtist = (id) => {
    window.currentViewId = 'artist';
    if (typeof toggleNavUI === 'function') toggleNavUI(false); 
    contentView.scrollTo(0, 0);

    const artist = window.ARTISTS[id] || { 
        name: "therichmusic", 
        bio: "", 
        is_verified: false,
        banner_url: "",
        featured_video_url: "",
        socials: [] 
    };

    const artistAlbs = window.ALBUMS.filter(a => a.artist_id == id && !a.hidden);

    // --- 1. DESKTOP FEATURE: SOCIALS & VIDEO LOGIC ---
    const socialConfig = [
        { name: 'YouTube',   match: 'youtube.com',   icon: 'play_circle', color: '#FF0000' },
        { name: 'Instagram', match: 'instagram.com', icon: 'camera_alt',  color: '#E1306C' },
        { name: 'Twitter',   match: 'twitter.com',   icon: 'x',           color: '#ffffff' },
        { name: 'Twitter',   match: 'x.com',         icon: 'x',           color: '#ffffff' },
        { name: 'TikTok',    match: 'tiktok.com',    icon: 'music_note',  color: '#00f2ea' }
    ];

    const renderSocials = () => {
        if (!Array.isArray(artist.socials)) return '';
        let count = 0;
        return artist.socials.map(url => {
            if (count >= 4) return '';
            const platform = socialConfig.find(c => url.toLowerCase().includes(c.match));
            if (platform) {
                count++;
                return `
                    <a href="${url}" target="_blank" style="text-decoration:none; color:${platform.color}; background:rgba(255,255,255,0.08); width:42px; height:42px; border-radius:10px; display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,0.1);">
                        <span class="material-icons" style="font-size:20px;">${platform.icon}</span>
                    </a>`;
            }
            return '';
        }).join('');
    };

    const getEmbedUrl = (url) => {
        if(!url) return null;
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? `https://www.youtube-nocookie.com/embed/${match[2]}?rel=0` : null;
    };
    const embedUrl = getEmbedUrl(artist.featured_video_url);

    // --- 2. CATEGORIZATION LOGIC ---
    const albums = artistAlbs.filter(a => ['ALBUM', 'MIXTAPE'].includes((a.type || '').toUpperCase()));
    const singles = artistAlbs.filter(a => ['SINGLE', 'EP'].includes((a.type || '').toUpperCase()));
    const compilations = artistAlbs.filter(a => (a.type || '').toUpperCase() === 'COMPILATION');

    const renderGrid = (list) => {
        if (list.length === 0) return '';
        return `
            <div class="mobile-home-grid" style="margin-bottom: 30px;">
                ${list.map(a => `
                    <div class="track-tile" onclick="viewAlbum('${a.id}')" style="background: rgba(255,255,255,0.03); border-radius: 12px; overflow: hidden; border: 1px solid rgba(255,255,255,0.05);">
                        <div style="position: relative; line-height:0;">
                            <img src="${a.art_url}" style="width:100%; aspect-ratio:1; border-radius: 12px; object-fit:cover;">
                            ${a.coming_soon ? `<div style="position:absolute; top:12px; right:12px; background:var(--accent-green); color:black; font-size:12px; font-weight:900; padding:8px 10px; border-radius:12px;">SOON</div>` : ''}
                        </div>
                        <div class="tile-content" style="padding: 10px;">
                            <span class="tile-title" style="font-weight:800; font-size:13px; display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${a.name.toUpperCase()}</span>
                            <span class="tile-label" style="font-size:10px; color:rgba(255,255,255,0.4); font-weight:700;">${a.full_release_date ? a.full_release_date.split(' ').pop() : (a.type || 'RELEASE')}</span>
                        </div>
                    </div>
                `).join('')}
            </div>`;
    };

    // --- 3. FINAL UI RENDER ---
    let html = `
    <div class="view-animate" style="padding-bottom: 120px;">
        <div style="height:420px; position:relative; overflow:hidden; display: flex; align-items: flex-end;">
            <img src="${artist.banner_url || ''}" style="position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover;">
            <div style="position:absolute; inset:0; background: linear-gradient(to top, var(--bg-black) 5%, rgba(0,0,0,0.4) 60%, transparent 100%);"></div>
            
            <div onclick="viewHome(); toggleNavUI(true);" 
                 style="position: fixed; left: 20px; top: 40px; width: 40px; height: 40px; background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 100; border: 1px solid rgba(255,255,255,0.1);">
                <span class="material-icons" style="color: white;">chevron_left</span>
            </div>

            <div style="position:relative; padding: 30px 20px; width: 100%;">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom: 10px;">
                    ${artist.is_verified ? '<span style="background:#3897f0; color:white; font-size:10px; font-weight:900; padding:4px 10px; border-radius:20px; display:flex; align-items:center; gap:4px;"><span class="material-icons" style="font-size:12px;">verified</span> VERIFIED</span>' : ''}
                </div>
                <h1 style="font-size:48px; margin:0; font-weight:900; letter-spacing:-2px; line-height:0.9; text-transform:uppercase; color:white;">${artist.name}</h1>
                <p style="color:rgba(255,255,255,0.7); margin:15px 0 20px; font-size:14px; line-height:1.5; font-weight:500; max-width:90%;">
                    ${artist.bio || 'Official TRM Records Artist.'}
                </p>
                
                <div style="display: flex; gap: 10px;">
                    ${renderSocials()}
                </div>
            </div>
        </div>

        <div class="standard-padding" style="margin-top: 30px;">
            
            ${albums.length > 0 ? `
                <h3 style="text-transform:uppercase; letter-spacing:1px; font-size:12px; margin-bottom:15px; color:var(--accent-green); font-weight:900;">Albums & Mixtapes</h3>
                ${renderGrid(albums)}
            ` : ''}

            ${singles.length > 0 ? `
                <h3 style="text-transform:uppercase; letter-spacing:1px; font-size:12px; margin-bottom:15px; color:var(--accent-green); font-weight:900;">Singles & EPs</h3>
                ${renderGrid(singles)}
            ` : ''}

            ${embedUrl ? `
                <div style="margin: 40px 0;">
                    <h3 style="text-transform:uppercase; letter-spacing:1px; font-size:12px; margin-bottom:15px; color:rgba(255,255,255,0.4); font-weight:900;">Featured Video</h3>
                    <div style="position: relative; width: 100%; padding-top: 56.25%; border-radius: 12px; overflow: hidden; background:#000; border: 1px solid rgba(255,255,255,0.1);">
                        <iframe style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" src="${embedUrl}" frameborder="0" allowfullscreen></iframe>
                    </div>
                </div>
            ` : ''}

            ${compilations.length > 0 ? `
                <h3 style="text-transform:uppercase; letter-spacing:1px; font-size:12px; margin-bottom:15px; color:var(--accent-green); font-weight:900;">Compilations</h3>
                ${renderGrid(compilations)}
            ` : ''}

        </div>
    </div>`;

    contentView.innerHTML = html;
};

// Listen for when a song finishes naturally
audio.onended = () => {
    // 1. Try to play the next track
    const hasNext = window.nextTrack();
    
    // 2. If nextTrack returns false, the album is over
    if (!hasNext) {
        console.log("Album finished. Resetting state...");
        
        // Reset Logic
        audio.currentTime = 0;
        window.isPlaying = false;
        
        // UI Reset: Mini Player & Full Player buttons
        ['m-play-btn', 'fp-play-btn'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.innerText = 'play_arrow';
        });

        // UI Reset: Mini Player "paused" state
        const miniPlayer = document.getElementById('mini-player');
        if (miniPlayer) miniPlayer.classList.add('paused');

        // UI Reset: Clear the active green highlight in the list
        if (window.currentViewId === 'album') {
            document.querySelectorAll('.track-row').forEach(row => {
                row.classList.remove('active-track');
                const icon = row.querySelector('.track-play-icon');
                if (icon) icon.innerText = 'play_arrow';
            });
        }
        
        // Optional: Close full player on finish
        // if (window.isFullPlayerOpen) window.toggleFullPlayer(false);
    }
};

window.viewAlbum = (id, scrollToTop = true) => {
    window.currentViewId = 'album';
    if (typeof toggleNavUI === 'function') toggleNavUI(false); 

    const alb = window.ALBUMS.find(a => a.id == id);
    if (!alb) return window.viewHome();

    const artist = window.ARTISTS[alb.artist_id] || { name: "therichmusic", id: "" };
    const tks = window.TRACKS[id] || [];

    // --- 1. DATA VALIDATION FOR IDs ---
    const isComingSoon = alb.coming_soon === true || alb.coming_soon === "true";
    const trailerUrl = alb.trailer_url || null;
    const releaseDateRaw = alb.full_release_date || null;

    // --- 2. RELEASE DATE FORMATTING ---
    const dateLabel = isComingSoon ? "RELEASING" : "RELEASED";
    let finalDateDisplay = "";
    
    if (releaseDateRaw) {
        const rawDate = String(releaseDateRaw).trim();
        if (/^\d{4}$/.test(rawDate)) {
            finalDateDisplay = rawDate;
        } else {
            const cleanedDate = rawDate.replace(/(\d+)(st|nd|rd|th)/, "$1");
            const dateObj = new Date(cleanedDate);
            if (!isNaN(dateObj)) {
                finalDateDisplay = dateObj.toLocaleDateString(undefined, {
                    year: 'numeric', month: 'long', day: 'numeric'
                });
            } else {
                finalDateDisplay = rawDate; // Fallback to raw string if parsing fails
            }
        }
    }

    const isThisAlbumActive = (window.currentAlbumId === id);
    const isCurrentlyPlaying = isThisAlbumActive && window.isPlaying;
    const playIcon = isCurrentlyPlaying ? 'pause' : 'play_arrow';

    let html = `
    <div class="${scrollToTop ? 'view-animate' : ''}" style="padding-bottom: 140px; color: white;">
        
        <div style="padding: 60px 20px 30px; text-align:center; position: relative;">
            
            <div onclick="viewHome(); toggleNavUI(true);" 
                 style="position: absolute; left: 20px; top: 40px; width: 42px; height: 42px; background: rgba(0,0,0,0.7); backdrop-filter: blur(15px); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.1); z-index: 10;">
                <span class="material-icons" style="font-size: 24px;">chevron_left</span>
            </div>

            <div style="position:relative; display: inline-block;">
                <img src="${alb.art_url}" style="width:240px; aspect-ratio:1; border-radius: 20px; box-shadow: 0 25px 50px rgba(0,0,0,0.8); object-fit: cover;">
                
                ${trailerUrl ? `
                    <div onclick="window.open('${trailerUrl}', '_blank')" 
                         style="position:absolute; bottom: -10px; right: -10px; background:#ff0000; width:52px; height:52px; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow: 0 6px 20px rgba(255,0,0,0.5); border: 4px solid #000; cursor: pointer; z-index: 5;">
                        <span class="material-icons" style="color:white; font-size:28px;">smart_display</span>
                    </div>
                ` : ''}
            </div>
            
            <h1 style="margin: 35px 0 12px; font-size: 38px; font-weight: 900; letter-spacing: -2px; line-height: 0.85; text-transform: uppercase;">${alb.name}</h1>
            
            <div style="display:flex; flex-direction: column; align-items:center; gap:14px;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <p style="color:var(--accent-green); font-weight: 900; margin:0; font-size: 19px; letter-spacing: 1px; text-transform: uppercase;" onclick="viewArtist('${alb.artist_id}')">
                        ${artist.name}
                    </p>
                    <div onclick="copyAlbumLink('${alb.id}')" style="background:rgba(255,255,255,0.1); width:38px; height:38px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor: pointer;">
                         <span class="material-icons" style="font-size:18px;">ios_share</span>
                    </div>
                </div>

                <button onclick="playAlbum('${alb.id}')" style="margin: 10px 0; background:white; border:none; width:68px; height:68px; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow: 0 10px 25px rgba(0,0,0,0.5);">
                    <span class="material-icons" style="font-size:44px; color:black;">${playIcon}</span>
                </button>

                ${finalDateDisplay ? `
                <div style="font-size: 12px; font-weight: 800; color: rgba(255,255,255,0.4); letter-spacing: 1.2px; text-transform: uppercase;">
                    ${tks.length} SONGS • ${dateLabel} ${finalDateDisplay}
                </div>
                ` : ''}
            </div>
        </div>

        <div style="padding: 0 20px;">
           ${tks.map((t, i) => {
    if (t.hidden_name) return ''; 
    
    const isPlayable = !isComingSoon || (t.album_id && t.album_id.split(',').some(aid => {
        const other = window.ALBUMS.find(a => a.id == aid.trim());
        return other && !other.coming_soon;
    }));

    const trackNumber = i + 1;
    const displayTitle = isPlayable ? t.title : `TRACK ${trackNumber}`;
    // Add the active-track class right here during render if it's already playing
    const isActive = (window.currentTrackId === t.id && window.currentAlbumId === id);

    return `
    <div class="track-row ${isActive ? 'active-track' : ''}" 
         data-id="${t.id}"
         style="display:flex; align-items: center; padding: 16px 0; border-bottom: 1px solid rgba(255,255,255,0.05); ${!isPlayable ? 'opacity:0.3;' : 'cursor:pointer;'}" 
         ${isPlayable ? `onclick="playTrack('${t.id}', true, '${alb.id}')"` : ''}>
        
        <div class="track-number" style="width: 38px; font-size: 14px; font-weight: 900;">
            ${isActive ? '<span class="material-icons" style="font-size: 18px;">volume_up</span>' : trackNumber}
        </div>
        
        <div style="flex:1; overflow: hidden;">
            <div class="track-title" style="font-weight:800; font-size: 17px; text-transform: uppercase; white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">
                ${displayTitle}
            </div>
            <div class="track-artist" style="font-size:12px; font-weight: 800; text-transform: uppercase;">
                ${isPlayable ? artist.name : 'COMING SOON'}
            </div>
        </div>
        
        <div class="track-duration" style="font-size: 12px; font-weight: 800; font-family: monospace;">
            ${isPlayable ? (t.duration || '0:00') : '--:--'}
        </div>
    </div>`;
}).join('')}
        </div>
    </div>`;

    contentView.innerHTML = html;
    if (scrollToTop) contentView.scrollTop = 0;
};

window.playTrack = (trackId, autoPlay = true, explicitAlbumId = null) => {
    const allTracks = Object.values(window.TRACKS).flat();
    const track = allTracks.find(t => t.id === trackId);
    if (!track) return;

    // 1. SILENT SECURITY CHECK
    const parentIds = track.album_id.split(',').map(s => s.trim());
    const isReleasedSomewhere = window.ALBUMS.some(a => parentIds.includes(a.id) && !a.coming_soon);
    
    if (!isReleasedSomewhere) {
        if (window.showTRMToast) window.showTRMToast("Coming Soon", "#ffcc00");
        return; 
    }

    // 2. RESOLVE IDENTITY
    const albId = explicitAlbumId || window.currentAlbumId || parentIds[0];
    const targetAlbum = window.ALBUMS.find(a => a.id == albId);
    if (!targetAlbum) return;

    const artistName = window.ARTISTS[targetAlbum.artist_id]?.name || "TRM";

    // 3. GLOBAL STATE SYNC
    window.currentTrackId = trackId;
    window.currentAlbumId = albId;
    window.currentArtistId = targetAlbum.artist_id;
    window.isPlaying = autoPlay;

    // 4. AUDIO SOURCE
    if (audio.src !== track.url) {
        audio.src = track.url;
        audio.load();
    }

    // 5. PLAYER UI UPDATES
    const uiUpdates = {
        'm-title': track.title, 'fp-title': track.title,
        'm-artist': artistName, 'fp-artist': artistName
    };

    for (const [id, val] of Object.entries(uiUpdates)) {
        const el = document.getElementById(id);
        if (el) el.innerText = val;
    }

    ['m-art', 'fp-art'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.src = targetAlbum.art_url;
    });

    ['m-play-btn', 'fp-play-btn'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerText = autoPlay ? 'pause' : 'play_arrow';
    });

    // Update Full Player Heart Icon state immediately on play
    const isLiked = window.STORAGE ? window.STORAGE.getLikes().includes(trackId) : false;
    const fpHeart = document.getElementById('fp-heart-icon');
    if (fpHeart) {
        fpHeart.innerText = isLiked ? 'favorite' : 'favorite_border';
        fpHeart.style.color = isLiked ? 'var(--accent-green)' : 'white';
    }

    const bgVisual = document.getElementById('fp-bg-visual');
    if (bgVisual) bgVisual.style.backgroundImage = `url('${targetAlbum.art_url}')`;

    const miniPlayer = document.getElementById('mini-player');
    if (miniPlayer) {
        miniPlayer.style.display = 'flex';
        miniPlayer.classList.toggle('paused', !autoPlay);
        miniPlayer.classList.add('mini-active');
    }

    // 6. MEDIA SESSION
    if ('mediaSession' in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
            title: track.title, artist: artistName, album: targetAlbum.name,
            artwork: [{ src: targetAlbum.art_url, sizes: '512x512', type: 'image/png' }]
        });
    }

    // 7. PERSISTENCE (Hardened for iOS)
const saveToRecent = (id) => {
        try {
            // Priority 1: Use the official helper if available
            if (window.STORAGE && typeof window.STORAGE.addRecent === 'function') {
                window.STORAGE.addRecent(id);
            } else {
                // Priority 2: Direct Manual Write (Safety Net)
                let recent = JSON.parse(localStorage.getItem('trm_recent') || '[]');
                // Remove existing instance to move it to the top
                recent = recent.filter(x => x !== id);
                recent.unshift(id);
                // Keep only the last 20 tracks
                localStorage.setItem('trm_recent', JSON.stringify(recent.slice(0, 20)));
            }
        } catch (e) {
            console.error("Tracking failed:", e);
        }
    };

    saveToRecent(trackId);
    localStorage.setItem('trm_last_track', trackId);

    // 8. EXECUTION
    if (autoPlay) {
        audio.play().catch(e => console.log("Playback interaction required"));
    }

    // 9. THE UI FIX: HIGHLIGHTS
    if (window.currentViewId === 'album') {
        const trackRows = document.querySelectorAll('.track-row');
        trackRows.forEach(row => {
            const rowTrackId = row.getAttribute('data-id') || row.getAttribute('onclick')?.match(/'([^']+)'/)?.[1];
            if (rowTrackId === trackId) {
                row.classList.add('active-track');
                const icon = row.querySelector('.track-play-icon');
                if (icon) icon.innerText = autoPlay ? 'pause' : 'play_arrow';
            } else {
                row.classList.remove('active-track');
                const icon = row.querySelector('.track-play-icon');
                if (icon) icon.innerText = 'play_arrow';
            }
        });
    }
    
    // Auto-refresh Library if playing from there
    if (window.currentViewId === 'library' && window.lastActiveTab === 'recent') viewLibrary('recent');
};
        window.goToCurrentArtist = () => {
            if (currentArtistId) {
                closeFullPlayer();
                viewArtist(currentArtistId);
            }
        };

window.viewSearch = () => {
    window.currentViewId = 'search';
    contentView.scrollTo(0, 0);
    setNav(1); // Assuming 1 is Search index
    
    contentView.innerHTML = `
        <div class="standard-padding view-animate">
            <h1 style="font-size: 34px; font-weight: 800; margin-bottom: 20px; letter-spacing: -1px;">Search</h1>
            <div style="position: sticky; top: 0; background: var(--bg-black); padding: 10px 0; z-index: 10;">
                <input type="text" id="mSearch" placeholder="Artists, Albums, or Songs" 
                       oninput="runSearch(this.value)" autocomplete="off">
            </div>
            <div id="mResults"></div>
        </div>`;
    
    // Focus search bar automatically
    setTimeout(() => document.getElementById('mSearch').focus(), 100);
};

window.runSearch = (q) => {
    const res = document.getElementById('mResults');
    if (!q || q.trim().length < 1) { res.innerHTML = ''; return; }
    
    const query = q.toLowerCase();
    
    // 1. Artists
    const artMatch = Object.values(window.ARTISTS).filter(a => 
        a.name.toLowerCase().includes(query)
    );

    // 2. Albums: Must not be hidden
    const albMatch = window.ALBUMS.filter(a => 
        a.name.toLowerCase().includes(query) && a.hidden !== true
    );

    // 3. Tracks: Inherited Hiding Logic
    const trkMatch = [];
    Object.keys(window.TRACKS).forEach(albumId => {
        const album = window.ALBUMS.find(a => a.id === albumId);
        
        // Skip this entire album's tracks if the album itself is hidden
        if (album && album.hidden === true) return; 

        window.TRACKS[albumId].forEach(t => {
            const matchesQuery = t.title.toLowerCase().includes(query);
            
            // Track is only visible if it's NOT hidden AND its album is NOT hidden
            // (The album check is handled by the 'return' above, but we keep t.hidden_name here)
            if (matchesQuery && t.hidden_name !== true) {
                trkMatch.push({
                    ...t,
                    albumArt: album ? album.art_url : 'https://via.placeholder.com/150',
                    albumId: albumId,
                    artistName: window.ARTISTS[album?.artist_id]?.name || 'Unknown Artist'
                });
            }
        });
    });

    let html = '';

    // Render Artists
    if (artMatch.length > 0) {
        html += `<div class="search-section-label">Artists</div>`;
        artMatch.forEach(a => {
            html += `
            <div class="result-item" onclick="viewArtist('${a.id}')">
                <img src="${a.banner_url || 'https://via.placeholder.com/150'}" style="width:55px; height:55px; border-radius:50%; object-fit:cover; margin-right:15px; border: var(--ios-border);">
                <div>
                    <div style="font-weight:bold; font-size:17px;">${a.name}</div>
                    <div style="font-size:12px; color:var(--accent-green); font-weight:700;">ARTIST</div>
                </div>
            </div>`;
        });
    }

    // Render Albums
    if (albMatch.length > 0) {
        html += `<div class="search-section-label">Albums</div>`;
        albMatch.forEach(a => {
            html += `
            <div class="result-item" onclick="viewAlbum('${a.id}')">
                <img src="${a.art_url}" style="width:55px; height:55px; border-radius:12px; object-fit:cover; margin-right:15px;">
                <div>
                    <div style="font-weight:bold; font-size:17px;">${a.name}</div>
                    <div style="font-size:12px; color:var(--text-dim);">ALBUM</div>
                </div>
            </div>`;
        });
    }

    // Render Tracks
    if (trkMatch.length > 0) {
        html += `<div class="search-section-label">Songs</div>`;
        trkMatch.forEach(t => {
            html += `
            <div class="result-item" onclick="playTrack('${t.id}', true, '${t.albumId}')">
                <img src="${t.albumArt}" style="width:55px; height:55px; border-radius:8px; object-fit:cover; margin-right:15px;">
                <div style="flex:1;">
                    <div style="font-weight:bold; font-size:17px;">${t.title}</div>
                    <div style="font-size:12px; color:var(--text-dim);">SONG • ${t.artistName}</div>
                </div>
                <span class="material-icons" style="color:var(--text-dim); font-size:20px;">more_horiz</span>
            </div>`;
        });
    }

    res.innerHTML = html || `<div style="text-align:center; margin-top:50px; color:var(--text-dim);">No results for "${q}"</div>`;
};

window.deepLinkCheckCount = 0;
window.handleDeepLinking = () => {
    let startTime = Date.now();
    const duration = 2000; // Spam for 2 seconds

    console.log("Deep Link: Background spam started...");

    const spamCheck = setInterval(() => {
        // 1. Check URL (Hash or Param)
        const urlParams = new URLSearchParams(window.location.search);
        let albId = urlParams.get('album') || window.location.hash.replace('#', '');

        // 2. Check if we've run out of time
        if (Date.now() - startTime > duration) {
            clearInterval(spamCheck);
            console.log("Deep Link: No ID found, stalling out.");
            return;
        }

        // 3. If we find an ID, try to process it
        if (albId) {
            // Ensure data is ready before proceeding
            if (window.ALBUMS && window.ALBUMS.length > 0) {
                const albumExists = window.ALBUMS.find(a => String(a.id) === String(albId));
                
                if (albumExists) {
                    clearInterval(spamCheck); // STOP SPAMMING
                    console.log("Deep Link: Found ID!", albId);
                    window.viewAlbum(albId);
                    
                    // Cleanup URL so refresh doesn't trigger it again
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
        }
    }, 100); // Check every 100ms

    // Bridge Listener (Keep this as a backup for the Fourthwall iframe message)
    const bridgeListener = (event) => {
        if (event.data && event.data.type === 'SET_ALBUM') {
            window.removeEventListener('message', bridgeListener);
            clearInterval(spamCheck); // Stop the spammer if the bridge wins
            window.viewAlbum(event.data.id);
        }
    };
    window.addEventListener('message', bridgeListener);
    
    // Cleanup bridge listener after 2 seconds too
    setTimeout(() => window.removeEventListener('message', bridgeListener), duration);
};

window.copyAlbumLink = (albumId) => {
    const alb = window.ALBUMS.find(a => a.id === albumId);
    const artist = window.ARTISTS[alb?.artist_id] || { name: "TRM Records" };
    
    // Aligned with Desktop baseUrl
    const baseUrl = "https://trm-brand-shop.fourthwall.com/pages/music-player"; 
    const shareUrl = `${baseUrl}#${albumId}`;

    const shareData = {
        title: alb ? alb.name.toUpperCase() : 'TRM Music',
        text: `Check out ${alb?.name} by ${artist.name} on TRM`,
        url: shareUrl
    };

    // Use Native Share if possible, fallback to Toast + Clipboard
    if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
        navigator.share(shareData).catch(err => {
            if (err.name !== "AbortError") copyToClipboardFallback(shareUrl);
        });
    } else {
        copyToClipboardFallback(shareUrl);
    }
};

// The Fallback function with a built-in "TRM Toast"
function copyToClipboardFallback(text) {
    const performCopy = () => {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            return navigator.clipboard.writeText(text);
        } else {
            // Older iOS fix
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            const successful = document.execCommand('copy');
            document.body.removeChild(textArea);
            return successful ? Promise.resolve() : Promise.reject();
        }
    };

    performCopy().then(() => {
        showTRMToast("Link copied to clipboard");
    }).catch(() => {
        showTRMToast("Failed to copy link", "#ff4444");
    });
}

// Lightweight TRM-styled notification
function showTRMToast(msg, color = "var(--accent-green)") {
    // Remove existing toast if user spams the button
    const oldToast = document.getElementById('trm-toast');
    if (oldToast) oldToast.remove();

    const toast = document.createElement('div');
    toast.id = 'trm-toast';
    // Styling to match your RICH aesthetic
    Object.assign(toast.style, {
        position: 'fixed',
        bottom: '100px', // Sits above the mobile nav
        left: '50%',
        transform: 'translateX(-50%)',
        background: 'rgba(0,0,0,0.8)',
        backdropFilter: 'blur(10px)',
        webkitBackdropFilter: 'blur(10px)',
        color: 'white',
        padding: '12px 24px',
        borderRadius: '12px',
        fontSize: '13px',
        fontWeight: '800',
        zIndex: '1000000',
        border: `1px solid ${color}`,
        boxShadow: '0 10px 30px rgba(0,0,0,0.5)',
        textTransform: 'uppercase',
        letterSpacing: '1px',
        pointerEvents: 'none',
        transition: 'all 0.3s ease'
    });

    toast.innerText = msg;
    document.body.appendChild(toast);

    // Fade out and remove
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.bottom = '90px';
        setTimeout(() => toast.remove(), 300);
    }, 2500);
}

window.togglePlay = () => {
    // 1. If no song is loaded, do nothing
    if (!audio.src || audio.src === "" || audio.src.includes('null')) return;

    const mBtn = document.getElementById('m-play-btn');
    const fBtn = document.getElementById('fp-play-btn');
    const miniPlayer = document.getElementById('mini-player');

    // 2. The actual toggle logic
    if (audio.paused) {
        audio.play().catch(e => console.log("Play failed"));
        if (mBtn) mBtn.innerText = 'pause';
        if (fBtn) fBtn.innerText = 'pause';
        if (miniPlayer) miniPlayer.classList.remove('paused'); // Expands art
    } else {
        audio.pause();
        if (mBtn) mBtn.innerText = 'play_arrow';
        if (fBtn) fBtn.innerText = 'play_arrow';
        if (miniPlayer) miniPlayer.classList.add('paused'); // Shrinks art
    }
};

// --- PROGRESS & TIME LOGIC ---
audio.ontimeupdate = function() {
    if (isNaN(audio.duration)) return;

    const percent = (audio.currentTime / audio.duration) * 100;
    
    // Update Mini Player Bar
    const miniBar = document.getElementById('mini-progress');
    if (miniBar) miniBar.style.width = percent + "%";

    // Update Full Player Bar
    const fpBar = document.getElementById('fp-progress');
    if (fpBar) fpBar.style.width = percent + "%";

    // Update Time Text
    const curTimeText = document.getElementById('time-cur');
    if (curTimeText) curTimeText.innerText = formatTime(audio.currentTime);
};

audio.onloadedmetadata = function() {
    const durText = document.getElementById('time-dur');
    if (durText) durText.innerText = formatTime(audio.duration);
};

audio.onplay = () => {
    if ('mediaSession' in navigator) {
        navigator.mediaSession.playbackState = "playing";
    }
};

audio.onpause = () => {
    if ('mediaSession' in navigator) {
        navigator.mediaSession.playbackState = "paused";
    }
};

function formatTime(sec) {
    if (isNaN(sec)) return "0:00";
    const m = Math.floor(sec / 60);
    const s = Math.floor(sec % 60);
    return `${m}:${s < 10 ? '0' : ''}${s}`;
}

window.seek = (e, el) => {
    if (!audio.duration) return;
    const rect = el.getBoundingClientRect();
    const per = (e.clientX - rect.left) / rect.width;
    audio.currentTime = per * audio.duration;
};

// --- CONTROLS & UTILS ---
window.handleLikeClick = () => { 
    if(!currentTrackId) return; 
    STORAGE.toggleLike(currentTrackId); 
    updateFpFavIcon(); 
};

function updateFpFavIcon() { 
    const isLiked = STORAGE.getLikes().includes(currentTrackId); 
    const icon = document.getElementById('m-fav-btn'); 
    if (icon) {
        icon.innerText = isLiked ? 'favorite' : 'favorite_border'; 
        icon.classList.toggle('glow-active', isLiked);
    }
}

window.toggleShuffle = () => { 
    isShuffle = !isShuffle; 
    document.getElementById('ctrl-shuffle').classList.toggle('glow-active', isShuffle); 
};

window.toggleLoop = () => { 
    isRepeat = !isRepeat; 
    audio.loop = isRepeat; 
    document.getElementById('ctrl-repeat').classList.toggle('glow-active', isRepeat); 
};

function setNav(idx) { 
    const ids = ['nav-home', 'nav-search', 'nav-lib']; 
    ids.forEach((id, i) => { 
        const el = document.getElementById(id); 
        if(el) el.classList.toggle('active', i === idx); 
    }); 
}

window.openFullPlayer = function() {
    const fp = document.getElementById('full-player');
    const mini = document.getElementById('mini-player');
    const scrollCont = document.getElementById('fp-scroll-container');
    
    let targetTrack = null;
    let albumArtFallback = "";

   let albumArtistId = ""; // Initialize this at the top
    
    if (window.ALBUMS) {
        for (const album of window.ALBUMS) {
            if (album.track_ids && album.track_ids.includes(window.currentTrackId)) {
                albumArtFallback = album.art_url;
                albumArtistId = album.artist_id; // Store this here!
                
                // Navigate the nested structure: window.TRACKS[album_id]
                const albumBucket = window.TRACKS ? window.TRACKS[album.id] : null; 
                
                if (albumBucket) {
                    if (Array.isArray(albumBucket)) {
                        targetTrack = albumBucket.find(t => t.id === window.currentTrackId);
                    } else {
                        targetTrack = albumBucket[window.currentTrackId];
                    }
                }
                break;
            }
        }
    }

// 2. UI INJECTION
    if (targetTrack) {
        document.getElementById('fp-title').innerText = targetTrack.title || "Unknown Track";
        
        const artistEl = document.getElementById('fp-artist');
        artistEl.innerText = targetTrack.artist || "therichmusic";
        
        // Restore Artist View functionality
        // We pull the artist_id from the targetTrack or the album we found
        const artistId = targetTrack.artist_id || albumArtistId; // Ensure you capture album.artist_id in step 1
        
        artistEl.onclick = () => {
            if (typeof window.viewArtist === 'function' && artistId) {
                closeFullPlayer();
                window.viewArtist(artistId);
            }
        };

        document.getElementById('fp-art').src = targetTrack.art_url || albumArtFallback || document.getElementById('m-art').src;

        const lyrics = targetTrack.lyrics || "Instrumental\n(No lyrics available)";
document.getElementById('fp-lyrics-text').innerHTML = lyrics;
document.getElementById('fp-lyrics-full').innerHTML = lyrics;
    }

    // 3. HEART SYNC
    const isLiked = window.STORAGE?.getLikes().includes(window.currentTrackId);
    const fpHeart = document.getElementById('fp-heart-icon');
    if (fpHeart) {
        fpHeart.innerText = isLiked ? 'favorite' : 'favorite_border';
        fpHeart.style.color = isLiked ? 'var(--accent-green)' : 'white';
    }

    // 4. SHOW & ANIMATE
    if (scrollCont) scrollCont.scrollTop = 0;
    fp.style.display = 'flex';
    requestAnimationFrame(() => {
        fp.classList.add('active');
        setTimeout(() => {
            if(fp.classList.contains('active')) {
                mini.style.opacity = '0';
                mini.style.pointerEvents = 'none';
            }
        }, 500);
    });
};

// Lyrics Focus Tab Toggle
window.openLyricsTab = () => { 
    const tab = document.getElementById('lyrics-tab');
    if (tab) {
        tab.style.display = 'flex';
        document.getElementById('fp-lyrics-full').scrollTop = 0;
    }
};

window.closeLyricsTab = () => { 
    const tab = document.getElementById('lyrics-tab');
    if (tab) tab.style.display = 'none'; 
};

window.openLyricsTab = () => { document.getElementById('lyrics-tab').style.display = 'flex'; };
window.closeLyricsTab = () => { document.getElementById('lyrics-tab').style.display = 'none'; };

function closeFullPlayer() {
    const fp = document.getElementById('full-player');
    const mini = document.getElementById('mini-player');
    
    fp.classList.remove('active');
    mini.style.opacity = '1';
    mini.style.pointerEvents = 'auto';
    
    // Hide display after transition finishes
    setTimeout(() => {
        if(!fp.classList.contains('active')) fp.style.display = 'none';
    }, 500);
}

window.nextTrack = () => {
    const album = window.ALBUMS.find(a => a.id === window.currentAlbumId);
    if (!album || !window.TRACKS[album.id]) return false;

    const trackList = window.TRACKS[album.id];
    let currentIndex = trackList.findIndex(t => t.id === window.currentTrackId);

    // Look for the next playable track (skipping 'Coming Soon' ones)
    for (let i = currentIndex + 1; i < trackList.length; i++) {
        const t = trackList[i];
        
        // Parity Security Check
        const parentIds = t.album_id.split(',').map(s => s.trim());
        const isReleased = window.ALBUMS.some(a => parentIds.includes(a.id) && !a.coming_soon);

        if (isReleased) {
            window.playTrack(t.id, true, album.id);
            return true; // Found a song!
        }
    }

    return false; // Reached the end of the line
};

window.prevTrack = () => {
    if (audio.currentTime > 3) {
        audio.currentTime = 0;
        return;
    }

    const album = window.ALBUMS.find(a => a.id === window.currentAlbumId);
    if (!album || !window.TRACKS[album.id]) return;

    const trackList = window.TRACKS[album.id];
    let currentIndex = trackList.findIndex(t => t.id === window.currentTrackId);

    if (currentIndex > 0) {
        const prevTrack = trackList[currentIndex - 1];
        window.playTrack(prevTrack.id, true, album.id);
    } else {
        audio.currentTime = 0; // First track in album, just restart
    }
};

window.STORAGE = {
    // Helper to safely get data
    get: (key) => {
        try {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
        } catch (e) {
            console.error("Storage Read Error:", e);
            return [];
        }
    },
    // Helper to safely set data
    set: (key, value) => {
        try {
            localStorage.setItem(key, JSON.stringify(value));
        } catch (e) {
            console.error("Storage Write Error (Quota exceeded?):", e);
        }
    },
    getLikes: function() { return this.get('trm_likes'); },
    getRecent: function() { return this.get('trm_recent'); },
    
    toggleLike: function(id) {
        let likes = this.getLikes();
        if (likes.includes(id)) {
            likes = likes.filter(itemId => itemId !== id);
        } else {
            likes.unshift(id);
        }
        this.set('trm_likes', likes);
        return likes.includes(id);
    },
    
    addRecent: function(id) {
        let recent = this.getRecent();
        recent = [id, ...recent.filter(itemId => itemId !== id)].slice(0, 50);
        this.set('trm_recent', recent);
    }
};

window.viewLibrary = (activeTab = 'liked') => {
    window.currentViewId = 'library';
    window.lastActiveTab = activeTab; 
    if (typeof resetScroll === 'function') resetScroll();
    if (typeof setNav === 'function') setNav(2); 

    // Guard against missing data
    if (!window.TRACKS || !window.ALBUMS) {
        contentView.innerHTML = `<div style="text-align:center; padding-top:100px; opacity:0.5;">Syncing Library...</div>`;
        setTimeout(() => viewLibrary(activeTab), 300);
        return;
    }

    // Safely get IDs from our new STORAGE helper
    const ids = (activeTab === 'liked') ? STORAGE.getLikes() : STORAGE.getRecent();
    
    // Flatten all tracks into one searchable list
    const allTracks = Object.values(window.TRACKS).flat();

    // Filter logic
    const displayTracks = ids.map(id => allTracks.find(t => t.id === id))
        .filter(t => {
            if (!t) return false;
            // Check parent album status
            const parentAlbumIds = t.album_id.split(',').map(s => s.trim());
            const alb = window.ALBUMS.find(a => parentAlbumIds.includes(a.id));
            // Only show if the album exists and is NOT coming soon
            return alb && !alb.coming_soon;
        });

    let html = `
    <div class="standard-padding view-animate" style="padding-bottom: 150px;">
        <h1 style="font-size: 34px; font-weight: 900; margin-bottom: 5px; color: #fff;">Library</h1>
        
        <div class="library-tabs ${activeTab === 'recent' ? 'tab-2-active' : ''}" style="margin-bottom: 25px;">
            <div class="tab-indicator"></div>
            <div class="lib-tab ${activeTab === 'liked' ? 'active' : ''}" onclick="viewLibrary('liked')">
                <span class="material-icons">favorite</span> Liked
            </div>
            <div class="lib-tab ${activeTab === 'recent' ? 'active' : ''}" onclick="viewLibrary('recent')">
                <span class="material-icons">history</span> Recent
            </div>
        </div>

        <div id="library-list">
            ${displayTracks.length > 0 ? displayTracks.map(t => {
                const parentAlbumIds = t.album_id ? t.album_id.split(',').map(s => s.trim()) : [];
                const alb = window.ALBUMS.find(a => parentAlbumIds.includes(a.id));
                const art = alb ? alb.art_url : 'https://thumbs2.imgbox.com/14/a7/fI8ktNrC_t.png';
                const isLiked = STORAGE.getLikes().includes(t.id);

                return `
                <div class="result-item" 
                     onclick="playTrack('${t.id}')"
                     style="display: flex; align-items: center; cursor: pointer; padding: 12px; border-radius: 18px; background: rgba(255,255,255,0.04); margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.02);">
                    
                    <img src="${art}" style="width: 55px; height: 55px; border-radius: 12px; margin-right: 15px; object-fit: cover;">
                    
                    <div style="flex: 1; overflow: hidden;">
                        <div style="font-weight: 800; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #fff;">${t.title}</div>
                        <div style="font-size: 13px; color: rgba(255,255,255,0.5); font-weight: 600;">${window.ARTISTS[alb?.artist_id]?.name || 'Artist'}</div>
                    </div>
                    
                    <div style="padding-left: 10px;" onclick="event.stopPropagation(); handleLikeToggle('${t.id}')">
                        <span class="material-icons" style="color: ${isLiked ? 'var(--accent-green)' : 'rgba(255,255,255,0.1)'}; font-size: 24px;">
                            ${isLiked ? 'favorite' : 'favorite_border'}
                        </span>
                    </div>
                </div>`;
            }).join('') : `
                <div style="text-align:center; margin-top:100px; opacity: 0.3;">
                    <span class="material-icons" style="font-size: 80px; color: #fff;">inventory_2</span>
                    <p style="margin-top: 20px; font-weight: 700; font-size: 18px;">Empty Library</p>
                    <p style="font-size: 14px;">Songs you like will appear here.</p>
                </div>
            `}
        </div>
    </div>`;
    
    contentView.innerHTML = html;
};

// Add this helper to refresh the view immediately when liking/unliking inside the library
window.handleLikeToggle = (id) => {
    // 1. Update Data
    const isNowLiked = window.STORAGE.toggleLike(id);
    
    // 2. Update Full Player UI (if open)
    const fpHeart = document.getElementById('fp-heart-icon');
    if (fpHeart) {
        fpHeart.innerText = isNowLiked ? 'favorite' : 'favorite_border';
        fpHeart.style.color = isNowLiked ? 'var(--accent-green)' : 'white';
    }

    // 3. Update Library UI (if currently viewing library)
    if (window.currentViewId === 'library') {
        viewLibrary(window.lastActiveTab);
    }

    // 4. Haptic Feedback / Toast (Optional but good for iOS)
    if (window.showTRMToast) {
        window.showTRMToast(isNowLiked ? "Added to Library" : "Removed from Library");
    }
};

window.openPatchNotes = function() {
    const versionHistory = [
                {
            version: "v1.0.3.2",
            date: "February 11, 2026",
            notes: [
                "⬆️ Deployed a patch to fix the Spotlight!",
            ],
            actionButton: {
                text: "VISIT THE BRAND SHOP",
                url: "https://trm-brand-shop.fourthwall.com"
            }
        },
    {
            version: "v1.0.3.1",
            date: "February 10, 2026",
            notes: [
                "🛠️ Hammered out some bugs.",
                "🔗 Copying links work now.",
                "⚙️ Regarding v1.0.4: We'll be introducing a bunch of new features, such as a settings menu, light mode, and more.",
                "⚠️ Due to a bug we've temporarliy disabled the Library.",
            ],
            actionButton: {
                text: "VISIT THE BRAND SHOP",
                url: "https://trm-brand-shop.fourthwall.com"
            }
        },
    {
            version: "v1.0.3",
            date: "February 10, 2026",
            notes: [
                "📱 Mobile Optimization",
                "🔗 Copying links should work like never before! (Finally... psst, unlike Desktop you can send them to your friends right from the app!)",
                "🎞️ Albums can now have featured videos, and so can your favorite artists!",
                "📷 Wanna follow your favorite artists everywhere? (Creep), well now you can with social links!",
                "🖌️ We got a bit artistic and made some improvements to UI in general!",
                "🔄️ I heard someone wanted to rotate their spotlight?",
                "🔦 Oh, and from a friend... I heard Light Mode is coming next update... 👀",
            ],
            actionButton: {
                text: "VISIT THE BRAND SHOP",
                url: "https://trm-brand-shop.fourthwall.com"
            }
        },
    ];

    if (document.getElementById('patch-modal-root')) return;

    const root = document.createElement('div');
    root.id = 'patch-modal-root';
    Object.assign(root.style, {
        position: 'fixed',
        inset: '0',
        zIndex: '999999',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        padding: '20px'
    });

    const current = versionHistory[0];

    root.innerHTML = `
        <div style="position: absolute; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);"></div>
        <div class="view-animate" style="position: relative; background: #0d0d0d; border: 1px solid #222; width: 100%; max-width: 400px; max-height: 85vh; border-radius: 28px; display: flex; flex-direction: column; color: white; box-shadow: 0 30px 60px rgba(0,0,0,0.5); overflow: hidden;">
            
            <div style="padding: 30px 30px 10px 30px;">
                <h2 style="font-size: 28px; font-weight: 900; margin: 0; letter-spacing: -1px; text-transform: uppercase;">Patch Notes</h2>
                <p style="color: var(--accent-green); font-weight: 800; font-size: 10px; margin: 5px 0 0 0; letter-spacing: 2px; text-transform: uppercase;">CURRENT VERSION ${current.version}</p>
            </div>

            <div style="flex: 1; overflow-y: auto; padding: 20px 30px; mask-image: linear-gradient(to bottom, transparent, black 5%, black 95%, transparent);">
                ${versionHistory.map(release => `
                    <div style="margin-bottom: 25px;">
                        <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 12px;">
                            <span style="font-weight: 900; font-size: 14px; color: white; opacity: 0.9;">${release.version}</span>
                            <span style="color: #444; font-size: 10px; font-weight: 700;">${release.date}</span>
                        </div>
                        <ul style="margin: 0; padding-left: 15px; color: #bbb; line-height: 1.5; font-size: 13px; font-weight: 500; list-style: disc;">
                            ${release.notes.map(note => `<li style="margin-bottom: 8px;">${note}</li>`).join('')}
                        </ul>
                    </div>
                `).join('')}
            </div>

            <div style="padding: 20px 30px 30px 30px; display: flex; flex-direction: column; gap: 10px; background: linear-gradient(to top, #0d0d0d 80%, transparent);">
                <button onclick="document.getElementById('patch-modal-root').remove()" style="width: 100%; background: #fff; color: #000; border: none; padding: 16px; border-radius: 14px; font-weight: 900; font-size: 13px; text-transform: uppercase; cursor: pointer;">
                    GOT IT
                </button>

                ${current.actionButton ? `
                    <a href="${current.actionButton.url}" target="_blank" style="width: 100%; background: rgba(255,255,255,0.05); color: #fff; border: 1px solid rgba(255,255,255,0.1); padding: 16px; border-radius: 14px; font-weight: 900; font-size: 12px; text-align: center; text-decoration: none; box-sizing: border-box;">
                        ${current.actionButton.text}
                    </a>
                ` : ''}
            </div>
        </div>
    `;

    document.body.appendChild(root);
};

// Variable to hold the timer state
let pressTimer;

window.handleLongPressStart = (id, type = 'album') => {
    // Clear any existing timer just in case
    clearTimeout(pressTimer);

    pressTimer = setTimeout(() => {
        if (type === 'track') {
            // Logic for a single track (from Library/Recent)
            STORAGE.toggleLike(id);
            if (navigator.vibrate) navigator.vibrate(40);
            
            // Refresh the library view if that's where we are
            if (window.currentViewId === 'library') {
                viewLibrary(window.lastActiveTab || 'liked');
            }
        } else {
            // Logic for an entire album
            bulkLikeAlbum(id);
            if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
        }
    }, 800); // 800ms is the standard "long press" duration
};

window.handleLongPressEnd = () => {
    // If the user lets go before 800ms, the timer is cancelled
    clearTimeout(pressTimer);
};

// Attach scroll listener to the ONLY scrollable container
contentView.addEventListener('scroll', () => {
    // LOCK: If we are on an album or artist page, keep the UI hidden regardless of scroll
    if (window.currentViewId === 'album' || window.currentViewId === 'artist') {
        toggleNavUI(false);
        return;
    }

    let scrollTop = contentView.scrollTop;
    if (scrollTop > 100) {
        if (scrollTop > lastScrollTop) {
            toggleNavUI(false); // Hide on Scroll Down
        } else {
            toggleNavUI(true);  // Show on Scroll Up
        }
    } else {
        toggleNavUI(true); // Always show at top of main pages
    }
    lastScrollTop = scrollTop <= 0 ? 0 : scrollTop; 
}, { passive: true });

        init();
    </script>
</body>
</html>