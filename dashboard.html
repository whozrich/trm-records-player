<!DOCTYPE html>
<html lang="en">
<head>
    <script>
(function() {
    const manifest = {
        "name": "TRM Music Player",
        "short_name": "TRM",
        "start_url": "https://trm-brand-shop.fourthwall.com/music-player",
        "display": "standalone",
        "background_color": "#000000",
        "theme_color": "#000000",
        "icons": [{
            "src": "https://thumbs2.imgbox.com/14/a7/fI8ktNrC_t.png",
            "sizes": "800x800",
            "type": "image/png"
        }],
        "screenshots": [
            {
                "src": "https://thumbs2.imgbox.com/14/a7/fI8ktNrC_t.png",
                "sizes": "800x800",
                "type": "image/png",
                "form_factor": "wide"
            },
            {
                "src": "https://thumbs2.imgbox.com/14/a7/fI8ktNrC_t.png",
                "sizes": "800x800",
                "type": "image/png"
            }
        ]
    };

    const stringManifest = JSON.stringify(manifest);
    const blob = new Blob([stringManifest], {type: 'application/manifest+json'});
    const manifestURL = URL.createObjectURL(blob);
    
    const link = document.createElement('link');
    link.rel = 'manifest';
    link.href = manifestURL;
    document.head.appendChild(link);
})();
</script>
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRM MUSIC PLAYER</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        :root {
            --header-height: 56px; 
            --accent-green: #00ff88;
            --neon-glow: drop-shadow(0 0 8px rgba(0, 255, 136, 0.6));
            --sidebar-width: 280px;
    --sidebar-collapsed-width: 80px;
        }

        /* 1. LAYOUT & STACKING - FORCED FULL SCREEN OVERLAY */
        body { 
            margin: 0; 
            background: #000; 
            color: #fff; 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; 
            height: 100vh;
            width: 100vw;
        }

        #dashboard-wrapper {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex; 
            flex-direction: column;
            overflow: hidden;
            z-index: 9999999; 
            background: #000;
        }

        /* Like Button Base Style */
#player-like-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Bouncy transition */
}

/* Hover Effect: Subtle Scale and Glow */
#player-like-btn:hover {
    transform: scale(1.2);
    color: #fff !important;
    filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.3));
}

/* Active Liked State: Intense Neon Glow */
#player-like-btn.is-liked {
    color: var(--accent-green) !important;
    filter: var(--neon-glow);
}

/* Heart Pop Animation Class */
.heart-pop {
    animation: heart-beat 0.3s ease-out;
}

@keyframes heart-beat {
    0% { transform: scale(1); }
    50% { transform: scale(1.4); }
    100% { transform: scale(1.2); }
}

        .main-viewport {
            display: flex; 
            flex: 1; 
            overflow: hidden; 
            height: calc(100vh - 100px); 
        }

        /* EXIT BUTTON */
        .exit-player-btn {
            position: absolute;
            top: 20px;
            right: 25px;
            z-index: 10000001;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px 18px;
            border-radius: 30px;
            font-size: 11px;
            font-weight: 900;
            text-decoration: none;
            letter-spacing: 1.5px;
            backdrop-filter: blur(10px);
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .exit-player-btn:hover {
            background: #ff4444;
            border-color: #ff4444;
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.3);
        }

        /* 2. THE PLAYER */
        #mini-player {
            height: 100px; 
            background: #050505; 
            border-top: 1px solid #111;
            display: flex; 
            align-items: center; 
            padding: 0 25px; 
            gap: 30px;
            position: relative;
            z-index: 10000000 !important;
        }

        #share-btn:hover {
    background: rgba(255, 255, 255, 0.2) !important;
    transform: scale(1.1);
}
#share-btn:active {
    transform: scale(0.95);
}

        /* CATALOGUE GLOW EFFECT */
        .glow-card {
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glow-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0, 255, 136, 0.2);
            border-color: rgba(0, 255, 136, 0.3);
        }

        #progress-container {
    cursor: pointer;
    position: relative;
}

#spotlight-carousel {
    position: relative;
    min-height: 320px;
    overflow: hidden;
}

/* The animation for the new slide coming in */
.slide-in {
    animation: slideRight 0.5s ease-out forwards;
}

@keyframes slideRight {
    from { 
        opacity: 0; 
        transform: translateX(20px); 
    }
    to { 
        opacity: 1; 
        transform: translateX(0); 
    }
}

#progress-bar {
    pointer-events: none; /* This ensures the click passes THROUGH the green bar to the container */
    transition: width 0.1s linear; /* Makes the movement smooth */
}

/* Ensure the panel sits on top of everything except the mini-player */
#info-panel {
position: fixed; /* Or absolute if inside main-viewport */
    right: -400px; 
    top: 0; 
    width: 350px; 
    height: calc(100vh - 100px); /* Leave room for player */
    background: #0a0a0a;
    z-index: 9999; /* Ensure this is HIGHER than #content-view */
    transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    border-left: 1px solid #222;
    display: flex;
    flex-direction: column;
    overflow: hidden; /* Prevent the container from scrolling */
}

#loop-btn {
    width: 40px;          /* Adjust to match your other icons */
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;      /* Lock the icon size */
    transition: color 0.2s ease;
    cursor: pointer;
    background: none;
    border: none;
    outline: none;
}

#info-panel.open { 
    right: 0; 
    visibility: visible; 
    box-shadow: -20px 0 50px rgba(0,0,0,0.8);
}

/* Add this new rule for the inner content */
#panel-content {
flex: 1;
    overflow-y: auto !important; /* Allow the content to scroll */
    padding: 0 30px 100px 30px; /* Extra bottom padding for the mini-player clearance */
    -webkit-overflow-scrolling: touch;
    padding-bottom: 60px;     /* Extra space at the bottom of the scroll */
}


#sidebar {
    width: 280px;
    min-width: 80px; /* Minimum width when collapsed */
    max-width: 450px;
    background: #000;
    display: flex;
    flex-direction: column;
    border-right: 1px solid #111;
    position: relative;
    transition: width 0.1s ease; /* Fast transition for dragging */
}

/* Draggable Divider */
#sidebar-resizer {
    width: 4px;
    cursor: col-resize;
    background: transparent;
    transition: background 0.2s;
    z-index: 10;
}
#sidebar-resizer:hover { background: var(--accent-green); }

/* Rotating border effect for the player art */
.player-art-loading {
    position: relative;
}

.player-art-loading::after {
    content: "";
    position: absolute;
    inset: -3px;
    border: 3px solid transparent;
    border-top-color: var(--accent-green);
    border-radius: 50%; /* Adjust based on your art shape */
    animation: spin 1s linear infinite;
    z-index: 5;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Optional: Dim the art while loading */
.loading-dim {
    filter: brightness(0.5);
    transition: filter 0.3s ease;
}

/* Collapsed States */
#sidebar.collapsed { width: 80px !important; }
#sidebar.collapsed span, 
#sidebar.collapsed .catalogue-header,
#sidebar.collapsed #search-input { 
    display: none; 
}

#sidebar.collapsed .sidebar-item { justify-content: center; padding: 15px 0; }

#main-content {
    flex: 1;
}

        #search-input {
            width: calc(100% - 32px); 
            background: #111; 
            border: 1px solid #222;
            color: #fff; 
            padding: 12px; 
            border-radius: 8px; 
            margin: 16px;
            outline: none; 
            transition: 0.3s; 
            box-sizing: border-box;
        }
        #search-input:focus {
            border-color: var(--accent-green);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.2);
        }

        /* 5. GLOW & INTERACTION RESTORATION */
        .control-toggle, .social-link, #volume-icon-wrapper, #play-btn {
            cursor: pointer !important;
            transition: 0.2s ease;
        }

        .control-toggle {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
}

.control-toggle svg {
    pointer-events: none; /* Prevents clicking the SVG itself instead of the div */
}

/* Purchase Dropdown Styling */
.purchase-menu {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    background: #282828;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    min-width: 160px;
    z-index: 100;
    margin-top: 8px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    overflow: hidden;
}

.menu-item {
    padding: 12px 16px;
    color: white;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: 0.2s;
}

.menu-item:hover {
    background: var(--accent-green);
    color: black;
}

/* Helper class for the active toggle */
.show-menu {
    display: block !important;
}

        .control-toggle:hover svg, #vol-svg:hover, .social-link:hover svg {
            color: var(--accent-green) !important;
            filter: var(--neon-glow);
            transform: scale(1.1);
        }

        .control-toggle.active svg {
            color: var(--accent-green) !important;
            filter: var(--neon-glow);
        }

        #play-btn:hover {
            background: var(--accent-green) !important;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
            transform: scale(1.05);
        }

        /* 6. CATALOGUE HOVER FIX - Adjusted for Image 2 Alignment */
        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 15px; 
            cursor: pointer; 
            border-radius: 6px;
            margin: 2px 10px; 
            transition: 0.2s; 
            color: #b3b3b3;
            font-size: 13px;
            font-weight: 600;
        }
        .sidebar-item:hover {
            background: rgba(255,255,255,0.05);
            color: #fff;
        }
        .sidebar-item img {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            object-fit: cover;
        }

        /* 7. TRACK ROW COLLISIONS */
        .track-row {
            display: flex; 
            padding: 12px 25px; 
            border-radius: 10px; 
            cursor: pointer; 
            align-items: center; 
            transition: all 0.2s ease; 
            border: 1px solid transparent;
            margin-bottom: 2px;
        }

        .track-row:hover {
            background: rgba(0, 255, 136, 0.04); 
            box-shadow: inset 0 0 15px rgba(0, 255, 136, 0.05), 0 0 10px rgba(0, 255, 136, 0.02);
            border-color: rgba(0, 255, 136, 0.1);
            transform: translateX(4px); 
        }

        .track-row.disabled {
            cursor: default;
            opacity: 0.5;
            filter: grayscale(1);
        }

        .track-index-col {
            width: 25px; 
            flex-shrink: 0; 
            font-weight: 900; 
            color: #444;
        }

        .album-view-header {
            display: flex; 
            gap: 40px; 
            align-items: flex-end; 
            margin-bottom: 40px;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #222; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-green); }

        /* 8. ANIMATION SYSTEM */
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        .view-animate {
            animation: fadeInScale 1.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* 9. BUTTON & LINK RESTORATION */
        .signup-btn {
            display: inline-block;
            background: #00ff88;
            color: #000 !important;
            padding: 12px 24px;
            border-radius: 30px;
            font-weight: 800;
            font-size: 13px;
            text-decoration: none !important;
            letter-spacing: 1px;
            transition: 0.3s;
            margin-top: 15px;
        }

        .signup-btn:hover {
            background: #fff;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
            transform: translateY(-2px);
        }

        .purchase-select {
            background: #111;
            color: #fff;
            border: 1px solid #333;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            outline: none;
            margin-top: 15px;
        }

        .purchase-select:hover { border-color: #00ff88; }

        .social-link {
            color: #666; 
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.03);
            text-decoration: none;
        }

        .social-link:hover {
            color: #00ff88; 
            background: rgba(0, 255, 136, 0.1);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.2);
        }

        #content-view {
            flex: 1;
            overflow-y: auto !important; 
            overflow-x: hidden;
            height: 100%; 
            background: linear-gradient(to bottom, #121212, #000);
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            position: relative;
        }

        /* Styling for the PiP button to match your theme */
#pip-btn:hover {
    color: var(--accent-green) !important;
    filter: var(--neon-glow);
}

#pip-btn.active {
    color: var(--accent-green) !important;
}

/* The dark background fade */
@keyframes overlayFadeIn {
    from { opacity: 0; backdrop-filter: blur(0px); }
    to { opacity: 1; backdrop-filter: blur(15px); }
}

/* The video window scaling up */
@keyframes videoPopIn {
    0% { opacity: 0; transform: scale(0.8) translateY(30px); }
    100% { opacity: 1; transform: scale(1) translateY(0); }
}

.video-overlay-active {
    animation: overlayFadeIn 0.4s ease forwards;
}

.video-content-active {
    animation: videoPopIn 0.5s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
}

@keyframes modalFadeOut {
    from { opacity: 1; backdrop-filter: blur(15px); }
    to { opacity: 0; backdrop-filter: blur(0px); }
}

@keyframes videoPopOut {
    from { opacity: 1; transform: scale(1); }
    to { opacity: 0; transform: scale(0.9); }
}

.modal-exit-active {
    animation: modalFadeOut 0.3s ease forwards !important;
}

.content-exit-active {
    animation: videoPopOut 0.3s ease forwards !important;
}

    </style>
</head>
<body>

<div id="dashboard-wrapper">
    <a href="https://trm-brand-shop.fourthwall.com" class="exit-player-btn">âœ• EXIT PLAYER</a>

    <div class="main-viewport">
        
        <div class="sidebar-container">
            <input type="text" id="search-input" placeholder="Search" oninput="performSearch(this.value)">
            <div id="sidebar-resizer"></div>
            <div class="sidebar-nav">
                <div class="sidebar-item" onclick="viewHome()">
                    <span class="material-icons">home</span><span>Home</span>
                </div>
                <div class="sidebar-item" onclick="viewRecents()">
                    <span class="material-icons">history</span><span>Recents</span>
                </div>
                <div class="sidebar-item" onclick="viewLikedSongs()">
                    <span class="material-icons" style="color:var(--accent-green);">favorite</span><span>Liked Songs</span>
                </div>

                <div class="sidebar-item" onclick="openPatchNotes()" style="margin-top: 5px; opacity: 0.6; transition: 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">
                    <span class="material-icons" style="font-size: 18px; color:#00ff88">new_releases</span>
                    <span style="font-size: 11px; letter-spacing: 1px;">Patch Notes</span>
                    <span style="margin-left: auto; font-size: 9px; background: #222; padding: 2px 6px; border-radius: 4px; color: var(--accent-green);">v1.0.3</span>
                </div>
                <div class="sidebar-item" onclick="viewArtistPortal()" style="margin-top: 0px; opacity: 0.6; transition: 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">
                    <span class="material-icons" style="font-size: 18px; color:#00ff88">person_add</span>
                    <span style="font-size: 11px; letter-spacing: 1px;">Become An Artist</span>
                    <span style="margin-left: auto; font-size: 9px; background: #222; padding: 2px 6px; border-radius: 4px; color: var(--accent-green);">New!</span>
                </div>
            </div>

            <div style="padding: 0 20px; font-size: 11px; font-weight: 900; color: #444; letter-spacing: 1px; margin-top: 10px; margin-bottom: 10px;">CATALOGUE</div>
            <div id="sidebar-releases" style="flex: 1; overflow-y: auto;"></div>
        </div>

        <div id="content-view">
            <div style="padding: 40px; font-weight: 900; letter-spacing: 1px;">INITIALIZING TRM MUSIC PLAYER...</div>
        </div>

        <div id="info-panel">
            <div style="display:flex; justify-content: space-between; align-items: center; padding: 30px 30px 10px 30px;">
                <h3 id="panel-type" style="margin:0; font-weight:900; color:#00ff88; font-size:12px; letter-spacing:2px;">LYRICS & INFO</h3>
                <button onclick="togglePanel()" style="background:none; border:none; color:#666; cursor:pointer; font-size:24px;">&times;</button>
            </div>
            <div id="panel-content" style="flex: 1; overflow-y: auto; padding: 0 30px 30px 30px;"></div>
        </div>

    </div> <div id="mini-player">
        <div style="width: 30%; display: flex; align-items: center; gap: 15px;">
            <img id="player-art" src="" style="width: 56px; height: 56px; border-radius: 4px; display: none; object-fit: cover;">
            <div style="overflow: hidden; flex: 1;">
                <div id="player-title" style="font-weight: 700; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Select a track</div>
                <div id="player-artist" style="font-size: 12px; color: #b3b3b3; cursor: pointer;"></div>
            </div>

<div style="width: 30%; display: flex; justify-content: flex-end; align-items: center; gap: 20px;">
    </div>
        </div>
        
        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px;">
            <div style="display: flex; align-items: center; gap: 24px;">
                <div id="shuffle-btn" class="control-toggle" onclick="toggleShuffle()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>
                </div>
                <div class="control-toggle" onclick="prevTrack()">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                </div>
                <button onclick="togglePlay()" id="play-btn" style="background: #fff; border: none; width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                    <svg id="play-icon" viewBox="0 0 24 24" width="20" height="20" fill="black"><path d="M8 5v14l11-7z"/></svg>
                </button>
                <div class="control-toggle" onclick="nextTrack()">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                </div>
                <div id="loop-btn" class="control-toggle" onclick="toggleLoop()">
                    <svg id="loop-svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
                </div>
            </div>
            <div style="width: 100%; max-width: 480px; display: flex; align-items: center; gap: 10px;">
                <span id="current-time" style="font-size: 11px; color: #666; width: 35px; text-align: right;">0:00</span>
                <div id="progress-container" onclick="seek(event)" style="flex: 1; height: 4px; background: #333; border-radius: 2px; cursor: pointer;">
                    <div id="progress-bar" style="width: 0%; height: 100%; background: #00ff88; border-radius: 2px;"></div>
                </div>
                <span id="total-duration" style="font-size: 11px; color: #666; width: 35px;">0:00</span>
            </div>
        </div>

        <div style="width: 30%; display: flex; justify-content: flex-end; align-items: center; gap: 20px;">
                                                                   <div id="player-like-btn" onclick="handleLikeClick()" style="cursor:pointer; color:#666; transition: 0.2s; padding-right: 10px;">
                <span class="material-icons" id="main-heart-icon" style="font-size: 20px;">favorite_border</span>
            </div>
            <div class="control-toggle" onclick="togglePanel()">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
            </div>
            <div id="volume-icon-wrapper" onclick="toggleMute()" style="color:#666;">
                <svg id="vol-svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
            </div>
            <input id="volume-slider" type="range" min="0" max="1" step="0.01" value="0.5" oninput="updateVolume(this.value)" style="width: 80px; accent-color: #00ff88;">
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// --- Global Variable Safeties ---
window.ALBUMS = window.ALBUMS || [];
window.TRACKS = window.TRACKS || {};
window.ARTISTS = window.ARTISTS || {};

// Check if audio is already declared in the window to avoid SyntaxErrors
if (!window.audio) {
    window.audio = new Audio();
    window.audio.preload = "auto"; 
    window.audio.volume = 0.5;
}
const audio = window.audio; 

// The rest of your variables
let currentTrackId = null;
let currentArtistId = null;

let isSidebarCollapsed = localStorage.getItem('trm_sidebar_collapsed') === 'true';

audio.preload = "auto"; 
audio.volume = 0.5;

const supabaseUrl = 'https://sxagulxljpzftqfnllhv.supabase.co';
const supabaseKey = 'sb_publishable_GG1VzWph8ZCK2hCyZugMfA_qR6LZcRn';
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

window.getLikes = function() {
    return JSON.parse(localStorage.getItem('trm_likes') || '[]');
};

window.getRecents = function() {
    return JSON.parse(localStorage.getItem('trm_recents') || '[]');
};

window.toggleLike = function(trackId) {
    let likes = window.getLikes();
    if (likes.includes(trackId)) {
        likes = likes.filter(id => id !== trackId);
    } else {
        likes.push(trackId);
    }
    localStorage.setItem('trm_likes', JSON.stringify(likes));
};

// --- 2. PLAYER & UI LOGIC ---

function formatTime(secs) {
    if (isNaN(secs) || secs === Infinity) return "0:00";
    const mins = Math.floor(secs / 60);
    const s = Math.floor(secs % 60);
    return `${mins}:${s < 10 ? '0' : ''}${s}`;
}

audio.onloadedmetadata = () => {
    const totalT = document.getElementById('total-duration');
    if (totalT) totalT.innerText = formatTime(audio.duration);
};

audio.ontimeupdate = () => {
    const progressBar = document.getElementById('progress-bar');
    const currentT = document.getElementById('current-time');
    if (audio.duration) {
        const pct = (audio.currentTime / audio.duration) * 100;
        if (progressBar) progressBar.style.width = pct + "%";
        if (currentT) currentT.innerText = formatTime(audio.currentTime);
    }
};

window.performSearch = function(query) {
    if (!query) { window.viewHome(); return; }
    const q = query.toLowerCase();
    
    // Filter Data
const albumResults = window.ALBUMS.filter(a => a.name.toLowerCase().includes(q) && !a.hidden);
    const artistResults = Object.values(window.ARTISTS).filter(art => art.name.toLowerCase().includes(q));
    const allTracks = Object.values(window.TRACKS).flat();
    const trackResults = Array.from(new Map(allTracks.map(t => [t.id, t])).values())
                              .filter(t => t.title.toLowerCase().includes(q));

    document.getElementById('content-view').innerHTML = `
    <div class="view-animate" style="padding:50px;">
        <h1 style="font-size:32px; font-weight:900; margin-bottom:40px;">Results for "${query}"</h1>
        
        ${artistResults.length ? `
            <section style="margin-bottom:40px;">
                <h3 style="color:#666; font-size:12px; letter-spacing:1px; margin-bottom:15px;">ARTISTS</h3>
                ${artistResults.map(art => `
                    <div onclick="viewArtist('${art.id}')" style="display:flex; align-items:center; gap:15px; cursor:pointer; padding:10px; border-radius:8px;" class="track-row">
                        <div style="width:50px; height:50px; border-radius:50%; background:#222; display:flex; align-items:center; justify-content:center; font-weight:900;">${art.name[0]}</div>
                        <div style="font-weight:700;">${art.name}</div>
                    </div>
                `).join('')}
            </section>
        ` : ''}

        ${albumResults.length ? `
            <section style="margin-bottom:40px;">
                <h3 style="color:#666; font-size:12px; letter-spacing:1px; margin-bottom:15px;">ALBUMS</h3>
                <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:20px;">
                    ${albumResults.map(alb => `
                        <div onclick="viewAlbum('${alb.id}')" class="glow-card" style="padding:15px; background:#111; border-radius:10px; cursor:pointer;">
                            <img src="${alb.art_url}" style="width:100%; aspect-ratio:1; border-radius:5px; margin-bottom:10px;">
                            <div style="font-weight:700;">${alb.name}</div>
                        </div>
                    `).join('')}
                </div>
            </section>
        ` : ''}

        <section>
            <h3 style="color:#666; font-size:12px; letter-spacing:1px; margin-bottom:15px;">SONGS</h3>
            ${trackResults.map((t, i) => renderTrackRow(t, i)).join('')}
        </section>
    </div>`;
};

window.seek = function(e) {
    if (!audio.duration) return;
    const container = document.getElementById('progress-container');
    const rect = container.getBoundingClientRect();
    const x = e.clientX - rect.left;
    audio.currentTime = (x / rect.width) * audio.duration;
};

window.togglePlay = function() {
    if (!audio.src || audio.src === window.location.href) return;
    if (audio.paused) {
        audio.play().then(() => { window.isPlaying = true; updatePlayerUI(); }).catch(e => console.error("Playback failed:", e));
    } else {
        audio.pause();
        window.isPlaying = false;
        updatePlayerUI();
    }
};

// --- UPDATED INFO PANEL (SINGLE DEFINITION) ---
window.updateInfoPanel = function(track, album) {
    const content = document.getElementById('panel-content');
    if (!content) return;

    const safeTrack = track || {};
    const safeAlbum = album || {};
    
    // Safety check for artist data
    const artistKey = safeTrack.artist_id || safeAlbum.artist_id;
    const artistObj = (window.ARTISTS && artistKey && window.ARTISTS[artistKey]) ? window.ARTISTS[artistKey] : { name: "therichmusic" };
    
    content.innerHTML = `
        <img src="${safeAlbum.art_url || ''}" style="width:100%; border-radius:12px; margin-bottom:20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
        <h2 style="margin:0; font-size: 24px; font-weight: 900;">${safeTrack.title || 'Unknown Track'}</h2>
        <p style="color:var(--accent-green); cursor:pointer; font-weight: 700; margin-top: 5px;" onclick="viewArtist('${artistObj.id || ''}')">${artistObj.name}</p>
        
        <h3 style="font-size:12px; color:#666; letter-spacing:1px; margin-top:32px; margin-bottom:12px; font-weight: 900;">LYRICS</h3>
        <div style="color:#b3b3b3; font-size:16px; line-height:1.8; white-space:pre-wrap; margin-bottom:40px;">${safeTrack.lyrics || 'No lyrics available.'}</div>
        
        <h3 style="font-size:12px; color:#666; letter-spacing:1px; margin-bottom:12px; font-weight: 900;">CREDITS</h3>
<div style="color:#888; font-size:13px; line-height:1.6; padding-bottom: 180px;">
    ${(Array.isArray(safeTrack.credits) ? safeTrack.credits : [safeTrack.credits || 'No credits listed.'])
        .map(line => line.includes(':') 
            ? `<b>${line.split(':')[0]}:</b>${line.split(':')[1]}` 
            : line
        ).join('<br>')}
</div>
    `;
};

// Global variable to track the current playback promise
window.activePlayPromise = null;

window.playTrack = function(id, autoPlay = true, explicitAlbumId = null) {
    const allTracks = Object.values(window.TRACKS).flat();
    const track = allTracks.find(t => t.id === id);
    if (!track) return;

    // --- LOADING UI START ---
    const artContainer = document.getElementById('player-art-container'); // Wrap your img in a div if needed
    const artImg = document.getElementById('player-art');
    
    const startLoading = () => {
        if (artContainer) artContainer.classList.add('player-art-loading');
        if (artImg) artImg.classList.add('loading-dim');
    };

    const stopLoading = () => {
        if (artContainer) artContainer.classList.remove('player-art-loading');
        if (artImg) artImg.classList.remove('loading-dim');
    };

    // Attach native listeners to the audio element once
    audio.onwaiting = () => startLoading();
    audio.onplaying = () => stopLoading();
    audio.oncanplay = () => stopLoading(); // Safety fallback
    // --- END LOADING UI SETUP ---

    const albId = explicitAlbumId || window.currentAlbumId || track.album_id.split(',')[0].trim();
    const album = window.ALBUMS.find(a => a.id === albId);
    const artistId = track.artist_id || album?.artist_id;
    const artist = window.ARTISTS[artistId] || { name: "therichmusic", id: "" };

    window.currentTrackId = id;
    window.currentAlbumId = albId;
    
    if (audio.src !== track.url) {
        startLoading(); // Trigger immediately when source changes
        audio.src = track.url; 
        audio.load();
    }

    // [Steps 4, 5, 6 remain exactly as you have them...]
    if ('mediaSession' in navigator) { /* ... */ }
    if(artImg) artImg.src = album?.art_url || '';
    
    const titleEl = document.getElementById('player-title');
    if(titleEl) titleEl.innerText = track.title;
    
    const pArtist = document.getElementById('player-artist');
    if(pArtist) {
        pArtist.innerText = artist.name; 
        pArtist.onclick = () => viewArtist(artistId);
    }

    if (typeof window.updateInfoPanel === 'function') window.updateInfoPanel(track, album);
    if (typeof saveRecent === 'function') saveRecent(id);
    localStorage.setItem('trm_last_track', id);

    // 7. Autoplay with Promise Handling
    if (autoPlay) {
        if (audio.context && audio.context.state === 'suspended') {
            audio.context.resume();
        }

        window.activePlayPromise = audio.play();

        window.activePlayPromise.then(() => { 
            window.isPlaying = true; 
            stopLoading(); // Success
            if (typeof updatePlayerUI === 'function') updatePlayerUI(); 
        }).catch(e => {
            if (e.name === 'AbortError') {
                console.log("Playback interrupted.");
            } else {
                console.warn("Playback failed:", e);
                stopLoading(); // Clean up UI even on failure
                window.isPlaying = false;
                if (typeof updatePlayerUI === 'function') updatePlayerUI(); 
            }
        });
    }
};

// Add this to your main initialization code
audio.addEventListener('ended', () => {
    // Safety check: if loopState isn't set, default to 0
    const state = window.loopState || 0;

    // STATE 2: Repeat One Song
    if (state === 2) {
        audio.currentTime = 0;
        audio.play();
        return; 
    }

    // STATE 0 & 1: Move to next track
    const nextExists = window.nextTrack();
    
    // If we hit the end of the album
    if (!nextExists) {
        if (state === 1) {
            // Loop All: Go back to song #1
            const albumTracks = window.TRACKS[window.currentAlbumId];
            if (albumTracks && albumTracks.length > 0) {
                window.playTrack(albumTracks[0].id, true);
            }
        } else {
            // State 0: Actually stop
            window.isPlaying = false;
            if (typeof updatePlayerUI === 'function') updatePlayerUI();
        }
    }
});

window.viewArtist = function(artistId) {
    const artist = window.ARTISTS[artistId] || { 
        name: "therichmusic", 
        bio: "", 
        verified: false,
        banner_url: "",
        featured_video_url: "",
        socials: [] // Now correctly expecting an Array based on your screenshot
    };
    
    const artistAlbums = window.ALBUMS.filter(a => a.artist_id === artistId);

    // 1. Configuration with "Match" strings for automatic detection
const socialConfig = [
    { name: 'YouTube',   match: 'youtube.com',   icon: 'fab fa-youtube',   color: '#FF0000' },
    { name: 'Instagram', match: 'instagram.com', icon: 'fab fa-instagram', color: '#E1306C' },
    { name: 'Twitter',   match: 'twitter.com',   icon: 'fab fa-x-twitter', color: '#ffffff' },
    { name: 'Twitter',   match: 'x.com',         icon: 'fab fa-x-twitter', color: '#ffffff' },
    { name: 'TikTok',    match: 'tiktok.com',    icon: 'fab fa-tiktok',    color: '#ffffff' } // TikTok usually looks best in white on dark themes
];

    // 2. Scan the Array and match URLs to icons
    const renderSocials = () => {
        if (!Array.isArray(artist.socials)) return '';
        
        let renderedCount = 0;
        return artist.socials.map(url => {
            if (renderedCount >= 4) return ''; // Limit to 4

            // Find the first config item that exists inside the URL string
            const platform = socialConfig.find(c => url.toLowerCase().includes(c.match));
            
            if (platform) {
                renderedCount++;
                return `
                    <a href="${url}" target="_blank" title="${platform.name}" style="text-decoration:none; color:${platform.color}; background:rgba(255,255,255,0.05); width:40px; height:40px; border-radius:10px; display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,0.1); transition:0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.15)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'">
                        <i class="${platform.icon}" style="font-size: 24px;"></i>
                    </a>
                `;
            }
            return ''; // Skips links not in the "allow list"
        }).join('');
    };

    // 3. YouTube Parser (Fixing the "Video Player Configuration Error")
    const getEmbedUrl = (url) => {
        if(!url) return null;
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        // Note: 'youtube-nocookie' helps with local file testing blocks
        return (match && match[2].length === 11) 
            ? `https://www.youtube-nocookie.com/embed/${match[2]}?rel=0&origin=${window.location.origin}` 
            : null;
    };

    const embedUrl = getEmbedUrl(artist.featured_video_url);

    document.getElementById('content-view').innerHTML = `
    <div class="view-animate">
        <div style="position: relative; height: 400px; width: 100%; display: flex; align-items: flex-end; padding: 50px; box-sizing: border-box; overflow: hidden;">
            <div style="position: absolute; inset: 0; background: url('${artist.banner_url || ''}') center/cover no-repeat; z-index: 1;"></div>
            <div style="position: absolute; inset: 0; background: linear-gradient(to top, #000 0%, rgba(0,0,0,0.4) 50%, rgba(0,0,0,0) 100%); z-index: 2;"></div>
            <div style="position: relative; z-index: 3;">
                ${artist.verified ? `
                    <div style="display: inline-flex; align-items: center; gap: 6px; background: #0070f3; color: white; padding: 6px 14px; border-radius: 4px; font-size: 11px; font-weight: 900; letter-spacing: 1px; margin-bottom: 15px;">
                        <span class="material-icons" style="font-size: 14px;">verified</span> VERIFIED ARTIST
                    </div>
                ` : ''}
                <h1 style="font-size: 96px; font-weight: 900; margin: 0; letter-spacing: -5px; line-height: 0.9; text-transform: uppercase;">${artist.name}</h1>
            </div>
        </div>

        <div style="padding: 40px 50px;">
            <div style="display: flex; gap: 60px; align-items: flex-start;">
                <div style="flex: 2;">
                    <h2 style="font-size: 24px; font-weight: 900; margin-bottom: 25px; border-bottom: 1px solid #222; padding-bottom: 15px;">Discography</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 25px;">
                        ${artistAlbums.map(alb => `
                            <div class="glow-card" onclick="viewAlbum('${alb.id}')" style="cursor:pointer; background: rgba(255,255,255,0.02); padding:15px; border-radius:12px; border: 1px solid rgba(255,255,255,0.05);">
                                <img src="${alb.art_url}" style="width:100%; aspect-ratio:1; border-radius:8px; margin-bottom:12px;">
                                <div style="font-weight:700; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${alb.name}</div>
                                <div style="color: #666; font-size: 11px; margin-top: 4px; font-weight: 800; letter-spacing: 0.5px;">${(alb.type || 'Album').toUpperCase()}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div style="flex: 1; display: flex; flex-direction: column; gap: 30px;">
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        ${renderSocials()}
                    </div>

                    ${embedUrl ? `
                        <div>
                            <h3 style="font-size: 12px; color: #666; letter-spacing: 2px; margin-bottom: 15px; font-weight: 900;">FEATURED VIDEO</h3>
                            <div style="position: relative; width: 100%; padding-top: 56.25%; border-radius: 12px; overflow: hidden; background:#111; border: 1px solid #222;">
                                <iframe style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" src="${embedUrl}" frameborder="0" allowfullscreen></iframe>
                            </div>
                        </div>
                    ` : ''}

                    <div style="background: rgba(255,255,255,0.03); padding: 30px; border-radius: 15px; border: 1px solid #111;">
                        <h3 style="font-size: 12px; color: #666; letter-spacing: 2px; margin-bottom: 15px; font-weight: 900;">ABOUT THE ARTIST</h3>
                        <p style="color: #b3b3b3; line-height: 1.6; font-size: 14px; margin: 0;">${artist.bio || 'No biography set.'}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>`;
};

window.updateLikeButtonUI = function(trackId) {
    const likeBtn = document.querySelector('.player-controls .like-btn i');
    if (!likeBtn) return;

    // Check if the user has liked this track
    // If you don't have a global getLikes function yet, we default to false
    const isLiked = (typeof window.getLikes === 'function') ? window.getLikes().includes(trackId) : false;

    if (isLiked) {
        likeBtn.classList.remove('fa-regular');
        likeBtn.classList.add('fa-solid');
        likeBtn.style.color = '#1db954';
    } else {
        likeBtn.classList.remove('fa-solid');
        likeBtn.classList.add('fa-regular');
        likeBtn.style.color = '#ffffff';
    }
};

window.handleLikeClick = function() {
if (!window.currentTrackId) return;
    if (typeof window.toggleLike === 'function') {
        window.toggleLike(window.currentTrackId);
    }
    window.updateLikeButtonUI(window.currentTrackId);
    
    // Refresh view if on Liked Songs page
    const title = document.querySelector('#content-view h1');
    if (title && title.innerText === 'Liked Songs') window.viewLikedSongs();
};

window.viewLikedSongs = function() {
    // Call getLikes() directly
    const likedIds = (typeof window.getLikes === 'function') ? window.getLikes() : [];
    const allTracks = Object.values(window.TRACKS).flat();
    // Unique tracks only (since tracks can belong to multiple albums)
    const uniqueTracks = Array.from(new Map(allTracks.map(t => [t.id, t])).values());
    const likedTracks = uniqueTracks.filter(t => likedIds.includes(t.id));

    document.getElementById('content-view').innerHTML = `
    <div class="view-animate" style="padding:50px;">
        <h1 style="font-size:48px; margin-bottom:30px; font-weight:900;">Liked Songs</h1>
        <div style="margin-top:20px;">
            ${likedTracks.length ? likedTracks.map((t, i) => renderTrackRow(t, i)).join('') : '<p style="color:#666;">No liked songs yet.</p>'}
        </div>
    </div>`;
};

function renderTrackRow(t, i) {
    const parentAlbumIds = t.album_id.split(',').map(s => s.trim());
    const isPlayable = parentAlbumIds.some(aid => {
        const alb = window.ALBUMS.find(a => a.id === aid);
        return alb && !alb.coming_soon;
    });

    return `
    <div class="track-row ${isPlayable ? '' : 'disabled'}" 
         style="display:flex; align-items:center; padding:10px; border-radius:4px; ${isPlayable ? '' : 'opacity:0.3; pointer-events:none;'}"
         onclick="playTrack('${t.id}')">
        <div style="width:30px; color:#666;">${i + 1}</div>
        <div style="flex:1; font-weight:700;">${t.title}</div>
        <div style="color:#666;">${t.duration || '0:00'}</div>
    </div>`;
}

window.viewRecents = function() {
    const recentIds = (typeof window.getRecents === 'function') ? window.getRecents() : [];
    const allTracks = Object.values(window.TRACKS).flat();
    const uniqueTracks = Array.from(new Map(allTracks.map(t => [t.id, t])).values());
    
    // Maintain the order of the recents array
    const recentTracks = recentIds.map(id => uniqueTracks.find(t => t.id === id)).filter(Boolean);

    document.getElementById('content-view').innerHTML = `
    <div class="view-animate" style="padding:50px;">
        <h1 style="font-size:48px; margin-bottom:30px; font-weight:900;">Recently Played</h1>
        <div style="margin-top:20px;">
            ${recentTracks.length ? recentTracks.map((t, i) => renderTrackRow(t, i)).join('') : '<p style="color:#666;">Your history is empty.</p>'}
        </div>
    </div>`;
};

// --- 3. VOLUME & NAVIGATION ---

window.updateVolume = (val) => {
    audio.volume = val;
    if (val > 0) window.preMuteVolume = val;
    updateVolumeIcon(val);
};

window.toggleMute = function() {
    const slider = document.getElementById('volume-slider');
    if (audio.volume > 0) {
        window.preMuteVolume = audio.volume;
        audio.volume = 0;
        if (slider) slider.value = 0;
    } else {
        audio.volume = window.preMuteVolume || 0.5;
        if (slider) slider.value = audio.volume;
    }
    updateVolumeIcon(audio.volume);
};

function updateVolumeIcon(vol) {
    const volIcon = document.getElementById('vol-svg');
    if (!volIcon) return;
    volIcon.innerHTML = vol == 0 ? 
        '<path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>' : 
        '<path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>';
}

window.viewHome = function() {
    // 1. HELPERS
    const getYTThumb = (url) => {
        if (!url) return null;
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        const videoId = (match && match[2].length == 11) ? match[2] : null;
        return videoId ? `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg` : null;
    };

    const getDaysUntil = (dateStr) => {
        const diff = new Date(dateStr) - new Date();
        const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
        return days > 0 ? days : 0;
    };

// 2. DATA PREP
const publicCatalogue = (window.ALBUMS || []).filter(alb => !alb.hidden).map(alb => ({
        ...alb,
        // Override coming_soon based on date
        coming_soon: window.isAlbumComingSoon(alb)
    }));

// SORT: Now using orderId (the Primary Key from Supabase)
const spotlights = (window.SPOTLIGHTS || []).sort((a, b) => {
    return Number(a.orderId) - Number(b.orderId);
});

console.log("Spotlight Order sequence (Numerical):", spotlights.map(s => s.orderId));

    // 3. RENDERER (Dynamic Tags & Pill Indicators)
const renderSlide = (index) => {
    const s = spotlights[index];
    if (!s) return '';

    let displayImg = "";
    let displayTitle = s.customTitle || "Featured";
    let tagText = "FEATURED";
    let subText = s.customSub || "";
    let actionTarget = "";
    let btnText = "View More";

    // 1. RELEASE (ALBUM) LOGIC
if (s.type === "Release") {
        const alb = publicCatalogue.find(a => a.id === s.targetId);
        if (alb) {
            // ... (rest of image/title logic)
            if (alb.coming_soon) {
                tagText = "COMING SOON";
                subText = s.customSub || `Drops in ${getDaysUntil(alb.full_release_date)} days.`;
            } else {
                tagText = "RELEASE SPOTLIGHT";
                // Clear the subText if it was a countdown but the album is now out
                if (!s.customSub) subText = "Available Now"; 
            }
        }
    }
    
    // 2. ARTIST LOGIC
    else if (s.type === "Artist") {
        const art = window.ARTISTS ? window.ARTISTS[s.targetId] : null;
        displayImg = art ? (art.banner_url || art.img_url) : "";
        displayTitle = s.customTitle || (art ? art.name : "Artist");
        tagText = "ARTIST SPOTLIGHT";
        actionTarget = `viewArtist('${s.targetId}')`;
        btnText = "View Profile";
    } 
    
    // 3. TRACK HIGHLIGHT LOGIC
else if (s.type === "Track") {
        // 1. Get all albums that contain this track
        const parentAlbums = publicCatalogue.filter(a => a.track_ids && a.track_ids.includes(s.targetId));
        
        // 2. Filter for strictly NON-coming-soon albums
        const publicReleases = parentAlbums.filter(a => !a.coming_soon);
        
        let latestAlb = null;
        if (publicReleases.length > 0) {
            // Grab the newest PUBLIC release
            latestAlb = publicReleases.sort((a, b) => new Date(b.full_release_date) - new Date(a.full_release_date))[0];
        } else {
            // Fallback to newest regardless if nothing is public yet
            latestAlb = parentAlbums.sort((a, b) => new Date(b.full_release_date) - new Date(a.full_release_date))[0];
        }

        let trackData = null;
        if (latestAlb && window.TRACKS && window.TRACKS[latestAlb.id]) {
            const bucket = window.TRACKS[latestAlb.id];
            // Match against s.targetId (the string ID from Supabase)
            trackData = Array.isArray(bucket) 
                ? bucket.find(t => t.id === s.targetId) 
                : bucket[s.targetId];
        }

        if (trackData && latestAlb) {
            displayImg = trackData.art_url || latestAlb.art_url;
            displayTitle = s.customTitle || trackData.title;
            
            const albumType = latestAlb.track_ids.length === 1 ? 'Single' : 'Album';
            subText = s.customSub || `Featured ${albumType}`;
            
            tagText = "TRACK HIGHLIGHT";
            btnText = "Play Now";
            
            // ACTION FIX: Use s.targetId for the play function
            actionTarget = `viewAlbum('${latestAlb.id}'); setTimeout(() => { if(window.playTrack) window.playTrack('${s.targetId}'); }, 500);`;
        }
    }

    // 4. VIDEO LOGIC
    else if (s.type === "Video") {
        displayImg = getYTThumb(s.url);
        displayTitle = s.customTitle || "New Video";
        tagText = "FEATURED VIDEO";
        actionTarget = `window.open('${s.url}', '_blank')`;
        btnText = "Watch Now";
    }

    // FALLBACK IMAGE
    if (!displayImg && publicCatalogue[0]) displayImg = publicCatalogue[0].art_url;

    return `
    <div class="slide-content slide-anim" onclick="${actionTarget}" style="position:relative; height:100%; width:100%; cursor:pointer; display:flex; align-items:center; padding:0 60px;">
        <div style="position:absolute; inset:0; background:url('${displayImg}') center/cover; filter:blur(40px) brightness(0.3); z-index:1;"></div>
        <div style="position:relative; z-index:2; display:flex; gap:40px; align-items:center; width:100%;">
            <img src="${displayImg}" style="width:220px; height:220px; border-radius:12px; object-fit:cover; box-shadow:0 20px 50px rgba(0,0,0,0.8); border: 1px solid rgba(255,255,255,0.1);">
            <div>
                <span style="background:var(--accent-green); color:#000; padding:5px 12px; font-size:11px; font-weight:900; border-radius:4px; text-transform:uppercase; letter-spacing:1px;">${tagText}</span>
                <h1 style="font-size:72px; margin:15px 0; font-weight:900; color:white; line-height:1; letter-spacing:-3px;">${displayTitle}</h1>
                ${subText ? `<p style="color:rgba(255,255,255,0.6); margin-bottom:20px; font-weight:600;">${subText}</p>` : ''}
                
                <div style="display:flex; align-items:center; gap:20px;">
                    <button class="signup-btn">${btnText}</button>
                    ${spotlights.length > 1 ? `
                    <div style="display:flex; gap:8px;">
                        ${spotlights.map((_, i) => `
                            <div style="width:${i === index ? '24px' : '8px'}; height:8px; background:${i === index ? 'var(--accent-green)' : 'rgba(255,255,255,0.3)'}; border-radius:4px; transition: all 0.3s ease;"></div>
                        `).join('')}
                    </div>
                    ` : ''}
                </div>
            </div>
        </div>
    </div>`;
};

    // 4. MOVE LOGIC (With Animation trigger)
    window.moveSpotlight = (dir) => {
        if (!spotlights.length) return;
        const slider = document.getElementById('spotlight-slider-content');
        if (!slider) return;

        window.currentSpotlightIndex = ((window.currentSpotlightIndex || 0) + dir + spotlights.length) % spotlights.length;
        
        // Instant update
        slider.innerHTML = renderSlide(window.currentSpotlightIndex);
        
        // Reset timer
        if (window.spotlightInterval) clearInterval(window.spotlightInterval);
        window.spotlightInterval = setInterval(() => window.moveSpotlight(1), 7000);
    };

    // 5. MAIN RENDER
    const content = document.getElementById('content-view');
    if (!content) return;

    content.innerHTML = `
    <style>
        .spot-container { position:relative; height:320px; border-radius:15px; overflow:hidden; background:#000; margin-bottom:40px; }
        .nav-arrow { 
            position:absolute; top:0; bottom:0; width:80px; z-index:10; 
            display:flex; align-items:center; justify-content:center; 
            cursor:pointer; opacity:0; transition:0.3s; color:white;
        }
        .spot-container:hover .nav-arrow { opacity:1; }
        .prev-arrow { left:0; background: linear-gradient(to right, rgba(0,0,0,0.7), transparent); }
        .next-arrow { right:0; background: linear-gradient(to left, rgba(0,0,0,0.7), transparent); }
        
        /* The Sliding Animation */
        .slide-anim { animation: slideIn 0.4s ease-out forwards; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>

    <div class="view-animate" style="padding:40px;">
        <div class="spot-container">
            <div class="nav-arrow prev-arrow" onclick="event.stopPropagation(); window.moveSpotlight(-1)">
                <span class="material-icons" style="font-size:40px;">chevron_left</span>
            </div>
            <div class="nav-arrow next-arrow" onclick="event.stopPropagation(); window.moveSpotlight(1)">
                <span class="material-icons" style="font-size:40px;">chevron_right</span>
            </div>
            <div id="spotlight-slider-content" style="height:100%;">
                ${renderSlide(window.currentSpotlightIndex || 0)}
            </div>
        </div>

        <h2 style="margin-bottom:24px; font-weight:900; font-size:24px;">Catalogue</h2>
        <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:30px;">
            ${publicCatalogue.map(alb => `
                <div class="glow-card" onclick="viewAlbum('${alb.id}')" style="cursor:pointer; background:#0a0a0a; padding:20px; border-radius:12px;">
                    <img src="${alb.art_url}" style="width:100%; aspect-ratio:1; border-radius:8px; margin-bottom:12px; ${alb.coming_soon ? 'filter:grayscale(1); opacity:0.5;' : ''}">
                    <div style="font-weight:700; color:white;">${alb.name}</div>
                    <div style="color:${alb.coming_soon ? '#ff4444' : '#666'}; font-size:12px; margin-top:5px; font-weight: 700;">
                        ${alb.coming_soon ? 'COMING SOON' : (alb.full_release_date || 'RELEASED')}
                    </div>
                </div>
            `).join('')}
        </div>
    </div>`;

    if (window.spotlightInterval) clearInterval(window.spotlightInterval);
    if (spotlights.length > 1) {
        window.spotlightInterval = setInterval(() => window.moveSpotlight(1), 7000);
    }
};


function initSidebarLogic() {
    const sidebar = document.getElementById('sidebar');
    const resizer = document.getElementById('sidebar-resizer');
    
    if (!sidebar || !resizer) return;

    let isResizing = false;

    // Apply initial state from localStorage immediately
    if (isSidebarCollapsed) {
        sidebar.classList.add('collapsed');
        sidebar.style.width = '80px';
    } else {
        const savedWidth = localStorage.getItem('trm_sidebar_width');
        if (savedWidth) sidebar.style.width = savedWidth;
    }

    resizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        document.body.style.cursor = 'col-resize';
        sidebar.style.transition = 'none'; // Disable transition while dragging for smoothness
    });

    document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        
        let newWidth = e.clientX;
        
        // Snapping logic
        if (newWidth < 150) {
            newWidth = 80;
            sidebar.classList.add('collapsed');
            isSidebarCollapsed = true;
        } else {
            sidebar.classList.remove('collapsed');
            isSidebarCollapsed = false;
        }
        
        if (newWidth > 450) newWidth = 450;
        
        sidebar.style.width = newWidth + 'px';
    });

    document.addEventListener('mouseup', () => {
        if (!isResizing) return;
        isResizing = false;
        document.body.style.cursor = 'default';
        sidebar.style.transition = 'width 0.3s cubic-bezier(0.4, 0, 0.2, 1)'; // Restore transition
        
        // Save states
        localStorage.setItem('trm_sidebar_width', sidebar.style.width);
        localStorage.setItem('trm_sidebar_collapsed', isSidebarCollapsed);
    });
}

window.toggleSidebar = function() {
    const sb = document.getElementById('sidebar');
    if (!sb) return;
    
    isSidebarCollapsed = !isSidebarCollapsed;
    if (isSidebarCollapsed) {
        sb.classList.add('collapsed');
        sb.style.width = '80px';
    } else {
        sb.classList.remove('collapsed');
        const savedWidth = localStorage.getItem('trm_sidebar_width');
        sb.style.width = (savedWidth && savedWidth !== '80px') ? savedWidth : '280px';
    }
    localStorage.setItem('trm_sidebar_collapsed', isSidebarCollapsed);
};

// --- CRITICAL: Link Player State to Album View ---
const originalUpdateUI = window.updatePlayerUI;

window.updatePlayerUI = function() {
    // Run the original desktop/bottom player UI updates first
    if (typeof originalUpdateUI === 'function') originalUpdateUI();

    // NEW: If the user is currently looking at an album, refresh the view
    // This ensures the Play/Pause icon and track highlights update instantly
    if (window.currentView === 'album' && window.viewingAlbumId) {
        window.viewAlbum(window.viewingAlbumId, false); // false = don't scroll to top
    }
};

// Centralized logic to check if an album should still be "Coming Soon"
window.isAlbumComingSoon = function(alb) {
    if (!alb.coming_soon) return false;
    if (!alb.full_release_date) return true;

    const rawDate = alb.full_release_date.trim();
    
    // Check if it's just a year (e.g., "2027")
    if (/^\d{4}$/.test(rawDate)) {
        return new Date().getFullYear() <= parseInt(rawDate);
    } 
    
    // Check full date
    const cleanedDate = rawDate.replace(/(\d+)(st|nd|rd|th)/, "$1");
    const dateObj = new Date(cleanedDate);
    if (!isNaN(dateObj)) {
        return new Date() < dateObj;
    }

    return true; // Fallback to coming soon if date is unparseable
};

window.viewAlbum = function(id, scrollToTop = true) {
    const alb = window.ALBUMS.find(a => a.id === id);
    if (!alb) return;
    
    window.currentView = 'album';
    window.viewingAlbumId = id;

    const artist = window.ARTISTS[alb.artist_id] || { name: "therichmusic", id: "" };
    const tks = alb.track_list || []; 
    
    const isActuallyComingSoon = window.isAlbumComingSoon(alb);
    const isReleased = !isActuallyComingSoon;
    const dateLabel = isReleased ? "Released" : "Releasing";
    let finalDateDisplay = "";

    if (alb.full_release_date) {
        const rawDate = alb.full_release_date.trim();
        if (/^\d{4}$/.test(rawDate)) {
            finalDateDisplay = rawDate;
        } else {
            const cleanedDate = rawDate.replace(/(\d+)(st|nd|rd|th)/, "$1");
            const dateObj = new Date(cleanedDate);
            if (!isNaN(dateObj)) {
                finalDateDisplay = dateObj.toLocaleDateString(undefined, {
                    year: 'numeric', month: 'long', day: 'numeric'
                });
            } else {
                finalDateDisplay = rawDate;
            }
        }
    }

    const detectPlatform = (url) => {
        const u = url.toLowerCase();
        if (u.includes('bandcamp.com')) return 'Bandcamp';
        if (u.includes('even.biz'))     return 'EVEN';
        if (u.includes('apple.com'))    return 'iTunes';
        if (u.includes('amazon.com'))   return 'Amazon';
        if (u.includes('shopify.com'))  return 'Shop';
        return 'Store';
    };

    const purchaseArray = (Array.isArray(alb.purchase_links) ? alb.purchase_links : []).map(item => {
        if (item.includes('|')) {
            const [url, title] = item.split('|');
            return { url: url.trim(), label: title.trim() };
        }
        return { url: item.trim(), label: detectPlatform(item) };
    });

    const calculateTotalRuntime = (tracks) => {
        let totalSeconds = 0;
        let hasPlayableTracks = false;
        tracks.forEach(t => {
            if (typeof t === 'string') return;
            const parentIds = t.album_id ? t.album_id.split(',').map(s => s.trim()) : [];
            const isReleasedElsewhere = parentIds.some(aid => {
                const other = window.ALBUMS.find(a => a.id === aid);
                return other && !window.isAlbumComingSoon(other);
            });
            if (isReleasedElsewhere || isReleased) {
                if (t.duration && t.duration !== "??:??") {
                    const parts = t.duration.split(':');
                    totalSeconds += (parseInt(parts[0]) * 60) + parseInt(parts[1]);
                    hasPlayableTracks = true;
                }
            }
        });
        if (!hasPlayableTracks) return null;
        const mins = Math.floor(totalSeconds / 60);
        const secs = totalSeconds % 60;
        return `${mins} min ${secs} sec`;
    };

    const albumRuntime = calculateTotalRuntime(tks);
    const formattedDescription = alb.description ? alb.description.replace(/~~(.+?)~~/g, '<s>$1</s>') : '';
    const isThisAlbumActive = (window.currentAlbumId === id);
    const isCurrentlyPlaying = isThisAlbumActive && window.isPlaying;
    const playIcon = isCurrentlyPlaying ? 'pause' : 'play_arrow';

    const content = `
    <div class="${scrollToTop ? 'view-animate' : ''}" style="padding:50px;">
        <style>
            .album-description { margin-top: 25px; color: #b3b3b3; font-size: 14px; line-height: 1.6; max-width: 700px; white-space: pre-wrap; }
            .album-description s { color: rgba(255,255,255,0.3); }
            .album-action-btn { padding: 10px 20px; border-radius: 6px; font-weight: 800; font-size: 13px; text-transform: uppercase; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px; border: none; }
            .btn-signup { background: var(--accent-green); color: black; }
            .btn-purchase { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }
            .purchase-menu { display: none; position: absolute; top: 115%; left: 0; background: #181818; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; min-width: 180px; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
            .menu-item { padding: 12px 20px; color: #ccc; font-size: 13px; font-weight: 700; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
            .menu-item:hover { background: #282828; color: var(--accent-green); }
            .show-menu { display: block !important; }
        </style>

        <div style="display:flex; gap:30px; align-items:flex-end; margin-bottom:30px;">
            <div style="position:relative;">
                <img src="${alb.art_url}" style="width:240px; height:240px; border-radius:12px; box-shadow: 0 15px 50px rgba(0,0,0,0.6);">
                ${!isReleased ? `<div style="position:absolute; top:10px; right:10px; background:var(--accent-green); color:black; padding:4px 12px; border-radius:20px; font-weight:900; font-size:10px; text-transform:uppercase;">Coming Soon</div>` : ''}
            </div>
            <div style="flex:1;">
                <p style="color:var(--accent-green); font-weight:900; letter-spacing:1px; margin-bottom:8px;">${(alb.type || 'ALBUM').toUpperCase()}</p>
                <h1 style="font-size:84px; margin:0; font-weight:900; letter-spacing:-4px; line-height:1; margin-bottom:20px;">${alb.name}</h1>
                
                <div style="display:flex; align-items:center; gap:12px; margin-bottom: 25px;">
                    <button onclick="playAlbum('${alb.id}')" style="background:white; border:none; color:black; width:65px; height:65px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                        <span class="material-icons" style="font-size:40px; color:${isCurrentlyPlaying ? 'var(--accent-green)' : 'black'}">${playIcon}</span>
                    </button>

                    ${(!isReleased && alb.signup_link) ? `
                        <button class="album-action-btn btn-signup" onclick="window.open('${alb.signup_link}', '_blank')">
                            <span class="material-icons" style="font-size:18px;">mail</span> Sign Up
                        </button>
                    ` : ''}

                    ${purchaseArray.length > 0 ? `
                        <div style="position:relative;">
                            <button class="album-action-btn btn-purchase" onclick="togglePurchaseMenu(this)">
                                <span class="material-icons" style="font-size:18px;">shopping_cart</span> 
                                ${isReleased ? 'Purchase' : 'Pre-Order'}
                                <span class="material-icons" style="font-size:16px;">expand_more</span>
                            </button>
                            <div id="purchase-dropdown" class="purchase-menu">
                                ${purchaseArray.map(link => `
                                    <div class="menu-item" onclick="window.open('${link.url}', '_blank')">
                                        ${link.label}
                                        <span class="material-icons" style="font-size:14px; opacity:0.5;">open_in_new</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${alb.trailer_url ? `
                        <button onclick="window.openVideoPlayer('${alb.trailer_url}')" style="background:rgba(255,0,0,0.15); border:1px solid rgba(255,0,0,0.3); color:#ff4e4e; width:45px; height:45px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                             <span class="material-icons">smart_display</span>
                        </button>
                    ` : ''}

                    <button id="share-btn" onclick="copyAlbumLink('${alb.id}')" style="background:rgba(255,255,255,0.1); border:none; color:white; width:45px; height:45px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                        <span class="material-icons">share</span>
                    </button>
                </div>

                <div style="display:flex; align-items:center; gap:8px; margin-top:10px; color:#aaa; font-size:14px;">
                    <span onclick="viewArtist('${artist.id}')" style="cursor:pointer; text-decoration:underline; font-weight:700; color:white;">${artist.name}</span> 
                    <span>â€¢</span>
                    <span>${tks.filter(i => typeof i !== 'string').length} Songs</span>
                    ${albumRuntime ? `<span>â€¢</span> <span>${albumRuntime}</span>` : ''}
                    ${alb.genre ? `<span>â€¢</span> <span>${alb.genre}</span>` : ''}
                    ${finalDateDisplay ? `<span>â€¢</span> <span style="font-size:12px; font-weight:600; text-transform:uppercase;">${dateLabel} ${finalDateDisplay}</span>` : ''}
                </div>

                ${formattedDescription ? `<div class="album-description">${formattedDescription}</div>` : ''}
            </div>
        </div>

        <div style="margin-top:20px; border-top: 1px solid rgba(255,255,255,0.05); padding-top:20px;">
            ${(() => {
                let discTrackCounter = 0;
                let currentDiscNum = 1;
                const trackList = alb.track_list || [];
                const hasMultipleDiscs = trackList.some(item => typeof item === 'string' && item.startsWith('DISC_'));

                return trackList.map((item, index) => {
                    if (typeof item === 'string' && item.startsWith('DISC_')) {
                        currentDiscNum = item.split('_')[1] || (currentDiscNum + 1);
                        discTrackCounter = 0; 
                        if (hasMultipleDiscs) {
                            return `<div style="width:100%; padding: 40px 15px 15px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom:10px; margin-top:20px;">
                                <h3 style="text-transform: uppercase; letter-spacing: 3px; font-size: 12px; color: var(--accent-green); margin: 0; font-weight: 900; display: flex; align-items: center; gap: 10px;">
                                    <span class="material-icons" style="font-size: 18px;">album</span> Disc ${currentDiscNum}
                                </h3>
                            </div>`;
                        }
                        return '';
                    }

                    const t = item;
                    if (!t) return '';

                    let htmlBuffer = '';
                    if (index === 0 && hasMultipleDiscs) {
                        htmlBuffer += `<div style="width:100%; padding: 10px 15px 15px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom:10px;"><h3 style="text-transform: uppercase; letter-spacing: 3px; font-size: 11px; color: #666; margin: 0; font-weight: 900;">Disc 1</h3></div>`;
                    }

                    const isVideo = t.isVideo || (t.id && t.id.startsWith('video_'));
                    if (!isVideo) discTrackCounter++;
                    
                    // --- FIXED ORDER: Define isPlayable BEFORE using it ---
                    const parentIds = t.album_id ? t.album_id.split(',').map(s => s.trim()) : [];
                    const isReleasedElsewhere = parentIds.some(aid => {
                        const other = window.ALBUMS.find(a => a.id === aid);
                        return other && !window.isAlbumComingSoon(other);
                    });
                    const isPlayable = isReleasedElsewhere || isReleased;
                    const isCurrentTrack = (window.currentTrackId === t.id && window.currentAlbumId === id);
                    const isBonusTrack = t.bonus_track === true;

                    const displayTitle = (isPlayable || isVideo) ? t.title : `Track ${discTrackCounter}`;
                    
                    const rightContent = isVideo 
                        ? `<span class="material-icons" style="font-size:18px; color:var(--accent-green); opacity:0.8;">videocam</span>`
                        : `<div style="color:#666; font-family:monospace; font-size:13px;">${isPlayable ? (t.duration || '0:00') : '??:??'}</div>`;

                    const clickAction = isVideo 
                        ? `onclick="event.preventDefault(); window.openVideoPlayer('${t.videoUrl}')"` 
                        : isPlayable ? `onclick="playTrack('${t.id}', true, '${alb.id}')"` : '';

                    htmlBuffer += `
                    <div class="track-row" 
                         style="display:flex; align-items:center; padding:12px 15px; border-radius:8px; cursor:pointer; background:${isCurrentTrack ? 'rgba(255,255,255,0.05)' : 'transparent'}; opacity:${(isPlayable || isVideo) ? '1' : '0.4'}; transition: 0.2s;"
                         ${clickAction}>
                        <div style="width:40px; color:${isCurrentTrack ? 'var(--accent-green)' : '#666'}; font-weight:bold;">
                            ${isVideo ? '<span class="material-icons" style="font-size:18px;">ondemand_video</span>' : (isCurrentTrack && window.isPlaying ? '<span class="material-icons" style="font-size:18px;">volume_up</span>' : discTrackCounter)}
                        </div>
                        <div style="flex:1; display:flex; align-items:center; gap:10px; font-weight:600; color:${isCurrentTrack ? 'var(--accent-green)' : 'white'};">
                            <span>${displayTitle}</span>
                            ${isBonusTrack ? `
                                <span style="padding: 2px 8px; background: rgba(0, 255, 135, 0.1); border: 1px solid rgba(0, 255, 135, 0.3); color: var(--accent-green); font-size: 10px; font-weight: 900; text-transform: uppercase; border-radius: 4px; letter-spacing: 0.5px; white-space: nowrap;">Bonus Track</span>
                            ` : ''}
                        </div>
                        ${rightContent}
                    </div>`;
                    
                    return htmlBuffer;
                }).join('');
            })()}
        </div>
    </div>`;

    const container = document.getElementById('content-view');
    container.innerHTML = content;
    if (scrollToTop) container.scrollTop = 0;
};

window.openVideoPlayer = function(url) {
    if (!url || url === 'undefined') return;
    const videoId = url.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^& \n?]+)/)?.[1];
    if (!videoId) return;

    if (window.audioPlayer) window.audioPlayer.pause();

    const old = document.getElementById('video-overlay');
    if (old) old.remove();

    const modal = document.createElement('div');
    modal.id = "video-overlay";
    modal.className = "video-overlay-active"; // Triggers immediate fade-in
    
    modal.setAttribute('style', `
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.95); z-index: 2147483647;
        display: flex; align-items: center; justify-content: center;
    `);
    
    // We leave the iframe out of the initial HTML to let the animation run smoothly
    modal.innerHTML = `
        <div class="video-content-active" style="width:90%; max-width:1100px;">
            <div style="display:flex; justify-content:flex-end; margin-bottom:15px;">
                <button onclick="closeVideoPlayer()" 
                        style="background:#00ff87; color:black; border:none; padding:12px 25px; font-weight:900; cursor:pointer; border-radius:30px; text-transform:uppercase;">
                    âœ• Close Video
                </button>
            </div>
            <div id="iframe-container" style="padding-top:56.25%; position:relative; background:#000; border-radius:16px; overflow:hidden; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 50px rgba(0,0,0,0.5);">
                <div id="video-loader" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); color:white; font-family:sans-serif;">Loading Visualizer...</div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);

    // Wait 500ms for the animation to finish, THEN load the heavy iframe
    setTimeout(() => {
        const container = document.getElementById('iframe-container');
        container.innerHTML = `
            <iframe style="position:absolute; top:0; left:0; width:100%; height:100%;" 
                    src="https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0" 
                    frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
        `;
    }, 500);
};

window.closeVideoPlayer = function() {
    const modal = document.getElementById('video-overlay');
    const content = modal ? modal.querySelector('.video-content-active') : null;
    
    if (modal) {
        // Add the exit animation classes
        modal.classList.add('modal-exit-active');
        if (content) content.classList.add('content-exit-active');

        // Wait for the animation (300ms) then destroy the element
        setTimeout(() => {
            modal.remove();
        }, 300);
    }
};

// GLOBAL DROPDOWN TOGGLE
window.togglePurchaseMenu = function(btn) {
    const menu = document.getElementById('purchase-dropdown');
    menu.classList.toggle('show-menu');
    
    const closeMenu = (e) => {
        if (!btn.contains(e.target) && !menu.contains(e.target)) {
            menu.classList.remove('show-menu');
            document.removeEventListener('click', closeMenu);
        }
    };
    document.addEventListener('click', closeMenu);
};

window.playAlbum = function(albumId) {
    // 1. If already viewing this album, just toggle the play/pause state
    if (window.currentAlbumId === albumId) {
        if (window.togglePlay) window.togglePlay();
        if (window.updatePlayerUI) window.updatePlayerUI();
        // Since we changed the icon color logic in viewAlbum, we re-render the button
        window.viewAlbum(albumId, false); 
        return;
    }

    const album = window.ALBUMS.find(a => a.id === albumId);
    if (!album || !album.track_list) return;

    // 2. Check the "Coming Soon" status using our global helper
    const isAlbumReleased = !window.isAlbumComingSoon(album);

    // 3. Find the first track that is ACTUALLY a track object and is playable
    const firstPlayable = album.track_list.find(t => {
        // Skip markers (strings)
        if (typeof t === 'string') return false;
        // Skip videos
        if (t.isVideo || (t.id && t.id.startsWith('video_'))) return false;

        const parentAlbumIds = t.album_id ? t.album_id.split(',').map(s => s.trim()) : [];
        const isReleasedElsewhere = parentAlbumIds.some(aid => {
            const otherAlb = window.ALBUMS.find(a => a.id === aid);
            return otherAlb && !window.isAlbumComingSoon(otherAlb);
        });

        return isReleasedElsewhere || isAlbumReleased;
    });

    if (firstPlayable) {
        console.log(`Playing first available track: ${firstPlayable.title}`);
        window.playTrack(firstPlayable.id, true, albumId);
        
        // Update the UI immediately so the play button changes icon
        if (window.updatePlayerUI) window.updatePlayerUI();
        window.viewAlbum(albumId, false);
    } else {
        console.warn("No playable audio tracks available in this album yet.");
    }
};
    
window.copyAlbumLink = function(albumId) {
    const baseUrl = "https://trm-brand-shop.fourthwall.com/pages/music-player"; 
    // Switching to the Hash (#) for better iframe compatibility
    const shareUrl = `${baseUrl}#${albumId}`;

    navigator.clipboard.writeText(shareUrl).then(() => {
        const btn = document.getElementById('share-btn');
        if (btn) {
            const icon = btn.querySelector('.material-icons');
            const originalText = btn.innerHTML;
            
            if (icon) icon.innerText = 'check';
            btn.style.background = 'var(--accent-green)';
            btn.style.color = '#000';

            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = '';
                btn.style.color = '';
            }, 2000);
        }
    }).catch(err => {
        console.error('Could not copy text: ', err);
    });
};

window.nextTrack = function() {
    const album = window.ALBUMS.find(a => a.id === window.currentAlbumId);
    if (!album || !album.track_list) return false;

    let currentIndex = album.track_list.findIndex(t => t.id === window.currentTrackId);
    
    // Look for the next playable track in the list
    for (let i = currentIndex + 1; i < album.track_list.length; i++) {
        const t = album.track_list[i];
        
        // Parity Check: Is this track released anywhere?
        const parentAlbumIds = t.album_id ? t.album_id.split(',').map(s => s.trim()) : [];
        const isReleasedElsewhere = parentAlbumIds.some(aid => {
            const otherAlb = window.ALBUMS.find(a => a.id === aid);
            return otherAlb && !otherAlb.coming_soon;
        });

        if (isReleasedElsewhere || !album.coming_soon) {
            window.playTrack(t.id, true, window.currentAlbumId);
            return true;
        }
    }

    console.log("No more playable tracks found in this album.");
    return false;
};

window.prevTrack = function() {
    const album = window.ALBUMS.find(a => a.id === window.currentAlbumId);
    if (!album || !album.track_list) return;

    let currentIndex = album.track_list.findIndex(t => t.id === window.currentTrackId);

    // If we are more than 3 seconds into a song, just restart the current song
    if (audio.currentTime > 3) {
        audio.currentTime = 0;
        return;
    }

    // Look backward for the first playable track
    for (let i = currentIndex - 1; i >= 0; i--) {
        const t = album.track_list[i];
        
        // Parity Check: Is this track released anywhere?
        const parentAlbumIds = t.album_id ? t.album_id.split(',').map(s => s.trim()) : [];
        const isReleasedElsewhere = parentAlbumIds.some(aid => {
            const otherAlb = window.ALBUMS.find(a => a.id === aid);
            return otherAlb && !otherAlb.coming_soon;
        });

        if (isReleasedElsewhere || !album.coming_soon) {
            window.playTrack(t.id, true, window.currentAlbumId);
            return;
        }
    }

    // If no previous playable track exists, just restart the current one
    audio.currentTime = 0;
};

window.toggleShuffle = () => { window.isShuffle = !window.isShuffle; document.getElementById('shuffle-btn').classList.toggle('active', window.isShuffle); };
window.toggleLoop = () => {
    if (window.loopState === undefined) window.loopState = 0;
    window.loopState = (window.loopState + 1) % 3;

    const btn = document.getElementById('loop-btn');
    const svg = document.getElementById('loop-svg');
    if (!btn || !svg) return;

    // SVG Paths
    const pathNormal = "M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z";
    const pathOne = "M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4zm-4-2V9h-1l-2 1v1h1.5v4H13z";

    if (window.loopState === 0) {
        btn.style.color = 'rgba(255,255,255)'; // Dim when off
        svg.querySelector('path').setAttribute('d', pathNormal);
    } else if (window.loopState === 1) {
        btn.style.color = 'var(--accent-green)';   // Loop All
        svg.querySelector('path').setAttribute('d', pathNormal);
    } else if (window.loopState === 2) {
        btn.style.color = 'var(--accent-green)';   // Loop One
        svg.querySelector('path').setAttribute('d', pathOne);
    }
    
    console.log("Loop State:", window.loopState);
};

window.togglePanel = function() {
    const panel = document.getElementById('info-panel');
    if (panel) panel.classList.toggle('open');
};

function updatePlayerUI() {
    const icon = document.getElementById('play-icon');
    if (icon) icon.innerHTML = window.isPlaying ? '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>' : '<path d="M8 5v14l11-7z"/>';
}

window.initApp = async function() {
    try {
        console.log("TRM MUSIC PLAYER: Initializing v1.0.4.0 (Video Support)...");

        // 1. FETCH ALL DATA IN PARALLEL (FAST)
        const [
            { data: artists },
            { data: albums },
            { data: tracks },
            { data: spotlightRows },
            { data: videos } // Added videos fetch
        ] = await Promise.all([
            supabaseClient.from('artists').select('*'),
            supabaseClient.from('albums').select('*'),
            supabaseClient.from('tracks').select('*'),
            supabaseClient.from('spotlight').select('*').eq('active', true).order('created_at', { ascending: false }).limit(4),
            supabaseClient.from('videos').select('*') // New table for Music Videos
        ]);

        // 2. PROCESS DATA
        window.SPOTLIGHTS = (spotlightRows || []).map(row => ({
            type: row.type,
            orderId: row.id,
            targetId: row.target_id,
            url: row.url,
            customTitle: row.custom_title,
            customSub: row.custom_sub
        }));
        
        window.ARTISTS = {};
        if (artists) artists.forEach(a => { window.ARTISTS[a.id] = a; });

        const parseDate = (str) => {
            if (!str || str === 'RELEASED') return 0;
            const cleanDate = str.replace(/(\d+)(st|nd|rd|th)/, "$1");
            return Date.parse(cleanDate) || 0;
        };

        window.ALBUMS = (albums || []).sort((a, b) => parseDate(b.full_release_date) - parseDate(a.full_release_date));

        // Create a master lookup for both audio tracks and music videos
        const trackLookup = {};
        if (tracks) tracks.forEach(t => { trackLookup[t.id] = t; });
        
        // Merge videos into lookup with the 'video_' ID prefix requirement
if (videos) {
    videos.forEach(v => { 
        // Force the ID to have the 'video_' prefix for the tracklist lookup
        const videoKey = v.id.startsWith('video_') ? v.id : `video_${v.id}`;
        
        // IMPORTANT: Map 'v.url' (from DB) to 'videoUrl' (internal)
        trackLookup[videoKey] = { 
            ...v, 
            id: videoKey, 
            isVideo: true, 
            videoUrl: v.url 
        }; 
    });
}
        
        window.TRACKS = {};
        window.ALBUMS.forEach(alb => {
            const manualOrder = alb.track_ids || []; 
            
            // Map the IDs while preserving DISC markers and handling Video objects
            alb.track_list = manualOrder.map(id => {
                if (typeof id === 'string' && id.startsWith('DISC_')) return id;
                return trackLookup[id];
            }).filter(Boolean); 

            window.TRACKS[alb.id] = alb.track_list;
        });

        // 3. RENDER SIDEBAR IMMEDIATELY
        renderSidebar();

        // 4. DEEP LINKING & INITIAL VIEW
        const urlParams = new URLSearchParams(window.location.search);
        const directAlbumId = urlParams.get('album') || window.location.hash.replace('#', '');

        if (directAlbumId) {
            window.viewAlbum(directAlbumId);
        } else {
            window.viewHome();
            console.log("Listening for Bridge handshake in background...");
            window.handleDeepLinking(); 
        }

    } catch (e) { 
        console.error("Initialization failed:", e); 
    }
}

function renderSidebar() {
    const sb = document.getElementById('sidebar-releases');
    if (sb) {
        sb.innerHTML = window.ALBUMS.filter(alb => !alb.hidden).map(alb => `
            <div class="sidebar-item" onclick="viewAlbum('${alb.id}')">
                <img src="${alb.art_url}" style="width:24px; height:24px; border-radius:2px; margin-right:10px;">
                <span>${alb.name}</span>
            </div>`).join('');
    }
}

window.handleDeepLinking = async function() {
    let albumId = null;

    // 1. Try Local URL (Immediate)
    const urlParams = new URLSearchParams(window.location.search);
    albumId = urlParams.get('album') || window.location.hash.replace('#', '');

    if (albumId) {
        processDeepLink(albumId);
        return;
    }

    // 2. Create a "Waiting Room" Promise
    console.log("Waiting for Parent Broadcast...");
    
    const waitForMessage = new Promise((resolve) => {
        const listener = (event) => {
            if (event.data && event.data.type === 'SET_ALBUM') {
                window.removeEventListener('message', listener); // Clean up
                resolve(event.data.id);
            }
        };
        window.addEventListener('message', listener);
        
        // Safety timeout: If no message in 2 seconds, resolve as null
        setTimeout(() => {
            window.removeEventListener('message', listener);
            resolve(null);
        }, 2000);
    });

    // 3. Wait for the promise to finish
    const receivedId = await waitForMessage;

    if (receivedId) {
        console.log("Deep link received via Bridge:", receivedId);
        processDeepLink(receivedId);
    } else {
        console.log("No deep link received, loading Home.");
        // window.viewHome();
    }
};

function processDeepLink(id) {
    const albumExists = window.ALBUMS && window.ALBUMS.find(a => a.id === id);
    if (albumExists) {
        window.viewAlbum(id);
    } else {
        window.viewHome();
    }
}

async function toggleDesktopPiP() {
    const video = document.getElementById('pip-video');
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = 512;
    canvas.height = 512;

    const albumArtUrl = document.getElementById('player-art').src;
    const trackTitle = document.getElementById('player-title').innerText;
    const artistName = document.getElementById('player-artist').innerText;

    if (!albumArtUrl) return;

    const img = new Image();
    img.crossOrigin = "Anonymous"; 
    img.src = albumArtUrl;

    img.onload = async () => {
        // Draw Background
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Draw Album Art
        ctx.drawImage(img, 0, 0, 512, 512);

        // Capture stream if not already active
        if (!video.srcObject) {
            video.srcObject = canvas.captureStream();
            await video.play();
        }

        try {
            if (document.pictureInPictureElement) {
                await document.exitPictureInPicture();
                document.getElementById('pip-btn').classList.remove('active');
            } else {
                await video.requestPictureInPicture();
                document.getElementById('pip-btn').classList.add('active');
            }
        } catch (error) {
            console.error("PiP failed:", error);
        }
    };
}

window.openPatchNotes = function() {
    const versionHistory = [
        {
            version: "v1.0.4",
            date: "February 12, 2026",
            notes: [
                "âš™ï¸ Did someone say more new features? Well we got them!",
                "ðŸ“º Videos are now in albums! These are currently in beta, so for right now they won't be everywhere... but expect them on your favorite albums soon!",
                "ðŸ’¿ Multiple Disc albums are here, check this out with the new RICH album (which also has a video...)",
                "ðŸ·ï¸ You can now see 'Bonus Track' tags on all albums! If your favorite artist thinks it's a bonus track they can now mark their album to have a bonus track.",
                "ðŸ†• All 'Upcoming' releases are now automatically released ON their release date!",
                "ðŸ’¬ Release descriptions are finally here! Launching for all Artists with v1.0.4.1",
                "âŒš Release pages now track the runtime of ALL released tracks!",
                "ðŸŽ¸ Genres now appear on release pages!",
            ],
            actionButton: {
                text: "VISIT THE BRAND SHOP",
                url: "https://trm-brand-shop.fourthwall.com"
            }
        },
        {
            version: "v1.0.3.9",
            date: "February 10, 2026",
            notes: ["â¬†ï¸ Deployed a patch to fix up Spotlight!"],
            actionButton: {
                text: "VISIT THE BRAND SHOP",
                url: "https://trm-brand-shop.fourthwall.com"
            }
        },
        {
            version: "v1.0.3.8",
            date: "February 10, 2026",
            notes: ["ðŸ”— Fixed up Release Sharing", "ðŸ“¹ Spotlight now rotates!"],
            actionButton: {
                text: "VISIT THE BRAND SHOP",
                url: "https://trm-brand-shop.fourthwall.com"
            }
        },
        {
            version: "v1.0.3.2",
            date: "February 10, 2026",
            notes: ["ðŸ› ï¸ Bug fixes, away! Hammered out a bug regarding copying album links. Test #2, away!"],
            actionButton: {
                text: "VISIT THE BRAND SHOP",
                url: "https://trm-brand-shop.fourthwall.com"
            }
        },
        {
            version: "v1.0.3.1",
            date: "February 10, 2026",
            notes: ["ðŸ”— Updated Copy Link, should return the Fourthwall link instead of Githack."],
            actionButton: {
                text: "VISIT THE BRAND SHOP",
                url: "https://trm-brand-shop.fourthwall.com"
            }
        },
        {
            version: "v1.0.3",
            date: "February 10, 2026",
            notes: [
                "ðŸ”— Added Artist Social Links.",
                "ðŸ“º Added Featured Videos on Artist Pages.",
                "ðŸŽžï¸ Added Trailers to Album Pages.",
                "ðŸ“… Added Release Dates to Album Pages.",
                "ðŸ‘¤ Added 'Become An Artist' Button to Sidebar.",
                "ðŸ—’ï¸ Added Patch Notes.",
                "ðŸ‘€ And there's more... coming soon!",
                "<a href='https://tally.so/r/aQYrxy' target='_blank' rel='noopener noreferrer' style='color:#00ff88; text-decoration:none;'>ðŸ“ Sign Up to be an Artist!</a>"
            ],
            actionButton: {
                text: "VISIT THE BRAND SHOP",
                url: "https://trm-brand-shop.fourthwall.com"
            }
        },
    ];

    if (document.getElementById('patch-modal-root')) return;

    const root = document.createElement('div');
    root.id = 'patch-modal-root';
    Object.assign(root.style, {
        all: 'initial',
        position: 'fixed',
        inset: '0',
        zIndex: '2147483647',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        fontFamily: 'sans-serif'
    });

    const currentRelease = versionHistory[0];

    root.innerHTML = `
        <div style="position: absolute; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);"></div>
        
        <div style="position: relative; background: #0d0d0d; border: 1px solid #222; width: 90%; max-width: 450px; max-height: 80vh; display: flex; flex-direction: column; border-radius: 24px; color: white; box-shadow: 0 30px 60px rgba(0,0,0,0.8); animation: modalFadeIn 0.3s ease-out; overflow: hidden;">
            
            <div style="padding: 40px 40px 20px 40px;">
                <button onclick="document.getElementById('patch-modal-root').remove()" style="position: absolute; top: 20px; right: 20px; background: none; border: none; color: #444; cursor: pointer; font-size: 24px;">&times;</button>
                <h2 style="font-size: 32px; font-weight: 900; margin: 0; letter-spacing: -1px; color: white; font-family: inherit;">Patch Notes</h2>
                <p style="color: #00ff88; font-weight: 800; font-size: 11px; margin: 5px 0 0 0; letter-spacing: 1px; text-transform: uppercase; font-family: inherit;">VERSION ${currentRelease.version}</p>
            </div>

            <div class="patch-scroll-area" style="overflow-y: auto; padding: 0 40px; flex: 1; margin-bottom: 20px;">
                <div style="padding-bottom: 10px;">
                    ${versionHistory.map(release => `
                        <div style="margin-bottom: 25px; border-left: 2px solid #222; padding-left: 20px;">
                            <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 10px;">
                                <span style="font-weight: 900; font-size: 16px; color: white; font-family: inherit;">${release.version}</span>
                                <span style="color: #444; font-size: 11px; font-family: inherit;">${release.date}</span>
                            </div>
                            <ul style="margin: 0; padding-left: 15px; color: #aaa; line-height: 1.6; font-size: 13px; font-family: inherit; list-style: disc;">
                                ${release.notes.map(note => `<li style="margin-bottom: 6px;">${note}</li>`).join('')}
                            </ul>
                        </div>
                    `).join('')}
                </div>
            </div>

            <div style="padding: 0 40px 40px 40px; display: flex; flex-direction: column; gap: 10px;">
                <button onclick="document.getElementById('patch-modal-root').remove()" style="width: 100%; background: white; color: black; border: none; padding: 14px; border-radius: 12px; font-weight: 900; cursor: pointer; font-family: inherit; font-size: 13px; transition: 0.2s;">
                    GOT IT
                </button>

                ${currentRelease.actionButton ? `
                    <a href="${currentRelease.actionButton.url}" target="_blank" style="width: 100%; background: rgba(255,255,255,0.05); color: white; border: 1px solid rgba(255,255,255,0.1); padding: 14px; border-radius: 12px; font-weight: 900; cursor: pointer; font-family: inherit; font-size: 13px; text-align: center; text-decoration: none; box-sizing: border-box; transition: 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'">
                        ${currentRelease.actionButton.text}
                    </a>
                ` : ''}
            </div>
        </div>

        <style>
            @keyframes modalFadeIn {
                from { opacity: 0; transform: translateY(15px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .patch-scroll-area::-webkit-scrollbar {
                width: 4px;
            }
            .patch-scroll-area::-webkit-scrollbar-track {
                background: transparent;
            }
            .patch-scroll-area::-webkit-scrollbar-thumb {
                background: #222;
                border-radius: 10px;
            }
            .patch-scroll-area::-webkit-scrollbar-thumb:hover {
                background: #333;
            }
        </style>
    `;

    document.documentElement.appendChild(root);
};

// Ensure the PiP window closes if the user exits the player
window.addEventListener('pagehide', () => {
    if (document.pictureInPictureElement) {
        document.exitPictureInPicture();
    }
});

window.viewArtistPortal = function() {
    console.log("Portal Opening...");

    if (document.getElementById('artist-hub-root')) return;

    const root = document.createElement('div');
    root.id = 'artist-hub-root';
    Object.assign(root.style, {
        all: 'initial', // Resets external CSS interference
        position: 'fixed',
        inset: '0',
        zIndex: '2147483647', // Max z-index possible
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        fontFamily: 'sans-serif'
    });

    root.innerHTML = `
        <div style="position: absolute; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);"></div>
        
        <div style="position: relative; background: #0d0d0d; border: 1px solid #222; width: 90%; max-width: 400px; border-radius: 24px; padding: 40px; color: white; box-shadow: 0 30px 60px rgba(0,0,0,0.8); animation: hubFadeIn 0.3s ease-out; text-align: center;">
            
            <button onclick="document.getElementById('artist-hub-root').remove()" style="position: absolute; top: 20px; right: 20px; background: none; border: none; color: #444; cursor: pointer; font-size: 24px;">&times;</button>

            <h2 style="font-size: 32px; font-weight: 900; margin: 0; letter-spacing: -1px; color: white; font-family: inherit;">Artist Hub</h2>
            <p style="color: #00ff88; font-weight: 800; font-size: 11px; margin: 5px 0 30px 0; letter-spacing: 1px; text-transform: uppercase; font-family: inherit;">Manage Your Presence</p>

            <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
                
                <a href="https://tally.so/r/aQYrxy" target="_blank" style="display: block; background: #1a1a1a; color: white; border: 1px solid #333; padding: 16px; border-radius: 14px; font-weight: 700; cursor: pointer; font-family: inherit; font-size: 14px; text-decoration: none; transition: 0.2s;" onmouseover="this.style.borderColor='#00ff88'" onmouseout="this.style.borderColor='#333'">
                    ðŸš€ Become an Artist!
                </a>

                <a href="https://tally.so/r/kd6Rze" target="_blank" style="display: block; background: #1a1a1a; color: white; border: 1px solid #333; padding: 16px; border-radius: 14px; font-weight: 700; cursor: pointer; font-family: inherit; font-size: 14px; text-decoration: none; transition: 0.2s;" onmouseover="this.style.borderColor='#00ff88'" onmouseout="this.style.borderColor='#333'">
                    ðŸ‘¤ Edit Artist Profile
                </a>

                <a href="https://tally.so/r/GxdBjp" target="_blank" style="display: block; background: rgba(0, 255, 136, 0.05); color: #00ff88; border: 1px solid rgba(0, 255, 136, 0.2); padding: 16px; border-radius: 14px; font-weight: 700; cursor: pointer; font-family: inherit; font-size: 14px; text-decoration: none; transition: 0.2s;" onmouseover="this.style.background='rgba(0, 255, 136, 0.1)'" onmouseout="this.style.background='rgba(0, 255, 136, 0.05)'">
                    ðŸ’¿ Submit A Release
                </a>

            </div>

            <button onclick="document.getElementById('artist-hub-root').remove()" style="width: 100%; background: transparent; color: #444; border: none; padding: 10px; font-weight: 700; cursor: pointer; font-family: inherit; font-size: 12px; text-decoration: underline;">
                BACK TO PLAYER
            </button>
        </div>

        <style>
            @keyframes hubFadeIn {
                from { opacity: 0; transform: scale(0.95); }
                to { opacity: 1; transform: scale(1); }
            }
        </style>
    `;

    document.documentElement.appendChild(root);
};

// --- UNIFIED BOOTSTRAP ---
window.addEventListener('load', () => {
    if (typeof supabase !== 'undefined') {
        const S_URL = 'https://sxagulxljpzftqfnllhv.supabase.co';
        const S_KEY = 'sb_publishable_GG1VzWph8ZCK2hCyZugMfA_qR6LZcRn';
        
        // Initialize the client once
        window.supabaseClient = supabase.createClient(S_URL, S_KEY);
        
        // Kick off the app logic
        initApp();
        console.log("Loaded TRM MUSIC PLAYER v1.0.3.8")
    } else {
        console.error("TRM Error: Supabase CDN blocked or failed to load.");
        const content = document.getElementById('content-view');
        if (content) {
            content.innerHTML = `
                <div style="padding: 40px; color: var(--accent-green); font-family: sans-serif;">
                    <h2 style="font-weight: 900;">CONNECTION ERROR</h2>
                    <p style="opacity: 0.6;">The Supabase CDN was blocked. Please disable any aggressive ad-blockers to load the TRM Catalogue.</p>
                </div>`;
            }
    }
});
</script>