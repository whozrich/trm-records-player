<!DOCTYPE html>
<html lang="en">
<!DOCTYPE html>
<html lang="en">
<head>
    <script>
(function() {
    const manifest = {
        "name": "TRM Music Player",
        "short_name": "TRM",
        "start_url": "https://trm-brand-shop.fourthwall.com/music-player",
        "display": "standalone",
        "background_color": "#000000",
        "theme_color": "#000000",
        "icons": [{
            "src": "https://thumbs2.imgbox.com/14/a7/fI8ktNrC_t.png",
            "sizes": "800x800",
            "type": "image/png"
        }],
        "screenshots": [
            {
                "src": "https://thumbs2.imgbox.com/14/a7/fI8ktNrC_t.png",
                "sizes": "800x800",
                "type": "image/png",
                "form_factor": "wide"
            },
            {
                "src": "https://thumbs2.imgbox.com/14/a7/fI8ktNrC_t.png",
                "sizes": "800x800",
                "type": "image/png"
            }
        ]
    };

    const stringManifest = JSON.stringify(manifest);
    const blob = new Blob([stringManifest], {type: 'application/manifest+json'});
    const manifestURL = URL.createObjectURL(blob);
    
    const link = document.createElement('link');
    link.rel = 'manifest';
    link.href = manifestURL;
    document.head.appendChild(link);
})();
</script>
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRM MUSIC PLAYER</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        :root {
            --header-height: 56px; 
            --accent-green: #7268ff;
            --neon-glow: drop-shadow(0 0 8px #524ac5);
            --sidebar-width: 280px;
            --sidebar-collapsed-width: 80px;
        }

        /* 1. LAYOUT & STACKING - FORCED FULL SCREEN OVERLAY */
        body { 
            margin: 0; 
            background: #000; 
            color: #fff; 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; 
            height: 100vh;
            width: 100vw;
        }

        /* Force the old class to use the new symbols font */
.material-icons {
    font-family: 'Material Symbols Outlined' !important;
    font-weight: normal;
    font-style: normal;
    line-height: 1;
    letter-spacing: normal;
    text-transform: none;
    display: inline-block;
    white-space: nowrap;
    word-wrap: normal;
    direction: ltr;
    -webkit-font-smoothing: antialiased;
}

        #dashboard-wrapper {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex; 
            flex-direction: column;
            overflow: hidden;
            z-index: 9999999; 
            background: #000;
        }

        /* Like Button Base Style */
        #player-like-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }

                .patch-scroll-area a {
    color: var(--accent-green) !important;
    text-decoration: none;
}

        #player-like-btn:hover {
            transform: scale(1.2);
            color: #fff !important;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.3));
        }

        #player-like-btn.is-liked {
            color: var(--accent-green) !important;
            filter: var(--neon-glow);
        }

        .heart-pop {
            animation: heart-beat 0.3s ease-out;
        }

        @keyframes heart-beat {
            0% { transform: scale(1); }
            50% { transform: scale(1.4); }
            100% { transform: scale(1.2); }
        }

        .main-viewport {
            display: flex; 
            flex: 1; 
            overflow: hidden; 
            height: calc(100vh - 100px); 
        }

        /* EXIT BUTTON */
        .exit-player-btn {
            position: absolute;
            top: 20px;
            right: 25px;
            z-index: 10000001;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px 18px;
            border-radius: 30px;
            font-size: 11px;
            font-weight: 900;
            text-decoration: none;
            letter-spacing: 1.5px;
            backdrop-filter: blur(10px);
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .exit-player-btn:hover {
            background: #ff4444;
            border-color: #ff4444;
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.3);
        }

        /* 2. THE PLAYER */
        #mini-player {
            height: 100px; 
            background: #050505; 
            border-top: 1px solid #111;
            display: flex; 
            align-items: center; 
            padding: 0 25px; 
            gap: 30px;
            position: relative;
            z-index: 10000000 !important;
        }

        #share-btn:hover {
            background: rgba(255, 255, 255, 0.2) !important;
            transform: scale(1.1);
        }
        #share-btn:active {
            transform: scale(0.95);
        }

        /* CATALOGUE GLOW EFFECT */
        .glow-card {
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glow-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(114, 104, 255, 0.2);
            border-color: var(--accent-green);
        }

        #progress-container {
            cursor: pointer;
            position: relative;
        }

        #spotlight-carousel {
            position: relative;
            min-height: 320px;
            overflow: hidden;
        }

        .slide-in {
            animation: slideRight 0.5s ease-out forwards;
        }

        @keyframes slideRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        #progress-bar {
            pointer-events: none; 
            transition: width 0.1s linear; 
        }

        #info-panel {
            position: fixed; 
            right: -400px; 
            top: 0; 
            width: 350px; 
            height: calc(100vh - 100px); 
            background: #0a0a0a;
            z-index: 9999; 
            transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            border-left: 1px solid #222;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        #loop-btn {
            width: 40px;          
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;      
            transition: color 0.2s ease;
            cursor: pointer;
            background: none;
            border: none;
            outline: none;
        }

        #info-panel.open { 
            right: 0; 
            visibility: visible; 
            box-shadow: -20px 0 50px rgba(0,0,0,0.8);
        }

        #panel-content {
            flex: 1;
            overflow-y: auto !important; 
            padding: 0 30px 100px 30px; 
            -webkit-overflow-scrolling: touch;
            padding-bottom: 60px;     
        }

        #login-btn-container {
            margin-top: auto;
            width: 100%;
            padding: 10px 8px; 
            box-sizing: border-box; 
        }

        .login-btn {
            width: 100%;
            text-align: left;
            background: none;
            border: none;
            color: white;
            font-weight: 700;
            cursor: pointer;
        }

        #sidebar {
            width: 280px;
            min-width: 80px; 
            max-width: 450px;
            background: #000;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #111;
            position: relative;
            transition: width 0.1s ease; 
        }

        #sidebar-resizer {
            width: 4px;
            cursor: col-resize;
            background: transparent;
            transition: background 0.2s;
            z-index: 10;
        }
        #sidebar-resizer:hover { background: var(--accent-green); }

        .player-art-loading { position: relative; }

        .player-art-loading::after {
            content: "";
            position: absolute;
            inset: -3px;
            border: 3px solid transparent;
            border-top-color: var(--accent-green);
            border-radius: 50%; 
            animation: spin 1s linear infinite;
            z-index: 5;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-dim {
            filter: brightness(0.5);
            transition: filter 0.3s ease;
        }

        #sidebar.collapsed { width: 80px !important; }
        #sidebar.collapsed span, 
        #sidebar.collapsed .catalogue-header,
        #sidebar.collapsed #search-input { 
            display: none; 
        }

        #sidebar.collapsed .sidebar-item { justify-content: center; padding: 15px 0; }

        #main-content { flex: 1; }

        #search-input {
            width: calc(100% - 32px); 
            background: #111; 
            border: 1px solid #222;
            color: #fff; 
            padding: 12px; 
            border-radius: 8px; 
            margin: 16px;
            outline: none; 
            transition: 0.3s; 
            box-sizing: border-box;
        }
        #search-input:focus {
            border-color: var(--accent-green);
            box-shadow: 0 0 10px rgba(114, 104, 255, 0.2);
        }

        .control-toggle, .social-link, #volume-icon-wrapper, #play-btn {
            cursor: pointer !important;
            transition: 0.2s ease;
        }

        .control-toggle {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .control-toggle svg { pointer-events: none; }

        .purchase-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #282828;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            min-width: 160px;
            z-index: 100;
            margin-top: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            overflow: hidden;
        }

        .menu-item {
            padding: 12px 16px;
            color: white;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
        }

        .menu-item:hover {
            background: var(--accent-green);
            color: #fff;
        }

        @keyframes modalOverlayIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes modalBoxIn {
            from { opacity: 0; transform: scale(0.9) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .sidebar-item .material-icons {
    width: 24px; /* Creates a consistent "hit box" for every icon */
    display: flex;
    justify-content: center;
    align-items: center;
    flex-shrink: 0;
}

        .modal-animate-in { animation: modalBoxIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .overlay-animate-in { animation: modalOverlayIn 0.3s ease-out forwards; }
        .show-menu { display: block !important; }

        .control-toggle:hover svg, #vol-svg:hover, .social-link:hover svg {
            color: var(--accent-green) !important;
            filter: var(--neon-glow);
            transform: scale(1.1);
        }

        .control-toggle.active svg {
            color: var(--accent-green) !important;
            filter: var(--neon-glow);
        }

        #play-btn:hover {
            background: var(--accent-green) !important;
            box-shadow: 0 0 20px rgba(114, 104, 255, 0.4);
            transform: scale(1.05);
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 15px; 
            cursor: pointer; 
            border-radius: 6px;
            margin: 2px 10px; 
            transition: 0.2s; 
            color: #b3b3b3;
            font-size: 13px;
            font-weight: 600;
        }
        .sidebar-item:hover {
            background: rgba(255,255,255,0.05);
            color: #fff;
        }
        .sidebar-item img {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            object-fit: cover;
        }

        .track-row {
            display: flex; 
            padding: 12px 25px; 
            border-radius: 10px; 
            cursor: pointer; 
            align-items: center; 
            transition: all 0.2s ease; 
            border: 1px solid transparent;
            margin-bottom: 2px;
        }

        .track-row:hover {
            background: rgba(114, 104, 255, 0.04); 
            box-shadow: inset 0 0 15px rgba(114, 104, 255, 0.05), 0 0 10px rgba(114, 104, 255, 0.02);
            border-color: rgba(114, 104, 255, 0.1);
            transform: translateX(4px); 
        }

        .track-row.disabled {
            cursor: default;
            opacity: 0.5;
            filter: grayscale(1);
        }

        .track-index-col {
            width: 25px; 
            flex-shrink: 0; 
            font-weight: 900; 
            color: #444;
        }

        .album-view-header {
            display: flex; 
            gap: 40px; 
            align-items: flex-end; 
            margin-bottom: 40px;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #222; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-green); }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        .view-animate {
            animation: fadeInScale 1.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .signup-btn {
            display: inline-block;
            background: var(--accent-green);
            color: #fff !important;
            padding: 12px 24px;
            border-radius: 30px;
            font-weight: 800;
            font-size: 13px;
            text-decoration: none !important;
            letter-spacing: 1px;
            transition: 0.3s;
            margin-top: 15px;
        }

        .signup-btn:hover {
            background: #fff;
            color: #000 !important;
            box-shadow: 0 0 20px rgba(114, 104, 255, 0.4);
            transform: translateY(-2px);
        }

        .purchase-select {
            background: #111;
            color: #fff;
            border: 1px solid #333;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            outline: none;
            margin-top: 15px;
        }

        .purchase-select:hover { border-color: var(--accent-green); }

        .social-link {
            color: #666; 
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.03);
            text-decoration: none;
        }

        .social-link:hover {
            color: var(--accent-green); 
            background: rgba(114, 104, 255, 0.1);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(114, 104, 255, 0.2);
        }

        #content-view {
            flex: 1;
            overflow-y: auto !important; 
            overflow-x: hidden;
            height: 100%; 
            background: linear-gradient(to bottom, #121212, #000);
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            position: relative;
        }

        #pip-btn:hover {
            color: var(--accent-green) !important;
            filter: var(--neon-glow);
        }

        #pip-btn.active {
            color: var(--accent-green) !important;
        }

        @keyframes overlayFadeIn {
            from { opacity: 0; backdrop-filter: blur(0px); }
            to { opacity: 1; backdrop-filter: blur(15px); }
        }

        @keyframes videoPopIn {
            0% { opacity: 0; transform: scale(0.8) translateY(30px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        @keyframes menuShow {
            from { opacity: 0; transform: translateY(10px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .user-menu-animate { animation: menuShow 0.2s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        .video-overlay-active { animation: overlayFadeIn 0.4s ease forwards; }
        .video-content-active { animation: videoPopIn 0.5s cubic-bezier(0.165, 0.84, 0.44, 1) forwards; }
        @keyframes modalFadeOut {
            from { opacity: 1; backdrop-filter: blur(15px); }
            to { opacity: 0; backdrop-filter: blur(0px); }
        }
        @keyframes videoPopOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.9); }
        }
        .modal-exit-active { animation: modalFadeOut 0.3s ease forwards !important; }
        .content-exit-active { animation: videoPopOut 0.3s ease forwards !important; }

        .player-art-loading::after {
            content: "";
            position: absolute;
            top: -4px; left: -4px; right: -4px; bottom: -4px;
            border: 3px solid transparent;
            border-top-color: var(--accent-green);
            border-radius: 50%; 
            animation: spin 1s linear infinite;
            z-index: 10;
        }

        .loading-dim {
            filter: brightness(0.4) blur(2px);
            transition: filter 0.3s ease;
        }
    </style>
</head>
<body>

<div id="dashboard-wrapper">
    <a href="https://trm-brand-shop.fourthwall.com" class="exit-player-btn">âœ• EXIT PLAYER</a>

    <div class="main-viewport">
        
<div class="sidebar-container">
    <input type="text" id="search-input" placeholder="Search" oninput="performSearch(this.value)">
    <div id="sidebar-resizer"></div>
    <div class="sidebar-nav">
        <div class="sidebar-item" onclick="viewHome()" style="margin-top: 5px; opacity: 0.6; transition: 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">
            <span class="material-icons" style="font-size: 18px; color:var(--accent-green)">home</span>
            <span style="font-size: 11px; letter-spacing: 1px;">Home</span>
        </div>

        <div class="sidebar-item" onclick="openPatchNotes()" style="margin-top: 5px; opacity: 0.6; transition: 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">
            <span class="material-icons" style="font-size: 18px; color:var(--accent-green)">new_releases</span>
            <span style="font-size: 11px; letter-spacing: 1px;">Patch Notes</span>
            <span style="margin-left: auto; font-size: 9px; background: #222; padding: 2px 6px; border-radius: 4px; color: var(--accent-green);">v1.0.5</span>
        </div>

<a href="https://trm-brand-shop.fourthwall.com/artist-hub" target="_blank" class="sidebar-item" style="margin-top: 0px; opacity: 0.6; transition: 0.2s; text-decoration: none; color: inherit; display: flex; align-items: center;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">
    <span class="material-icons" style="font-size: 18px; color:var(--accent-green)">artist</span>
    <span style="font-size: 11px; letter-spacing: 1px; color: #fff;">Artist Hub</span>
</a>



<div id="login-btn-container" class="nav-item">
        <button onclick="window.openAuthModal('login')" class="login-btn">LOGIN</button>
    </div>

    
    </div>

    <div style="padding: 0 20px; font-size: 10px; font-weight: 900; color: #222; letter-spacing: 2px; margin-top: 25px; margin-bottom: 10px; text-transform: uppercase;">
        Liked Songs
    </div>
    
    <div id="sidebar-library-placeholder" style="padding: 0 20px; opacity: 0.3;">
        <p style="font-size: 11px; font-weight: 700; line-height: 1.4; color: #444;">
            Sign in to save your favorite releases.
        </p>
    </div>
    
    <div id="sidebar-releases" style="display: none;"></div>
</div>

        <div id="content-view">
            <div style="padding: 40px; font-weight: 900; letter-spacing: 1px;">INITIALIZING TRM MUSIC PLAYER...</div>
        </div>

        <div id="info-panel">
            <div style="display:flex; justify-content: space-between; align-items: center; padding: 30px 30px 10px 30px;">
                <h3 id="panel-type" style="margin:0; font-weight:900; color:var(--accent-green); font-size:12px; letter-spacing:2px;">LYRICS & INFO</h3>
                <button onclick="togglePanel()" style="background:none; border:none; color:#666; cursor:pointer; font-size:24px;">&times;</button>
            </div>
            <div id="panel-content" style="flex: 1; overflow-y: auto; padding: 0 30px 30px 30px;"></div>
        </div>

    </div> <div id="mini-player">
        <div style="width: 30%; display: flex; align-items: center; gap: 15px;">
            <img id="player-art" src="" style="width: 56px; height: 56px; border-radius: 4px; display: none; object-fit: cover;">
            <div style="overflow: hidden; flex: 1;">
                <div id="player-title" style="font-weight: 700; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Select a track</div>
                <div id="player-artist" style="font-size: 12px; color: #b3b3b3; cursor: pointer;"></div>
            </div>

<div style="width: 30%; display: flex; justify-content: flex-end; align-items: center; gap: 20px;">
    </div>
        </div>
        
        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px;">
            <div style="display: flex; align-items: center; gap: 24px;">
                <div id="shuffle-btn" class="control-toggle" onclick="toggleShuffle()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>
                </div>
                <div class="control-toggle" onclick="prevTrack()">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                </div>
                <button onclick="togglePlay()" id="play-btn" style="background: #fff; border: none; width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                    <svg id="play-icon" viewBox="0 0 24 24" width="20" height="20" fill="black"><path d="M8 5v14l11-7z"/></svg>
                </button>
                <div class="control-toggle" onclick="nextTrack()">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                </div>
                <div id="loop-btn" class="control-toggle" onclick="toggleLoop()">
                    <svg id="loop-svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
                </div>
            </div>
            <div style="width: 100%; max-width: 480px; display: flex; align-items: center; gap: 10px;">
                <span id="current-time" style="font-size: 11px; color: #666; width: 35px; text-align: right;">0:00</span>
                <div id="progress-container" onclick="seek(event)" style="flex: 1; height: 4px; background: #333; border-radius: 2px; cursor: pointer;">
                    <div id="progress-bar" style="width: 0%; height: 100%; background: var(--accent-green); border-radius: 2px;"></div>
                </div>
                <span id="total-duration" style="font-size: 11px; color: #666; width: 35px;">0:00</span>
            </div>
        </div>

        <div style="width: 30%; display: flex; justify-content: flex-end; align-items: center; gap: 20px;">
                                                                   <div id="player-like-btn" onclick="handleLikeClick()" style="cursor:pointer; color:#666; transition: 0.2s; padding-right: 10px;">
                <span class="material-icons" id="main-heart-icon" style="font-size: 20px;">favorite_border</span>
            </div>
            <div class="control-toggle" onclick="togglePanel()">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
            </div>
            <div id="volume-icon-wrapper" onclick="toggleMute()" style="color:#666;">
                <svg id="vol-svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
            </div>
            <input id="volume-slider" type="range" min="0" max="1" step="0.01" value="0.5" oninput="updateVolume(this.value)" style="width: 80px; accent-color: var(--accent-green);">
        </div>
    </div>
</div>
<div id="auth-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; align-items:center; justify-content:center; backdrop-filter:blur(10px);">
    <div style="background:#0a0a0a; width:100%; max-width:400px; padding:40px; border-radius:20px; border:1px solid #1a1a1a; position:relative;">
        <button onclick="closeAuthModal()" style="position:absolute; top:20px; right:20px; background:none; border:none; color:#444; cursor:pointer; font-size:20px;">&times;</button>
        
        <div id="auth-form-container">
            <h2 id="auth-title" style="font-size:24px; font-weight:900; margin-bottom:10px; color:white;">Welcome back</h2>
            <p id="auth-subtitle" style="color:#666; font-size:14px; margin-bottom:30px;">Login to your account to continue.</p>

            <div style="display:flex; flex-direction:column; gap:15px;">
                <div id="signup-fields" style="display:none; flex-direction:column; gap:15px;">
                    <input type="text" id="auth-username" placeholder="Username (e.g. jdoe)" style="background:#111; border:1px solid #222; padding:15px; border-radius:10px; color:white; outline:none;">
                    <input type="text" id="auth-display-name" placeholder="Display Name (e.g. John Doe)" style="background:#111; border:1px solid #222; padding:15px; border-radius:10px; color:white; outline:none;">
                </div>

                <input type="email" id="auth-email" placeholder="Email Address" style="background:#111; border:1px solid #222; padding:15px; border-radius:10px; color:white; outline:none;">
                <input type="password" id="auth-password" placeholder="Password" style="background:#111; border:1px solid #222; padding:15px; border-radius:10px; color:white; outline:none;">
                
                <button id="auth-submit-btn" onclick="handleAuthSubmit()" style="background:var(--accent-green); color:black; font-weight:900; padding:15px; border-radius:10px; border:none; cursor:pointer; margin-top:10px;">LOGIN</button>
            </div>

            <p style="text-align:center; margin-top:25px; font-size:13px; color:#444;">
                <span id="auth-toggle-text">Don't have an account?</span> 
                <span id="auth-toggle-link" onclick="toggleAuthMode()" style="color:var(--accent-green); cursor:pointer; font-weight:700; margin-left:5px;">Sign Up</span>
            </p>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// --- Global Variable Safeties ---
window.ALBUMS = window.ALBUMS || [];
window.TRACKS = window.TRACKS || {};
window.ARTISTS = window.ARTISTS || {};

// Check if audio is already declared in the window to avoid SyntaxErrors
if (!window.audio) {
    window.audio = new Audio();
    window.audio.preload = "auto"; 
    window.audio.volume = 0.5;
}
const audio = window.audio; 

// The rest of your variables
let currentTrackId = null;
let currentArtistId = null;

let isSidebarCollapsed = localStorage.getItem('trm_sidebar_collapsed') === 'true';

audio.preload = "auto"; 
audio.volume = 0.5;

const supabaseUrl = 'https://sxagulxljpzftqfnllhv.supabase.co';
const supabaseKey = 'sb_publishable_GG1VzWph8ZCK2hCyZugMfA_qR6LZcRn';

// Initialize and attach to both names just to be safe
window.supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
window.sbc = window.supabaseClient; 

console.log("Supabase initialized as sbc");

// --- 2. PLAYER & UI LOGIC ---

function formatTime(secs) {
    if (isNaN(secs) || secs === Infinity) return "0:00";
    const mins = Math.floor(secs / 60);
    const s = Math.floor(secs % 60);
    return `${mins}:${s < 10 ? '0' : ''}${s}`;
}

audio.onloadedmetadata = () => {
    const totalT = document.getElementById('total-duration');
    if (totalT) totalT.innerText = formatTime(audio.duration);
};

audio.ontimeupdate = () => {
    const progressBar = document.getElementById('progress-bar');
    const currentT = document.getElementById('current-time');
    if (audio.duration) {
        const pct = (audio.currentTime / audio.duration) * 100;
        if (progressBar) progressBar.style.width = pct + "%";
        if (currentT) currentT.innerText = formatTime(audio.currentTime);
    }
};

window.performSearch = function(query) {
    const content = document.getElementById('content-view');
    if (!content) return;
    
    if (!query || query.trim() === "") { 
        window.viewHome(); 
        return; 
    }
    
    const q = query.toLowerCase().trim();
    const albums = window.ALBUMS || [];
    const artists = Object.values(window.ARTISTS || {});
    const tracks = Object.values(window.TRACKS || {}).flat();

    // --- BULLETPROOF GENRE FILTER ---
    // Uses includes() to catch "Hip-Hop / Alternative" when searching "Hip-Hop"
    const genreResults = albums.filter(a => {
        if (!a.genre || a.hidden) return false;
        const genreStr = a.genre.toLowerCase();
        return genreStr.includes(q) || genreStr.replace(/-/g, ' ').includes(q);
    });

    const albumResults = albums.filter(a => !a.hidden && a.name && a.name.toLowerCase().includes(q));
    const artistResults = artists.filter(art => art.name && art.name.toLowerCase().includes(q));
    const trackResults = tracks.filter(t => t.title && t.title.toLowerCase().includes(q));

    content.innerHTML = `
    <div class="view-animate" style="padding:50px;">
        <h1 style="font-size:32px; font-weight:900; margin-bottom:40px; letter-spacing:-1px;">Results for "${query}"</h1>
        
        ${genreResults.length ? `
            <section style="margin-bottom:50px;">
                <h3 style="color:var(--accent-green); font-size:11px; letter-spacing:2px; margin-bottom:20px; font-weight:900; text-transform:uppercase;">Genre: ${query}</h3>
                <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:25px;">
                    ${genreResults.map(alb => `
                        <div onclick="viewAlbum('${alb.id}')" class="glow-card" style="padding:15px; background:#0f0f0f; border-radius:12px; cursor:pointer; border:1px solid rgba(255,255,255,0.05);">
                            <img src="${alb.art_url}" style="width:100%; aspect-ratio:1; border-radius:8px; margin-bottom:12px; ${window.isAlbumComingSoon(alb) ? 'filter:grayscale(1); opacity:0.5;' : ''}">
                            <div style="font-weight:700; color:white; font-size:15px;">${alb.name}</div>
                            <div style="font-size:11px; color:#666; margin-top:4px; font-weight:600;">${alb.genre}</div>
                        </div>
                    `).join('')}
                </div>
            </section>
        ` : ''}

        ${artistResults.length ? `
            <section style="margin-bottom:40px;">
                <h3 style="color:#444; font-size:11px; letter-spacing:1.5px; margin-bottom:15px; font-weight:800;">ARTISTS</h3>
                ${artistResults.map(art => `
                    <div onclick="viewArtist('${art.id}')" style="display:flex; align-items:center; gap:15px; cursor:pointer; padding:12px; border-radius:10px;" class="track-row">
                        <div style="width:45px; height:45px; border-radius:50%; background:#1a1a1a; display:flex; align-items:center; justify-content:center; font-weight:900; color:var(--accent-green); border:1px solid rgba(255,255,255,0.1);">${art.name[0]}</div>
                        <div style="font-weight:700; font-size:16px; color:white;">${art.name}</div>
                    </div>
                `).join('')}
            </section>
        ` : ''}

        <section>
            <h3 style="color:#444; font-size:11px; letter-spacing:1.5px; margin-bottom:15px; font-weight:800;">SONGS</h3>
            <div style="max-width:800px;">
                ${trackResults.length ? trackResults.map((t, i) => renderTrackRow(t, i)).join('') : '<p style="color:#333; font-weight:600;">No matching songs found.</p>'}
            </div>
        </section>
    </div>`;
};

window.renderTrackRow = function(t, i) {
    if (!t) return '';

    // Safety check for album_id to prevent split() errors
    const parentAlbumIds = t.album_id ? String(t.album_id).split(',').map(s => s.trim()) : [];
    
    // Check if playable (at least one parent album is NOT coming_soon)
    const isPlayable = parentAlbumIds.some(aid => {
        const alb = (window.ALBUMS || []).find(a => a.id === aid);
        return alb && !window.isAlbumComingSoon(alb);
    });

    // Match your screenshot's "BONUS TRACK" styling
    const isBonus = t.title && t.title.toLowerCase().includes('bonus');

    return `
    <div class="track-row ${isPlayable ? '' : 'disabled'}" 
         style="display:flex; align-items:center; padding:12px; border-radius:8px; margin-bottom:4px; transition: 0.2s; ${isPlayable ? 'cursor:pointer;' : 'opacity:0.3; pointer-events:none;'}"
         onclick="if(window.playTrack) window.playTrack('${t.id}')">
        <div style="width:35px; color:#444; font-weight:800; font-size:13px;">${String(i + 1).padStart(2, '0')}</div>
        <div style="flex:1; font-weight:700; color:white; display:flex; align-items:center; gap:12px;">
            ${t.title}
            ${isBonus ? `
                <span style="
                    background: var(--accent-green); 
                    color: #7657ff; 
                    font-size: 9px; 
                    padding: 3px 8px; 
                    border-radius: 4px; 
                    border: 1px solid var(--accent-green); 
                    font-weight: 900; 
                    letter-spacing: 0.5px;
                    text-transform: uppercase;
                ">BONUS TRACK</span>` : ''}
        </div>
        <div style="color:#444; font-family:monospace; font-size:12px;">${t.duration || '??:??'}</div>
    </div>`;
};

window.seek = function(e) {
    if (!audio.duration) return;
    const container = document.getElementById('progress-container');
    const rect = container.getBoundingClientRect();
    const x = e.clientX - rect.left;
    audio.currentTime = (x / rect.width) * audio.duration;
};

window.togglePlay = function() {
    if (!audio.src || audio.src === window.location.href) return;

    if (audio.paused) {
        audio.play().then(() => { 
            window.isPlaying = true; 
            window.updatePlayerUI(); 
        }).catch(e => console.error("Playback failed:", e));
    } else {
        audio.pause();
        window.isPlaying = false;
        window.updatePlayerUI();
    }
};

// --- UPDATED INFO PANEL (SINGLE DEFINITION) ---
window.updateInfoPanel = function(track, album) {
    const content = document.getElementById('panel-content');
    if (!content) return;

    const safeTrack = track || {};
    const safeAlbum = album || {};
    const artistKey = safeTrack.artist_id || safeAlbum.artist_id;
    const artistObj = (window.ARTISTS && artistKey && window.ARTISTS[artistKey]) ? window.ARTISTS[artistKey] : { name: "therichmusic" };

    // --- GENIUS & LYRICS PARSING ---
    let rawLyrics = safeTrack.lyrics || 'No lyrics available.';
    let geniusUrl = null;

    // Detect genius_ link inside the lyrics text
    if (rawLyrics.includes('genius_')) {
        const parts = rawLyrics.split('genius_');
        // Assume the URL is the first "word" or string after genius_
        const afterGenius = parts[1].split(/\s+/)[0]; 
        geniusUrl = afterGenius;
        // Clean the "genius_url" string out of the displayed lyrics
        rawLyrics = rawLyrics.replace(`genius_${afterGenius}`, '').trim();
    }

    content.innerHTML = `
        <img src="${safeAlbum.art_url || ''}" style="width:100%; border-radius:12px; margin-bottom:20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
        <h2 style="margin:0; font-size: 24px; font-weight: 900;">${safeTrack.title || 'Unknown Track'}</h2>
        <p style="color:var(--accent-green); cursor:pointer; font-weight: 700; margin-top: 5px;" onclick="viewArtist('${artistObj.id || ''}')">${artistObj.name}</p>
        
        <div style="display:flex; justify-content: space-between; align-items: flex-end; margin-top:32px; margin-bottom:12px;">
            <h3 style="font-size:12px; color:#666; letter-spacing:1px; margin:0; font-weight: 900;">LYRICS</h3>
            <div style="display:flex; gap:10px;">
                ${geniusUrl ? `
                    <button onclick="window.open('${geniusUrl}', '_blank')" style="background:none; border:none; color:#666; cursor:pointer; font-size:10px; font-weight:900; display:flex; align-items:center; gap:4px;">
                        <span class="material-icons" style="font-size:14px;">explicit</span> GENIUS
                    </button>
                ` : ''}
                <button onclick="copyLyrics(this)" style="background:none; border:none; color:#666; cursor:pointer; font-size:10px; font-weight:900; display:flex; align-items:center; gap:4px;">
                    <span class="material-icons" style="font-size:14px;">content_copy</span> COPY
                </button>
            </div>
        </div>
        <div id="lyrics-body" style="color:#b3b3b3; font-size:16px; line-height:1.8; white-space:pre-wrap; margin-bottom:40px;">${rawLyrics}</div>
        
        <h3 style="font-size:12px; color:#666; letter-spacing:1px; margin-bottom:12px; font-weight: 900;">CREDITS</h3>
        <div style="color:#888; font-size:13px; line-height:1.6; padding-bottom: 180px;">
            ${(Array.isArray(safeTrack.credits) ? safeTrack.credits : [safeTrack.credits || 'No credits listed.'])
                .map(line => line.includes(':') 
                    ? `<b>${line.split(':')[0]}:</b>${line.split(':')[1]}` 
                    : line
                ).join('<br>')}
        </div>
    `;
};

// Global variable to track the current playback promise
window.activePlayPromise = null;

window.resolveYouTubeAudio = async (url) => {
    // 1. Clean the URL (handle shorts, mobile links, etc)
    const videoIdMatch = url.match(/(?:youtu\.be\/|youtube\.com\/(?:.*v(?:\/|=)|(?:.*shorts\/)))([^?&"'>]+)/);
    if (!videoIdMatch) return url; // Not a YT link, return as is

    const videoId = videoIdMatch[1];
    console.log(`Resolving YT Audio for: ${videoId}`);

    try {
        // Using a public Cobalt instance (free, no-key API for developers)
        // Note: In a production app, you'd want your own instance.
        const response = await fetch('https://api.cobalt.tools/api/json', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                url: `https://www.youtube.com/watch?v=${videoId}`,
                downloadMode: 'audio',
                audioFormat: 'mp3',
                isAudioOnly: true
            })
        });

        const data = await response.json();
        if (data.url) return data.url;
        
        throw new Error("No stream URL returned");
    } catch (err) {
        console.error("YouTube Conversion Failed:", err);
        // Fallback: If conversion fails, just return original (though it likely won't play)
        return url; 
    }
};

window.logArtistListen = async function(artistId) {
    const client = window.sbc; 
    if (!client) return;

    const { data: { session } } = await client.auth.getSession();
    const user = session?.user;
    if (!user) return;

    const cleanId = String(artistId);

    try {
        // 1. First, increment the global artist listener count
        // This hits the new PostgreSQL function we just created
        await client.rpc('increment_artist_listeners', { artist_id: cleanId });

        // 2. Then, handle the user's personal "listened_artists" array
        const { data: profile, error: fetchError } = await client
            .from('users')
            .select('listened_artists')
            .eq('id', user.id)
            .single();

        if (fetchError) throw fetchError;

        let listened = Array.isArray(profile?.listened_artists) ? profile.listened_artists : [];
        
        if (!listened.some(id => String(id) === cleanId)) {
            listened.push(cleanId);
            
            const { error: updateError } = await client
                .from('users')
                .update({ listened_artists: listened })
                .eq('id', user.id);
                
            if (updateError) throw updateError;
            console.log("Registered as monthly listener for:", cleanId);
        }
    } catch (err) {
        console.error("Listener Log Error:", err.message);
    }
};

window.playTrack = function(id, autoPlay = true, explicitAlbumId = null) {
    const track = window.TRACKS?.[id];
    if (!track) return;

    // 1. FIND THE ALBUM BY SCANNING THE TRACK_IDS ARRAYS
    // We look for the album that contains this specific track ID in its array
    let album = explicitAlbumId 
        ? window.ALBUMS.find(a => a.id === explicitAlbumId)
        : window.ALBUMS.find(a => Array.isArray(a.track_ids) && a.track_ids.includes(id));
    
    const currentContextId = album ? album.id : null;

    // --- ANALYTICS LOGIC ---
    if (window.listenTimer) clearTimeout(window.listenTimer);
    if (autoPlay) {
        window.listenTimer = setTimeout(() => {
            if (window.currentTrackId === id && window.isPlaying) {
                window.logListen(id, currentContextId);
                if (album?.artist_id) {
                    window.logArtistListen(album.artist_id);
                }
            }
        }, 3000); 
    }

    // --- TRACK STATE & PANEL SYNC ---
    window.currentTrackId = id;
    window.isPlaying = autoPlay;
    window.CURRENT_TRACK = track; 

    // UI Updates
    const playIcon = document.getElementById('play-icon');
    if (playIcon) {
        playIcon.innerHTML = window.isPlaying 
            ? '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>' 
            : '<path d="M8 5v14l11-7z"/>';
    }

    const titleEl = document.getElementById('player-title');
    const pArtist = document.getElementById('player-artist');
    
    // Find Artist via the Album owner
    const artistData = album ? window.ARTISTS?.[album.artist_id] : null;

    if (titleEl) titleEl.innerText = track.title;
    if (pArtist) pArtist.innerText = artistData?.name || "therichmusic";

    // Trigger Panel Refresh
    const panel = document.getElementById('info-panel');
    if (panel && panel.classList.contains('open') && typeof window.updatePanelContent === 'function') {
        window.updatePanelContent();
    }

    const loadAudio = async () => {
        if (typeof audio !== 'undefined') {
            audio.pause();
            let finalUrl = track.url;

            if (finalUrl && (finalUrl.includes('youtube.com') || finalUrl.includes('youtu.be'))) {
                try {
                    const converted = await window.resolveYouTubeAudio(finalUrl);
                    if (converted) finalUrl = converted;
                } catch (e) { console.error("YT API Error", e); }
            }

            audio.src = finalUrl;

            // --- AUTOPLAY LOGIC (Array Boundary Safe) ---
            audio.onended = () => {
                if (!album || !Array.isArray(album.track_ids)) {
                    window.isPlaying = false;
                    return;
                }

                const ids = album.track_ids;
                const currentIndex = ids.indexOf(id);
                
                // If there's a next index available in the array
                if (currentIndex !== -1 && currentIndex < ids.length - 1) {
                    // Start checking from the next item
                    for (let i = currentIndex + 1; i < ids.length; i++) {
                        const nextId = ids[i];
                        const nextTrackData = window.TRACKS[nextId];
                        
                        if (!nextTrackData) continue;

                        // Check if track is available in ANY released album
                        const isAvailable = window.ALBUMS.some(a => 
                            Array.isArray(a.track_ids) && 
                            a.track_ids.includes(nextId) && 
                            !window.isAlbumComingSoon(a)
                        );

                        if (!window.isAlbumComingSoon(album) || isAvailable) {
                            window.playTrack(nextId, true, currentContextId);
                            return;
                        }
                    }
                }
                
                // If we reach the end of the array or no playable tracks found
                window.isPlaying = false;
                if (playIcon) playIcon.innerHTML = '<path d="M8 5v14l11-7z"/>';
            };

            if (autoPlay) {
                audio.play().catch(err => {
                    console.error("Playback Blocked", err);
                    window.isPlaying = false;
                });
            }
        }
    };

    if (window.currentView === 'album' && typeof window.viewAlbum === 'function') {
        window.viewAlbum(window.viewingAlbumId, false);
    }

    loadAudio();
};

window.logListen = async (trackId, albumId) => {
    // Use the specific instance you initialized
    const client = window.sbc || window.supabaseClient;

    if (!client) {
        console.error("Analytics Error: Supabase client (sbc) not found.");
        return;
    }

    console.log(`Log: 3s threshold met for track ${trackId}`);

    try {
        // Update Track Listens
        const { error: tErr } = await client.rpc('increment_track_listens', { row_id: trackId });
        
        // Update Album Listens
        if (albumId) {
            await client.rpc('increment_album_listens', { row_id: albumId });
        }

        if (tErr) console.error("Database RPC Error:", tErr);
    } catch (err) {
        console.error("Critical Analytics Failure:", err);
    }
};

// Global state
window.USER_LIKES = { songs: [], artists: [], albums: []};

window.handleLikeClick = function() {
    if (window.CURRENT_TRACK) {
        // Use track.id from the global state we just fixed
        toggleLike(window.CURRENT_TRACK.id, 'song');
    } else {
        console.warn("Liking failed: window.CURRENT_TRACK is undefined.");
    }
};

async function toggleLike(id, type = 'song') {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return window.openAuthModal('login');

    const listKey = type === 'song' ? 'songs' : 'albums';
    const dbKey = type === 'song' ? 'liked_songs' : 'liked_albums';
    
    let currentList = [...(window.USER_LIKES[listKey] || [])];
    const isAdding = !currentList.includes(id);
    
    if (isAdding) {
        currentList.push(id);
    } else {
        currentList = currentList.filter(item => item !== id);
    }

    // UPDATED: Pointing to 'users' table instead of 'profiles'
    const { error } = await supabaseClient
        .from('users') 
        .update({ [dbKey]: currentList })
        .eq('id', user.id);

    if (!error) {
        window.USER_LIKES[listKey] = currentList;
        
        // Visual Feedback
        const btn = document.getElementById('player-like-btn');
        if (btn && isAdding) {
            btn.classList.add('heart-pop');
            setTimeout(() => btn.classList.remove('heart-pop'), 300);
        }

        if (window.renderSidebarLibrary) window.renderSidebarLibrary();
        if (window.updateLikeButtonUI) window.updateLikeButtonUI();
    } else {
        console.error("Supabase Error:", error.message);
    }
}

// 3. UI UPDATE LOGIC
function updateLikeButtonUI() {
    const currentTrackId = window.CURRENT_TRACK?.id;
    const heartIcon = document.getElementById('main-heart-icon');
    const btnWrapper = document.getElementById('player-like-btn');
    
    if (!heartIcon || !btnWrapper) return;

    if (currentTrackId && window.USER_LIKES.songs.includes(currentTrackId)) {
        heartIcon.innerText = 'favorite'; // Filled heart
        btnWrapper.classList.add('is-liked');
    } else {
        heartIcon.innerText = 'favorite_border'; // Outlined heart
        btnWrapper.classList.remove('is-liked');
    }
}

let isFetchingLikes = false;

// 1. IMPROVED FETCH LIKES (SAFE BACKGROUND EXECUTION)
window.fetchUserLikes = async function() {
    if (window.isFetchingLikes) return;

    const { data: { session } } = await window.sbc.auth.getSession();
    const user = session?.user;
    if (!user) {
        // Clear state if no user is found
        window.USER_LIKES = { songs: [], artists: [], albums: [] };
        return;
    }

    window.isFetchingLikes = true;

    try {
        const { data, error } = await window.sbc
            .from('users')
            // Double check: Is it 'followedartists' or 'followed_artists' in your DB?
            .select('liked_songs, liked_albums, followedartists') 
            .eq('id', user.id)
            .single();

        if (error) throw error;

        if (data) {
            // Ensure the structure remains consistent
            window.USER_LIKES = {
                songs: data.liked_songs || [],
                albums: data.liked_albums || [],
                artists: data.followedartists || [] // This maps to your window.USER_LIKES.artists
            };

            console.log("Library Hydrated:", window.USER_LIKES);

            // Force UI refreshes
            if (window.renderSidebarLibrary) await window.renderSidebarLibrary();
            if (window.currentViewId === 'library' && window.viewLibrary) window.viewLibrary();
        }

    } catch (err) {
        if (err.name !== 'AbortError') console.error("Fetch Likes Error:", err);
    } finally {
        window.isFetchingLikes = false;
    }
};

window.renderSidebarLibrary = async function() {
    const container = document.getElementById('sidebar-library-placeholder');
    if (!container) return;

    container.style.opacity = "1"; 
    container.style.padding = "0"; 

    const likedIds = window.USER_LIKES?.songs || [];
    const followedIds = window.USER_LIKES?.artists || [];
    const sortedFollowed = [...followedIds].reverse();

    // 1. Render Liked Songs
    const songItems = likedIds.map(id => {
        const track = window.TRACKS?.[id];
        if (!track) return '';
        return `
            <div onclick="playLikedSong('${track.id}', '${track.album_id || ''}')" class="sidebar-item">
                <span class="material-icons" style="width:24px; font-size:18px; color:var(--accent-green); margin-right:10px; display:flex; align-items:center; justify-content:center;">music_note</span>
                <span style="color: #fff; font-size: 13px; font-weight: 600;">${track.title}</span>
            </div>`;
    }).join('');

    // 2. Render Followed Artists
    const artistItems = sortedFollowed.map(id => {
        // Find artist by direct key or by searching values
        const artist = window.ARTISTS[id] || Object.values(window.ARTISTS).find(a => 
            String(a.id) === String(id) || 
            String(a.handle) === String(id) ||
            String(a.name).toLowerCase().replace(/\s+/g, '-') === String(id).toLowerCase()
        );
        
        if (!artist) {
            console.warn(`Sidebar: No artist data found for ID/Handle: "${id}"`);
            return `
                <div class="sidebar-item" style="opacity: 0.5;">
                    <span class="material-icons" style="width:24px; font-size:18px; color:#333; margin-right:10px;">person</span>
                    <span style="color: #666; font-size: 13px; font-weight: 600;">Loading...</span>
                </div>`;
        }
        
        const visual = artist.img_url 
            ? `<img src="${artist.img_url}" style="width:24px; height:24px; border-radius:50%; margin-right:10px; object-fit:cover;">`
            : `<span class="material-icons" style="width:24px; font-size:18px; color:var(--accent-green); margin-right:10px; display:flex; align-items:center; justify-content:center;">person</span>`;

        return `
            <div onclick="viewArtist('${artist.id}')" class="sidebar-item">
                ${visual}
                <span style="color: #fff; font-size: 13px; font-weight: 600;">${artist.name}</span>
            </div>`;
    }).join('');

    container.innerHTML = `
        <div style="margin-top: 5px;">
            ${songItems}
            ${followedIds.length > 0 ? `
                <div style="padding: 0 25px; font-size: 10px; font-weight: 900; color: #555; letter-spacing: 2px; margin-top: 20px; margin-bottom: 10px; text-transform: uppercase;">
                    Followed Artists
                </div>
                ${artistItems}
            ` : ''}
        </div>
    `;
};

window.playLikedSong = function(trackId, albumId) {
    console.log(`Sidebar: Requesting play for track ${trackId}`);

    const trackObj = window.TRACKS?.[trackId];
    if (!trackObj) {
        console.error("Track not found in memory.");
        return;
    }

    // 1. Split the albumId string in case it contains multiple IDs
    // "rich-album, about-damn-time-single" -> ["rich-album", "about-damn-time-single"]
    const potentialAlbumIds = typeof albumId === 'string' 
        ? albumId.split(',').map(id => id.trim()) 
        : [albumId];

    let targetAlbumId = null;

    if (window.ALBUMS) {
        // 2. Filter window.ALBUMS for anything in that ID list that isn't coming soon
        const validAlbums = window.ALBUMS.filter(alb => 
            potentialAlbumIds.includes(alb.id) && 
            alb.coming_soon !== true && 
            !alb.hidden
        );

        if (validAlbums.length > 0) {
            // 3. Grab the last one (most recent)
            const bestAlbum = validAlbums[validAlbums.length - 1];
            targetAlbumId = bestAlbum.id;
            console.log(`Smart Select: Found released album "${bestAlbum.name}" for this track.`);
        }
    }

    // 4. Fallback: If no released album found, use the first ID in the original list
    if (!targetAlbumId && potentialAlbumIds.length > 0) {
        targetAlbumId = potentialAlbumIds[0];
    }

    // 5. Update UI and Play
    if (targetAlbumId && window.viewAlbum) {
        window.viewAlbum(targetAlbumId);
    }

    if (window.playTrack) {
        window.playTrack(trackObj.id, true);
    }
};


// Add this to your main initialization code
audio.addEventListener('ended', () => {
    // Safety check: if loopState isn't set, default to 0
    const state = window.loopState || 0;

    // STATE 2: Repeat One Song
    if (state === 2) {
        audio.currentTime = 0;
        audio.play();
        return; 
    }

    // STATE 0 & 1: Move to next track
    const nextExists = window.nextTrack();
    
    // If we hit the end of the album
    if (!nextExists) {
        if (state === 1) {
            // Loop All: Go back to song #1
            const albumTracks = window.TRACKS[window.currentAlbumId];
            if (albumTracks && albumTracks.length > 0) {
                window.playTrack(albumTracks[0].id, true);
            }
        } else {
            // State 0: Actually stop
            window.isPlaying = false;
            if (typeof updatePlayerUI === 'function') updatePlayerUI();
        }
    }
});

window.viewArtist = function(artistId) {
    let artist = window.ARTISTS[artistId];
    
    // 1. Artist Detection Logic
    if (!artist && window.ARTISTS) {
        const cleanTarget = String(artistId).replace(/-/g,'').toLowerCase();
        artist = Object.values(window.ARTISTS).find(a => String(a.id).replace(/-/g,'').toLowerCase() === cleanTarget);
    }
    if (!artist) {
        artist = { id: artistId, name: "Artist", bio: "", verified: false, banner_url: "", featured_video_url: "", socials: [], followers: 0, listeners: 0 };
    }
    
    const isFollowing = (window.USER_LIKES?.artists || []).includes(artist.id);

    // --- HELPERS FOR SORTING & COUNTDOWN ---
    const parseSmartDate = (dateStr) => {
        if (!dateStr) return new Date(0);
        // If it's just a 4-digit year (e.g., "2026"), treat as year-end so it doesn't jump ahead of Dec 2025
        if (/^\d{4}$/.test(String(dateStr))) {
            return new Date(`${dateStr}-12-31T23:59:59`);
        }
        return new Date(dateStr);
    };

    const getDaysUntil = (dateStr) => {
        const target = parseSmartDate(dateStr);
        const diff = target - new Date();
        const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
        return days > 0 ? days : 0;
    };

    // 2. Advanced Sorting Logic
    const rawReleases = window.ALBUMS.filter(a => a.artist_id === artist.id || a.artist_id === artistId);
    
    const getSortPriority = (alb) => {
        const isSoon = typeof isAlbumComingSoon === 'function' && isAlbumComingSoon(alb);
        const time = parseSmartDate(alb.full_release_date || alb.release_date || alb.year).getTime();
        // Give Coming Soon albums a massive 10-year boost in the milliseconds sort
        return isSoon ? time + 315360000000 : time;
    };

    // Identify the absolute newest "Coming Soon" for the spotlight banner
    const comingSoonReleases = rawReleases
        .filter(a => typeof isAlbumComingSoon === 'function' && isAlbumComingSoon(a))
        .sort((a, b) => getSortPriority(b) - getSortPriority(a));
    
    const spotlightRelease = comingSoonReleases[0] || null;

    // Logic for "Newest Releases" section
    const sortedByDate = [...rawReleases].sort((a, b) => getSortPriority(b) - getSortPriority(a));
    
    let topFour = [];
    if (sortedByDate.length > 0) {
        const latest = sortedByDate[0];
        const others = sortedByDate.slice(1).sort((a, b) => {
            const listensA = a.listens || 0;
            const listensB = b.listens || 0;
            if (listensB !== listensA) return listensB - listensA;
            return 0.5 - Math.random(); 
        });
        topFour = [latest, ...others].slice(0, 4);
    }

    // 3. Categorization
    const categories = {
        "Albums & Mixtapes": rawReleases.filter(a => ['album', 'mixtape'].includes((a.type || 'album').toLowerCase())),
        "Singles & EPs": rawReleases.filter(a => ['single', 'ep'].includes((a.type || 'album').toLowerCase())),
        "Compilations": rawReleases.filter(a => (a.type || '').toLowerCase() === 'compilation')
    };

    // 4. Social & Video Helpers
    const socialConfig = [
        { name: 'YouTube',    match: 'youtube.com',    icon: 'fab fa-youtube',    color: '#FF0000' },
        { name: 'Instagram',  match: 'instagram.com',  icon: 'fab fa-instagram',  color: '#E1306C' },
        { name: 'Twitter',    match: 'twitter.com',    icon: 'fab fa-x-twitter',  color: '#ffffff' },
        { name: 'Twitter',    match: 'x.com',          icon: 'fab fa-x-twitter',  color: '#ffffff' },
        { name: 'TikTok',     match: 'tiktok.com',     icon: 'fab fa-tiktok',     color: '#ffffff' },
        { name: 'SoundCloud', match: 'soundcloud.com', icon: 'fab fa-soundcloud', color: '#f76700' },
        { name: 'Website',    match: '',               icon: 'fa-solid fa-globe', color: '#ffffff' }
    ];

    const renderSocials = () => {
        if (!Array.isArray(artist.socials)) return '';
        return artist.socials.map(socialObj => {
            const url = typeof socialObj === 'string' ? socialObj : socialObj.url;
            if (!url) return '';
            let platform = socialConfig.find(c => c.match !== '' && url.toLowerCase().includes(c.match)) || socialConfig.find(c => c.name === 'Website');
            return `
                <a href="${url}" target="_blank" title="${platform.name}" 
                   style="text-decoration:none; color:${platform.color}; background:rgba(255,255,255,0.05); width:44px; height:44px; border-radius:12px; display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,0.1); transition:0.2s;" 
                   onmouseover="this.style.background='rgba(255,255,255,0.15)'; this.style.transform='scale(1.05)';" 
                   onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.transform='scale(1)';">
                    <i class="${platform.icon}" style="font-size: 20px;"></i>
                </a>`;
        }).join('');
    };

    const getEmbedUrl = (url) => {
        if(!url) return null;
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? `https://www.youtube-nocookie.com/embed/${match[2]}?rel=0` : null;
    };

    const embedUrl = getEmbedUrl(artist.featured_video_url);

    // 5. Build the UI
    document.getElementById('content-view').innerHTML = `
    <div class="view-animate">
        <div style="position: relative; height: 520px; width: 100%; display: flex; align-items: flex-end; padding: 60px 80px; box-sizing: border-box; overflow: hidden;">
            <div style="position: absolute; inset: 0; background: url('${artist.banner_url || ''}') center/cover no-repeat; z-index: 1;"></div>
            <div style="position: absolute; inset: 0; background: linear-gradient(to top, #000 0%, rgba(0,0,0,0.4) 50%, rgba(0,0,0,0) 100%); z-index: 2;"></div>
            
            <div style="position: relative; z-index: 3; width: 100%;">
                <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 25px;">
                    ${artist.verified ? `<div style="display: inline-flex; align-items: center; gap: 6px; background: #0070f3; color: white; padding: 6px 14px; border-radius: 4px; font-size: 11px; font-weight: 900; letter-spacing: 1px;"><span class="material-icons" style="font-size: 14px;">verified</span> VERIFIED</div>` : ''}
                    <div style="display: flex; gap: 25px; color: rgba(255,255,255,0.8); font-size: 13px; font-weight: 800; letter-spacing: 0.5px;">
                        <span>${(artist.listeners || 0).toLocaleString()} MONTHLY LISTENERS</span>
                        <span>${(artist.followers || 0).toLocaleString()} FOLLOWERS</span>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                    <h1 style="font-size: 120px; font-weight: 900; margin: 0; letter-spacing: -7px; line-height: 0.8; text-transform: uppercase;">${artist.name}</h1>
                    <button onclick="toggleFollowArtist('${artist.id}')" id="follow-btn" 
                        style="background: ${isFollowing ? 'var(--accent-green, #1db954)' : 'transparent'}; color: ${isFollowing ? 'black' : 'white'}; border: ${isFollowing ? 'none' : '1px solid rgba(255,255,255,0.4)'}; padding: 16px 40px; border-radius: 50px; font-weight: 900; font-size: 12px; letter-spacing: 1.5px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 10px;">
                        <span class="material-icons" style="font-size: 18px;">${isFollowing ? 'favorite' : 'favorite_border'}</span>
                        ${isFollowing ? 'FOLLOWING' : 'FOLLOW'}
                    </button>
                </div>
            </div>
        </div>

        <div style="padding: 60px 80px;">
            <div style="display: flex; gap: 70px; align-items: flex-start;">
                
                <div style="flex: 2;">
                    ${spotlightRelease ? `
                        <div style="background: linear-gradient(90deg, rgba(58, 29, 185,0.15) 0%, rgba(0,0,0,0) 100%); border: 1px solid rgba(58, 29, 185,0.3); border-radius: 20px; padding: 30px; margin-bottom: 50px; display: flex; align-items: center; gap: 30px; cursor: pointer;" onclick="viewAlbum('${spotlightRelease.id}')">
                            <img src="${spotlightRelease.art_url}" style="width: 120px; height: 120px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                            <div>
                                <div style="color: var(--accent-green, #441db9); font-size: 11px; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 8px;">
                                    Coming Soon â€¢ ${getDaysUntil(spotlightRelease.full_release_date)} Days Left
                                </div>
                                <div style="font-size: 32px; font-weight: 900; margin-bottom: 5px;">${spotlightRelease.name}</div>
                                <div style="color: #888; font-size: 14px; font-weight: 600;">Releasing ${spotlightRelease.full_release_date || spotlightRelease.year}</div>
                            </div>
                            <span class="material-icons" style="margin-left: auto; color: var(--accent-green); font-size: 40px;">timer</span>
                        </div>
                    ` : ''}

                    <div id="discography-default">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid #1a1a1a; padding-bottom: 15px;">
                            <h2 style="font-size: 11px; color: #555; letter-spacing: 3px; text-transform: uppercase; font-weight: 900; margin: 0;">Newest Releases</h2>
                            ${rawReleases.length > 4 ? `<button onclick="document.getElementById('discography-default').style.display='none'; document.getElementById('discography-full').style.display='block';" style="background:none; border:none; color:var(--accent-green, #1db954); font-size:11px; font-weight:900; cursor:pointer; letter-spacing:1px;">SHOW ALL</button>` : ''}
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 30px;">
                            ${topFour.map((alb, index) => {
                                const isSoon = typeof isAlbumComingSoon === 'function' && isAlbumComingSoon(alb);
                                return `
                                <div class="glow-card" onclick="viewAlbum('${alb.id}')" style="cursor:pointer; background: rgba(255,255,255,0.02); padding:18px; border-radius:16px; border: 1px solid rgba(255,255,255,0.05); transition: 0.3s;">
                                    <div style="position:relative;">
                                        <img src="${alb.art_url}" style="width:100%; aspect-ratio:1; border-radius:10px; margin-bottom:15px; box-shadow: 0 8px 20px rgba(0,0,0,0.4);">
                                        ${index === 0 ? `<div style="position:absolute; top:10px; right:10px; background:${isSoon ? '#0070f3' : 'var(--accent-green, #1db954)'}; color:${isSoon ? 'white' : 'black'}; font-size:9px; font-weight:900; padding:4px 8px; border-radius:4px;">${isSoon ? 'SOON' : 'LATEST'}</div>` : ''}
                                    </div>
                                    <div style="font-weight:700; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${alb.name}</div>
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top: 6px;">
                                        <div style="color: #666; font-size: 11px; font-weight: 800; letter-spacing: 0.5px;">${(alb.type || 'Album').toUpperCase()}</div>
                                        <div style="color: #444; font-size: 10px; font-weight: 600;">${isSoon ? 'COMING SOON' : (alb.listens || 0).toLocaleString()}</div>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>

                    <div id="discography-full" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                            <h2 style="font-size: 11px; color: #555; letter-spacing: 3px; text-transform: uppercase; font-weight: 900; margin: 0;">Full Discography</h2>
                            <button onclick="document.getElementById('discography-full').style.display='none'; document.getElementById('discography-default').style.display='block';" style="background:none; border:none; color:#666; font-size:11px; font-weight:900; cursor:pointer; letter-spacing:1px;">SHOW LESS</button>
                        </div>
                        
                        ${Object.entries(categories).map(([title, albums]) => {
                            if (albums.length === 0) return '';
                            return `
                                <div style="margin-bottom: 40px;">
                                    <h3 style="font-size: 10px; color: #333; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 20px;">${title}</h3>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px;">
                                        ${albums.map(alb => `
                                            <div class="glow-card" onclick="viewAlbum('${alb.id}')" style="cursor:pointer; background: rgba(255,255,255,0.01); padding:15px; border-radius:12px; border: 1px solid rgba(255,255,255,0.03); transition: 0.3s;">
                                                <img src="${alb.art_url}" style="width:100%; aspect-ratio:1; border-radius:8px; margin-bottom:12px;">
                                                <div style="font-weight:700; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${alb.name}</div>
                                                <div style="color: #555; font-size: 10px; margin-top: 4px; font-weight: 800;">${alb.year || ''}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>`;
                        }).join('')}
                    </div>
                </div>

                <div style="flex: 1; display: flex; flex-direction: column; gap: 45px;">
                    <div>
                        <h3 style="font-size: 11px; color: #555; letter-spacing: 2px; margin-bottom: 18px; font-weight: 900;">CONNECT</h3>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">${renderSocials()}</div>
                    </div>

                    ${embedUrl ? `
                        <div>
                            <h3 style="font-size: 11px; color: #555; letter-spacing: 2px; margin-bottom: 18px; font-weight: 900;">FEATURED VIDEO</h3>
                            <div style="position: relative; width: 100%; padding-top: 56.25%; border-radius: 20px; overflow: hidden; background:#000; border: 1px solid #1a1a1a;">
                                <iframe style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" src="${embedUrl}" frameborder="0" allowfullscreen></iframe>
                            </div>
                        </div>` : ''}

                    <div style="background: linear-gradient(145deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0) 100%); padding: 40px; border-radius: 30px; border: 1px solid #111;">
                        <h3 style="font-size: 11px; color: #555; letter-spacing: 2px; margin-bottom: 20px; font-weight: 900;">ARTIST BIO</h3>
                        <p style="color: #999; line-height: 1.8; font-size: 14px; margin: 0; font-weight: 400;">${artist.bio || 'This artist hasn\'t shared a story yet.'}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>`;
};

window.handleToggleFollow = async function(artistId) {
    // 1. Run your existing toggle logic
    await window.toggleFollowArtist(artistId);
    
    // 2. Refresh the count in the UI
    const followerEl = document.getElementById('follower-display');
    if (followerEl && window.sbc) {
        const { data: newCount } = await window.sbc.rpc('get_artist_follower_count', { 
            target_artist_id: artistId 
        });
        followerEl.innerText = `${(newCount || 0).toLocaleString()} FOLLOWERS`;
    }
};

// --- 3. VOLUME & NAVIGATION ---

window.updateVolume = (val) => {
    audio.volume = val;
    if (val > 0) window.preMuteVolume = val;
    updateVolumeIcon(val);
};

window.toggleMute = function() {
    const slider = document.getElementById('volume-slider');
    if (audio.volume > 0) {
        window.preMuteVolume = audio.volume;
        audio.volume = 0;
        if (slider) slider.value = 0;
    } else {
        audio.volume = window.preMuteVolume || 0.5;
        if (slider) slider.value = audio.volume;
    }
    updateVolumeIcon(audio.volume);
};

function updateVolumeIcon(vol) {
    const volIcon = document.getElementById('vol-svg');
    if (!volIcon) return;
    volIcon.innerHTML = vol == 0 ? 
        '<path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>' : 
        '<path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>';
}

window.viewHome = function() {
    // 1. HELPERS
    const getYTThumb = (url) => {
        if (!url) return null;
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        const videoId = (match && match[2].length == 11) ? match[2] : null;
        return videoId ? `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg` : null;
    };

    const getDaysUntil = (dateStr) => {
        const diff = new Date(dateStr) - new Date();
        const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
        return days > 0 ? days : 0;
    };

    // 2. DATA PREP
const publicCatalogue = (window.ALBUMS || [])
        .filter(alb => !alb.hidden)
        .map(alb => ({
            ...alb,
            coming_soon: window.isAlbumComingSoon(alb)
        }))
        .sort((a, b) => {
            // Priority 1: Coming Soon status (true values first)
            if (a.coming_soon !== b.coming_soon) {
                return a.coming_soon ? -1 : 1;
            }
            // Priority 2: Newest release date first within those groups
            return new Date(b.full_release_date) - new Date(a.full_release_date);
        });

    // Take the top 6 (Coming Soon will now naturally be at the front)
    const recentReleases = publicCatalogue.slice(0, 6);

    const spotlights = (window.SPOTLIGHTS || []).sort((a, b) => Number(a.orderId) - Number(b.orderId));

    // 3. RENDERER (Dynamic Tags & Pill Indicators)
    const renderSlide = (index) => {
        const s = spotlights[index];
        if (!s) return '';

        let displayImg = "";
        let displayTitle = s.customTitle || "Featured";
        let tagText = "FEATURED";
        let subText = s.customSub || "";
        let actionTarget = "";
        let btnText = "View More";

if (s.type === "Release") {
        const alb = publicCatalogue.find(a => String(a.id) === String(s.targetId));
        if (alb) {
            displayImg = alb.art_url;
            displayTitle = s.customTitle || alb.name;
            actionTarget = `viewAlbum('${alb.id}')`;
            if (alb.coming_soon) {
                tagText = "COMING SOON";
                subText = s.customSub || `Drops in ${getDaysUntil(alb.full_release_date)} days.`;
            } else {
                tagText = "RELEASE SPOTLIGHT";
                if (!s.customSub) subText = "Available Now";
            }
        } else {
            console.warn(`Lookup Failed: Release ID "${s.targetId}" not found in publicCatalogue.`);
        }
    } 
    else if (s.type === "Artist") {
        let art = window.ARTISTS ? window.ARTISTS[s.targetId] : null;

        if (!art && window.ARTISTS) {
            const cleanTarget = String(s.targetId).replace(/-/g, '').toLowerCase();
            art = Object.values(window.ARTISTS).find(a =>
                String(a.id).replace(/-/g, '').toLowerCase() === cleanTarget
            );
        }

        if (art) {
            displayImg = art.banner_url || art.img_url;
            displayTitle = s.customTitle || art.name;
            tagText = "ARTIST SPOTLIGHT";
            actionTarget = `viewArtist('${art.id}')`;
            btnText = "View Artist";
        } else {
            console.warn(`Lookup Failed: Artist ID "${s.targetId}" not found in window.ARTISTS.`);
        }
    } 
    else if (s.type === "Track") {
        let trackData = window.TRACKS ? window.TRACKS[s.targetId] : null;
        console.log("Track Data Found:", trackData);

        const parentAlbum = (window.ALBUMS || []).find(a => {
            let ids = Array.isArray(a.track_ids) ? a.track_ids : [];
            return ids.map(String).includes(String(s.targetId));
        });
        console.log("Parent Album Found:", parentAlbum);

        if (trackData && parentAlbum) {
            displayImg = trackData.art_url || parentAlbum.art_url;
            displayTitle = s.customTitle || trackData.title;
            subText = s.customSub || (parentAlbum.track_ids.length === 1 ? 'Featured Single' : `From ${parentAlbum.name}`);
            tagText = "TRACK HIGHLIGHT";
            btnText = "Play Now";
            actionTarget = `viewAlbum('${parentAlbum.id}'); setTimeout(() => { if(window.playTrack) window.playTrack('${s.targetId}', true, '${parentAlbum.id}'); }, 600);`;
        } else {
            console.error(`Lookup Failed: Track logic failed for ID ${s.targetId}. TrackData exists: ${!!trackData}, ParentAlbum exists: ${!!parentAlbum}`);
            // Fallback
            displayImg = trackData?.art_url || (window.ALBUMS && window.ALBUMS[0]?.art_url);
            displayTitle = s.customTitle || trackData?.title || "Featured Track";
        }
    } 
    else if (s.type === "Video") {
        displayImg = getYTThumb(s.url);
        displayTitle = s.customTitle || "New Video";
        tagText = "FEATURED VIDEO";
        actionTarget = `window.open('${s.url}', '_blank')`;
        btnText = "Watch Now";
    }

    console.log("Final Render Metadata:", { displayTitle, displayImg, actionTarget });
    console.groupEnd();

        if (!displayImg && publicCatalogue[0]) displayImg = publicCatalogue[0].art_url;

        return `
        <div class="slide-content slide-anim" onclick="${actionTarget}" style="position:relative; height:100%; width:100%; cursor:pointer; display:flex; align-items:center; padding:0 60px;">
            <div style="position:absolute; inset:0; background:url('${displayImg}') center/cover; filter:blur(40px) brightness(0.3); z-index:1;"></div>
            <div style="position:relative; z-index:2; display:flex; gap:40px; align-items:center; width:100%;">
                <img src="${displayImg}" style="width:220px; height:220px; border-radius:12px; object-fit:cover; box-shadow:0 20px 50px rgba(0,0,0,0.8); border: 1px solid rgba(255,255,255,0.1);">
                <div>
                    <span style="background:var(--accent-green); color:#000; padding:5px 12px; font-size:11px; font-weight:900; border-radius:4px; text-transform:uppercase; letter-spacing:1px;">${tagText}</span>
                    <h1 style="font-size:72px; margin:15px 0; font-weight:900; color:white; line-height:1; letter-spacing:-3px;">${displayTitle}</h1>
                    ${subText ? `<p style="color:rgba(255,255,255,0.6); margin-bottom:20px; font-weight:600;">${subText}</p>` : ''}
                    <div style="display:flex; align-items:center; gap:20px;">
                        <button class="signup-btn">${btnText}</button>
                        ${spotlights.length > 1 ? `
                        <div style="display:flex; gap:8px;">
                            ${spotlights.map((_, i) => `<div style="width:${i === index ? '24px' : '8px'}; height:8px; background:${i === index ? 'var(--accent-green)' : 'rgba(255,255,255,0.3)'}; border-radius:4px; transition: all 0.3s ease;"></div>`).join('')}
                        </div>` : ''}
                    </div>
                </div>
            </div>
        </div>`;
    };

    // 4. MOVE LOGIC
    window.moveSpotlight = (dir) => {
        if (!spotlights.length) return;
        const slider = document.getElementById('spotlight-slider-content');
        if (!slider) return;
        window.currentSpotlightIndex = ((window.currentSpotlightIndex || 0) + dir + spotlights.length) % spotlights.length;
        slider.innerHTML = renderSlide(window.currentSpotlightIndex);
        if (window.spotlightInterval) clearInterval(window.spotlightInterval);
        window.spotlightInterval = setInterval(() => window.moveSpotlight(1), 7000);
    };

    // 5. MAIN RENDER
    const content = document.getElementById('content-view');
    if (!content) return;

    content.innerHTML = `
    <style>
        .spot-container { position:relative; height:320px; border-radius:15px; overflow:hidden; background:#000; margin-bottom:40px; }
        .nav-arrow { position:absolute; top:0; bottom:0; width:80px; z-index:10; display:flex; align-items:center; justify-content:center; cursor:pointer; opacity:0; transition:0.3s; color:white; }
        .spot-container:hover .nav-arrow { opacity:1; }
        .prev-arrow { left:0; background: linear-gradient(to right, rgba(0,0,0,0.7), transparent); }
        .next-arrow { right:0; background: linear-gradient(to left, rgba(0,0,0,0.7), transparent); }
        .slide-anim { animation: slideIn 0.4s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        .browse-all-btn { background: #111; color: white; border: 1px solid #333; padding: 10px 20px; border-radius: 8px; font-weight: 800; cursor: pointer; font-size: 11px; letter-spacing: 1px; transition: 0.2s; }
        .browse-all-btn:hover { border-color: var(--accent-green); color: var(--accent-green); }
    </style>

    <div class="view-animate" style="padding:40px;">
        <div class="spot-container">
            <div class="nav-arrow prev-arrow" onclick="event.stopPropagation(); window.moveSpotlight(-1)"><span class="material-icons" style="font-size:40px;">chevron_left</span></div>
            <div class="nav-arrow next-arrow" onclick="event.stopPropagation(); window.moveSpotlight(1)"><span class="material-icons" style="font-size:40px;">chevron_right</span></div>
            <div id="spotlight-slider-content" style="height:100%;">${renderSlide(window.currentSpotlightIndex || 0)}</div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
            <h2 style="font-weight:900; font-size:24px; text-transform:uppercase; letter-spacing:-1px;">Latest Releases</h2>
            <button class="browse-all-btn" onclick="viewAllReleases()">BROWSE ALL</button>
        </div>

        <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:30px;">
            ${recentReleases.map(alb => `
                <div class="glow-card" onclick="viewAlbum('${alb.id}')" style="cursor:pointer; background:#0a0a0a; padding:20px; border-radius:12px;">
                    <img src="${alb.art_url}" style="width:100%; aspect-ratio:1; border-radius:8px; margin-bottom:12px; ${alb.coming_soon ? 'filter:grayscale(1); opacity:0.5;' : ''}">
                    <div style="font-weight:700; color:white;">${alb.name}</div>
<div style="color:${alb.coming_soon ? '#ff4444' : '#666'}; font-size:12px; margin-top:5px; font-weight: 700; text-transform: uppercase;">
    ${alb.coming_soon ? 'COMING SOON' : 
        `${alb.full_release_date || 'Unknown'} â€¢ ${alb.type || 'Release'}`
    }
</div>
                </div>
            `).join('')}
        </div>
    </div>`;

    if (window.spotlightInterval) clearInterval(window.spotlightInterval);
    if (spotlights.length > 1) window.spotlightInterval = setInterval(() => window.moveSpotlight(1), 7000);
};

// New View All function
window.viewAllReleases = function() {
    const allPublic = (window.ALBUMS || [])
        .filter(a => !a.hidden)
        .map(alb => ({
            ...alb,
            coming_soon: window.isAlbumComingSoon(alb)
        }))
        .sort((a, b) => {
            if (a.coming_soon !== b.coming_soon) return a.coming_soon ? -1 : 1;
            return new Date(b.full_release_date) - new Date(a.full_release_date);
        });

    document.getElementById('content-view').innerHTML = `
    <div class="view-animate" style="padding:50px;">
        <h1 style="font-size:48px; font-weight:900; margin-bottom:40px; text-transform:uppercase;">Catalogue</h1>
        <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:30px;">
            ${allPublic.map(alb => `
                <div class="glow-card" onclick="viewAlbum('${alb.id}')" style="cursor:pointer; background:#0a0a0a; padding:20px; border-radius:12px;">
                    <img src="${alb.art_url}" style="width:100%; aspect-ratio:1; border-radius:8px; margin-bottom:12px; ${alb.coming_soon ? 'filter:grayscale(1) brightness(0.5); border: 1px solid #ff4444;' : ''}">
                    <div style="font-weight:700; color:white;">${alb.name}</div>
                    <div style="color:${alb.coming_soon ? '#ff4444' : '#666'}; font-size:11px; margin-top:5px; font-weight:700; text-transform: uppercase; letter-spacing: 0.5px;">
                        ${alb.coming_soon ? 'COMING SOON' : 
                            `${alb.full_release_date} â€¢ ${alb.type || 'Album'}`
                        }
                    </div>
                </div>
            `).join('')}
        </div>
    </div>`;
};


function initSidebarLogic() {
    const sidebar = document.getElementById('sidebar');
    const resizer = document.getElementById('sidebar-resizer');
    
    if (!sidebar || !resizer) return;

    let isResizing = false;

    // Apply initial state from localStorage immediately
    if (isSidebarCollapsed) {
        sidebar.classList.add('collapsed');
        sidebar.style.width = '80px';
    } else {
        const savedWidth = localStorage.getItem('trm_sidebar_width');
        if (savedWidth) sidebar.style.width = savedWidth;
    }

    resizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        document.body.style.cursor = 'col-resize';
        sidebar.style.transition = 'none'; // Disable transition while dragging for smoothness
    });

    document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        
        let newWidth = e.clientX;
        
        // Snapping logic
        if (newWidth < 150) {
            newWidth = 80;
            sidebar.classList.add('collapsed');
            isSidebarCollapsed = true;
        } else {
            sidebar.classList.remove('collapsed');
            isSidebarCollapsed = false;
        }
        
        if (newWidth > 450) newWidth = 450;
        
        sidebar.style.width = newWidth + 'px';
    });

    document.addEventListener('mouseup', () => {
        if (!isResizing) return;
        isResizing = false;
        document.body.style.cursor = 'default';
        sidebar.style.transition = 'width 0.3s cubic-bezier(0.4, 0, 0.2, 1)'; // Restore transition
        
        // Save states
        localStorage.setItem('trm_sidebar_width', sidebar.style.width);
        localStorage.setItem('trm_sidebar_collapsed', isSidebarCollapsed);
    });
}

window.toggleSidebar = function() {
    const sb = document.getElementById('sidebar');
    if (!sb) return;
    
    isSidebarCollapsed = !isSidebarCollapsed;
    if (isSidebarCollapsed) {
        sb.classList.add('collapsed');
        sb.style.width = '80px';
    } else {
        sb.classList.remove('collapsed');
        const savedWidth = localStorage.getItem('trm_sidebar_width');
        sb.style.width = (savedWidth && savedWidth !== '80px') ? savedWidth : '280px';
    }
    localStorage.setItem('trm_sidebar_collapsed', isSidebarCollapsed);
};

// --- CRITICAL: Link Player State to Album View ---
const originalUpdateUI = window.updatePlayerUI;

window.updatePlayerUI = function() {
    const playIcon = document.getElementById('play-icon');
    
    if (playIcon) {
        if (window.isPlaying) {
            // Inject the PAUSE icon (two vertical bars)
            playIcon.innerHTML = `<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>`;
        } else {
            // Inject the PLAY icon (the triangle)
            playIcon.innerHTML = `<path d="M8 5v14l11-7z"/>`;
        }
    }

    // This handles the original UI updates (like the progress bar logic)
    if (typeof originalUpdateUI === 'function') originalUpdateUI();

    // This refreshes the album tracklist so the green speaker icon moves
    if (window.currentView === 'album' && window.viewingAlbumId) {
        window.viewAlbum(window.viewingAlbumId, false);
    }
};

window.isAlbumComingSoon = function(alb) {
    if (!alb) return false;

    // 1. MANUAL OVERRIDE (Boolean Power)
    if (alb.coming_soon === false || alb.coming_soon === "false") return false;

    // 2. FALLBACK IF NO DATE
    if (!alb.full_release_date) return alb.coming_soon;

    try {
        const rawDate = String(alb.full_release_date).trim();
        const nowET = new Date(new Date().toLocaleString("en-US", { timeZone: "America/New_York" }));

        // 3. CHECK IF IT'S JUST A YEAR (e.g., "2026")
        if (/^\d{4}$/.test(rawDate)) {
            const releaseYear = parseInt(rawDate);
            const currentYear = nowET.getFullYear();
            
            // FIX: If it's the current year or future year, keep it as "Coming Soon"
            // It only goes live if the current year is strictly GREATER than the release year
            // Or if you use the Manual Override (Step 1)
            return currentYear <= releaseYear;
        }

        // 4. FULL DATE COMPARISON
        const cleanedDate = rawDate.replace(/(\d+)(st|nd|rd|th)/, "$1");
        const dateObj = new Date(cleanedDate);

        if (!isNaN(dateObj)) {
            return nowET < dateObj;
        }

        return alb.coming_soon;
    } catch (e) {
        console.error("Date check error:", e);
        return alb.coming_soon;
    }
};

window.viewAlbum = function(id, scrollToTop = true) {
    const alb = window.ALBUMS.find(a => a.id === id);
    if (!alb) return;

// 1. Check if the currently playing track is actually in THIS album's tracklist
    const playingTrackId = window.currentTrackId;
    const isSongFromThisAlbumPlaying = alb.track_ids.includes(playingTrackId);
    
    // 2. The album is "Active" if the IDs match OR if one of its songs is playing
    const isThisAlbumActive = (window.currentAlbumId === id || isSongFromThisAlbumPlaying);
    
    // 3. The icon is "Pause" only if the album is active AND the audio is actually playing
    const isCurrentlyPlaying = isThisAlbumActive && window.isPlaying;
    
    const playIcon = isCurrentlyPlaying ? 'pause' : 'play_arrow';
    
    window.currentView = 'album';
    window.viewingAlbumId = id;

    const artist = window.ARTISTS[alb.artist_id] || { name: "therichmusic", id: "" };
    const rawIds = alb.track_ids || [];
    
    const tks = rawIds.map(id => {
        if (typeof id === 'string' && id.startsWith('DISC_')) return id;
        const foundTrack = window.TRACKS[id];
        if (foundTrack) return foundTrack;
        console.warn(`UI missing track data for ID: ${id}`);
        return null;
    }).filter(Boolean);
    
    const isActuallyComingSoon = window.isAlbumComingSoon(alb);
    const isReleased = !isActuallyComingSoon;
    const dateLabel = isReleased ? "Released" : "Releasing";
    let finalDateDisplay = "";

    // Date display logic
    if (alb.full_release_date) {
        const rawDate = alb.full_release_date.trim();
        if (/^\d{4}$/.test(rawDate)) {
            finalDateDisplay = rawDate;
        } else {
            const cleanedDate = rawDate.replace(/(\d+)(st|nd|rd|th)/, "$1");
            const dateObj = new Date(cleanedDate);
            if (!isNaN(dateObj)) {
                finalDateDisplay = dateObj.toLocaleDateString(undefined, {
                    year: 'numeric', month: 'long', day: 'numeric'
                });
            } else {
                finalDateDisplay = rawDate;
            }
        }
    }

    const detectPlatform = (url) => {
        const u = url.toLowerCase();
        if (u.includes('bandcamp.com')) return 'Bandcamp';
        if (u.includes('even.biz'))     return 'EVEN';
        if (u.includes('apple.com'))    return 'iTunes';
        if (u.includes('amazon.com'))   return 'Amazon';
        if (u.includes('shopify.com'))  return 'Shop';
        return 'Store';
    };

    const purchaseArray = (Array.isArray(alb.purchase_links) ? alb.purchase_links : []).map(item => {
        if (item.includes('|')) {
            const [url, title] = item.split('|');
            return { url: url.trim(), label: title.trim() };
        }
        return { url: item.trim(), label: detectPlatform(item) };
    });

    const calculateTotalRuntime = (tracks) => {
        let totalSeconds = 0;
        let hasPlayableTracks = false;
        tracks.forEach(t => {
            if (!t || typeof t === 'string') return;
            const parentIds = t.album_id ? t.album_id.split(',').map(s => s.trim()) : [];
            const isReleasedElsewhere = parentIds.some(aid => {
                const other = window.ALBUMS.find(a => a.id === aid);
                return other && !window.isAlbumComingSoon(other);
            });
            if (isReleasedElsewhere || isReleased) {
                if (t.duration && t.duration !== "??:??") {
                    const parts = t.duration.split(':');
                    totalSeconds += (parseInt(parts[0]) * 60) + parseInt(parts[1]);
                    hasPlayableTracks = true;
                }
            }
        });
        if (!hasPlayableTracks) return null;
        const mins = Math.floor(totalSeconds / 60);
        const secs = totalSeconds % 60;
        return `${mins} min ${secs} sec`;
    };

    const albumRuntime = calculateTotalRuntime(tks);
    const formattedDescription = alb.description ? alb.description.replace(/~~(.+?)~~/g, '<s>$1</s>') : '';

    const content = `
    <div class="${scrollToTop ? 'view-animate' : ''}" style="padding:50px;">
        <style>
            .album-description { margin-top: 25px; color: #b3b3b3; font-size: 14px; line-height: 1.6; max-width: 700px; white-space: pre-wrap; }
            .album-description s { color: rgba(255,255,255,0.3); }
            .album-action-btn { padding: 10px 20px; border-radius: 6px; font-weight: 800; font-size: 13px; text-transform: uppercase; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px; border: none; }
            .btn-signup { background: var(--accent-green); color: black; }
            .btn-purchase { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }
            .purchase-menu { display: none; position: absolute; top: 115%; left: 0; background: #181818; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; min-width: 180px; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
            .menu-item { padding: 12px 20px; color: #ccc; font-size: 13px; font-weight: 700; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
            .menu-item:hover { background: #282828; color: var(--accent-green); }
            .show-menu { display: block !important; }
            .track-row:hover { background: rgba(255,255,255,0.1) !important; }
        </style>

        <div style="display:flex; gap:30px; align-items:flex-end; margin-bottom:30px;">
            <div style="position:relative;">
                <img src="${alb.art_url}" style="width:240px; height:240px; border-radius:12px; box-shadow: 0 15px 50px rgba(0,0,0,0.6);">
                ${!isReleased ? `<div style="position:absolute; top:10px; right:10px; background:var(--accent-green); color:black; padding:4px 12px; border-radius:20px; font-weight:900; font-size:10px; text-transform:uppercase;">Coming Soon</div>` : ''}
            </div>
            <div style="flex:1;">
                <p style="color:var(--accent-green); font-weight:900; letter-spacing:1px; margin-bottom:8px;">${(alb.type || 'ALBUM').toUpperCase()}</p>
                <h1 style="font-size:84px; margin:0; font-weight:900; letter-spacing:-4px; line-height:1; margin-bottom:20px;">${alb.name}</h1>
                
                <div style="display:flex; align-items:center; gap:12px; margin-bottom: 25px;">
                    <button onclick="playAlbum('${alb.id}')" style="background:white; border:none; color:black; width:65px; height:65px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                        <span class="material-icons" style="font-size:40px; color:${isCurrentlyPlaying ? 'var(--accent-green)' : 'black'}">${playIcon}</span>
                    </button>

                    ${(!isReleased && alb.signup_link) ? `
                        <button class="album-action-btn btn-signup" onclick="window.open('${alb.signup_link}', '_blank')">
                            <span class="material-icons" style="font-size:18px;">mail</span> Sign Up
                        </button>
                    ` : ''}

                    ${purchaseArray.length > 0 ? `
                        <div style="position:relative;">
                            <button class="album-action-btn btn-purchase" onclick="togglePurchaseMenu(this)">
                                <span class="material-icons" style="font-size:18px;">shopping_cart</span> 
                                ${isReleased ? 'Purchase' : 'Pre-Order'}
                                <span class="material-icons" style="font-size:16px;">expand_more</span>
                            </button>
                            <div id="purchase-dropdown" class="purchase-menu">
                                ${purchaseArray.map(link => `
                                    <div class="menu-item" onclick="window.open('${link.url}', '_blank')">
                                        ${link.label}
                                        <span class="material-icons" style="font-size:14px; opacity:0.5;">open_in_new</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

${alb.trailer_url ? `
    <button onclick="window.openVideoPlayer('${alb.trailer_url}')" 
            style="background:rgba(118, 87, 255, 0.15); border:1px solid rgba(118, 87, 255, 0.3); color:#7657ff; width:45px; height:45px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; transition: 0.2s;"
            onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
        <span class="material-icons" style="font-size: 28px;">videocam</span>
    </button>
` : ''}

<button id="share-btn" onclick="copyAlbumLink('${alb.id}')" 
        style="background:rgba(255,255,255,0.1); border:none; color:white; width:45px; height:45px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; transition: 0.2s;"
        onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
    <span class="material-icons" style="font-size: 22px;">share</span>
</button>
                </div>

                <div style="display:flex; align-items:center; gap:8px; margin-top:10px; color:#aaa; font-size:14px;">
                    <span onclick="viewArtist('${artist.id}')" style="cursor:pointer; text-decoration:underline; font-weight:700; color:white;">${artist.name}</span> 
                    <span>â€¢</span>
                    <span>${tks.filter(i => typeof i !== 'string').length} Songs</span>
                    ${albumRuntime ? `<span>â€¢</span> <span>${albumRuntime}</span>` : ''}
                    ${alb.genre ? `<span>â€¢</span> <span>${alb.genre}</span>` : ''}
                    ${finalDateDisplay ? `<span>â€¢</span> <span style="font-size:12px; font-weight:600; text-transform:uppercase;">${dateLabel} ${finalDateDisplay}</span>` : ''}
                </div>

                ${formattedDescription ? `<div class="album-description">${formattedDescription}</div>` : ''}
            </div>
        </div>

        <div style="margin-top:20px; border-top: 1px solid rgba(255,255,255,0.05); padding-top:20px;">
            ${(() => {
                let discTrackCounter = 0;
                let currentDiscNum = 1;
                const hasMultipleDiscs = tks.some(item => typeof item === 'string' && item.startsWith('DISC_'));

                return tks.map((item, index) => {
                    if (typeof item === 'string' && item.startsWith('DISC_')) {
                        currentDiscNum = item.split('_')[1] || (currentDiscNum + 1);
                        discTrackCounter = 0; 
                        return `<div style="width:100%; padding: 40px 15px 15px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom:10px; margin-top:20px;">
                            <h3 style="text-transform: uppercase; letter-spacing: 3px; font-size: 12px; color: var(--accent-green); margin: 0; font-weight: 900; display: flex; align-items: center; gap: 10px;">
                                <span class="material-icons" style="font-size: 18px;">album</span> Disc ${currentDiscNum}
                            </h3>
                        </div>`;
                    }

                    const t = item;
                    if (!t || typeof t === 'string') return '';

                    if (!t.isVideo && !t.id?.startsWith('video_')) discTrackCounter++;
                    
                    const parentIds = t.album_id ? t.album_id.split(',').map(s => s.trim()) : [];
                    const isReleasedElsewhere = parentIds.some(aid => {
                        const other = window.ALBUMS.find(a => a.id === aid);
                        return other && !window.isAlbumComingSoon(other);
                    });
                    const isPlayable = isReleasedElsewhere || isReleased;
                    
                    // --- ACTIVE ROW LOGIC ---
                    const isCurrentTrack = (window.currentTrackId === t.id);
                    const isVideo = t.isVideo || (t.id && t.id.startsWith('video_'));
                    const isBonusTrack = t.bonus_track === true;

                    const displayTitle = (isPlayable || isVideo) ? t.title : `Track ${discTrackCounter}`;
                    const isLiked = window.USER_LIKES.songs.includes(t.id);
                    const heartIcon = isLiked ? 'favorite' : 'favorite_border';
                    const heartColor = isLiked ? 'var(--accent-green)' : '#666';
                    const showHeart = isPlayable && !isVideo;

                    const rightContent = isVideo 
                        ? `<span class="material-icons" style="font-size:18px; color:var(--accent-green); opacity:0.8;">videocam</span>`
                        : `<div style="display:flex; align-items:center; gap:15px;">
                            ${showHeart ? `
                                <span class="material-icons" 
                                      onclick="window.toggleTrackLikeInAlbum(event, '${t.id}')" 
                                      style="font-size:18px; color:${heartColor}; cursor:pointer; transition:0.2s;">
                                      ${heartIcon}
                                </span>
                            ` : ''}
                            <div style="color:#666; font-family:monospace; font-size:13px;">${isPlayable ? (t.duration || '0:00') : '??:??'}</div>
                           </div>`;

                    const clickAction = isVideo 
                        ? `onclick="event.preventDefault(); window.openVideoPlayer('${t.videoUrl}')"` 
                        : isPlayable ? `onclick="playTrack('${t.id}', true, '${alb.id}')"` : '';

return `
                    <div class="track-row" 
                         style="display:flex; align-items:center; padding:12px 15px; border-radius:8px; cursor:pointer; background:${isCurrentTrack ? 'rgba(118, 87, 255, 0.1)' : 'transparent'}; opacity:${(isPlayable || isVideo) ? '1' : '0.4'}; transition: 0.2s;"
                         ${clickAction}>
                        <div style="width:40px; color:${isCurrentTrack ? 'var(--accent-green)' : '#666'}; font-weight:bold;">
                            ${isCurrentTrack && window.isPlaying ? '<span class="material-icons" style="font-size:18px;">volume_up</span>' : (isVideo ? '<span class="material-icons" style="font-size:18px;">ondemand_video</span>' : discTrackCounter)}
                        </div>
                        <div style="flex:1; display:flex; align-items:center; gap:10px; font-weight:600; color:${isCurrentTrack ? 'var(--accent-green)' : 'white'};">
                            <span>${displayTitle}</span>
                            ${isBonusTrack ? `
                                <span style="display: inline-flex; align-items: center; gap: 4px; padding: 1px 6px; background: rgba(118, 87, 255, 0.1); border: 1px solid rgba(118, 87, 255, 0.2); color: var(--accent-green); font-size: 9px; font-weight: 900; text-transform: uppercase; border-radius: 3px; letter-spacing: 0.5px; white-space: nowrap; vertical-align: middle;">
                                    <span class="material-icons" style="font-size: 11px;">auto_awesome</span>
                                    BONUS TRACK
                                </span>` : ''}
                        </div>
                        ${rightContent}
                    </div>`;
                }).join('');
            })()}
        </div>
    </div>`;

    const container = document.getElementById('content-view');
    container.innerHTML = content;
    if (scrollToTop) container.scrollTop = 0;
};

window.toggleTrackLikeInAlbum = async function(event, trackId) {
    event.stopPropagation(); // Prevents the track from playing when clicking the heart
    if (!window.toggleLike) return;
    await window.toggleLike(trackId, 'song');
    // Refresh the current album view to update heart states
    if (window.viewingAlbumId) window.viewAlbum(window.viewingAlbumId, false);
};

window.copyLyrics = function(btn) {
    const lyricsBody = document.getElementById('lyrics-body');
    if (!lyricsBody) return;
    
    const textToCopy = lyricsBody.innerText;

    // Helper to handle the UI feedback
    const showSuccess = () => {
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="material-icons" style="font-size:14px;">check</span> COPIED';
        btn.style.color = 'var(--accent-green)';
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.style.color = '#666';
        }, 2000);
    };

    // 1. Primary Method: Navigator API
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(textToCopy).then(showSuccess);
    } else {
        // 2. Fallback Method: Textarea Hack (Works on HTTP/Older Browsers)
        const textArea = document.createElement("textarea");
        textArea.value = textToCopy;
        textArea.style.position = "fixed"; // Avoid scrolling to bottom
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            showSuccess();
        } catch (err) {
            console.error('Fallback copy failed', err);
        }
        document.body.removeChild(textArea);
    }
};

window.openVideoPlayer = function(url) {
    if (!url || url === 'undefined') return;
    const videoId = url.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^& \n?]+)/)?.[1];
    if (!videoId) return;

// Pause the song music
    if (window.audio) {
        window.audio.pause();
        window.isPlaying = false;
        if (typeof updatePlayerUI === 'function') updatePlayerUI();
    }

    const old = document.getElementById('video-overlay');
    if (old) old.remove();

    const modal = document.createElement('div');
    modal.id = "video-overlay";
    modal.className = "video-overlay-active"; // Triggers immediate fade-in
    
    modal.setAttribute('style', `
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.95); z-index: 2147483647;
        display: flex; align-items: center; justify-content: center;
    `);
    
    // We leave the iframe out of the initial HTML to let the animation run smoothly
    modal.innerHTML = `
        <div class="video-content-active" style="width:90%; max-width:1100px;">
            <div style="display:flex; justify-content:flex-end; margin-bottom:15px;">
                <button onclick="closeVideoPlayer()" 
                        style="background:var(--accent-green); color:black; border:none; padding:12px 25px; font-weight:900; cursor:pointer; border-radius:30px; text-transform:uppercase;">
                    âœ• Close Video
                </button>
            </div>
            <div id="iframe-container" style="padding-top:56.25%; position:relative; background:#000; border-radius:16px; overflow:hidden; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 50px rgba(0,0,0,0.5);">
                <div id="video-loader" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); color:white; font-family:sans-serif;">Loading Visualizer...</div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);

    // Wait 500ms for the animation to finish, THEN load the heavy iframe
    setTimeout(() => {
        const container = document.getElementById('iframe-container');
        container.innerHTML = `
            <iframe style="position:absolute; top:0; left:0; width:100%; height:100%;" 
                    src="https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0" 
                    frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
        `;
    }, 500);
};

window.closeVideoPlayer = function() {
    const modal = document.getElementById('video-overlay');
    const content = modal ? modal.querySelector('.video-content-active') : null;
    
    if (modal) {
        // Add the exit animation classes
        modal.classList.add('modal-exit-active');
        if (content) content.classList.add('content-exit-active');

        // Wait for the animation (300ms) then destroy the element
        setTimeout(() => {
            modal.remove();
        }, 300);
    }
};

// GLOBAL DROPDOWN TOGGLE
window.togglePurchaseMenu = function(btn) {
    const menu = document.getElementById('purchase-dropdown');
    menu.classList.toggle('show-menu');
    
    const closeMenu = (e) => {
        if (!btn.contains(e.target) && !menu.contains(e.target)) {
            menu.classList.remove('show-menu');
            document.removeEventListener('click', closeMenu);
        }
    };
    document.addEventListener('click', closeMenu);
};

window.playAlbum = function(albumId) {
    const album = window.ALBUMS.find(a => a.id === albumId);
    if (!album) return;

    // 1. If a song from this album is ALREADY playing, just toggle
    const isSongFromThisAlbumPlaying = album.track_ids.includes(window.currentTrackId);
    
    if (isSongFromThisAlbumPlaying) {
        if (window.togglePlay) window.togglePlay();
        return; // togglePlay handles the UI refresh
    }

    // 2. Otherwise, find the first playable track
    const isAlbumReleased = !window.isAlbumComingSoon(album);
    
    // Get the first ID that isn't a DISC marker and exists in TRACKS
    const firstTrackId = album.track_ids.find(tid => {
        if (typeof tid === 'string' && tid.startsWith('DISC_')) return false;
        const t = window.TRACKS[tid];
        if (!t || t.isVideo) return false;

        // Check if track is released here or elsewhere
        const parentIds = t.album_id ? t.album_id.split(',').map(s => s.trim()) : [];
        const releasedElsewhere = parentIds.some(aid => {
            const other = window.ALBUMS.find(a => a.id === aid);
            return other && !window.isAlbumComingSoon(other);
        });

        return isAlbumReleased || releasedElsewhere;
    });

    if (firstTrackId) {
        window.playTrack(firstTrackId, true, albumId);
    } else {
        console.warn("No playable tracks found.");
    }
};
    
window.copyAlbumLink = function(albumId) {
    const baseUrl = "https://trm-brand-shop.fourthwall.com/pages/music-player"; 
    // Switching to the Hash (#) for better iframe compatibility
    const shareUrl = `${baseUrl}#${albumId}`;

    navigator.clipboard.writeText(shareUrl).then(() => {
        const btn = document.getElementById('share-btn');
        if (btn) {
            const icon = btn.querySelector('.material-icons');
            const originalText = btn.innerHTML;
            
            if (icon) icon.innerText = 'check';
            btn.style.background = 'var(--accent-green)';
            btn.style.color = '#000';

            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = '';
                btn.style.color = '';
            }, 2000);
        }
    }).catch(err => {
        console.error('Could not copy text: ', err);
    });
};

window.nextTrack = function() {
    const album = window.ALBUMS.find(a => a.id === window.currentAlbumId);
    if (!album || !album.track_list) return false;

    let currentIndex = album.track_list.findIndex(t => t.id === window.currentTrackId);
    
    // Look for the next playable track in the list
    for (let i = currentIndex + 1; i < album.track_list.length; i++) {
        const t = album.track_list[i];
        
        // Parity Check: Is this track released anywhere?
        const parentAlbumIds = t.album_id ? t.album_id.split(',').map(s => s.trim()) : [];
        const isReleasedElsewhere = parentAlbumIds.some(aid => {
            const otherAlb = window.ALBUMS.find(a => a.id === aid);
            return otherAlb && !otherAlb.coming_soon;
        });

        if (isReleasedElsewhere || !album.coming_soon) {
            window.playTrack(t.id, true, window.currentAlbumId);
            return true;
        }
    }

    console.log("No more playable tracks found in this album.");
    return false;
};

window.prevTrack = function() {
    const album = window.ALBUMS.find(a => a.id === window.currentAlbumId);
    if (!album || !album.track_list) return;

    let currentIndex = album.track_list.findIndex(t => t.id === window.currentTrackId);

    // If we are more than 3 seconds into a song, just restart the current song
    if (audio.currentTime > 3) {
        audio.currentTime = 0;
        return;
    }

    // Look backward for the first playable track
    for (let i = currentIndex - 1; i >= 0; i--) {
        const t = album.track_list[i];
        
        // Parity Check: Is this track released anywhere?
        const parentAlbumIds = t.album_id ? t.album_id.split(',').map(s => s.trim()) : [];
        const isReleasedElsewhere = parentAlbumIds.some(aid => {
            const otherAlb = window.ALBUMS.find(a => a.id === aid);
            return otherAlb && !otherAlb.coming_soon;
        });

        if (isReleasedElsewhere || !album.coming_soon) {
            window.playTrack(t.id, true, window.currentAlbumId);
            return;
        }
    }

    // If no previous playable track exists, just restart the current one
    audio.currentTime = 0;
};

window.toggleFollowArtist = async function(artistId) {
    const client = window.sbc; 
    if (!client) return console.error("Supabase client not found.");

    const { data: { session } } = await client.auth.getSession();
    const user = session?.user;
    if (!user) return alert("Log in to follow your favorite artists!");

    const btn = document.getElementById('follow-btn');

    try {
        const { data: profile, error: fetchError } = await client
            .from('users')
            .select('followedartists')
            .eq('id', user.id)
            .single();

        if (fetchError && fetchError.code !== 'PGRST116') throw fetchError;

        let currentFollows = Array.isArray(profile?.followedartists) ? profile.followedartists : [];
        const isFollowing = currentFollows.includes(artistId);

        // Toggle follow
        if (isFollowing) {
            currentFollows = currentFollows.filter(id => id !== artistId);
        } else {
            currentFollows.push(artistId);
        }

        // Update database
        const { error: updateError } = await client
            .from('users')
            .update({ followedartists: currentFollows })
            .eq('id', user.id);

        if (updateError) throw updateError;

        // --- UPDATE LOCAL STATE ---
        window.USER_LIKES = window.USER_LIKES || {};
        window.USER_LIKES.artists = currentFollows;

        // --- UPDATE UI ---
        if (btn) {
            const nowFollowing = currentFollows.includes(artistId);
            const heart = nowFollowing ? 'favorite' : 'favorite_border';
            
            btn.style.background = nowFollowing ? 'var(--accent-green)' : 'transparent';
            btn.style.color = nowFollowing ? 'black' : 'white';
            btn.style.border = nowFollowing ? 'none' : '1px solid rgba(255,255,255,0.3)';
            btn.innerHTML = `<span class="material-icons" style="font-size: 18px;">${heart}</span> ${nowFollowing ? 'FOLLOWING' : 'FOLLOW'}`;
        }

        if (window.renderSidebarLibrary) await window.renderSidebarLibrary();

    } catch (err) {
        console.error("Follow Error:", err.message);
    }
};

window.toggleShuffle = () => { window.isShuffle = !window.isShuffle; document.getElementById('shuffle-btn').classList.toggle('active', window.isShuffle); };
window.toggleLoop = () => {
    if (window.loopState === undefined) window.loopState = 0;
    window.loopState = (window.loopState + 1) % 3;

    const btn = document.getElementById('loop-btn');
    const svg = document.getElementById('loop-svg');
    if (!btn || !svg) return;

    // SVG Paths
    const pathNormal = "M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z";
    const pathOne = "M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4zm-4-2V9h-1l-2 1v1h1.5v4H13z";

    if (window.loopState === 0) {
        btn.style.color = 'rgba(255,255,255)'; // Dim when off
        svg.querySelector('path').setAttribute('d', pathNormal);
    } else if (window.loopState === 1) {
        btn.style.color = 'var(--accent-green)';   // Loop All
        svg.querySelector('path').setAttribute('d', pathNormal);
    } else if (window.loopState === 2) {
        btn.style.color = 'var(--accent-green)';   // Loop One
        svg.querySelector('path').setAttribute('d', pathOne);
    }
    
    console.log("Loop State:", window.loopState);
};

window.togglePanel = function() {
    const panel = document.getElementById('info-panel');
    if (!panel) return;
    
    // Toggle the class
    panel.classList.toggle('open');
    
    // Always refresh content when opening
    if (panel.classList.contains('open')) {
        window.updatePanelContent();
    }
};

window.updatePanelContent = function() {
    const content = document.getElementById('panel-content');
    const track = window.CURRENT_TRACK;
    if (!track || !content) return;

    // 1. Find Album & Artist
    const album = window.ALBUMS.find(a => Array.isArray(a.track_ids) && a.track_ids.includes(track.id));
    const artist = album ? window.ARTISTS?.[album.artist_id] : null;

    // 2. Format Credits
    let creditsRaw = Array.isArray(track.credits) ? track.credits.join(', ') : String(track.credits || "");
    const formattedCredits = creditsRaw
        .replace(/,\s*(Produced|Written|Mixed|Engineered|Mastered)/gi, '<br>$1')
        .trim();

    const cleanLyrics = (track.lyrics || "Lyrics aren't available for this track yet.").trim();

    content.innerHTML = `
        <div style="margin-top: 20px; width: 100%; display: block; text-align: left;">
            <img src="${album?.art_url || ''}" style="width:100%; aspect-ratio:1; object-fit:cover; border-radius:12px; margin-bottom:25px; display: block;">
            
            <div style="text-align: left; margin-bottom: 30px;">
                <h2 style="font-size: 26px; font-weight: 900; color:#fff; margin: 0 0 5px 0; display: block;">${track.title || 'Unknown Track'}</h2>
                
                <p 
                    onclick="if(typeof window.viewArtist === 'function') { window.viewArtist('${album?.artist_id}'); window.togglePanel(); }"
                    style="color: var(--accent-green); font-weight: 700; margin: 0; text-transform: uppercase; font-size: 14px; letter-spacing: 1px; cursor: pointer; display: inline-block;"
                    onmouseover="this.style.textDecoration='underline'" 
                    onmouseout="this.style.textDecoration='none'"
                >
                    ${artist?.name || 'therichmusic'}
                </p>
            </div>
            
            <div style="background: rgba(255,255,255,0.03); padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); display: block; width: 100%; box-sizing: border-box;">
                <h4 style="margin: 0 0 15px 0; font-size: 10px; color: #555; letter-spacing: 2px; text-transform: uppercase; font-weight: 800; text-align: left;">Lyrics</h4>
                <div style="display: block; text-align: left; margin: 0; padding: 0; white-space: pre-wrap; line-height: 1.8; color: #d1d1d1; font-size: 16px; font-weight: 500; width: 100%;">${cleanLyrics}</div>
            </div>

            <div style="margin-top: 30px; padding: 0 0 0 15px; text-align: left; border-left: 2px solid rgba(255,255,255,0.05); display: block;">
                <h4 style="margin: 0 0 10px 0; font-size: 10px; color: #555; letter-spacing: 2px; text-transform: uppercase; font-weight: 800;">Credits</h4>
                <p style="color: #888; font-size: 13px; line-height: 1.7; font-weight: 500; margin: 0; text-align: left;">
                    ${formattedCredits || 'Written & Produced by therichmusic'}
                </p>
            </div>
        </div>
    `;
};

window.updatePlayerUI = function() {
    // 1. Swap the Mini-Player SVG Icon
    const playIcon = document.getElementById('play-icon');
    if (playIcon) {
        if (window.isPlaying) {
            // Pause Bars
            playIcon.innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';
        } else {
            // Play Triangle
            playIcon.innerHTML = '<path d="M8 5v14l11-7z"/>';
        }
    }

    // 2. Sync the Album Tracklist (Green text / Speaker icons)
    if (window.currentView === 'album' && window.viewingAlbumId) {
        window.viewAlbum(window.viewingAlbumId, false); 
    }
};

window.initApp = async function() {
    // 1. Set global state immediately
    window.USER_LIKES = { songs: [], artists: [], albums: [] };

    try {
        console.log("TRM MUSIC PLAYER: Initializing...");

        // 2. Core Data Fetch
        const [
            { data: artists },
            { data: albums },
            { data: tracks },
            { data: spotlightRows },
            { data: videos }
        ] = await Promise.all([
            window.sbc.from('artists').select('*'),
            window.sbc.from('albums').select('*'),
            window.sbc.from('tracks').select('*'),
            window.sbc.from('spotlight').select('*').eq('active', true).order('created_at', { ascending: false }).limit(4),
            window.sbc.from('videos').select('*')
        ]);

        // 3. Process Data (Spotlight/Artists/Tracks)
        window.SPOTLIGHTS = (spotlightRows || []).map(row => ({
            type: row.type, orderId: row.id, targetId: row.target_id,
            url: row.url, customTitle: row.custom_title, customSub: row.custom_sub
        }));
        
// Setup Artist Lookup - Map by BOTH id and name/handle to be safe
        window.ARTISTS = {};
        if (artists) {
            artists.forEach(a => { 
                window.ARTISTS[a.id] = a; 
                // This is the key: if 'lc-xavier' is a handle/name, map it here too
                if (a.handle) window.ARTISTS[a.handle] = a;
                if (a.name) window.ARTISTS[a.name.toLowerCase().replace(/\s+/g, '-')] = a;
            });
        }

        const trackLookup = {};
        if (tracks) tracks.forEach(t => { trackLookup[t.id] = t; });
        if (videos) {
            videos.forEach(v => { 
                const videoKey = v.id.startsWith('video_') ? v.id : `video_${v.id}`;
                trackLookup[videoKey] = { ...v, id: videoKey, isVideo: true, videoUrl: v.url }; 
            });
        }
        window.TRACKS = trackLookup; 

        // 4. Sorting & Formatting
        const parseSmartDate = (dateStr) => {
            if (!dateStr || dateStr === 'RELEASED') return 0;
            const cleanDate = String(dateStr).replace(/(\d+)(st|nd|rd|th)/, "$1");
            return /^\d{4}$/.test(cleanDate) ? new Date(`${cleanDate}-12-31`).getTime() : Date.parse(cleanDate) || 0;
        };

        window.ALBUMS = (albums || []).sort((a, b) => 
            parseSmartDate(b.full_release_date || b.release_date) - parseSmartDate(a.full_release_date || a.release_date)
        );

        window.ALBUMS.forEach(alb => {
            let ids = Array.isArray(alb.track_ids) ? alb.track_ids : [];
            if (typeof alb.track_ids === 'string') {
                try { ids = alb.track_ids.startsWith('[') ? JSON.parse(alb.track_ids) : alb.track_ids.split(',').map(s => s.trim()); } catch(e) { ids = []; }
            }
            alb.track_list = ids.map(id => window.TRACKS[id] || { id: id, title: "Unknown", missing: true });
        });

        // 5. Initial UI Render
        if (typeof renderSidebar === 'function') renderSidebar();
        
        const urlParams = new URLSearchParams(window.location.search);
        const directId = urlParams.get('album') || window.location.hash.replace('#', '');
        
        if (directId) window.viewAlbum(directId);
        else window.viewHome();

        // 6. Final Sync
        // We call this last. If the LockManager is busy, the catch will prevent the app from crashing.
        window.fetchUserLikes().catch(() => console.log("Auth lock busy, retrying via listener..."));

    } catch (e) { 
        console.error("Init Error:", e); 
        window.viewHome();
    }
};

function renderSidebar() {
    const sb = document.getElementById('sidebar-releases');
    if (sb) {
        sb.innerHTML = window.ALBUMS.filter(alb => !alb.hidden).map(alb => `
            <div class="sidebar-item" onclick="viewAlbum('${alb.id}')">
                <img src="${alb.art_url}" style="width:24px; height:24px; border-radius:2px; margin-right:10px;">
                <span>${alb.name}</span>
            </div>`).join('');
    }
}

window.handleDeepLinking = async function() {
    let albumId = null;

    // 1. Try Local URL (Immediate)
    const urlParams = new URLSearchParams(window.location.search);
    albumId = urlParams.get('album') || window.location.hash.replace('#', '');

    if (albumId) {
        processDeepLink(albumId);
        return;
    }

    // 2. Create a "Waiting Room" Promise
    console.log("Waiting for Parent Broadcast...");
    
    const waitForMessage = new Promise((resolve) => {
        const listener = (event) => {
            if (event.data && event.data.type === 'SET_ALBUM') {
                window.removeEventListener('message', listener); // Clean up
                resolve(event.data.id);
            }
        };
        window.addEventListener('message', listener);
        
        // Safety timeout: If no message in 2 seconds, resolve as null
        setTimeout(() => {
            window.removeEventListener('message', listener);
            resolve(null);
        }, 2000);
    });

    // 3. Wait for the promise to finish
    const receivedId = await waitForMessage;

    if (receivedId) {
        console.log("Deep link received via Bridge:", receivedId);
        processDeepLink(receivedId);
    } else {
        console.log("No deep link received, loading Home.");
        // window.viewHome();
    }
};

function processDeepLink(id) {
    const albumExists = window.ALBUMS && window.ALBUMS.find(a => a.id === id);
    if (albumExists) {
        window.viewAlbum(id);
    } else {
        window.viewHome();
    }
}

async function toggleDesktopPiP() {
    const video = document.getElementById('pip-video');
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = 512;
    canvas.height = 512;

    const albumArtUrl = document.getElementById('player-art').src;
    const trackTitle = document.getElementById('player-title').innerText;
    const artistName = document.getElementById('player-artist').innerText;

    if (!albumArtUrl) return;

    const img = new Image();
    img.crossOrigin = "Anonymous"; 
    img.src = albumArtUrl;

    img.onload = async () => {
        // Draw Background
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Draw Album Art
        ctx.drawImage(img, 0, 0, 512, 512);

        // Capture stream if not already active
        if (!video.srcObject) {
            video.srcObject = canvas.captureStream();
            await video.play();
        }

        try {
            if (document.pictureInPictureElement) {
                await document.exitPictureInPicture();
                document.getElementById('pip-btn').classList.remove('active');
            } else {
                await video.requestPictureInPicture();
                document.getElementById('pip-btn').classList.add('active');
            }
        } catch (error) {
            console.error("PiP failed:", error);
        }
    };
}

window.openPatchNotes = function() {
    const versionHistory = [
        {
            version: "v1.0.5.3",
            date: "February 19, 2026",
            notes: [
                "ðŸœ Squashed a bug relating to new artist's stats not showing on the app!",
                "ðŸŽ¨ Artist Hub is our next big ambition! So expect us to... <a href='https://trm-brand-shop.fourthwall.com/pages/music-player#goin-dark-5' target='_blank' rel='noopener noreferrer' style='color:#00ff88; text-decoration:none;'>go dark...</a>",
            ],
            actionButton: {
                text: "Support TRM BRAND via Ko-Fi",
                url: "https://ko-fi.com/mybudshadow"
            }
        },
                        {
            version: "v1.0.5.2",
            date: "February 18, 2026",
            notes: [
                "ðŸ¤” A ton of new features was introduced with this update to level up artists! Let's go through them all (As well as your UX!)",
                "ðŸœ We squashed a ton of bugs with the big v1.0.5 update, such as the removal of Artist Bios, Featured Videos & Socials.",
                "ðŸ”— We don't discriminate! We've added three new social links (Including websites!)",
                "â³ Time is ticking... for countdowns! Check them out on your favorite artist's profile.",
                "ðŸ”¢ We've introduced statistics, such as: Followers, Monthly Listeners, and Plays! Plays aren't shown on Release Pages or Singles, just the Artist's Page for the release.",
                "âš™ï¸ Update on Light Mode: We've decided to scrap light mode as a coming soon feature. While we love the idea of allowing users to use more than one theme, we're trying to also get the player to a stable position first.",
                "ðŸŽ¶ Fixed a bug relating to the lyrics & info panel.",
            ],
            actionButton: {
                text: "Support TRM BRAND via Ko-Fi",
                url: "https://ko-fi.com/mybudshadow"
            }
        },
                {
            version: "v1.0.5.1",
            date: "February 17, 2026",
            notes: [
                "âœ¨ Woah! We got some new colors flowing in.",
                "ðŸŽ¨ Threw a fresh coat of paint onto the icons as well!",
            ],
            actionButton: {
                text: "Support TRM BRAND via Ko-Fi",
                url: "https://ko-fi.com/mybudshadow"
            }
        },
                {
            version: "v1.0.5",
            date: "February 14, 2026",
            notes: [
                "ðŸ‘¤ Accounts are here!",
                "ðŸ©· Likes (and following artists) are back! Now you can view them on your sidebar.",
                "ðŸ› ï¸ Note that we're also working on a bunch of other new features that will take time to set up! Go support us on Ko-Fi (Link Below)",
                "<a href='https://trm-brand-shop.fourthwall.com/music-player#rich-album' target='_blank' rel='noopener noreferrer' style='color:#00ff88; text-decoration:none;'>ðŸ’¿ I heard that something weird IS happening...</a>",
                "<a href='https://trm-brand-shop.fourthwall.com/blog' target='_blank' rel='noopener noreferrer' style='color:#00ff88; text-decoration:none;'>ðŸ“° Want to know more about your privacy (regarding accounts)? Well, we just pushed an article regarding on this very topic.</a>"
            ],
            actionButton: {
                text: "Support Us via Ko-Fi (WE are a one man team!)",
                url: "https://ko-fi.com/mybudshadow"
            }
        },
                {
            version: "v1.0.4.1",
            date: "February 12, 2026",
            notes: [
                "ðŸ  Home now only shows the 6 latest releases, BUT... there's a browse all button.",
                "ðŸ’• Likes & Recents have been temporarliy disabled whilst we move towards an account system for v1.0.5",
            ],
            actionButton: {
                text: "VISIT THE BRAND SHOP",
                url: "https://trm-brand-shop.fourthwall.com"
            }
        },
        {
            version: "v1.0.4",
            date: "February 12, 2026",
            notes: [
                "âš™ï¸ Did someone say more new features? Well we got them!",
                "ðŸ“º Videos are now in albums! These are currently in beta, so for right now they won't be everywhere... but expect them on your favorite albums soon!",
                "ðŸ’¿ Multiple Disc albums are here, check this out with the new RICH album (which also has a video...)",
                "ðŸ·ï¸ You can now see 'Bonus Track' tags on all albums! If your favorite artist thinks it's a bonus track they can now mark their album to have a bonus track.",
                "ðŸ†• All 'Upcoming' releases are now automatically released ON their release date!",
                "ðŸ’¬ Release descriptions are finally here! Launching for all Artists with v1.0.4.1",
                "âŒš Release pages now track the runtime of ALL released tracks!",
                "ðŸŽ¸ Genres now appear on release pages!",
            ],
            actionButton: {
                text: "VISIT THE BRAND SHOP",
                url: "https://trm-brand-shop.fourthwall.com"
            }
        },
        {
            version: "v1.0.3.9",
            date: "February 10, 2026",
            notes: ["â¬†ï¸ Deployed a patch to fix up Spotlight!"],
            actionButton: {
                text: "VISIT THE BRAND SHOP",
                url: "https://trm-brand-shop.fourthwall.com"
            }
        },
        {
            version: "v1.0.3.8",
            date: "February 10, 2026",
            notes: ["ðŸ”— Fixed up Release Sharing", "ðŸ“¹ Spotlight now rotates!"],
            actionButton: {
                text: "VISIT THE BRAND SHOP",
                url: "https://trm-brand-shop.fourthwall.com"
            }
        },
        {
            version: "v1.0.3.2",
            date: "February 10, 2026",
            notes: ["ðŸ› ï¸ Bug fixes, away! Hammered out a bug regarding copying album links. Test #2, away!"],
            actionButton: {
                text: "VISIT THE BRAND SHOP",
                url: "https://trm-brand-shop.fourthwall.com"
            }
        },
        {
            version: "v1.0.3.1",
            date: "February 10, 2026",
            notes: ["ðŸ”— Updated Copy Link, should return the Fourthwall link instead of Githack."],
            actionButton: {
                text: "VISIT THE BRAND SHOP",
                url: "https://trm-brand-shop.fourthwall.com"
            }
        },
        {
            version: "v1.0.3",
            date: "February 10, 2026",
            notes: [
                "ðŸ”— Added Artist Social Links.",
                "ðŸ“º Added Featured Videos on Artist Pages.",
                "ðŸŽžï¸ Added Trailers to Album Pages.",
                "ðŸ“… Added Release Dates to Album Pages.",
                "ðŸ‘¤ Added 'Become An Artist' Button to Sidebar.",
                "ðŸ—’ï¸ Added Patch Notes.",
                "ðŸ‘€ And there's more... coming soon!",
                "<a href='https://tally.so/r/aQYrxy' target='_blank' rel='noopener noreferrer' style='color:#00ff88; text-decoration:none;'>ðŸ“ Sign Up to be an Artist!</a>"
            ],
            actionButton: {
                text: "VISIT THE BRAND SHOP",
                url: "https://trm-brand-shop.fourthwall.com"
            }
        },
    ];

    if (document.getElementById('patch-modal-root')) return;

    const root = document.createElement('div');
    root.id = 'patch-modal-root';
    Object.assign(root.style, {
        all: 'initial',
        position: 'fixed',
        inset: '0',
        zIndex: '2147483647',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        fontFamily: 'sans-serif'
    });

    const currentRelease = versionHistory[0];

    root.innerHTML = `
        <div style="position: absolute; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);"></div>
        
        <div style="position: relative; background: #0d0d0d; border: 1px solid #222; width: 90%; max-width: 450px; max-height: 80vh; display: flex; flex-direction: column; border-radius: 24px; color: white; box-shadow: 0 30px 60px rgba(0,0,0,0.8); animation: modalFadeIn 0.3s ease-out; overflow: hidden;">
            
            <div style="padding: 40px 40px 20px 40px;">
                <button onclick="document.getElementById('patch-modal-root').remove()" style="position: absolute; top: 20px; right: 20px; background: none; border: none; color: #444; cursor: pointer; font-size: 24px;">&times;</button>
                <h2 style="font-size: 32px; font-weight: 900; margin: 0; letter-spacing: -1px; color: white; font-family: inherit;">Patch Notes</h2>
                <p style="color: var(--accent-green); font-weight: 800; font-size: 11px; margin: 5px 0 0 0; letter-spacing: 1px; text-transform: uppercase; font-family: inherit;">VERSION ${currentRelease.version}</p>
            </div>

            <div class="patch-scroll-area" style="overflow-y: auto; padding: 0 40px; flex: 1; margin-bottom: 20px;">
                <div style="padding-bottom: 10px;">
                    ${versionHistory.map(release => `
                        <div style="margin-bottom: 25px; border-left: 2px solid #222; padding-left: 20px;">
                            <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 10px;">
                                <span style="font-weight: 900; font-size: 16px; color: white; font-family: inherit;">${release.version}</span>
                                <span style="color: #444; font-size: 11px; font-family: inherit;">${release.date}</span>
                            </div>
                            <ul style="margin: 0; padding-left: 15px; color: #aaa; line-height: 1.6; font-size: 13px; font-family: inherit; list-style: disc;">
                                ${release.notes.map(note => `<li style="margin-bottom: 6px;">${note}</li>`).join('')}
                            </ul>
                        </div>
                    `).join('')}
                </div>
            </div>

            <div style="padding: 0 40px 40px 40px; display: flex; flex-direction: column; gap: 10px;">
                <button onclick="document.getElementById('patch-modal-root').remove()" style="width: 100%; background: white; color: black; border: none; padding: 14px; border-radius: 12px; font-weight: 900; cursor: pointer; font-family: inherit; font-size: 13px; transition: 0.2s;">
                    GOT IT
                </button>

                ${currentRelease.actionButton ? `
                    <a href="${currentRelease.actionButton.url}" target="_blank" style="width: 100%; background: rgba(255,255,255,0.05); color: white; border: 1px solid rgba(255,255,255,0.1); padding: 14px; border-radius: 12px; font-weight: 900; cursor: pointer; font-family: inherit; font-size: 13px; text-align: center; text-decoration: none; box-sizing: border-box; transition: 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'">
                        ${currentRelease.actionButton.text}
                    </a>
                ` : ''}
            </div>
        </div>

        <style>
            @keyframes modalFadeIn {
                from { opacity: 0; transform: translateY(15px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .patch-scroll-area::-webkit-scrollbar {
                width: 4px;
            }
            .patch-scroll-area::-webkit-scrollbar-track {
                background: transparent;
            }
            .patch-scroll-area::-webkit-scrollbar-thumb {
                background: #222;
                border-radius: 10px;
            }
            .patch-scroll-area::-webkit-scrollbar-thumb:hover {
                background: #333;
            }
        </style>
    `;

    document.documentElement.appendChild(root);
};

// Ensure the PiP window closes if the user exits the player
window.addEventListener('pagehide', () => {
    if (document.pictureInPictureElement) {
        document.exitPictureInPicture();
    }
});

window.viewArtistPortal = function() {
    console.log("Portal Opening...");

    if (document.getElementById('artist-hub-root')) return;

    const root = document.createElement('div');
    root.id = 'artist-hub-root';
    Object.assign(root.style, {
        all: 'initial', // Resets external CSS interference
        position: 'fixed',
        inset: '0',
        zIndex: '2147483647', // Max z-index possible
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        fontFamily: 'sans-serif'
    });

    root.innerHTML = `
        <div style="position: absolute; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);"></div>
        
        <div style="position: relative; background: #0d0d0d; border: 1px solid #222; width: 90%; max-width: 400px; border-radius: 24px; padding: 40px; color: white; box-shadow: 0 30px 60px rgba(0,0,0,0.8); animation: hubFadeIn 0.3s ease-out; text-align: center;">
            
            <button onclick="document.getElementById('artist-hub-root').remove()" style="position: absolute; top: 20px; right: 20px; background: none; border: none; color: #444; cursor: pointer; font-size: 24px;">&times;</button>

            <h2 style="font-size: 32px; font-weight: 900; margin: 0; letter-spacing: -1px; color: white; font-family: inherit;">Artist Hub</h2>
            <p style="color: #00ff88; font-weight: 800; font-size: 11px; margin: 5px 0 30px 0; letter-spacing: 1px; text-transform: uppercase; font-family: inherit;">Manage Your Presence</p>

            <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
                
                <a href="https://tally.so/r/aQYrxy" target="_blank" style="display: block; background: #1a1a1a; color: white; border: 1px solid #333; padding: 16px; border-radius: 14px; font-weight: 700; cursor: pointer; font-family: inherit; font-size: 14px; text-decoration: none; transition: 0.2s;" onmouseover="this.style.borderColor='#00ff88'" onmouseout="this.style.borderColor='#333'">
                    ðŸš€ Become an Artist!
                </a>

                <a href="https://tally.so/r/kd6Rze" target="_blank" style="display: block; background: #1a1a1a; color: white; border: 1px solid #333; padding: 16px; border-radius: 14px; font-weight: 700; cursor: pointer; font-family: inherit; font-size: 14px; text-decoration: none; transition: 0.2s;" onmouseover="this.style.borderColor='#00ff88'" onmouseout="this.style.borderColor='#333'">
                    ðŸ‘¤ Edit Artist Profile
                </a>

                <a href="https://tally.so/r/GxdBjp" target="_blank" style="display: block; background: rgba(0, 255, 136, 0.05); color: #00ff88; border: 1px solid rgba(0, 255, 136, 0.2); padding: 16px; border-radius: 14px; font-weight: 700; cursor: pointer; font-family: inherit; font-size: 14px; text-decoration: none; transition: 0.2s;" onmouseover="this.style.background='rgba(0, 255, 136, 0.1)'" onmouseout="this.style.background='rgba(0, 255, 136, 0.05)'">
                    ðŸ’¿ Submit A Release
                </a>

            </div>

            <button onclick="document.getElementById('artist-hub-root').remove()" style="width: 100%; background: transparent; color: #444; border: none; padding: 10px; font-weight: 700; cursor: pointer; font-family: inherit; font-size: 12px; text-decoration: underline;">
                BACK TO PLAYER
            </button>
        </div>

        <style>
            @keyframes hubFadeIn {
                from { opacity: 0; transform: scale(0.95); }
                to { opacity: 1; transform: scale(1); }
            }
        </style>
    `;

    document.documentElement.appendChild(root);
};

let isSignUpMode = false;
const sbc = window.supabaseClient;

window.openAuthModal = function(mode = 'login') {
    if (document.getElementById('auth-modal-root')) return;

    window.isSignUpMode = (mode === 'signup');

    const root = document.createElement('div');
    root.id = 'auth-modal-root';
    Object.assign(root.style, {
        all: 'initial',
        position: 'fixed',
        inset: '0',
        zIndex: '2147483647',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        fontFamily: 'sans-serif'
    });

    const updateModalContent = () => {
        const title = window.isSignUpMode ? "Create Account" : "Welcome back";
        const subtitle = window.isSignUpMode ? "Join the community today." : "Login to your account to continue.";
        const submitText = window.isSignUpMode ? "SIGN UP" : "LOGIN";
        const toggleText = window.isSignUpMode ? "Already have an account?" : "Don't have an account?";
        const toggleLink = window.isSignUpMode ? "Login" : "Sign Up";

        root.innerHTML = `
            <div class="overlay-animate-in" style="position: absolute; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);"></div>
            
            <div class="modal-animate-in" style="position: relative; background: #0d0d0d; border: 1px solid #222; width: 90%; max-width: 400px; padding: 40px; border-radius: 28px; color: white; box-shadow: 0 40px 100px rgba(0,0,0,0.9);">
                
                <button onclick="document.getElementById('auth-modal-root').remove()" style="position: absolute; top: 20px; right: 20px; background: none; border: none; color: #444; cursor: pointer; font-size: 24px; transition: 0.2s;" onmouseover="this.style.color='#fff'">&times;</button>
                
                <h2 style="font-size: 32px; font-weight: 900; margin: 0; letter-spacing: -1px;">${title}</h2>
                <p style="color: #666; font-size: 14px; margin: 10px 0 30px 0;">${subtitle}</p>
                
                <div style="display:flex; flex-direction:column; gap:15px;">
                    ${window.isSignUpMode ? `
                        <input type="text" id="modal-auth-username" placeholder="Username" style="background:#111; border:1px solid #222; padding:15px; border-radius:12px; color:white; outline:none; font-family:inherit;">
                        <input type="text" id="modal-auth-display-name" placeholder="Display Name" style="background:#111; border:1px solid #222; padding:15px; border-radius:12px; color:white; outline:none; font-family:inherit;">
                    ` : ''}
                    <input type="email" id="modal-auth-email" placeholder="Email Address" style="background:#111; border:1px solid #222; padding:15px; border-radius:12px; color:white; outline:none; font-family:inherit;">
                    <input type="password" id="modal-auth-password" placeholder="Password" style="background:#111; border:1px solid #222; padding:15px; border-radius:12px; color:white; outline:none; font-family:inherit;">
                    
                    <button id="auth-submit-btn" onclick="window.handleAuthSubmit()" style="background:var(--accent-green); color:black; font-weight:900; padding:16px; border-radius:12px; border:none; cursor:pointer; margin-top:10px; font-size:14px; letter-spacing:0.5px; transition: 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='none'">${submitText}</button>
                    
                    <div id="auth-notification" style="font-size: 12px; text-align: center; min-height: 18px; border-radius: 8px;"></div>
                </div>

                <p style="text-align:center; margin-top:25px; font-size:13px; color:#444;">
                    ${toggleText} <span onclick="window.toggleAuthMode()" style="color:var(--accent-green); cursor:pointer; font-weight:700;">${toggleLink}</span>
                </p>
            </div>
        `;
    };

    window.toggleAuthMode = () => {
        window.isSignUpMode = !window.isSignUpMode;
        updateModalContent();
    };

    updateModalContent();
    document.documentElement.appendChild(root);
};

window.closeAuthModal = () => {
    const root = document.getElementById('auth-modal-root');
    if (!root) return;
    
    // Reverse the animation
    root.style.transition = 'opacity 0.2s ease';
    root.style.opacity = '0';
    
    setTimeout(() => root.remove(), 200);
};

window.toggleAuthMode = () => {
    isSignUpMode = !isSignUpMode;
    const title = document.getElementById('auth-title');
    const subtitle = document.getElementById('auth-subtitle');
    const signupFields = document.getElementById('signup-fields');
    const submitBtn = document.getElementById('auth-submit-btn');
    const toggleText = document.getElementById('auth-toggle-text');
    const toggleLink = document.getElementById('auth-toggle-link');

    if (isSignUpMode) {
        title.innerText = "Create Account";
        subtitle.innerText = "Join the community today.";
        signupFields.style.display = 'flex';
        submitBtn.innerText = "SIGN UP";
        toggleText.innerText = "Already have an account?";
        toggleLink.innerText = "Login";
    } else {
        title.innerText = "Welcome back";
        subtitle.innerText = "Login to your account to continue.";
        signupFields.style.display = 'none';
        submitBtn.innerText = "LOGIN";
        toggleText.innerText = "Don't have an account?";
        toggleLink.innerText = "Sign Up";
    }
};

window.handleAuthSubmit = async () => {
    // Check for the client under any of its possible names
    const client = window.sbc || window.supabaseClient;

    const notification = document.getElementById('auth-notification');
    const submitBtn = document.getElementById('auth-submit-btn');

    // 1. Safety Check: If the client is missing, stop here.
    if (!client || !client.auth) {
        console.error("Critical: Supabase client (sbc) is not initialized.");
        notification.innerHTML = "System Error: Auth service unavailable.";
        notification.style.color = "#ff4444";
        return;
    }

    const email = document.getElementById('modal-auth-email').value.trim();
    const password = document.getElementById('modal-auth-password').value;

    const showMsg = (text, isError = true) => {
        notification.innerHTML = text; 
        notification.style.color = isError ? "#ff4444" : "#00ff88";
        submitBtn.style.opacity = "1";
        submitBtn.innerText = window.isSignUpMode ? "SIGN UP" : "LOGIN";
    };

    if (password.length < 6) return showMsg("Password must be at least 6 characters.");

    submitBtn.style.opacity = "0.5";
    submitBtn.innerText = "PROCESSING...";

    try {
        if (window.isSignUpMode) {
            const username = document.getElementById('modal-auth-username').value.trim();
            const displayName = document.getElementById('modal-auth-display-name').value.trim();

            // 2. Use the 'client' variable we validated above
            const { error } = await client.auth.signUp({
                email, 
                password,
                options: { 
                    data: { 
                        username: username, 
                        display_name: displayName 
                    } 
                }
            });
            
            if (error) throw error;
            showMsg("Account created! Check your email.", false);
} else {
            const { error } = await client.auth.signInWithPassword({ email, password });
            if (error) throw error;
            
            const modal = document.getElementById('auth-modal-root');
            if (modal) modal.remove();
            
            // 1. Update the Header/Login button
            if (window.updateAuthUI) window.updateAuthUI();

            // 2. FETCH LIKES IMMEDIATELY
            if (window.fetchUserLikes) {
                await window.fetchUserLikes();
                // 3. RE-RENDER SIDEBAR AFTER FETCH
                if (window.renderSidebarLibrary) window.renderSidebarLibrary();
            }
        }
    } catch (err) {
        // This will now catch and show the 500 or 422 error messages properly
        showMsg(err.message);
    }
};

window.updateAuthUI = async () => {
    const client = window.sbc || window.supabaseClient;
    const container = document.getElementById('login-btn-container');
    if (!container) return;

    const { data: { session } } = await client.auth.getSession();

    if (session) {
        const { data: profile } = await client.from('users').select('username, display_name').eq('id', session.user.id).single();
        const name = (profile?.display_name || profile?.username || 'User').toUpperCase();

        container.innerHTML = `
            <div onclick="event.stopPropagation(); window.toggleUserMenu()" 
                 style="display: flex; align-items: center; gap: 20px; padding: 12px 16px; cursor: pointer; border-radius: 12px; transition: 0.2s;"
                 onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='none'">
                <div style="width: 24px; height: 24px; background: #7657ff; color: black; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 11px; flex-shrink: 0;">
                    ${name[0]}
                </div>
                <span style="font-weight: 700; color: white; font-size: 16px; letter-spacing: 0.5px;">${name}</span>
            </div>
        `;
    } else {
        // FIXED: Logged out state now matches sidebar styling
        container.innerHTML = `
            <div onclick="window.openAuthModal('login')" 
                 style="display: flex; align-items: center; gap: 20px; padding: 12px 16px; cursor: pointer; border-radius: 12px; transition: 0.2s;"
                 onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='none'">
                <div style="width: 24px; height: 24px; background: #222; color: #666; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0;">
                    <i class="fa-solid fa-user"></i>
                </div>
                <span style="font-weight: 700; color: white; font-size: 16px; letter-spacing: 0.5px;">LOGIN</span>
            </div>
        `;
    }
};

// Run this immediately on page load
window.updateAuthUI();

window.handleLogout = async () => {
    const client = window.sbc || window.supabaseClient;
    await client.auth.signOut();
    window.location.reload(); // Refresh to clear all states
};

window.toggleUserMenu = () => {
    const container = document.getElementById('login-btn-container');
    if (!container) return;

    // Ensure the container itself can hold the absolute menu
    if (container.style.position !== 'relative') {
        container.style.position = 'relative';
    }

    let menu = document.getElementById('user-dropdown-menu');
    
    if (!menu) {
        menu = document.createElement('div');
        menu.id = 'user-dropdown-menu';
        
        // CSS Styles
        Object.assign(menu.style, {
            position: 'absolute',
            bottom: 'calc(100% + 10px)', // Gap above the button
            left: '0',
            right: '0',
            background: '#121212',
            border: '1px solid rgba(255,255,255,0.1)',
            padding: '8px',
            borderRadius: '16px',
            display: 'none',
            flexDirection: 'column',
            zIndex: '9999',
            boxShadow: '0 -15px 30px rgba(0,0,0,0.8)',
            backdropFilter: 'blur(20px)',
            transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)'
        });

        menu.innerHTML = `
            <div style="color: rgba(255,255,255,0.3); font-size: 10px; font-weight: 900; padding: 10px 12px; letter-spacing: 1.5px; text-transform: uppercase;">Manage</div>
            <button onclick="viewAccount(); window.toggleUserMenu();" style="all:unset; display:flex; align-items:center; gap:10px; color:white; padding:12px; text-align:left; cursor:pointer; font-weight:700; font-size:13px; border-radius:10px; transition:0.2s;">
                <span class="material-icons" style="font-size:18px;">person</span> PROFILE
            </button>
            <div style="height:1px; background: rgba(255,255,255,0.05); margin: 4px 8px;"></div>
            <button onclick="window.handleLogout()" style="all:unset; display:flex; align-items:center; gap:10px; color:#ff4444; padding:12px; text-align:left; cursor:pointer; font-weight:700; font-size:13px; border-radius:10px; transition:0.2s;">
                <span class="material-icons" style="font-size:18px;">logout</span> LOGOUT
            </button>
        `;
        container.appendChild(menu);
    }

    const isHidden = menu.style.display === 'none';
    
    if (isHidden) {
        // Close other menus if any exist
        menu.style.display = 'flex';
        // Small delay to trigger CSS transition opacity if you have it
        setTimeout(() => {
            menu.style.opacity = '1';
            menu.style.transform = 'translateY(0)';
        }, 10);
    } else {
        menu.style.display = 'none';
    }

    // Close when clicking anywhere else
    const closeMenu = (e) => {
        if (!container.contains(e.target)) {
            menu.style.display = 'none';
            document.removeEventListener('click', closeMenu);
        }
    };
    
    if (isHidden) {
        setTimeout(() => document.addEventListener('click', closeMenu), 10);
    }
};

window.addEventListener('click', (e) => {
    const menu = document.getElementById('user-dropdown-menu');
    const container = document.getElementById('login-btn-container');
    
    if (menu && !container.contains(e.target)) {
        menu.style.display = 'none';
    }
});

let isHydrating = false; // Flag to prevent multiple simultaneous calls

window.sbc.auth.onAuthStateChange((event, session) => {
    console.log("Auth Event:", event);
    
    // Use a non-blocking approach for hydration
    if (session?.user) {
        // Don't await here; let it run in the background
        window.fetchUserLikes().catch(err => console.error("Hydration fail:", err));
    } else if (event === 'SIGNED_OUT') {
        window.USER_LIKES = { songs: [], artists: [], albums: [] };
        if (window.renderSidebarLibrary) window.renderSidebarLibrary();
        if (window.updateLikeButtonUI) window.updateLikeButtonUI();
        if (window.currentViewId === 'library') window.viewLibrary();
    }

    if (window.updateAuthUI) window.updateAuthUI();
});

// --- UNIFIED BOOTSTRAP ---
window.addEventListener('load', () => {
    if (typeof supabase !== 'undefined') {
        const S_URL = 'https://sxagulxljpzftqfnllhv.supabase.co';
        const S_KEY = 'sb_publishable_GG1VzWph8ZCK2hCyZugMfA_qR6LZcRn';
        
        // Initialize the client once
        window.supabaseClient = supabase.createClient(S_URL, S_KEY);
        
        // Kick off the app logic
        initApp();
        console.log("Loaded TRM MUSIC PLAYER (Desktop) v1.0.4")
    } else {
        console.error("TRM Error: Supabase CDN blocked or failed to load.");
        const content = document.getElementById('content-view');
        if (content) {
            content.innerHTML = `
                <div style="padding: 40px; color: var(--accent-green); font-family: sans-serif;">
                    <h2 style="font-weight: 900;">CONNECTION ERROR</h2>
                    <p style="opacity: 0.6;">The Supabase CDN was blocked. Please disable any aggressive ad-blockers to load the TRM Catalogue.</p>
                </div>`;
            }
    }
});
</script>