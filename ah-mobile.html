<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Artist Hub | Mobile</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --accent-green: #7268ff;
            --bg-black: #050505;
            --card-bg: #0a0a0a;
            --border: #1a1a1a;
        }

        body, html {
            margin: 0; padding: 0;
            background-color: var(--bg-black);
            color: white;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            height: 100%; overflow: hidden;
        }

        #dashboard-wrapper {
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
        }

#viewport-container {
    flex: 1;
    overflow-y: auto; /* Keep this for long search results */
    padding: 20px;
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
    width: 100%;
    /* Prevents weird iOS rubber-banding */
    -webkit-overflow-scrolling: touch; 
}

/* Add this to lock the dashboard specifically */
.locked-view {
    justify-content: center;
    align-items: center;
    overflow: hidden !important; /* No scroll on the 'Welcome Back' screen */
    height: 100%;
}

.btn-builder-add {
    background: #111;
    border: 1px solid #222;
    color: #666;
    font-size: 10px;
    font-weight: 900;
    padding: 6px 12px;
    border-radius: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer;
}

        /* Input Styling */
        .mobile-input {
            width: 100%; background: #111; border: 1px solid var(--border);
            padding: 18px; border-radius: 16px; color: white;
            font-size: 16px; box-sizing: border-box; outline: none;
        }
        .mobile-input:focus { border-color: var(--accent-green); }

        /* Button Styling */
        .btn-main {
            background: white; color: black; border: none;
            padding: 16px; border-radius: 14px;
            font-weight: 900; font-size: 14px; width: 100%;
            transition: transform 0.1s;
        }
        .btn-main:active { transform: scale(0.96); }

        #drop-zone {
    transition: all 0.3s ease;
    background: #000;
    position: relative;
}

#drop-zone:active {
    transform: scale(0.95);
}

/* A glowing effect when art is ready */
#drop-zone.ready {
    border-color: var(--accent-green) !important;
    box-shadow: 0 0 15px rgba(0, 255, 136, 0.2);
}

        /* Search Item */
        .search-item {
            display: flex; align-items: center; justify-content: space-between;
            background: var(--card-bg); padding: 15px;
            border-radius: 18px; border: 1px solid var(--border);
            margin-bottom: 12px;
        }

        /* Modal Overlay */
        #apply-modal-root {
            position: fixed; inset: 0; z-index: 10000;
            background: rgba(0,0,0,0.95); backdrop-filter: blur(10px);
            display: flex; align-items: flex-end; /* Slide up feel */
        }

        .modal-content {
            background: #0d0d0d; width: 100%;
            padding: 30px; border-radius: 30px 30px 0 0;
            border-top: 1px solid var(--border);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    color: #444;
    transition: 0.2s;
    flex: 1;
}

.nav-item i {
    font-size: 18px;
}

.nav-item span {
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
}

.nav-item.active {
    color: var(--accent-green);
}
    </style>
</head>
<body>

<div id="dashboard-wrapper">
    <div id="viewport-container">
        </div>

    <!-- <div id="mini-player" style="height: 70px; background: #000; border-top: 1px solid var(--border); display: flex; align-items: center; justify-content: center;">
        <div style="color: #333; font-size: 10px; font-weight: 900; letter-spacing: 2px;">SIMULATION MODE</div>
    </div> -->
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    // 1. SUPABASE CONFIG
const SB_URL = 'https://sxagulxljpzftqfnllhv.supabase.co';
const SB_KEY = 'sb_publishable_GG1VzWph8ZCK2hCyZugMfA_qR6LZcRn';
let client;

// 2. THE FIX: Wait for the library to be ready
async function startApp() {
    // Define viewport here to make sure the element exists
    viewport = document.getElementById('viewport-container');
    
    if (typeof window.supabase === 'undefined') {
        setTimeout(startApp, 100);
        return;
    }

    client = window.supabase.createClient(SB_URL, SB_KEY);
    window.db = client;
    window.supabaseClient = client;

    await initMobileHub();
}

// 3. MOBILE INIT (Mirrors your Desktop logic)
async function initMobileHub() {
    const { data: { session } } = await client.auth.getSession();

    if (!session) {
        renderLoginState();
        return;
    }

    try {
        const { data: profile, error } = await client
            .from('users')
            .select('userArtistId, username')
            .eq('id', session.user.id)
            .single();

        if (error && error.code !== 'PGRST116') throw error; // PGRST116 is "no rows found"

        if (profile?.userArtistId?.trim()) {
            window.currentArtistProfile = { id: profile.userArtistId };
            
            // On mobile, we combine these or show a simplified loader
            await showMobileDashboard(profile.userArtistId); 
            // await loadArtistData(); // If you have this function defined
        } else {
            showArtistSearchUI();
        }
    } catch (err) {
        console.error("Profile Fetch Error:", err.message);
        showArtistSearchUI();
    }
}

// --- 1. THE MISSING SEARCH UI ---
function showArtistSearchUI() {
    if (!viewport) return; // Safety check
    
    viewport.style.display = 'flex'; // Ensure display is flex so justifyContent works
    viewport.style.justifyContent = 'flex-start'; 
    
    viewport.innerHTML = `
        <div style="width: 100%; text-align: left;">
            <h1 style="font-weight:900; font-size:32px; margin-bottom: 10px; letter-spacing:-1px;">Artist Hub</h1>
            <p style="color:#666; margin-bottom: 30px; font-size: 15px;">Search for your name to claim your profile.</p>
            
            <input type="text" id="artist-search" class="mobile-input" placeholder="Search artists...">

            <div id="search-results" style="margin-top: 20px; display: flex; flex-direction: column; gap: 12px;"></div>

            <div style="border-top:1px solid #111; padding-top:30px; margin-top:40px;">
                <p style="color:#444; font-weight:900; font-size: 11px; letter-spacing: 1px; text-transform:uppercase;">Don't see yourself?</p>
                <button onclick="alert('New Artist flow coming soon!')" style="background:transparent; border:1px solid #222; color:white; width: 100%; padding: 15px; border-radius: 12px; margin-top: 10px; font-weight: 700;">CREATE NEW ENTITY</button>
            </div>
        </div>
    `;

    document.getElementById('artist-search').addEventListener('input', debounce(handleArtistSearch, 400));
}

window.switchView = (viewId) => {
    console.log("Switching to:", viewId);
    const content = document.getElementById('content-view');
    if (!content) return;

    // Update Nav UI
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    const activeNav = document.getElementById(`nav-${viewId}`);
    if (activeNav) activeNav.classList.add('active');

    // Scroll to top of content
    content.scrollTo(0, 0);

    switch (viewId) {
        case 'home':
            renderHomeView(content);
            break;
        case 'releases':
            renderReleasesView(content);
            break;
        case 'analytics':
            content.innerHTML = `<h2 style="font-weight:900;">Analytics</h2><p style="color:#666;">Detailed stats are best viewed on desktop.</p>`;
            break;
        case 'profile':
            content.innerHTML = `<h2 style="font-weight:900;">Profile Settings</h2><p style="color:#666;">Manage your artist bio and links.</p>`;
            break;
    }
};

function renderHomeView(container) {
    const latest = window.artistAlbums[0] || null;

    container.innerHTML = `
        <div style="margin-bottom: 30px;">
            <h1 style="font-weight: 900; font-size: 28px; margin-bottom: 5px;">Dashboard</h1>
            <p style="color: #666; font-size: 14px;">Your music performance at a glance.</p>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px;">
            <div style="background: #0d0d0d; padding: 20px; border-radius: 20px; border: 1px solid #111;">
                <span style="font-size: 10px; font-weight: 900; color: var(--accent-green);">TOTAL PLAYS</span>
                <h2 style="margin: 5px 0 0; font-weight: 900;">--</h2>
            </div>
            <div style="background: #0d0d0d; padding: 20px; border-radius: 20px; border: 1px solid #111;">
                <span style="font-size: 10px; font-weight: 900; color: var(--accent-green);">FOLLOWERS</span>
                <h2 style="margin: 5px 0 0; font-weight: 900;">--</h2>
            </div>
        </div>

        <h3 style="font-weight: 900; margin-bottom: 15px;">Latest Activity</h3>
        ${latest ? `
            <div style="display: flex; align-items: center; gap: 15px; background: #0d0d0d; padding: 15px; border-radius: 18px; border: 1px solid #111;">
                <img src="${latest.art_url}" style="width: 50px; height: 50px; border-radius: 10px; object-fit: cover;">
                <div>
                    <h4 style="margin: 0; font-weight: 800;">${latest.name}</h4>
                    <span style="font-size: 11px; color: ${latest.isPending ? '#ffaa00' : '#666'};">
                        ${latest.isPending ? 'Under Review' : 'Live on Player'}
                    </span>
                </div>
            </div>
        ` : `<p style="color:#444;">No releases found.</p>`}
    `;
}

function renderLoginState() {
    if (!viewport) return;
    viewport.style.display = 'flex';
    viewport.style.justifyContent = 'center';
    viewport.style.alignItems = 'center';

    viewport.innerHTML = `
        <div style="padding: 40px; text-align: center; width: 100%;">
            <div style="width: 80px; height: 80px; background: rgba(114, 104, 255, 0.05); border: 1px solid rgba(114, 104, 255, 0.1); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 25px;">
                <i class="fa-solid fa-lock fa-2xl" style="color: var(--accent-green);"></i>
            </div>
            <h1 style="font-weight:900; font-size: 28px; margin-bottom: 10px;">Artist Hub</h1>
            <p style="color:#888; margin-bottom: 30px; font-size: 15px; line-height: 1.5;">Access your studio tools, analytics, and release management on the go.</p>
            <button onclick="window.openAuthModal('login')" class="btn-main" style="background:var(--accent-green); color:white;">LOGIN TO ACCOUNT</button>
            <p style="margin-top: 20px; font-size: 12px; color: #444; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Artist Verification Required</p>
        </div>
    `;
}

// --- MOBILE AUTH MODAL ---
window.openAuthModal = function(mode = 'login') {
    if (document.getElementById('auth-modal-root')) return;

    window.isSignUpMode = (mode === 'signup');

    const root = document.createElement('div');
    root.id = 'auth-modal-root';
    Object.assign(root.style, {
        position: 'fixed',
        inset: '0',
        zIndex: '2147483647',
        display: 'flex',
        alignItems: 'flex-end', // Slide up from bottom on mobile
        background: 'rgba(0,0,0,0.85)',
        backdropFilter: 'blur(15px)',
        webkitBackdropFilter: 'blur(15px)'
    });

    const updateModalContent = () => {
        const title = window.isSignUpMode ? "Create Account" : "Welcome back";
        const subtitle = window.isSignUpMode ? "Join the community today." : "Login to your account to continue.";
        const submitText = window.isSignUpMode ? "SIGN UP" : "LOGIN";
        const toggleText = window.isSignUpMode ? "Already have an account?" : "Don't have an account?";
        const toggleLink = window.isSignUpMode ? "Login" : "Sign Up";

        root.innerHTML = `
            <div class="modal-content" style="background: #0d0d0d; border-top: 1px solid #222; width: 100%; padding: 30px; border-radius: 28px 28px 0 0; color: white; animation: slideUp 0.3s ease-out;">
                <div style="width: 40px; height: 5px; background: #333; margin: 0 auto 20px; border-radius: 10px;"></div>
                
                <h2 style="font-size: 28px; font-weight: 900; margin: 0; letter-spacing: -1px;">${title}</h2>
                <p style="color: #666; font-size: 14px; margin: 10px 0 25px 0;">${subtitle}</p>
                
                <div style="display:flex; flex-direction:column; gap:12px;">
                    ${window.isSignUpMode ? `
                        <input type="text" id="modal-auth-username" placeholder="Username" class="mobile-input">
                        <input type="text" id="modal-auth-display-name" placeholder="Display Name" class="mobile-input">
                    ` : ''}
                    <input type="email" id="modal-auth-email" placeholder="Email Address" class="mobile-input">
                    <input type="password" id="modal-auth-password" placeholder="Password" class="mobile-input">
                    
                    <button id="auth-submit-btn" onclick="window.handleAuthSubmit()" class="btn-main" style="background:var(--accent-green); color:white; margin-top:10px;">${submitText}</button>
                    
                    <div id="auth-notification" style="font-size: 12px; text-align: center; min-height: 18px; margin-top: 5px;"></div>
                </div>

                <p style="text-align:center; margin-top:20px; font-size:13px; color:#444;">
                    ${toggleText} <span onclick="window.toggleAuthMode()" style="color:var(--accent-green); cursor:pointer; font-weight:700;">${toggleLink}</span>
                </p>
                
                <button onclick="document.getElementById('auth-modal-root').remove()" style="width:100%; background:none; border:none; color:#444; font-weight:800; margin-top:20px; font-size:12px;">CLOSE</button>
            </div>
        `;
    };

    window.toggleAuthMode = () => {
        window.isSignUpMode = !window.isSignUpMode;
        updateModalContent();
    };

    updateModalContent();
    document.body.appendChild(root);
};

// --- AUTH SUBMISSION ---
window.handleAuthSubmit = async () => {
    const notification = document.getElementById('auth-notification');
    const submitBtn = document.getElementById('auth-submit-btn');
    
    // Use the 'client' we defined in startApp()
    if (!client) return console.error("Supabase client not ready");

    const email = document.getElementById('modal-auth-email').value.trim();
    const password = document.getElementById('modal-auth-password').value;

    const showMsg = (text, isError = true) => {
        notification.innerHTML = text; 
        notification.style.color = isError ? "#ff4444" : "#00ff88";
        submitBtn.style.opacity = "1";
        submitBtn.innerText = window.isSignUpMode ? "SIGN UP" : "LOGIN";
    };

    if (password.length < 6) return showMsg("Password must be 6+ characters.");

    submitBtn.style.opacity = "0.5";
    submitBtn.innerText = "PROCESSING...";

    try {
        if (window.isSignUpMode) {
            const username = document.getElementById('modal-auth-username').value.trim();
            const displayName = document.getElementById('modal-auth-display-name').value.trim();

            const { error } = await client.auth.signUp({
                email, 
                password,
                options: { data: { username, display_name: displayName } }
            });
            
            if (error) throw error;
            showMsg("Account created! Check your email.", false);
        } else {
            const { error } = await client.auth.signInWithPassword({ email, password });
            if (error) throw error;
            
            document.getElementById('auth-modal-root').remove();
            
            // Re-run the init hub to check for artist profile now that we are logged in
            initMobileHub();
        }
    } catch (err) {
        showMsg(err.message);
    }
};

// --- 2. THE MISSING DASHBOARD UI ---
async function showMobileDashboard(artistSlug) {
    console.log("ðŸš€ [MOBILE DASHBOARD] Loading for:", artistSlug);
    
    // Safety check for viewport
    if (!viewport) viewport = document.getElementById('viewport-container');
    viewport.className = ''; // Remove centering classes
    viewport.style.padding = "0"; // Main view handles its own padding

    // 1. Fetch BOTH Live and Pending at the same time
    const [liveRes, pendingRes] = await Promise.all([
        window.db.from('albums').select('*').eq('artist_id', artistSlug),
        window.db.from('albumrequests').select('*').eq('artist_id', artistSlug)
    ]);

    // 1. ADD THIS RESET LOGIC
    if (!viewport) viewport = document.getElementById('viewport-container');
    viewport.style.display = 'block';         // Change from flex to block
    viewport.style.justifyContent = 'unset';  // Remove centering
    viewport.style.alignItems = 'unset';     // Remove centering
    viewport.style.padding = '0';            // Clean slate for the shell

    if (liveRes.error || pendingRes.error) {
        console.error("Fetch Error:", liveRes.error || pendingRes.error);
        return;
    }

    // 2. Merge into global state
    window.artistAlbums = [
        ...(liveRes.data || []).map(a => ({ ...a, isPending: false })),
        ...(pendingRes.data || []).map(r => ({ ...r, isPending: true, status: r.status || 'pending' }))
    ];

    // 3. Render Mobile Shell with Bottom Navigation
    viewport.innerHTML = `
        <div id="mobile-shell" style="display: flex; flex-direction: column; height: 100vh;">
            <header style="padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #111;">
                <span style="font-weight: 900; letter-spacing: -1px; font-size: 20px;">Artist Hub</span>
                <div id="login-btn-container"></div>
            </header>

            <main id="content-view" style="flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px;"></main>

            <nav id="bottom-nav" style="position: fixed; bottom: 0; left: 0; right: 0; height: 70px; background: #080808; border-top: 1px solid #111; display: flex; justify-content: space-around; align-items: center; z-index: 1000; padding-bottom: env(safe-area-inset-bottom);">
                <div class="nav-item active" id="nav-home" onclick="switchView('home')">
                    <i class="fa-solid fa-house"></i>
                    <span>Home</span>
                </div>
                <div class="nav-item" id="nav-releases" onclick="switchView('releases')">
                    <i class="fa-solid fa-compact-disc"></i>
                    <span>Releases</span>
                </div>
                <div class="nav-item" id="nav-analytics" onclick="switchView('analytics')">
                    <i class="fa-solid fa-chart-line"></i>
                    <span>Stats</span>
                </div>
                <div class="nav-item" id="nav-profile" onclick="switchView('profile')">
                    <i class="fa-solid fa-user"></i>
                    <span>Profile</span>
                </div>
            </nav>
        </div>
    `;

    // 4. Initialize
    if (window.updateAuthUI) window.updateAuthUI();
    switchView('home');
}

function renderReleasesView(container) {
    const list = window.artistAlbums || [];

    // 1. Sorting Logic (Matching your desktop logic)
    const sorted = [...list].sort((a, b) => {
        const getNumericDateValue = (dateStr) => {
            if (!dateStr || dateStr === "0") return 0;
            return new Date(dateStr).getTime();
        };
        return getNumericDateValue(b.full_release_date || b.release_date) - 
               getNumericDateValue(a.full_release_date || a.release_date);
    });

    container.innerHTML = `
        <div style="padding: 10px 0 30px 0; display:flex; justify-content:space-between; align-items:flex-end;">
            <div>
                <h1 style="font-weight: 900; font-size: 32px; margin: 0; letter-spacing: -1px;">Releases</h1>
                <p style="color: #666; font-size: 15px; margin: 5px 0 0 0;">Manage your discography.</p>
            </div>
            <button onclick="openCreateReleaseModal()" class="btn-main" style="width:auto; padding: 10px 15px; font-size: 11px; background: var(--accent-green); color: black;">
                + NEW
            </button>
        </div>

        <div style="display:grid; gap:12px; padding-bottom: 40px;">
            ${sorted.map(album => `
                <div style="display:flex; align-items:center; background:#0d0d0d; border:1px solid #1a1a1a; padding:12px; border-radius:18px; ${album.isPending ? 'opacity:0.7;' : ''}">
                    <img src="${album.art_url}" style="width:55px; height:55px; border-radius:10px; object-fit:cover; margin-right:15px; ${album.isPending ? 'filter:grayscale(1);' : ''}">
                    
                    <div style="flex:1; min-width:0;">
                        <h4 style="margin:0; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            ${album.name}
                        </h4>
                        <p style="font-size:11px; color:#555; margin:3px 0 0 0; font-weight:700;">
                            ${album.full_release_date || album.release_date || 'No Date'}
                        </p>
                        ${album.isPending ? 
                            `<span style="display:inline-block; font-size:8px; background:var(--accent-green); color:#000; padding:2px 6px; border-radius:4px; margin-top:5px; font-weight:900;">UNDER REVIEW</span>` 
                            : ''
                        }
                    </div>

                    <div style="margin-left:10px;">
                        ${album.isPending ? 
                            `<i class="fa-solid fa-lock" style="color:#222; padding: 10px;"></i>` : 
                            `<button class="btn-main" onclick="window.openEditModal('${album.id}')" style="width:auto; padding: 8px 12px; font-size:10px; background:#1a1a1a; color:white; border:1px solid #222;">EDIT</button>`
                        }
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

window.generateSlug = (text) => {
    return text.toString().toLowerCase()
        .replace(/\s+/g, '-')           // Replace spaces with -
        .replace(/[()]/g, '')           // Remove parentheses
        .replace(/[^\w-]+/g, '')        // Remove all non-word chars
        .replace(/--+/g, '-')           // Replace multiple - with single -
        .replace(/^-+/, '')             // Trim - from start
        .replace(/-+$/, '');            // Trim - from end
};

window.openCreateReleaseModal = (isEdit = false) => {
    // 1. Clean up if one already exists
    const existing = document.getElementById('create-release-modal');
    if (existing) existing.remove();

    // 2. Clear image memory for fresh projects
    if (!isEdit) {
        window.lastUploadedArtUrl = null;
    }

    const modal = document.createElement('div');
    modal.id = 'create-release-modal';
    
    // Mobile-specific styling: Full screen, top-down flow
    Object.assign(modal.style, {
        position: 'fixed', inset: '0', zIndex: '100000',
        display: 'flex', flexDirection: 'column',
        background: '#050505', overflowY: 'auto'
    });

    modal.innerHTML = `
        <div style="position: sticky; top: 0; z-index: 10; padding: 20px; background: #080808; border-bottom: 1px solid #111; display:flex; justify-content:space-between; align-items:center;">
            <div style="flex:1;">
                <input type="text" id="project-title-input" placeholder="Project Title" 
                       style="background: transparent; border: none; font-size: 22px; font-weight: 900; letter-spacing: -1px; color: white; width: 100%; outline: none;">
                <p id="item-counter" style="color: #444; font-size: 9px; font-weight: 800; margin-top: 4px; letter-spacing: 1px;">0 / 30 ITEMS</p>
            </div>
            <button onclick="document.getElementById('create-release-modal').remove()" style="background:none; border:none; color:#444; font-size: 24px;"><i class="fa-solid fa-xmark"></i></button>
        </div>

        <div style="padding: 20px; padding-bottom: 120px;">
            <div style="display: flex; justify-content: center; margin-bottom: 25px;">
                <div id="drop-zone" onclick="document.getElementById('art-upload').click()" 
                     style="width: 180px; height: 180px; background: #000; border: 2px dashed #1a1a1a; border-radius: 24px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; transition: 0.3s;">
                    
                    <span id="upload-txt" style="font-size: 9px; color: #444; font-weight: 900; letter-spacing: 1px; z-index: 1;">UPLOAD ART</span>
                    <img id="art-preview" style="position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; display: none; z-index: 0;">
                    
                    <div id="upload-overlay" style="position: absolute; inset: 0; background: rgba(0,0,0,0.7); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2; backdrop-filter: blur(4px);">
                        <i class="fa-solid fa-circle-notch fa-spin" style="color: var(--accent-green); font-size: 24px; margin-bottom: 10px;"></i>
                        <span style="color: white; font-size: 10px; font-weight: 900; letter-spacing: 1px;">UPLOADING...</span>
                    </div>

                    <input type="file" id="art-upload" hidden accept="image/*" onchange="window.handleImageUpload(this)">
                </div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 30px;">
                <textarea id="project-desc-input" placeholder="Project description..." 
                          style="width: 100%; height: 80px; background: #0d0d0d; border: 1px solid #111; padding: 15px; border-radius: 16px; color: white; font-size: 14px; resize: none; outline: none;"></textarea>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <input type="text" id="date-input" placeholder="Release Date" 
                           style="background: #0d0d0d; border: 1px solid #111; padding: 14px; border-radius: 12px; color: white; font-size: 13px;">
                    <input type="text" id="genre-input" placeholder="Genre" 
                           style="background: #0d0d0d; border: 1px solid #111; padding: 14px; border-radius: 12px; color: white; font-size: 13px;">
                </div>
                
                <input type="text" id="trailer-url-input" placeholder="Featured Video URL" 
                       style="width: 100%; background: #0d0d0d; border: 1px solid #111; padding: 14px; border-radius: 12px; color: white; font-size: 13px;">
            </div>

            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="font-size: 16px; font-weight: 900; margin: 0;">Tracklist</h3>
                    <div id="add-buttons-container" style="display: flex; gap: 6px;">
                        <button onclick="addTrackItem('track')" class="btn-builder-add" style="font-size: 10px; padding: 8px 12px; background:var(--accent-green); color:#000; border:none;">+ TRACK</button>
                    </div>
                </div>
                <div id="track-list-render" style="display: flex; flex-direction: column; gap: 10px;"></div>
            </div>
        </div>

        <div style="position: fixed; bottom: 0; left: 0; right: 0; padding: 20px; background: rgba(8,8,8,0.9); backdrop-filter: blur(10px); border-top: 1px solid #111;">
            <button onclick="publishProject()" class="btn-main" style="background: white; color: black; font-weight: 900;">PUBLISH PROJECT</button>
        </div>
    `;

    document.body.appendChild(modal);

    // Initial resets
    window.trackItems = []; 
    renderTracklist();

    // 3. Draft Handling (Logic Gate)
    if (!isEdit) {
        // Auto-Save listeners
        modal.addEventListener('input', () => {
            saveReleaseDraft();
        });

        // Restore existing draft
        if (localStorage.getItem('ah_release_draft')) {
            setTimeout(restoreDraftToUI, 100);
        }
    }
};

window.addTrackItem = (type) => {
    if (trackItems.length >= 30) return;
    trackItems.push({ type: type, title: '', isBonus: false });
    renderTracklist();
};

window.removeTrackItem = (index) => {
    trackItems.splice(index, 1);
    renderTracklist();
};

window.toggleBonus = (index) => {
    trackItems[index].isBonus = !trackItems[index].isBonus;
    renderTracklist();
};

window.moveItem = (index, direction) => {
    const newIndex = index + direction;
    if (newIndex < 0 || newIndex >= trackItems.length) return; // Boundary check
    
    // Swap the items in the array
    const temp = trackItems[index];
    trackItems[index] = trackItems[newIndex];
    trackItems[newIndex] = temp;
    
    renderTracklist();
};

window.loadProjectForEdit = async (albumData) => {
    window.trackItems = []; // Reset memory
    
    if (!albumData.track_ids || !Array.isArray(albumData.track_ids)) return;

    // We populate trackItems so the masterTrackIds map in updateProject 
    // doesn't return an empty array.
    window.trackItems = albumData.track_ids.map(id => {
        if (id.startsWith('DISC_')) {
            return {
                type: 'disc',
                title: id.replace('DISC_', '').replace(/_/g, ' ')
            };
        } else {
            // It's a standard track ID
            return {
                type: 'track',
                id: id
            };
        }
    });
    
    console.log("âœ… Hydrated memory with", window.trackItems.length, "items.");
};

window.openEditModal = async (input) => {
    let albumData = null;

    // Fetch data if input is an ID string
    if (typeof input === 'string') {
        const { data: reqData } = await window.db.from('albumrequests').select('*').eq('id', input).single();
        albumData = reqData || (await window.db.from('albums').select('*').eq('id', input).single()).data;
    } else {
        albumData = input;
    }

if (!albumData) return alert("Could not load project data.");

    // Pass 'true' to indicate this is an EDIT, which bypasses draft restoration
    window.openCreateReleaseModal(true);
    
    // 2. Hydrate data after modal initialization
    setTimeout(async () => {
        const modal = document.getElementById('create-release-modal');
        if (!modal) return;

        // Load tracks into memory
        await window.loadProjectForEdit(albumData);

        // Fill Metadata
        document.getElementById('project-title-input').value = albumData.name || "";
        document.getElementById('genre-input').value = albumData.genre || "";
        document.getElementById('date-input').value = albumData.full_release_date || "";
        document.getElementById('project-desc-input').value = albumData.description || "";
        document.getElementById('trailer-url-input').value = albumData.trailer_url || "";

        // UI Adjustments for Edit Mode
        const addButtons = document.getElementById('add-buttons-container');
        if (addButtons) addButtons.style.display = 'none';

        const publishBtn = modal.querySelector('.btn-main'); // Matches mobile button class
        if (publishBtn) {
            publishBtn.innerText = "UPDATE PROJECT";
            publishBtn.onclick = () => window.updateProject(albumData.id);
        }

        // Restore Cover Art
        if (albumData.art_url) {
            window.lastUploadedArtUrl = albumData.art_url;
            const preview = document.getElementById('art-preview');
            const uploadTxt = document.getElementById('upload-txt');
            if (preview) {
                preview.src = albumData.art_url;
                preview.style.display = 'block';
                if (uploadTxt) uploadTxt.style.display = 'none';
            }
        }

        // Show Locked Tracklist State
        const renderArea = document.getElementById('track-list-render');
        if (renderArea) {
            renderArea.innerHTML = `
                <div style="background:rgba(0,255,136,0.03); padding:30px; border-radius:20px; border:1px dashed rgba(0,255,136,0.2); text-align:center;">
                    <i class="fa-solid fa-lock" style="color:var(--accent-green); margin-bottom:10px; font-size:20px;"></i>
                    <p style="color:var(--accent-green); font-size:11px; font-weight:900; letter-spacing:1px; margin:0; text-transform:uppercase;">
                        Structure Locked
                    </p>
                    <p style="color:#666; font-size:10px; margin-top:5px; line-height:1.4;">
                        Tracklist structure is fixed during updates.<br>
                        ${window.trackItems.length} Elements Hydrated.
                    </p>
                </div>`;
        }
    }, 300);
};

window.updateProject = async (releaseId) => {
    const updateBtn = document.querySelector('#create-release-modal .btn-main');
    
    try {
        if (window.trackItems.length === 0) {
            throw new Error("Track data failed to hydrate. Please close and try again.");
        }

        updateBtn.disabled = true;
        updateBtn.innerText = "UPDATING...";

        // Recalculate Project Type
        const trackCount = window.trackItems.filter(i => i.type === 'track').length;
        let projectType = "Album";
        if (trackCount <= 2) projectType = "Single";
        else if (trackCount <= 6) projectType = "EP";

        // Map IDs back to master array
        const masterTrackIds = window.trackItems.map(item => {
            if (item.type === 'disc') return `DISC_${item.title.toUpperCase().replace(/\s+/g, '_')}`;
            return item.id;
        });

        const { error: albumErr } = await window.db.from('albumrequests').upsert({
            id: releaseId,
            artist_id: window.currentArtistProfile.id,
            name: document.getElementById('project-title-input').value,
            genre: document.getElementById('genre-input').value,
            full_release_date: document.getElementById('date-input').value,
            description: document.getElementById('project-desc-input').value,
            trailer_url: document.getElementById('trailer-url-input').value,
            art_url: window.lastUploadedArtUrl,
            track_ids: masterTrackIds,
            type: projectType,
            status: 'pending' // Re-flag for review
        });

        if (albumErr) throw albumErr;

        window.clearReleaseDraft(); // Clear any local draft
        alert("Project updated and resubmitted for review!");
        location.reload();

    } catch (err) {
        console.error("Update Error:", err);
        alert("Error: " + err.message);
        updateBtn.disabled = false;
        updateBtn.innerText = "UPDATE PROJECT";
    }
};

window.publishProject = async () => {
    // Select the button - handling both class-based and id-based selection
const publishBtn = document.querySelector('.btn-primary') || document.querySelector('.btn-main');
    const title = document.getElementById('project-title-input')?.value;
    const genre = document.getElementById('genre-input')?.value;
    const dateValue = document.getElementById('date-input')?.value;
    
    // MATCHING THE HANDLER VARIABLE
    const artUrl = window.lastUploadedArtUrl || ""; 

    if (!title || !genre) return alert("Please enter a Title and Genre.");
    if (!artUrl) return alert("Wait! The cover art hasn't finished uploading yet.");
    const description = document.getElementById('project-desc-input')?.value;
    const trailerUrl = document.getElementById('trailer-url-input')?.value;
    
    // Using the variable from our handleImageUpload helper

    if (!title || !genre) return alert("Please enter a Title and Genre.");
    if (!artUrl) return alert("Please upload cover art before publishing.");
    if (window.trackItems.length === 0) return alert("Please add at least one track or video.");

    try {
        publishBtn.disabled = true;
        publishBtn.innerText = "SUBMITTING...";

        const albumSlug = window.generateSlug(title);
        const artistId = window.currentArtistProfile?.id;

        if (!artistId || artistId === "anonymous") {
             alert("Error: Artist profile not detected. Please refresh.");
             return;
        }

        // --- MULTI-TYPE LOGIC ---
        const masterTrackIds = [];
        const trackSubmissions = [];
        const videoSubmissions = [];

        window.trackItems.forEach((item) => {
            if (item.type === 'disc') {
                const discString = `DISC_${item.title.toUpperCase().replace(/\s+/g, '_')}`;
                masterTrackIds.push(discString);
            } 
            else if (item.type === 'video') {
                const videoId = `video_${window.generateSlug(item.title)}`;
                masterTrackIds.push(videoId);
                videoSubmissions.push({
                    id: videoId,
                    title: item.title,
                    url: item.reviewLink || "" 
                });
            } 
            else {
                const trackSlug = `${albumSlug}-${window.generateSlug(item.title)}`;
                masterTrackIds.push(trackSlug);
                trackSubmissions.push({
                    id: trackSlug,
                    album_id: albumSlug,
                    title: item.title,
                    bonus_track: item.isBonus || false,
                    review_link: item.reviewLink || ""
                });
            }
        });

        // --- PROJECT CLASSIFICATION ---
        const actualTrackCount = trackSubmissions.length;
        let projectType = "Album";
        if (actualTrackCount >= 1 && actualTrackCount <= 2) projectType = "Single";
        else if (actualTrackCount >= 3 && actualTrackCount <= 6) projectType = "EP";
        else if (actualTrackCount >= 7 && actualTrackCount <= 10) projectType = "Mixtape";

        // 1. Insert Album Request
        const { error: albumError } = await window.db.from('albumrequests').insert([{
            id: albumSlug,
            name: title,
            description: description,
            genre: genre,
            full_release_date: dateValue,
            artist_id: artistId,
            art_url: artUrl,
            track_ids: masterTrackIds,
            type: projectType,
            trailer_url: trailerUrl
        }]);
        if (albumError) throw albumError;

        // 2. Insert Tracks
        if (trackSubmissions.length > 0) {
            const { error: tracksError } = await window.db.from('requestedtracks').insert(trackSubmissions);
            if (tracksError) throw tracksError;
        }

        // 3. Insert Videos
        if (videoSubmissions.length > 0) {
            const { error: videosError } = await window.db.from('requestedvideos').insert(videoSubmissions);
            if (videosError) throw videosError;
        }

        // --- SUCCESS & CLEANUP ---
        window.clearReleaseDraft(); // Wipe the LocalStorage draft
        alert(`Release Published Successfully as a ${projectType}!`);
        
        // Remove the modal and reload the list to show the pending item
        const modal = document.getElementById('create-release-modal');
        if (modal) modal.remove();
        
        if (window.showMobileDashboard) {
            location.reload(); // Hard reload to sync Supabase state
        }

    } catch (err) {
        console.error("Submission error:", err);
        alert(`Error: ${err.message}`);
    } finally {
        publishBtn.disabled = false;
        publishBtn.innerText = "PUBLISH";
    }
};

function renderTracklist() {
    const list = document.getElementById('track-list-render');
    const counter = document.getElementById('item-counter');
    const btnContainer = document.getElementById('add-buttons-container');
    
    if (!list) return;

    list.innerHTML = '';
    let trackNum = 1;

    window.trackItems.forEach((item, index) => {
        const row = document.createElement('div');
        row.className = "track-row";
        // Optimized background and border for mobile legibility
        row.style = `display: flex; gap: 12px; align-items: center; padding: 15px; border-radius: 18px; border: 1px solid #1a1a1a; background: ${item.type === 'track' ? '#0d0d0d' : '#111'}; margin-bottom: 8px;`;
        
        let contentHTML = '';
        let iconHTML = '';

        if (item.type === 'track') {
            iconHTML = `<span style="color:#444; font-weight:900; width:20px; text-align:center; font-size:12px;">${trackNum++}</span>`;
            
            contentHTML = `
                <div style="flex:1; display:flex; flex-direction:column; gap:8px;">
                    <input type="text" placeholder="TRACK NAME" value="${item.title || ''}" 
                           oninput="window.trackItems[${index}].title = this.value" 
                           style="width:100%; background:transparent; border:none; color:white; font-size:15px; outline:none; font-weight:bold; padding:0;">
                    
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div style="background: rgba(114, 104, 255, 0.1); border-radius: 6px; padding: 4px 8px; display: flex; align-items: center; flex: 1;">
                            <i class="fa-solid fa-link" style="font-size: 10px; color: var(--accent-green); margin-right: 8px;"></i>
                            <input type="text" placeholder="REVIEW LINK (YT/SC)" value="${item.reviewLink || ''}" 
                                   oninput="window.trackItems[${index}].reviewLink = this.value" 
                                   style="flex:1; background:transparent; border:none; color:var(--accent-green); font-size:11px; outline:none; font-weight: 600;">
                        </div>
                    </div>
                </div>
            `;
        } else if (item.type === 'video') {
            iconHTML = `<i class="fa-solid fa-video" style="color:#444; width:20px; text-align:center; font-size:12px;"></i>`;
            contentHTML = `
                <div style="flex:1; display:flex; flex-direction:column; gap:8px;">
                    <input type="text" placeholder="VIDEO NAME" value="${item.title || ''}" 
                           oninput="window.trackItems[${index}].title = this.value" 
                           style="background:transparent; border:none; color:white; font-size:15px; outline:none; width:100%; font-weight:bold; padding:0;">
                    <div style="background: rgba(255, 255, 255, 0.05); border-radius: 6px; padding: 4px 8px; display: flex; align-items: center;">
                         <input type="text" placeholder="PASTE VIDEO URL" value="${item.reviewLink || ''}" 
                               oninput="window.trackItems[${index}].reviewLink = this.value" 
                               style="width:100%; background:transparent; border:none; color:#888; font-size:11px; outline:none;">
                    </div>
                </div>`;
        } else if (item.type === 'disc') {
            iconHTML = `<i class="fa-solid fa-compact-disc" style="color:var(--accent-green); width:20px; text-align:center;"></i>`;
            contentHTML = `
                <div style="flex:1;">
                    <input type="text" placeholder="DISC NAME" value="${item.title || ''}" 
                           oninput="window.trackItems[${index}].title = this.value" 
                           style="width:100%; background:transparent; border:none; color:white; font-size:15px; font-weight:900; outline:none;">
                </div>`;
        }

        row.innerHTML = `
            <div style="display: flex; flex-direction: column; gap: 8px; margin-right: 5px;">
                <button onclick="window.moveItem(${index}, -1)" style="background:none; border:none; color:#333; padding:5px;"><i class="fa-solid fa-chevron-up"></i></button>
                <button onclick="window.moveItem(${index}, 1)" style="background:none; border:none; color:#333; padding:5px;"><i class="fa-solid fa-chevron-down"></i></button>
            </div>
            
            ${iconHTML}
            ${contentHTML}
            
            <button onclick="window.removeTrackItem(${index})" style="background:none; border:none; color:#222; margin-left: 5px; padding: 10px;">
                <i class="fa-solid fa-trash-can"></i>
            </button>
        `;
        list.appendChild(row);
    });

    // Update Counter Logic
    if (counter) {
        counter.innerText = `${window.trackItems.length} / 30 ITEMS USED`;
        const isFull = window.trackItems.length >= 30;
        counter.style.color = isFull ? 'var(--accent-green)' : '#444';
        if (btnContainer) {
            btnContainer.style.opacity = isFull ? '0.2' : '1';
            btnContainer.style.pointerEvents = isFull ? 'none' : 'auto';
        }
    }
}

// Image Previewer
window.previewImage = (input) => {
    const preview = document.getElementById('art-preview');
    const txt = document.getElementById('upload-txt');
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
            preview.src = e.target.result;
            preview.style.display = 'block';
            txt.style.display = 'none';
        };
        reader.readAsDataURL(input.files[0]);
    }
};

window.uploadToImgBB = async (file) => {
    const IMGBB_API_KEY = 'e403a366e471b218bd958732a550add8';
    const formData = new FormData();
    formData.append('image', file);

    try {
        const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        if (data.success) return data.data.url;
        return null;
    } catch (err) {
        return null;
    }
};

// Adjusted for the Release Modal and Artist Profiles
window.handleImageUpload = async function(input, targetId) {
    const file = input.files[0];
    if (!file) return;

    const dropZone = document.getElementById('drop-zone');
    const uploadTxt = document.getElementById('upload-txt');
    const previewImg = document.getElementById('art-preview');
    const publishBtn = document.querySelector('.btn-primary') || document.querySelector('.btn-main');

    // 1. Loading UI State
    if (uploadTxt) uploadTxt.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> UPLOADING...';
    dropZone.style.opacity = "0.5";
    dropZone.style.pointerEvents = "none";
    if (publishBtn) publishBtn.disabled = true;

    try {
        const url = await window.uploadToImgBB(file);
        
        if (url) {
            // 2. Success State
            window.lastUploadedArtUrl = url; // SET GLOBAL VARIABLE
            
            previewImg.src = url;
            previewImg.style.display = 'block';
            if (uploadTxt) uploadTxt.style.display = 'none';
            
            // Border feedback
            dropZone.style.border = "2px solid var(--accent-green)";
            console.log("âœ… Art Uploaded:", url);
            
            if (window.saveReleaseDraft) window.saveReleaseDraft();
        } else {
            throw new Error("Upload failed");
        }
    } catch (e) {
        // 3. Error State
        alert("Upload failed. Try a smaller image or check connection.");
        if (uploadTxt) uploadTxt.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> TRY AGAIN';
        dropZone.style.border = "2px solid #ff4444";
    } finally {
        dropZone.style.opacity = "1";
        dropZone.style.pointerEvents = "auto";
        if (publishBtn) {
            publishBtn.disabled = false;
            publishBtn.innerText = "PUBLISH PROJECT";
        }
    }
};

// --- DRAFT LOGIC ---
window.saveReleaseDraft = () => {
    const draft = {
        title: document.getElementById('project-title-input')?.value || '',
        description: document.getElementById('project-desc-input')?.value || '',
        date: document.getElementById('date-input')?.value || '',
        genre: document.getElementById('genre-input')?.value || '',
        trailer: document.getElementById('trailer-url-input')?.value || '',
        artUrl: window.currentUploadUrl || '',
        tracks: window.trackItems
    };
    localStorage.setItem('ah_release_draft', JSON.stringify(draft));
};

window.loadReleaseDraft = () => {
    const raw = localStorage.getItem('ah_release_draft');
    if (!raw) return null;
    return JSON.parse(raw);
};

window.clearReleaseDraft = () => {
    localStorage.removeItem('ah_release_draft');
    window.currentUploadUrl = null;
};

// --- RESTORE UI ---
window.restoreDraftToUI = () => {
    const draft = loadReleaseDraft();
    if (!draft) return;

    if (confirm("You have an unsaved draft. Would you like to restore it?")) {
        if (document.getElementById('project-title-input')) document.getElementById('project-title-input').value = draft.title;
        if (document.getElementById('project-desc-input')) document.getElementById('project-desc-input').value = draft.description;
        if (document.getElementById('date-input')) document.getElementById('date-input').value = draft.date;
        if (document.getElementById('genre-input')) document.getElementById('genre-input').value = draft.genre;
        if (document.getElementById('trailer-url-input')) document.getElementById('trailer-url-input').value = draft.trailer;
        
        if (draft.artUrl) {
            window.currentUploadUrl = draft.artUrl;
            const preview = document.getElementById('art-preview');
            const txt = document.getElementById('upload-txt');
            if (preview) {
                preview.src = draft.artUrl;
                preview.style.display = 'block';
                if (txt) txt.style.display = 'none';
            }
        }

        window.trackItems = draft.tracks || [];
        renderTracklist();
    } else {
        clearReleaseDraft();
    }
};

// Add Track/Video/Disc
window.addTrackItem = (type) => {
    if (window.trackItems.length >= 30) return;
    
    const newItem = {
        type: type,
        title: '',
        reviewLink: '',
        audioFile: null,
        needsReview: false
    };
    
    window.trackItems.push(newItem);
    renderTracklist(); // This calls your provided logic to show the row
};

function debounce(func, timeout = 300) {
    let timer;
    return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => { func.apply(this, args); }, timeout);
    };
}

// Trigger the start
startApp();
</script>

</body>
</html>