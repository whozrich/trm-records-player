<head>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>

<style>
    :root {
        /* Theme Colors - Default Dark */
        --bg: #0a0a0a;
        --card: #161616;
        --text: #ffffff;
        --text-dim: #a0a0a0;
        --border: #333;
        --accent: #5865F2; /* Blurple */
        --modal-bg: rgba(0, 0, 0, 0.95);
        /* Category Specifics */
        --color-roblox: #00a2ff;
        --color-music: #ffcc00;
        --color-store: #00ff88;
    }

    [data-theme="light"] {
        --bg: #f4f4f4;
        --card: #ffffff;
        --text: #1a1a1a;
        --text-dim: #666666;
        --border: #dddddd;
        --modal-bg: rgba(255, 255, 255, 0.95);
    }

    body { background-color: var(--bg); color: var(--text); transition: background 0.3s; font-family: 'Inter', sans-serif; margin: 0; }

    /* Controls Bar */
    .controls { max-width: 1200px; margin: 40px auto; padding: 0 20px; display: flex; flex-wrap: wrap; gap: 20px; justify-content: space-between; align-items: center; }
    .search-box { background: var(--card); border: 1px solid var(--border); padding: 10px 20px; border-radius: 25px; color: var(--text); width: 250px; outline: none; }
    .search-box:focus { border-color: var(--accent); }
    
    .blog-filters { display: flex; gap: 10px; flex-wrap: wrap; }
    .filter-btn { 
        background: var(--card); border: 1px solid var(--border); color: var(--text); 
        padding: 8px 18px; border-radius: 20px; cursor: pointer; transition: 0.3s;
        display: flex; align-items: center; gap: 8px;
        font-size: 14px;
    margin-right: 5px; /* Adds space between icon and text */
    color: inherit;    /* Ensures icon matches text color */
    }
    .filter-btn.active { background: var(--accent); border-color: var(--accent); color: white; 
    transform: scale(1.1);
    transition: transform 0.2s ease;}

    /* Blog Grid */
    .blog-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; max-width: 1200px; margin: 0 auto; padding: 20px; }

    /* Card Design */
    .blog-card { 
        background: var(--card); border: 1px solid var(--border); border-radius: 16px; 
        overflow: hidden; transition: 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        display: flex; flex-direction: column; cursor: pointer;
    }
    .blog-card:hover { transform: translateY(-8px); border-color: var(--accent); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }

    /* Neon Glows per category */
    .blog-card[data-category="roblox"]:hover { border-color: var(--color-roblox); box-shadow: 0 0 15px var(--color-roblox); }
    .blog-card[data-category="music"]:hover { border-color: var(--color-music); box-shadow: 0 0 15px var(--color-music); }
    .blog-card[data-category="store"]:hover { border-color: var(--color-store); box-shadow: 0 0 15px var(--color-store); }

.card-image {
    position: relative;
    height: 180px;
    background: #000; /* Black background if image fails to load or is smaller */
}
    .card-image img { width: 100%; height: 100%; object-fit: cover; }
    
    .badge { 
        position: absolute; top: 12px; right: 12px; padding: 4px 10px; border-radius: 6px; 
        font-size: 11px; font-weight: 700; color: #000; text-transform: uppercase; 
    }
    .blog-card[data-category="roblox"] .badge { background: var(--color-roblox); }
    .blog-card[data-category="music"] .badge { background: var(--color-music); }
    .blog-card[data-category="store"] .badge { background: var(--color-store); }

    .card-content { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
    .card-content time { font-size: 12px; color: var(--text-dim); }
    .card-content h2 { margin: 10px 0; font-size: 1.3rem; }
    .card-content p { color: var(--text-dim); font-size: 0.9rem; line-height: 1.4; }

    .tags { margin-top: auto; padding-top: 15px; display: flex; flex-wrap: wrap; gap: 6px; }
    .tag { color: var(--accent); font-size: 11px; font-weight: 600; }

    .play-overlay {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(88, 101, 242, 0.9); /* Blurple */
    color: white;
    width: 50px; height: 50px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
    z-index: 2;
    pointer-events: none;
    box-shadow: 0 0 15px rgba(0,0,0,0.5);
}

    /* Modal Styling */
.post-modal {
    display: none; /* Hide entirely when not active */
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.85);
    z-index: 9999;
    overflow-y: auto;
    padding: 40px 20px;
}
.post-modal.is-active {
    display: flex;
    justify-content: center;
}

.modal-content {
    background: transparent;
    width: 100%;
    max-width: 850px;
    border-radius: 15px;
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

#full-post-body:not(:empty) {
    background: var(--card);
    padding: 40px;
    border-radius: 15px;
    box-shadow: 0 10px 50px rgba(0,0,0,0.5);
    position: relative;
}

#full-post-body:empty {
    display: none;
}

    .post-modal.is-active .modal-content { transform: scale(1); }
    .close-btn { position: absolute; top: 20px; right: 20px; background: none; border: none; color: var(--text); font-size: 30px; cursor: pointer; }

    #full-post-body img { width: 100%; border-radius: 12px; margin: 20px 0; }
    #full-post-body .article-text { line-height: 1.8; white-space: pre-wrap; color: var(--text); }

    .article-preview {
    color: var(--text-dim);
    font-size: 0.9rem;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2; /* Limits preview to 2 lines */
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.close-post-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: var(--text);
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    transition: 0.2s ease;
}

.close-post-btn:hover {
    background: var(--accent);
    color: white;
    transform: rotate(90deg);
}

.post-meta-row {
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 20px;
    padding-right: 40px; /* Space so it doesn't clip under the X button */
}

.category-badge {
    color: var(--accent);
    font-weight: bold;
    text-transform: uppercase;
    font-size: 0.75rem;
}

.date-text {
    color: var(--text-dim);
    font-size: 0.85rem;
}

.post-title {
    font-size: 2.2rem;
    margin: 10px 0 20px 0;
    line-height: 1.1;
    color: var(--text);
}

/* Removes any automatic indentation from the blog content */
.article-text {
    text-align: left;
    padding: 0;
    margin: 0;
}

.article-text p {
    margin-bottom: 1.5rem; /* Adds nice spacing between paragraphs */
    text-indent: 0 !important; /* Forces removal of any paragraph indents */
    padding-left: 0 !important;
}

/* Ensure the container doesn't have internal padding pushing content */
.content-fade-in {
    width: 100%;
    display: block;
}

.read-btn {
    transition: transform 0.1s ease, background 0.2s ease;
}

.post-modal.is-active .modal-content {
    transform: translateY(0) scale(1);
}

.read-btn:active {
    transform: scale(0.95); /* Button physically sinks when clicked */
}

#reading-progress {
    position: fixed;
    top: 0;
    left: 0;
    height: 4px;
    background: var(--accent);
    z-index: 10002; /* Ensure it stays above EVERYTHING */
    transition: width 0.1s ease;
}

    .theme-toggle { cursor: pointer; background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 10px; border-radius: 50%; width: 40px; height: 40px; }
/* Back to Store Button */
    .back-nav { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
    .btn-secondary { 
        background: transparent; border: 1px solid var(--border); color: var(--text); 
        padding: 8px 15px; border-radius: 8px; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 8px;
    }
    .btn-secondary:hover { border-color: var(--accent); background: rgba(88, 101, 242, 0.1); }

    /* Video Embed Container */
    .video-container {
        position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;
        border-radius: 12px; margin: 20px 0; background: #000;
    }
    .video-container iframe {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;
    }

    /* Article Formatting */
    .article-text b, .article-text strong { font-weight: bold; color: var(--text); }
    .article-text i, .article-text em { font-style: italic; }
    .article-text u { text-decoration: underline; }
    .article-text s, .article-text strike { text-decoration: line-through; }
    .article-text a { color: var(--accent); text-decoration: none; border-bottom: 1px solid transparent; }
    .article-text a, .card-content a {
    color: var(--accent);
    text-decoration: none;
    font-weight: 600;
    border-bottom: 1px solid transparent;
    transition: 0.2s ease;
}

.article-text a:hover, .card-content a:hover {
    border-bottom: 1px solid var(--accent);
    filter: brightness(1.2); /* Makes it pop slightly on hover */
}

.blog-card, .modal-content, .theme-toggle, .search-box, .filter-btn {
    transition: background-color 0.8s ease, border-color 0.8s ease, color 0.8s ease, transform 0.3s ease;
}

.theme-toggle i {
    display: inline-block;
    transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    font-size: 1.2rem;
}

.theme-toggle.rotating i {
    transform: rotate(360deg);
}

/* Optional: Make the button feel more like a button */
.theme-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 45px;
    height: 45px;
    transition: all 0.3s ease;
}

.theme-toggle:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(88, 101, 242, 0.1);
}

.theme-toggle.rotating i {
    transform: rotate(360deg);
}

.btn-secondary:hover .animate-arrow {
    transform: translateX(-5px);
}

.animate-arrow {
    transition: transform 0.3s ease;
    margin-right: 8px;
}

.scroll-top-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--accent);
    color: white;
    border: none;
    cursor: pointer;
    display: none; /* Hidden by default */
    z-index: 999;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    transition: transform 0.3s ease;
}

.scroll-top-btn:hover {
    transform: translateY(-5px);
}
</style>

<section class="blog-section">
    <div class="controls">
        <div class="blog-filters" id="filter-bar">
<div class="blog-filters" id="filter-bar">
    <button class="filter-btn active" data-cat="All">
        <i class="fa-solid fa-border-all"></i> All
    </button>
    <button class="filter-btn" data-cat="Roblox">
        <i class="fa-solid fa-gamepad"></i> Roblox
    </button>
    <button class="filter-btn" data-cat="Music">
        <i class="fa-solid fa-music"></i> Music
    </button>
    <button class="filter-btn" data-cat="Store">
        <i class="fa-solid fa-bag-shopping"></i> Store
    </button>
</div>
        </div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <input type="text" class="search-box" id="tag-search" placeholder="Search">
<button class="theme-toggle" onclick="toggleTheme()">
    <i id="theme-icon" class="fa-solid fa-moon"></i>
</button>        </div>
    </div>

    <div id="blog-grid" class="blog-grid"></div>

    <div id="post-modal" class="post-modal">
        <div class="modal-content">
            <button onclick="closePost()" class="close-btn">&times;</button>
            <div id="full-post-body"></div>
        </div>
    </div>
<div class="back-nav">
    <a href="https://trm-brand-shop.fourthwall.com" class="btn-secondary">
        <i class="fa-solid fa-arrow-left animate-arrow"></i> Back to Store
    </a>
</div>

<button id="scrollTop" class="scroll-top-btn">
    <i class="fa-solid fa-arrow-up"></i>
</button>
</section>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    // 1. Setup
    const SB_URL = 'https://sxagulxljpzftqfnllhv.supabase.co';
    const SB_KEY = 'sb_publishable_GG1VzWph8ZCK2hCyZugMfA_qR6LZcRn';
    window.db = supabase.createClient(SB_URL, SB_KEY);

    const blogManager = {
        container: document.getElementById('blog-grid'),
        allPosts: [],

        async init() {
            await this.fetchPosts();
            this.setupEventListeners();
        },

        getMedia(url) {
        if (!url) return { type: 'image', url: 'https://via.placeholder.com/400x200' };
        
        const ytRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i;
        const match = url.match(ytRegex);

        if (match && match[1]) {
            return { 
                type: 'video', 
                id: match[1], 
                thumbnail: `https://img.youtube.com/vi/${match[1]}/maxresdefault.jpg` 
            };
        }
        return { type: 'image', url: url };
    },

        async fetchPosts() {
            this.container.innerHTML = '<div style="grid-column: 1/-1; text-align: center;">Loading...</div>';
            const { data, error } = await window.db
                .from('blog_posts')
                .select('*')
                .eq('is_published', true)
                .order('created_at', { ascending: false });

            if (error) {
                console.error(error);
                return;
            }
            this.allPosts = data;
            this.render(this.allPosts);
        },

        render(posts) {
        if (!posts.length) {
            this.container.innerHTML = '<p style="grid-column: 1/-1; text-align: center;">No matches found.</p>';
            return;
        }

        this.container.innerHTML = posts.map(post => {
            const media = this.getMedia(post.featured_image);
            const displayImage = media.type === 'video' ? media.thumbnail : media.url;
            
            return `
                <article class="blog-card" data-category="${post.category.toLowerCase()}" onclick="viewFullPost('${post.slug}')">
                    <div class="card-image">
                        ${media.type === 'video' ? '<div class="play-overlay">â–¶</div>' : ''}
                        <img src="${displayImage}" alt="" onerror="this.src='https://via.placeholder.com/400x200'">
                        <span class="badge">${post.category}</span>
                    </div>
                    <div class="card-content">
                        <time>${new Date(post.created_at).toLocaleDateString()}</time>
                        <h2>${post.title}</h2>
                        <div class="article-preview">${post.content.substring(0, 100)}...</div>
                        <div class="tags">
                            ${post.tags.map(t => `<span class="tag">#${t}</span>`).join('')}
                        </div>
                    </div>
                </article>
            `;
        }).join('');
    },

        setupEventListeners() {
            // Category Filter
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    this.applyFilters();
                });
            });

            // Tag Search
            document.getElementById('tag-search').addEventListener('input', () => {
                this.applyFilters();
            });
        },

applyFilters() {
    const categoryBtn = document.querySelector('.filter-btn.active');
    const category = categoryBtn ? categoryBtn.dataset.cat : 'All';
    const searchTerm = document.getElementById('tag-search').value.toLowerCase().trim();

    let filtered = this.allPosts;

    // If there is a search term, ignore category and just find the title
    if (searchTerm) {
        filtered = filtered.filter(p => {
            const inTitle = p.title.toLowerCase().includes(searchTerm);
            const inContent = p.content.toLowerCase().includes(searchTerm);
            return inTitle || inContent;
        });
    } 
    // Otherwise, just filter by category normally
    else if (category !== 'All') {
        filtered = filtered.filter(p => p.category === category);
    }

    this.render(filtered);
}
    };

    // Global Functions
window.viewFullPost = async (slug, btnElement) => {
    const modal = document.getElementById('post-modal');
    const body = document.getElementById('full-post-body');
    
    // 1. INSTANT ACTION: Open modal and show loading state immediately
    modal.classList.add('is-active');
    document.body.style.overflow = 'hidden';
    
    body.innerHTML = `
        <button class="close-post-btn" onclick="closePost()"><i class="fa-solid fa-xmark"></i></button>
        <div class="skeleton-loader">
            <div class="skeleton-title"></div>
            <div class="skeleton-media"></div>
            <div class="skeleton-text"></div>
        </div>
    `;

    try {
        // 2. Fetch data in the background
        const { data, error } = await window.db.from('blog_posts').select('*').eq('slug', slug).single();
        if (error || !data) throw error;

        const dateString = new Date(data.created_at).toLocaleDateString('en-US', {
            year: 'numeric', month: 'long', day: 'numeric'
        });

        // 3. Smoothly swap skeleton for real content
// Inside your viewFullPost function, ensure this part looks like this:
body.innerHTML = `
    <button class="close-post-btn animate-pop" onclick="closePost()">
        <i class="fa-solid fa-xmark"></i>
    </button>
    <div class="content-fade-in">
        <div class="post-meta-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-right: 50px;">
            <span style="color:var(--accent); font-weight:bold; text-transform: uppercase; font-size: 0.8rem;">${data.category}</span>
            <span style="color:var(--text-dim); font-size: 0.8rem;"><i class="fa-regular fa-calendar"></i> ${dateString}</span>
        </div>
        <h1 style="font-size: 2.5rem; margin: 10px 0 20px 0; line-height: 1.2; text-align: left;">${data.title}</h1>
        <div class="featured-image-container" style="width: 100%; margin-bottom: 30px;">
            ${getMediaHTML(data.featured_image)}
        </div>
        <div class="article-text">${data.content}</div>
    </div>
`;

    } catch (err) {
        console.error("Error:", err);
        closePost(); // Auto-close if fetch fails
    }
};

window.closePost = () => {
    const modal = document.getElementById('post-modal');
    modal.classList.remove('is-active');
    document.body.style.overflow = 'auto';
    // No need to "remove" the button here because it's part of the body.innerHTML now
};

    // Helper to detect and convert YouTube links to Embeds
function getMediaHTML(url) {
    if (!url) return '';
    
    // Check for YouTube patterns (standard, shorts, or shared)
    const ytRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i;
    const match = url.match(ytRegex);

    if (match && match[1]) {
        return `<div class="video-container">
                    <iframe src="https://www.youtube.com/embed/${match[1]}" allowfullscreen></iframe>
                </div>`;
    }

    // Default to Image if not YouTube
    return `<img src="${url}" alt="Blog Media">`;
}

document.getElementById('post-modal').addEventListener('scroll', function() {
    const winScroll = this.scrollTop;
    const height = this.scrollHeight - this.clientHeight;
    const scrolled = (winScroll / height) * 100;
    document.getElementById("reading-progress").style.width = scrolled + "%";
});

// This should be at the very bottom of your <script>
document.getElementById('post-modal').addEventListener('click', function(e) {
    // We check the ID of the element actually clicked
    if (e.target.id === 'post-modal' || e.target.id === 'reading-progress') {
        closePost();
    }
});

// The actual "Click Anywhere Else" logic
document.getElementById('post-modal').addEventListener('click', function(e) {
    // Only close if the user clicked the actual dark background (the modal div)
    if (e.target === this) {
        closePost();
    }
});

const scrollBtn = document.getElementById("scrollTop");

window.onscroll = function() {
    if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
        scrollBtn.style.display = "block";
    } else {
        scrollBtn.style.display = "none";
    }
};

scrollBtn.onclick = function() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
};

function toggleTheme() {
    const root = document.documentElement;
    const btn = document.querySelector('.theme-toggle');
    const icon = document.getElementById('theme-icon');
    const current = root.getAttribute('data-theme');

    // 1. Start the spin
    btn.classList.add('rotating');

    // 2. Wait 250ms (halfway through spin) to swap colors and icon
    setTimeout(() => {
        if (current === 'light') {
            root.setAttribute('data-theme', 'dark');
            icon.className = 'fa-solid fa-moon';
        } else {
            root.setAttribute('data-theme', 'light');
            icon.className = 'fa-solid fa-sun';
        }
    }, 250);

    // 3. Cleanup class so it can spin again on next click
    setTimeout(() => {
        btn.classList.remove('rotating');
    }, 500);
}


// Close post on Escape key press
document.addEventListener('keydown', function(e) {
    if (e.key === "Escape") {
        const modal = document.getElementById('post-modal');
        if (modal.classList.contains('is-active')) {
            closePost();
        }
    }
});

    // Run
    document.addEventListener('DOMContentLoaded', () => blogManager.init());
</script>