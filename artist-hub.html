<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRM ARTIST HUB</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        :root {
            --accent-green: #7268ff;
            --sidebar-width: 280px;
        }

        body { 
            margin: 0; 
            background: #000; 
            color: #fff; 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; 
            height: 100vh;
        }

        #dashboard-wrapper {
            display: flex; 
            flex-direction: column;
            height: 100vh;
        }

        .main-viewport {
            display: flex; 
            flex: 1; 
            overflow: hidden; 
        }

        /* SIDEBAR */
        #sidebar {
            width: var(--sidebar-width);
            background: #000;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #111;
            padding: 20px 0;
        }

        .sidebar-title {
            padding: 0 25px 20px 25px;
            font-size: 10px;
            font-weight: 900;
            color: #444;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 25px; 
            cursor: pointer; 
            transition: 0.2s; 
            color: #fff; 
            font-weight: 700;
            text-decoration: none;
            background: rgba(0, 255, 136, 0.05);
            border-right: 3px solid var(--accent-green);
        }

        /* Builder Specific Buttons */
.btn-builder-add {
    background: #fff; 
    color: #000; 
    border: none; 
    padding: 8px 15px; 
    border-radius: 8px; 
    font-size: 10px; 
    font-weight: 900; 
    cursor: pointer;
    transition: 0.2s;
    text-transform: uppercase;
}
.btn-builder-add:hover { opacity: 0.8; }

/* The Track Row Bonus Tag */
.bonus-tag {
    font-size: 9px;
    font-weight: 900;
    padding: 6px 12px;
    border-radius: 8px;
    border: 1px solid #222;
    color: #444;
    cursor: pointer;
    transition: 0.2s;
    background: #151515;
}
.bonus-tag.active {
    background: rgba(0, 255, 136, 0.1);
    border-color: var(--accent-green);
    color: var(--accent-green);
}

        #login-btn-container {
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid #111;
        }

        /* MAIN CONTENT */
        #content-view {
            flex: 1;
            overflow-y: auto;
            background: linear-gradient(to bottom, #121212, #000);
            padding: 60px;
        }

        .release-banner {
            background: #0a0a0a;
            border: 1px solid #222;
            border-radius: 24px;
            padding: 40px;
            display: flex;
            gap: 40px;
            align-items: center;
            max-width: 900px;
        }

        .release-art {
            width: 200px;
            height: 200px;
            background: #111;
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        .badge {
            background: var(--accent-green);
            color: #000;
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 10px;
            font-weight: 900;
            letter-spacing: 1px;
            margin-bottom: 15px;
            display: inline-block;
        }

        .btn-primary {
            background: var(--accent-green);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 900;
            cursor: pointer;
            transition: 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 12px;
        }

        .btn-primary:hover {
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(114, 104, 255, 0.6);
        }

        .search-result-item {
            background: #111;
            border: 1px solid #222;
            padding: 15px 20px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        /* MODAL ANIMATION */
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-animate-in { animation: modalIn 0.2s ease-out forwards; }
    </style>
</head>
<body>

<div id="dashboard-wrapper">
    <div class="main-viewport" id="viewport-container">
        </div>

    <div id="mini-player" style="height: 100px; background: #050505; border-top: 1px solid #111; display: flex; align-items: center; padding: 0 25px;">
        <div style="color: #444; font-size: 11px; font-weight: 900; letter-spacing: 1px;">STUDIO MONITOR OFF</div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.1500.0.min.js"></script>

<script>
// SUPABASE CONFIG
const SB_URL = 'https://sxagulxljpzftqfnllhv.supabase.co';
const SB_KEY = 'sb_publishable_GG1VzWph8ZCK2hCyZugMfA_qR6LZcRn';
window.db = window.supabase.createClient(SB_URL, SB_KEY);

let client;
const viewport = document.getElementById('viewport-container');

async function init() {
    client = supabase.createClient(SB_URL, SB_KEY);
    window.supabaseClient = client;
    window.db = client; 

    const { data: { session } } = await client.auth.getSession();

    if (!session) {
        renderLoginState();
        return;
    }

    const { data: profile } = await client
        .from('users')
        .select('userArtistId')
        .eq('id', session.user.id)
        .single();

    if (profile?.userArtistId?.trim()) {
        window.currentArtistProfile = { id: profile.userArtistId };
        
        // 1. Build the UI shell first
        await showArtistDashboard(profile.userArtistId); 
        
        // 2. Fetch all data (Live + Pending) into the global state
        await loadArtistData(); 
        
        // 3. Explicitly ensure we start on the Home view
        switchView('home'); 
    } else {
        showArtistSearchUI();
    }
}

// 2. STATE: LOGIN REQUIRED
function renderLoginState() {
    viewport.innerHTML = `
        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; width:100%; gap:20px;">
            <i class="fa-solid fa-lock fa-3x" style="color:#222;"></i>
            <h1 style="font-weight:900;">Please Login</h1>
            <p style="color:#666;">Access the Artist Hub by logging into your account.</p>
            <button onclick="window.openAuthModal('login')" class="btn-primary">LOGIN TO ACCOUNT</button>
        </div>
    `;
}

// 3. STATE: SEARCH/CLAIM ARTIST
function showArtistSearchUI() {
    viewport.innerHTML = `
        <div style="flex:1; padding:60px; max-width:800px; margin:0 auto; overflow-y:auto;">
            <h1 style="font-weight:900; font-size:42px; letter-spacing:-1.5px;">Claim Your Artist Profile</h1>
            <p style="color:#666; margin-bottom:40px;">Search for your artist name to get started.</p>
            
            <input type="text" id="artist-search" placeholder="Type artist name..." 
                style="width:100%; background:#111; border:1px solid #222; padding:18px; border-radius:12px; color:white; font-size:16px; outline:none; margin-bottom:20px;">

            <div id="search-results"></div>

            <div style="border-top:1px solid #111; padding-top:30px; margin-top:20px;">
                <p style="color:#444; font-weight:700;">DON'T SEE YOURSELF?</p>
                <button class="btn-primary" style="background:transparent; border:1px solid #222; color:white;">CREATE NEW ARTIST ENTITY</button>
            </div>
        </div>
    `;

    document.getElementById('artist-search').addEventListener('input', debounce(handleArtistSearch, 400));
}

async function handleArtistSearch(e) {
    const query = e.target.value;
    const resultsContainer = document.getElementById('search-results');
    if (query.length < 2) { resultsContainer.innerHTML = ''; return; }

    const { data: artists } = await client
        .from('artists')
        .select('id, name')
        .ilike('name', `%${query}%`)
        .limit(5);

    if (artists && artists.length > 0) {
        resultsContainer.innerHTML = artists.map(a => `
            <div class="search-result-item">
                <span style="font-weight:700;">${a.name}</span>
                <button class="btn-primary" style="padding:8px 16px;" onclick="openApplyModal('${a.name}', '${a.id}')">APPLY</button>
            </div>
        `).join('');
    } else {
        resultsContainer.innerHTML = `<p style="color:#444;">No results found.</p>`;
    }
}

// 3. View Switcher Logic
function switchView(view) {
    const navHome = document.getElementById('nav-home');
    const navReleases = document.getElementById('nav-releases');
    const navAnalytics = document.getElementById('nav-analytics');
    const navProfile = document.getElementById('nav-profile');

    const navElements = [navHome, navReleases, navAnalytics, navProfile];

    // Reset Sidebar Styles
    navElements.forEach(el => {
        if (!el) return;
        el.style.background = 'transparent';
        el.style.borderRight = 'none';
        el.style.color = '#888';
    });

    const activeEl = document.getElementById(`nav-${view}`);
    if (activeEl) {
        activeEl.style.background = 'rgba(114, 104, 255, 0.05)';
        activeEl.style.borderRight = '3px solid #7268ff'; // Updated to match your theme
        activeEl.style.color = '#fff';
    }

    // Route to the correct render function
    switch(view) {
        case 'home': renderHomeView(); break;
        case 'analytics': renderAnalyticsView(); break;
        case 'profile': renderProfileEditor(); break;
        default: renderReleaseList();
    }
}

// Helper for ImgBB uploads
// Consolidate into ONE global handler
window.uploadToImgBB = async (file) => {
    const IMGBB_API_KEY = 'e403a366e471b218bd958732a550add8';
    const formData = new FormData();
    formData.append('image', file);

    try {
        const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (data.success) {
            console.log("‚úÖ Upload Successful:", data.data.url);
            return data.data.url;
        } else {
            console.error("‚ùå ImgBB Error:", data.error.message);
            return null;
        }
    } catch (err) {
        console.error("‚ùå Network Error:", err);
        return null;
    }
};

window.handleImageUpload = async function(input, targetId) {
    const file = input.files[0];
    if (!file) return;

    // 1. Instant UI Preview
    const previewUrl = URL.createObjectURL(file);
    const bannerContainer = input.closest('div'); 
    if (bannerContainer) {
        bannerContainer.style.backgroundImage = `url('${previewUrl}')`;
    }

    // 2. Loading State
    const btn = input.previousElementSibling;
    const originalContent = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> UPLOADING...';
    btn.disabled = true;

    try {
        // 3. Call the consolidated global function
        const url = await window.uploadToImgBB(file);
        
        if (url) {
            // 4. Update the hidden input for the SaveProfile function
            document.getElementById(targetId).value = url;
            
            // 5. Success State
            btn.innerHTML = '<i class="fa-solid fa-check" style="color: #00ff00;"></i> READY';
            console.log(`Input #${targetId} updated with: ${url}`);
        } else {
            throw new Error("Upload returned no URL");
        }
    } catch (e) {
        console.error("Handler Error:", e);
        alert("Upload failed. Please check your console for details.");
        btn.innerHTML = originalContent;
    } finally {
        btn.disabled = false;
    }
};

// Helper to validate YouTube URLs
function isValidYouTube(url) {
    if (!url) return true; // Allow empty
    return url.includes('youtube.com/') || url.includes('youtu.be/');
}

async function renderProfileEditor() {
    const content = document.getElementById('content-view');
    if (!content) return;

    content.innerHTML = `<div style="padding: 20px;"><div id="profile-form-container" class="loader"></div></div>`;

    const socialConfig = {
    'Instagram':  { icon: 'fa-instagram',   brand: true },
    'Twitter':    { icon: 'fa-x-twitter',   brand: true },
    'YouTube':    { icon: 'fa-youtube',     brand: true },
    'TikTok':     { icon: 'fa-tiktok',      brand: true },
    'SoundCloud': { icon: 'fa-soundcloud',  brand: true },
    'Spotify':    { icon: 'fa-spotify',     brand: true },
    'Website':    { icon: 'fa-globe',       brand: false } // Example of a non-brand icon
};

    try {
        const { data: { user } } = await window.db.auth.getUser();
        const { data: userLink } = await window.db.from('users').select('userArtistId').eq('id', user.id).single();
        const { data: artist } = await window.db.from('artists').select('*').eq('id', userLink.userArtistId).single();

        const getSocial = (platform) => artist.socials?.find(s => s.platform === platform)?.url || '';

        document.getElementById('profile-form-container').innerHTML = `
            <div style="background: #0a0a0a; border: 1px solid #111; border-radius: 24px; padding: 40px; display: flex; flex-direction: column; gap: 30px;">
                
                <div style="position: relative; height: 180px; border-radius: 16px; background: url('${artist.banner_url || ''}') center/cover no-repeat; border: 1px solid #222; overflow: hidden; display: flex; align-items: center; justify-content: center;">
                    <div style="position: absolute; inset: 0; background: rgba(0,0,0,0.4);"></div>
                    <button onclick="document.getElementById('banner-file').click()" style="position: relative; z-index: 2; background: #fff; color: #000; border: none; padding: 10px 20px; border-radius: 30px; font-weight: 900; cursor: pointer; font-size: 12px;">
                        CHANGE BANNER
                    </button>
                    <input type="file" id="banner-file" hidden onchange="handleImageUpload(this, 'edit-banner')">
                    <input type="hidden" id="edit-banner" value="${artist.banner_url || ''}">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 60px;">
                    <div>
                        <label style="font-size: 10px; font-weight: 900; color: #444; text-transform: uppercase;">Artist Name</label>
                        <input type="text" id="edit-name" value="${artist.name}" style="width:100%; background:#050505; border:1px solid #222; color:#fff; padding:12px; border-radius:12px; margin-top: 8px;">
                    </div>
                    <div>
                        <label style="font-size: 10px; font-weight: 900; color: #444; text-transform: uppercase;">Featured Video</label>
                        <input type="text" id="edit-video" value="${artist.featured_video_url || ''}" placeholder="youtube.com/..." style="width:100%; background:#050505; border:1px solid #222; color:#fff; padding:12px; border-radius:12px; margin-top: 8px;">
                    </div>
                </div>

                <div>
                    <label style="font-size: 10px; font-weight: 900; color: #444; text-transform: uppercase;">Social Links</label>
                    <div style="display: flex; gap: 15px; margin-top: 10px;">
${Object.keys(socialConfig).map(p => {
                const val = getSocial(p);
                const config = socialConfig[p];
                const iconClass = config.brand ? 'fa-brands' : 'fa-solid';
                
                return `
                    <div id="wrapper-${p}" style="position: relative; display: flex; align-items: center;">
                        <div onclick="toggleSocialInput('${p}')" id="icon-${p}" 
                             style="width: 44px; height: 44px; border-radius: 12px; background: #111; border: 1px solid ${val ? '#00ff00' : '#222'}; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s;"
                             onmouseover="this.style.borderColor='${val ? '#00ff00' : '#444'}'" 
                             onmouseout="this.style.borderColor='${val ? '#00ff00' : '#222'}'"
                        >
                            <i class="${iconClass} ${config.icon}" style="color: ${val ? '#00ff00' : '#fff'}; font-size: 18px;"></i>
                        </div>
                        <input type="text" id="social-${p.toLowerCase()}" class="social-input" data-platform="${p}" value="${val}" 
                            onkeypress="if(event.key === 'Enter') toggleSocialInput('${p}')"
                            placeholder="${p} URL..."
                            style="display: none; width: 220px; background: #111; border: 1px solid #333; color: #fff; padding: 10px; border-radius: 12px; margin-left: 10px; font-size: 12px;">
                    </div>
                `;
            }).join('')}
                    </div>
                </div>

                <div>
                    <label style="font-size: 10px; font-weight: 900; color: #444; text-transform: uppercase;">Biography</label>
                    <textarea id="edit-bio" style="width:100%; height:120px; background:#050505; border:1px solid #222; color:#fff; padding:12px; border-radius:12px; resize:none; margin-top: 8px;">${artist.bio || ''}</textarea>
                </div>

                <button onclick="window.saveArtistProfile('${artist.id}')" style="background:#fff; color:#000; border:none; padding:16px; border-radius:14px; font-weight:900; cursor:pointer; transition: 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                    SAVE PROFILE UPDATES
                </button>
            </div>
        `;
    } catch (e) { console.error(e); }
}

window.toggleSocialInput = function(platform) {
    const input = document.getElementById(`social-${platform.toLowerCase()}`);
    const iconDiv = document.getElementById(`icon-${platform}`);
    const isHidden = input.style.display === 'none';
    
    input.style.display = isHidden ? 'block' : 'none';
    if (!isHidden) {
        iconDiv.style.borderColor = input.value.trim() ? '#00ff00' : '#222';
        iconDiv.querySelector('i').style.color = input.value.trim() ? '#00ff00' : '#fff';
    } else {
        input.focus();
    }
};

window.saveArtistProfile = async function(artistId) {
    // Show loading state on Save Button
    const saveBtn = event.target;
    const originalText = saveBtn.innerText;
    saveBtn.innerText = "SAVING...";
    saveBtn.disabled = true;

    // Get the value specifically from the hidden input updated by handleImageUpload
    const bannerUrl = document.getElementById('edit-banner').value;
    const name = document.getElementById('edit-name').value.trim();
    const videoUrl = document.getElementById('edit-video').value.trim();
    const bio = document.getElementById('edit-bio').value.trim();

    if (videoUrl !== "" && !isValidYouTube(videoUrl)) {
        alert("‚ùå Invalid Video: Please use a YouTube link.");
        saveBtn.innerText = originalText;
        saveBtn.disabled = false;
        return;
    }

    const platforms = ['Instagram', 'Twitter', 'YouTube', 'TikTok', 'SoundCloud', 'Website'];
    const socials = platforms.map(p => ({
        platform: p,
        url: document.getElementById(`social-${p.toLowerCase()}`).value.trim()
    })).filter(s => s.url !== "");

    try {
        const { data, error } = await window.db
            .from('artists')
            .update({
                name: name,
                featured_video_url: videoUrl,
                bio: bio,
                banner_url: bannerUrl, // This now contains the public URL from the upload
                socials: socials,
                updated_at: new Date().toISOString()
            })
            .eq('id', artistId)
            .select(); // Adding .select() confirms what was actually written

        if (error) throw error;

        console.log("Successfully updated database:", data);
        alert("‚úÖ Profile updated successfully!");
        
        // Force refresh the local state so the rest of the app sees the change
        if (window.currentArtistProfile) {
            window.currentArtistProfile = { ...window.currentArtistProfile, ...data[0] };
        }
        
    } catch (err) {
        console.error("Save Error:", err);
        alert("Update failed: " + err.message);
    } finally {
        saveBtn.innerText = originalText;
        saveBtn.disabled = false;
    }
};

// 4. STATE: DASHBOARD (HOME)
// Variable to store albums globally for this session to avoid re-fetching
let artistAlbums = [];

async function showArtistDashboard(artistSlug) {
    console.log("üöÄ [DASHBOARD] Loading for:", artistSlug);
    
    // 1. Fetch BOTH Live and Pending at the same time
    const [liveRes, pendingRes] = await Promise.all([
        window.db.from('albums').select('*').eq('artist_id', artistSlug),
        window.db.from('albumrequests').select('*').eq('artist_id', artistSlug)
    ]);

    if (liveRes.error || pendingRes.error) {
        console.error("Fetch Error:", liveRes.error || pendingRes.error);
        return;
    }

    // 2. Merge them into the global artistAlbums array
    // We mark pending items so the UI can style them
    window.artistAlbums = [
        ...(liveRes.data || []).map(a => ({ ...a, isPending: false })),
        ...(pendingRes.data || []).map(r => ({ ...r, isPending: true, status: r.status || 'pending' }))
    ];

    // 3. Keep your window.combinedReleases synced for the debug render
    window.combinedReleases = window.artistAlbums;

    // 4. Render Sidebar and Main Shell
    viewport.innerHTML = `
        <nav id="sidebar">
            <div class="sidebar-title">Menu</div>
            <div class="sidebar-item active" id="nav-home" onclick="switchView('home')">
                <i class="fa-solid fa-house"></i><span>Home</span>
            </div>
            <div class="sidebar-item" id="nav-releases" onclick="switchView('releases')">
                <i class="fa-solid fa-compact-disc"></i><span>Releases</span>
            </div>
                        <div class="sidebar-item" id="nav-analytics" onclick="switchView('analytics')">
                <i class="fa-solid fa-chart-line"></i><span>Analytics</span>
            </div>
                                    <div class="sidebar-item" id="nav-profile" onclick="switchView('profile')">
                <i class="fa-solid fa-chart-line"></i><span>Profile</span>
            </div>
            <div id="login-btn-container"></div>
        </nav>
        <main id="content-view"></main>
    `;

    if (window.updateAuthUI) window.updateAuthUI();
    switchView('home');
}

function renderHomeView() {
    const content = document.getElementById('content-view');
    if (!content) return;

    // Pull from the merged global array
    const data = window.artistAlbums || window.combinedReleases || [];
    
    // Get the ID for the personalized greeting
    const artistId = window.currentArtistProfile?.id || "Artist";

    if (data.length === 0) {
        content.innerHTML = `
            <div style="padding: 60px; text-align: center;">
                <h1 style="font-size: 42px; font-weight: 900; letter-spacing: -1.5px; margin-bottom: 10px; text-transform: capitalize;">
                    Welcome back, ${artistId}
                </h1>
                <p style="color: #666; margin-bottom: 40px;">We're syncing your catalog...</p>
                <div class="loader"></div> 
            </div>
        `;
        // Re-check in 500ms in case data is still fetching
        setTimeout(() => { if(window.artistAlbums?.length > 0) renderHomeView(); }, 500);
        return;
    }

    // Identify latest or upcoming release
    const now = new Date();
    const sorted = [...data].sort((a, b) => {
        const dateA = new Date(a.full_release_date || a.release_date || 0);
        const dateB = new Date(b.full_release_date || b.release_date || 0);
        return dateB - dateA;
    });

    const featured = sorted[0];
    const isUpcoming = new Date(featured.full_release_date) > now || featured.coming_soon;

    content.innerHTML = `
        <h1 style="font-size: 42px; font-weight: 900; letter-spacing: -1.5px; margin-bottom: 5px;">
            Welcome back, ${artistId}
        </h1>
        <p style="color: #666; margin-bottom: 40px;">Dashboard Overview</p>
        
        <div class="release-banner" style="background: linear-gradient(45deg, #050505, #111); border: 1px solid #222; border-radius: 24px; display: flex; padding: 30px; gap: 30px; align-items: center;">
            <img src="${featured.art_url}" style="width: 200px; height: 200px; border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.5);">
            <div class="release-info">
                <span class="badge" style="background: ${isUpcoming ? '#fff' : 'var(--accent-green)'}; color: #000; padding: 4px 12px; border-radius: 20px; font-size: 10px; font-weight: 900;">
                    ${isUpcoming ? 'UPCOMING' : 'LATEST RELEASE'}
                </span>
                <h3 style="font-size: 32px; margin: 15px 0 5px 0; font-weight: 900;">${featured.name}</h3>
                <p style="color: #666; margin: 0;">${featured.full_release_date || featured.release_date}</p>
<div style="margin-top: 25px; display: flex; gap: 15px;">
    <button class="btn-primary" 
            onclick="window.openEditModal('${featured.id}')" 
            style="background: transparent; border: 1px solid #333; color: #fff; cursor: pointer;">
        EDIT PROJECT
    </button>
</div>
            </div>
        </div>
    `;
}

window.isAlbumComingSoon = function(alb) {
    if (!alb) return false;

    // 1. MANUAL OVERRIDE (Boolean Power)
    if (alb.coming_soon === false || alb.coming_soon === "false") return false;

    // 2. FALLBACK IF NO DATE
    if (!alb.full_release_date) return alb.coming_soon;

    try {
        const rawDate = String(alb.full_release_date).trim();
        const nowET = new Date(new Date().toLocaleString("en-US", { timeZone: "America/New_York" }));

        // 3. CHECK IF IT'S JUST A YEAR (e.g., "2026")
        if (/^\d{4}$/.test(rawDate)) {
            const releaseYear = parseInt(rawDate);
            const currentYear = nowET.getFullYear();
            
            // FIX: If it's the current year or future year, keep it as "Coming Soon"
            // It only goes live if the current year is strictly GREATER than the release year
            // Or if you use the Manual Override (Step 1)
            return currentYear <= releaseYear;
        }

        // 4. FULL DATE COMPARISON
        const cleanedDate = rawDate.replace(/(\d+)(st|nd|rd|th)/, "$1");
        const dateObj = new Date(cleanedDate);

        if (!isNaN(dateObj)) {
            return nowET < dateObj;
        }

        return alb.coming_soon;
    } catch (e) {
        console.error("Date check error:", e);
        return alb.coming_soon;
    }
};

async function renderAnalyticsView() {
    const content = document.getElementById('content-view');
    if (!content) return;

    const supabase = window.db; 
    if (!supabase) return;

    const artistId = window.currentArtistProfile?.id;
    
    if (!artistId || !window.artistAlbums || window.artistAlbums.length === 0) {
        content.innerHTML = `<div style="padding: 60px; text-align: center;"><div class="loader" style="margin: 0 auto;"></div></div>`;
        setTimeout(() => renderAnalyticsView(), 1000);
        return;
    }

    try {
        // 1. Fetch fresh Artist metrics (Listeners/Followers) and Tracks in parallel
        const allTrackIds = [...new Set(window.artistAlbums.flatMap(alb => alb.track_ids || []))];
        
        const [tracksRes, artistRes] = await Promise.all([
            supabase.from('tracks').select('*').in('id', allTrackIds).order('listens', { ascending: false }),
            supabase.from('artists').select('listeners, followers').eq('id', artistId).single()
        ]);

        if (tracksRes.error) throw tracksRes.error;
        
        const allTracks = tracksRes.data;
        const metrics = artistRes.data || { listeners: 0, followers: 0 };
        
        window.cachedAnalyticsTracks = allTracks;
        const totalStreams = allTracks?.reduce((acc, curr) => acc + (curr.listens || 0), 0) || 0;

        content.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 40px;">
                <div>
                    <h1 style="font-size: 42px; font-weight: 900; letter-spacing: -1.5px; margin-bottom: 5px;">Analytics</h1>
                    <p style="color: #666; margin: 0;">Real-time performance of your catalog</p>
                </div>
                
                <div style="background: #0a0a0a; border: 1px solid #111; padding: 4px; border-radius: 12px; display: flex; gap: 4px;">
                    <button id="toggle-tracks" onclick="window.switchAnalyticsTab('tracks')" style="background: #7268ff; color: #fff; border: none; padding: 8px 16px; border-radius: 8px; font-size: 11px; font-weight: 900; cursor: pointer; transition: 0.2s;">TRACKS</button>
                    <button id="toggle-albums" onclick="window.switchAnalyticsTab('albums')" style="background: transparent; color: #444; border: none; padding: 8px 16px; border-radius: 8px; font-size: 11px; font-weight: 900; cursor: pointer; transition: 0.2s;">ALBUMS</button>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px;">
                <div style="background: #0a0a0a; border: 1px solid #111; padding: 30px; border-radius: 24px;">
                    <p style="font-size: 10px; font-weight: 900; color: #444; text-transform: uppercase; letter-spacing: 1px;">Monthly Listeners</p>
                    <h2 style="font-size: 36px; margin: 10px 0 0 0; font-weight: 900; color: #fff;">${(metrics.listeners || 0).toLocaleString()}</h2>
                </div>

                <div style="background: #0a0a0a; border: 1px solid #111; padding: 30px; border-radius: 24px;">
                    <p style="font-size: 10px; font-weight: 900; color: #444; text-transform: uppercase; letter-spacing: 1px;">Followers</p>
                    <h2 style="font-size: 36px; margin: 10px 0 0 0; font-weight: 900; color: #fff;">${(metrics.followers || 0).toLocaleString()}</h2>
                </div>

                <div style="background: #0a0a0a; border: 1px solid #111; padding: 30px; border-radius: 24px;">
                    <p style="font-size: 10px; font-weight: 900; color: #444; text-transform: uppercase; letter-spacing: 1px;">Total Plays</p>
                    <h2 style="font-size: 36px; margin: 10px 0 0 0; font-weight: 900; color: #7268ff;">${totalStreams.toLocaleString()}</h2>
                </div>

                <div style="background: #0a0a0a; border: 1px solid #111; padding: 30px; border-radius: 24px;">
                    <p style="font-size: 10px; font-weight: 900; color: #444; text-transform: uppercase; letter-spacing: 1px;">Catalog Size</p>
                    <h2 style="font-size: 36px; margin: 10px 0 0 0; font-weight: 900; color: #fff;">${allTracks?.length || 0}</h2>
                </div>
            </div>

            <div id="analytics-dynamic-content"></div>
        `;

        // Default to track view
        window.switchAnalyticsTab('tracks');

    } catch (err) {
        console.error("Analytics Fetch Error:", err);
    }
}

window.switchAnalyticsTab = function(tab) {
    const trackBtn = document.getElementById('toggle-tracks');
    const albumBtn = document.getElementById('toggle-albums');
    const container = document.getElementById('analytics-dynamic-content');

    if (tab === 'tracks') {
        trackBtn.style.background = '#7268ff'; trackBtn.style.color = '#fff';
        albumBtn.style.background = 'transparent'; albumBtn.style.color = '#444';
        renderTrackAnalyticsList();
    } else {
        albumBtn.style.background = '#7268ff'; albumBtn.style.color = '#fff';
        trackBtn.style.background = 'transparent'; trackBtn.style.color = '#444';
        renderAlbumAnalyticsGrid();
    }
};

function renderTrackAnalyticsList() {
    const container = document.getElementById('analytics-dynamic-content');
    
    // Calculate how many tracks are "Coming Soon" (no URL)
    const comingSoonCount = window.cachedAnalyticsTracks?.filter(t => !t.url || t.url === "").length || 0;

    container.innerHTML = `
        <div style="background: #0a0a0a; border: 1px solid #111; border-radius: 24px; padding: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <div>
                    <h3 id="analytics-title" style="font-size: 18px; font-weight: 900; letter-spacing: -0.5px; margin: 0;">Top Performing Tracks</h3>
                    ${comingSoonCount > 0 ? `
                        <p style="margin: 5px 0 0 0; font-size: 10px; font-weight: 900; color: #444; text-transform: uppercase; letter-spacing: 0.5px;">
                            <span style="color: #7268ff;">${comingSoonCount}</span> Tracks Pending Release
                        </p>
                    ` : ''}
                </div>
                
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="position: relative;">
                        <i class="fa-solid fa-magnifying-glass" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #444; font-size: 10px;"></i>
                        <input type="text" id="analytics-search" placeholder="Search catalog..." 
                            oninput="window.filterAnalytics(this.value)"
                            style="background: #050505; border: 1px solid #111; color: #fff; padding: 8px 12px 8px 30px; border-radius: 12px; font-size: 12px; width: 220px; outline: none; transition: border-color 0.2s;"
                            onfocus="this.style.borderColor='#333'"
                            onblur="this.style.borderColor='#111'">
                    </div>
                </div>
            </div>
            <div id="analytics-list" style="display: flex; flex-direction: column; gap: 12px;"></div>
        </div>
    `;
    
    window.filterAnalytics('');
}

function renderAlbumAnalyticsGrid() {
    const container = document.getElementById('analytics-dynamic-content');
    const modeToggle = document.getElementById('data-mode-container');
    if (!container) return;
    
    // Ensure the data mode toggle is visible in this view
    if (modeToggle) modeToggle.style.display = 'flex';

    const totalCatalogPlays = window.cachedAnalyticsTracks.reduce((acc, curr) => acc + (curr.listens || 0), 0);

    // 1. Map, De-duplicate, and Sort based on current mode
    const processedAlbums = window.artistAlbums.map(alb => {
        let displayPlays = 0;
        
        if (window.currentAnalyticsMode === 'real') {
            displayPlays = alb.listens || 0;
        } else {
            const uniqueIds = [...new Set(alb.track_ids || [])];
            const albumTracks = window.cachedAnalyticsTracks.filter(t => uniqueIds.includes(t.id));
            displayPlays = albumTracks.reduce((acc, curr) => acc + (curr.listens || 0), 0);
        }

        return { ...alb, displayPlays };
    }).sort((a, b) => b.displayPlays - a.displayPlays);

    // 2. Render Grid
    const albumHtml = processedAlbums.map(alb => {
        const share = totalCatalogPlays > 0 ? ((alb.displayPlays / totalCatalogPlays) * 100).toFixed(1) : 0;
        const isSoon = window.isAlbumComingSoon(alb);

        return `
            <div onclick="window.filterByAlbum('${alb.id}')" 
                 style="background: #0a0a0a; border: 1px solid #111; border-radius: 24px; padding: 20px; display: flex; flex-direction: column; gap: 15px; transition: 0.2s; cursor: pointer;"
                 onmouseover="this.style.borderColor='#333'; this.style.transform='translateY(-5px)';" 
                 onmouseout="this.style.borderColor='#111'; this.style.transform='translateY(0)';"
            >
                <div style="position: relative; width: 100%; aspect-ratio: 1/1;">
                    <img src="${alb.art_url}" style="width: 100%; height: 100%; border-radius: 16px; object-fit: cover; filter: ${isSoon ? 'grayscale(0.6)' : 'none'};">
                    ${isSoon ? `
                        <div style="position: absolute; top: 12px; right: 12px; background: #fff; color: #000; font-size: 8px; font-weight: 900; padding: 4px 10px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.5);">
                            COMING SOON
                        </div>
                    ` : ''}
                </div>

                <div>
                    <h4 style="margin: 0; font-size: 15px; font-weight: 900; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${alb.name}</h4>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                        <div>
                            <p style="margin: 0; color: ${window.currentAnalyticsMode === 'real' ? '#fff' : '#7268ff'}; font-weight: 900; font-size: 16px;">${alb.displayPlays.toLocaleString()}</p>
                            <p style="margin: 0; font-size: 8px; color: #444; font-weight: 900; text-transform: uppercase;">${window.currentAnalyticsMode === 'real' ? 'Album Clicks' : 'Listens'}</p>
                        </div>
                        <div style="text-align: right;">
                            <p style="margin: 0; color: #fff; font-weight: 900; font-size: 12px;">${share}%</p>
                            <p style="margin: 0; font-size: 8px; color: #444; font-weight: 900; text-transform: uppercase;">Share</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 25px;">
            ${albumHtml}
        </div>
    `;
}

window.renderFilteredList = function(tracks, isFromAlbum = false) {
    const listContainer = document.getElementById('analytics-list');
    const titleContainer = document.getElementById('analytics-title');
    if (!listContainer) return;

    // 1. HEADER LOGIC (Keep your existing spacing fix)
    if (isFromAlbum && titleContainer) {
        const currentTitle = titleContainer.innerText.replace('SHOW ALL', '').replace('SHOWING:', '').trim();
        titleContainer.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: space-between; width: 100%; gap: 20px;">
                <span style="font-size: 18px; font-weight: 900; letter-spacing: -0.5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    SHOWING: ${currentTitle}
                </span>
                <button onclick="window.resetTrackFilter()" 
                    style="background: #111; color: #fff; border: 1px solid #222; padding: 6px 14px; border-radius: 10px; font-size: 10px; font-weight: 900; cursor: pointer; transition: 0.2s; letter-spacing: 0.5px; flex-shrink: 0;">
                    SHOW ALL
                </button>
            </div>
        `;
    }

    const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);

    // 2. TRACK MAPPING
    listContainer.innerHTML = tracks.map((track, index) => {
        // Find the parent album for this track to check release dates
        const parentAlbum = window.artistAlbums.find(alb => alb.track_ids.includes(track.id));
        
        // Check "Coming Soon" status:
        // Priority 1: Manual track override or missing URL
        // Priority 2: Use your isAlbumComingSoon function on the parent album
        const isSoon = (track.coming_soon === true || !track.url || track.url === "") || 
                       (parentAlbum && window.isAlbumComingSoon(parentAlbum));

        const lastPlayed = track.last_played_at ? new Date(track.last_played_at) : null;
        const isTrending = lastPlayed && lastPlayed > oneDayAgo;

        return `
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px; background: #050505; border-radius: 16px; border: 1px solid #0f0f0f; margin-bottom: 10px; transition: 0.2s; ${isSoon ? 'opacity: 0.6;' : ''}">
            <div style="display: flex; align-items: center; gap: 20px;">
                ${!isFromAlbum ? `<span style="color: #333; font-weight: 900; font-size: 14px; width: 20px;">0${index + 1}</span>` : ''}
                <div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <p style="margin: 0; font-weight: 800; font-size: 14px; color: #fff;">${track.title}</p>
                        ${isSoon ? `
                            <span style="background: #fff; color: #000; font-size: 8px; font-weight: 900; padding: 2px 8px; border-radius: 4px; letter-spacing: 0.5px; text-transform: uppercase;">COMING SOON</span>
                        ` : ''}
                        ${isTrending && !isSoon ? `
                            <span style="background: rgba(114, 104, 255, 0.1); color: #7268ff; font-size: 8px; font-weight: 900; padding: 2px 6px; border-radius: 4px;">
                                <i class="fa-solid fa-fire"></i> TRENDING
                            </span>
                        ` : ''}
                    </div>
                    <p style="margin: 0; font-size: 11px; color: #444;">ID: ${track.id}</p>
                </div>
            </div>
            <div style="text-align: right;">
                <p style="margin: 0; font-weight: 900; color: #7268ff; font-size: 14px;">${(track.listens || 0).toLocaleString()}</p>
                <p style="margin: 0; font-size: 9px; color: #333; font-weight: 900; text-transform: uppercase;">Listens</p>
            </div>
        </div>`;
    }).join('');

    if (tracks.length === 0) {
        listContainer.innerHTML = `<p style="color: #444; text-align: center; padding: 40px;">No tracks found.</p>`;
    }
};

window.resetTrackFilter = function() {
    console.log("Resetting track filters...");
    
    // 1. Clear the search input UI
    const searchInput = document.getElementById('analytics-search');
    if (searchInput) searchInput.value = '';

    // 2. Reset the title to the default
    const titleContainer = document.getElementById('analytics-title');
    if (titleContainer) titleContainer.innerText = 'Top Performing Tracks';

    // 3. Re-run the default filter (shows Top 5)
    if (typeof window.filterAnalytics === 'function') {
        window.filterAnalytics('');
    }
};

// Helper to handle clicking an album card
window.filterByAlbum = function(albumId) {
    const album = window.artistAlbums.find(a => a.id === albumId);
    if (!album) return;

    window.switchAnalyticsTab('tracks');
    
    const trackList = window.cachedAnalyticsTracks.filter(t => album.track_ids.includes(t.id));
    
    const titleContainer = document.getElementById('analytics-title');
    if (titleContainer) titleContainer.innerText = `${album.name}`; // Set clean title first
    
    window.renderFilteredList(trackList, true); 
};

window.filterAnalytics = function(query) {
    const titleContainer = document.getElementById('analytics-title');
    if (!window.cachedAnalyticsTracks) return;

    const isSearching = query.trim().length > 0;
    if (titleContainer) titleContainer.innerText = isSearching ? 'Search Results' : 'Top Performing Tracks';

    const filtered = isSearching 
        ? window.cachedAnalyticsTracks.filter(t => t.title.toLowerCase().includes(query.toLowerCase()))
        : window.cachedAnalyticsTracks.slice(0, 5);

    // Call the helper! Pass 'isSearching' as the second param so numbers hide when searching
    window.renderFilteredList(filtered, isSearching);
};

async function loadArtistData() {
    console.log("üöÄ [DEBUG] Starting loadArtistData...");
    try {
        const artistId = window.currentArtistProfile?.id;
        console.log("üë§ [DEBUG] Current Artist ID:", artistId);

        if (!artistId) {
            console.error("‚ùå [DEBUG] No Artist Profile ID found. Check window.currentArtistProfile");
            return;
        }

        // 1. Get Live Albums
        console.log("üì° [DEBUG] Fetching Live Albums...");
        const { data: liveAlbums, error: liveErr } = await window.db
            .from('albums')
            .select('*')
            .eq('artist_id', artistId);

        if (liveErr) console.error("‚ùå [DEBUG] Live Albums Error:", liveErr);
        console.log("üì¶ [DEBUG] Live Albums Found:", liveAlbums?.length || 0, liveAlbums);

        // 2. Get Pending Requests
        console.log("üì° [DEBUG] Fetching Pending Requests...");
        const { data: pendingRequests, error: pendErr } = await window.db
            .from('albumrequests')
            .select('*')
            .eq('artist_id', artistId);

        if (pendErr) console.error("‚ùå [DEBUG] Pending Requests Error:", pendErr);
        console.log("üì¶ [DEBUG] Pending Requests Found:", pendingRequests?.length || 0, pendingRequests);

        // 3. Combine
        window.combinedReleases = [
            ...(liveAlbums || []).map(a => ({ ...a, isPending: false })),
            ...(pendingRequests || []).map(r => ({ ...r, isPending: r.status === 'pending' }))
        ];

        console.log("üîó [DEBUG] Combined Releases Array:", window.combinedReleases);

        renderReleaseList();

    } catch (err) {
        console.error("üíÄ [DEBUG] Fatal Load Error:", err);
    }
}

// Wrap the whole thing in an async IIFE (Immediately Invoked Function Expression)
(async () => {
    console.log("üïµÔ∏è [DEBUG] Running Schema/RLS Diagnosis...");
    
    try {
        // 1. Check if we can see ANY albums at all (Testing 'Allow public read' policy)
        const { data: allAlbums, error: checkErr } = await window.db
            .from('albums')
            .select('name, artist_id')
            .limit(5);

        if (checkErr) {
            console.error("‚ùå [DEBUG] RLS Blocked 'SELECT' on albums:", checkErr.message);
        } else {
            console.log("üïµÔ∏è [DEBUG] Database Sample (Is RLS open?):", allAlbums);
        }

        // 2. Re-trigger the main load
        await loadArtistData();
        
    } catch (err) {
        console.error("üíÄ [DEBUG] Diagnosis Failed:", err);
    }
})();

function renderReleaseList() {
    const content = document.getElementById('content-view');
    // Ensure we are using the merged data
    const list = window.artistAlbums || [];

    const sorted = [...list].sort((a, b) => {
        const dateA = a.full_release_date || a.release_date || "0";
        const dateB = b.full_release_date || b.release_date || "0";
        return getNumericDateValue(dateB) - getNumericDateValue(dateA);
    });

content.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:40px;">
        <h1 style="font-size: 42px; font-weight: 900; letter-spacing: -1.5px; margin:0;">Releases</h1>
        <button onclick="openCreateReleaseModal()" class="btn-primary" style="font-size:11px;">+ NEW RELEASE</button>
    </div>
    <div style="display:grid; gap:15px;">
        ${sorted.map(album => `
            <div class="release-list-item" style="display:flex; align-items:center; background:#0a0a0a; border:1px solid #111; padding:15px; border-radius:16px; ${album.isPending ? 'opacity:0.6;' : ''}">
                <img src="${album.art_url}" style="width:60px; height:60px; border-radius:8px; object-fit:cover; margin-right:20px; ${album.isPending ? 'filter:grayscale(1);' : ''}">
                <div style="flex:1;">
                    <h4 style="margin:0;">${album.name} ${album.isPending ? '<span style="font-size:8px; background:var(--accent-green); color:#000; padding:2px 6px; border-radius:4px; margin-left:10px;">UNDER REVIEW</span>' : ''}</h4>
                    <p style="font-size:12px; color:#666; margin:4px 0 0 0;">${album.full_release_date || album.release_date}</p>
                </div>
                <div>
                    ${album.isPending ? 
                        '<button class="btn-primary" style="background:transparent; border:1px solid #222; color:#444; cursor:not-allowed;" disabled>LOCKED</button>' : 
                        `<button class="btn-primary" onclick="window.openEditModal('${album.id}')">EDIT</button>`
                    }
                </div>
            </div>
        `).join('')}
    </div>
`;

let trackItems = [];
}

window.openCreateReleaseModal = () => {
    // Clean up if one already exists
    const existing = document.getElementById('create-release-modal');
    if (existing) existing.remove();

    const modal = document.createElement('div');
    modal.id = 'create-release-modal';
    Object.assign(modal.style, {
        position: 'fixed', inset: '0', zIndex: '100000',
        display: 'flex', alignItems: 'center', justifyContent: 'center',
        background: 'rgba(0,0,0,0.9)', backdropFilter: 'blur(20px)', padding: '40px'
    });

    modal.innerHTML = `
        <div class="modal-animate-in" style="background: #080808; border: 1px solid #111; width: 100%; max-width: 900px; max-height: 95vh; border-radius: 32px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 30px 60px rgba(0,0,0,0.5);">
            
            <div style="padding: 30px 40px; border-bottom: 1px solid #111; display:flex; justify-content:space-between; align-items:center; background: #0a0a0a;">
                <div style="flex:1; margin-right: 40px;">
                    <input type="text" id="project-title-input" placeholder="Project Title" 
                           style="background: transparent; border: none; font-size: 28px; font-weight: 900; letter-spacing: -1px; color: white; width: 100%; outline: none; padding: 0;">
                    <p id="item-counter" style="color: #444; font-size: 10px; font-weight: 800; margin-top: 5px; letter-spacing: 1px; text-transform: uppercase;">0 / 30 ITEMS USED</p>
                </div>
                <button onclick="document.getElementById('create-release-modal').remove()" style="background:none; border:none; color:#333; cursor:pointer; transition: 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#333'"><i class="fa-solid fa-circle-xmark fa-2x"></i></button>
            </div>

            <div style="flex: 1; overflow-y: auto; padding: 40px; scrollbar-width: thin; scrollbar-color: #222 transparent;">
                
                <div style="display: grid; grid-template-columns: 200px 1fr; gap: 30px; margin-bottom: 30px;">
                    <div id="drop-zone" onclick="document.getElementById('art-upload').click()" style="width: 200px; height: 200px; background: #000; border: 2px dashed #111; border-radius: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden; transition: 0.3s;">
                        <span id="upload-txt" style="font-size: 9px; color: #333; font-weight: 900; text-align: center; letter-spacing: 1px;">UPLOAD ART</span>
                        <input type="file" id="art-upload" hidden accept="image/*" onchange="previewImage(this)">
                        <img id="art-preview" style="position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; display: none;">
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <textarea id="project-desc-input" placeholder="Add a description for this project..." 
                                  style="width: 100%; height: 100px; background: #000; border: 1px solid #111; padding: 15px; border-radius: 12px; color: white; font-size: 13px; resize: none; outline: none;"></textarea>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="display:flex; flex-direction:column; gap:10px;">
                                <input type="text" id="date-input" placeholder="Release Date" oninput="checkFutureDate(this.value)" 
                                       style="background: #000; border: 1px solid #111; padding: 14px; border-radius: 12px; color: white; font-size: 13px;">
                                
                                <div id="press-release-container" style="display:none; flex-direction:column; gap:10px; background: #050505; padding: 10px; border-radius: 12px; border: 1px solid #111;">
                                    <div style="display:flex; align-items:center; gap:8px;">
                                        <input type="checkbox" id="press-toggle" onchange="window.toggleSignupFields(this.checked)" style="accent-color:var(--accent-green);">
                                        <label for="press-toggle" style="font-size:9px; font-weight:900; color:var(--accent-green); text-transform:uppercase;">Press Release</label>
                                    </div>
                                    <input type="text" id="signup-link-input" placeholder="SIGNUP / PRE-SAVE URL" 
                                           style="display:none; background:#000; border:1px solid #1a1a1a; padding:10px; border-radius:8px; color:white; font-size:11px; width: 75%;">
                                </div>
                            </div>
                            <input type="text" id="genre-input" placeholder="Genre" 
                                   style="background: #000; border: 1px solid #111; padding: 14px; border-radius: 12px; color: white; font-size: 13px; height: fit-content;">
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 30px;">
                    <label style="display: block; font-size: 9px; font-weight: 900; color: #444; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 1px;">Featured Trailer/Video</label>
                    <input type="text" id="trailer-url-input" placeholder="YouTube URL" style="width: 100%; background: #000; border: 1px solid #111; padding: 14px; border-radius: 12px; color: white; font-size: 13px;">
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 16px; font-weight: 900; margin: 0; letter-spacing: -0.5px;">Tracklist Content</h3>
                    <div id="add-buttons-container" style="display: flex; gap: 8px;">
                        <button onclick="addTrackItem('disc')" class="btn-builder-add">+ DISC</button>
                        <button onclick="addTrackItem('video')" class="btn-builder-add">+ VIDEO</button>
                        <button onclick="addTrackItem('track')" class="btn-builder-add" style="background:var(--accent-green); color:#000; border-color:var(--accent-green);">+ TRACK</button>
                    </div>
                </div>

                <div id="track-list-render" style="display: flex; flex-direction: column; gap: 10px;"></div>
            </div>

            <div style="padding: 20px 40px; background: #050505; border-top: 1px solid #111; text-align: right;">
                <button onclick="publishProject()" class="btn-primary" style="padding: 14px 60px; font-weight: 900; border-radius: 12px;">PUBLISH</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    window.trackItems = []; 
    renderTracklist();
};

window.loadProjectForEdit = async (album) => {
    console.log("üöÄ Hydrating with 'Contains' logic for ID:", album.id);
    window.trackItems = [];

    // Use .ilike() with wildcards to find the ID within your comma-separated string
    const [liveTracks, reqTracks, liveVideos, reqVideos] = await Promise.all([
        window.db.from('tracks').select('*').ilike('album_id', `%${album.id}%`),
        window.db.from('requestedtracks').select('*').ilike('album_id', `%${album.id}%`),
        window.db.from('videos').select('*').filter('id', 'in', `(${album.track_ids.join(',')})`),
        window.db.from('requestedvideos').select('*').filter('id', 'in', `(${album.track_ids.join(',')})`)
    ]);

    const allTracks = [...(liveTracks.data || []), ...(reqTracks.data || [])];
    const allVideos = [...(liveVideos.data || []), ...(reqVideos.data || [])];

    console.log("Found matches:", allTracks.length);

    album.track_ids.forEach((id, index) => {
        if (id.startsWith('DISC_')) {
            window.trackItems.push({ type: 'disc', title: id.replace('DISC_', '').replace(/_/g, ' '), id: id });
        } else if (id.startsWith('video_')) {
            const vData = allVideos.find(v => v.id === id);
            window.trackItems.push({
                type: 'video',
                title: vData ? vData.title : 'Unknown Video',
                reviewLink: vData ? (vData.url || vData.review_link) : '',
                id: id
            });
        } else {
            const tData = allTracks.find(t => t.id === id);
            if (tData) {
                window.trackItems.push({
                    type: 'track',
                    title: tData.title,
                    id: tData.id,
                    isBonus: tData.bonus_track,
                    needsReview: false
                });
            } else {
                console.error(`‚ùå Still missing: ${id}`);
                // Placeholder to keep your 31-item count correct
                window.trackItems.push({ type: 'track', title: `Missing: ${id}`, id: id });
            }
        }
    });

    if (typeof renderTracklist === 'function') renderTracklist();
};

window.openEditModal = async (input) => {
    let albumData = null;

    // Fetch data if needed
    if (typeof input === 'string') {
        const { data } = await window.db.from('albums').select('*').eq('id', input).single();
        albumData = data || (await window.db.from('albumrequests').select('*').eq('id', input).single()).data;
    } else {
        albumData = input;
    }

    if (!albumData) return;

    // 1. Open the UI first
    window.openCreateReleaseModal();
    
    // 2. Delay slightly to let openCreateReleaseModal finish its internal window.trackItems = [] reset
    setTimeout(async () => {
        const modal = document.getElementById('create-release-modal');
        if (!modal) return;

        // 3. NOW load the tracks into memory
        await window.loadProjectForEdit(albumData);

        // 4. Fill standard Metadata
        document.getElementById('project-title-input').value = albumData.name || "";
        document.getElementById('genre-input').value = albumData.genre || "";
        document.getElementById('date-input').value = albumData.full_release_date || "";
        document.getElementById('project-desc-input').value = albumData.description || "";
        document.getElementById('trailer-url-input').value = albumData.trailer_url || "";

        // UI Adjustments
        const addButtons = document.getElementById('add-buttons-container');
        if (addButtons) addButtons.style.display = 'none';

        const publishBtn = modal.querySelector('.btn-primary');
        if (publishBtn) {
            publishBtn.innerText = "UPDATE PROJECT";
            publishBtn.onclick = () => window.updateProject(albumData.id, true);
        }

        // Image Handling
        if (albumData.art_url) {
            window.lastUploadedArtUrl = albumData.art_url;
            const preview = document.getElementById('art-preview');
            if (preview) {
                preview.src = albumData.art_url;
                preview.style.display = 'block';
                document.getElementById('upload-txt').style.display = 'none';
            }
        }

        // 5. UPDATE THE UI COUNT (Final step after hydration)
        const renderArea = document.getElementById('track-list-render');
        if (renderArea) {
            const count = window.trackItems.length; // Get the total count of tracks/videos/discs
            renderArea.innerHTML = `
                <div style="background:rgba(255,255,255,0.02); padding:30px; border-radius:15px; border:1px dashed #222; text-align:center;">
                    <p style="color:var(--accent-green); font-size:11px; font-weight:900; letter-spacing:1px; margin:0;">
                        TRACKLIST LOCKED FOR METADATA UPDATE
                    </p>
                    <p style="color:#555; font-size:10px; margin-top:5px;">
                        ${count} Tracks & Elements Hydrated
                    </p>
                </div>`;
        }
    }, 300); // Increased delay slightly to ensure modal initialization is 100% done
};

window.toggleTrackReview = (trackId) => {
    const track = window.trackItems.find(t => t.id === trackId);
    if (track) {
        track.needsReview = !track.needsReview;
        // If they toggle it off, clear the link
        if (!track.needsReview) track.reviewLink = "";
        window.renderTracklist(); // Refresh the list to show/hide the input
    }
};

window.updateTrackLink = (trackId, value) => {
    const track = window.trackItems.find(t => t.id === trackId);
    if (track) track.reviewLink = value;
};

window.updateProject = async (releaseId, isPending) => {
    try {
        const trackCount = window.trackItems.filter(i => i.type === 'track').length;
        
        // Safety check: Don't allow update if trackItems failed to hydrate
        if (window.trackItems.length === 0) {
            throw new Error("Track data is missing. Please close and try again.");
        }

        let projectType = trackCount <= 2 ? "Single" : trackCount <= 6 ? "EP" : "Album";

        const masterTrackIds = window.trackItems.map(item => {
            if (item.type === 'disc') return `DISC_${item.title.toUpperCase().replace(/\s+/g, '_')}`;
            if (item.type === 'video') return `video_${item.title.toLowerCase().replace(/\s+/g, '-')}`;
            return item.id;
        });

        const { error: albumErr } = await window.db.from('albumrequests').upsert({
            id: releaseId,
            artist_id: window.currentArtistProfile.id,
            name: document.getElementById('project-title-input').value,
            genre: document.getElementById('genre-input').value,
            full_release_date: document.getElementById('date-input').value,
            description: document.getElementById('project-desc-input').value, // SAVES DESC
            trailer_url: document.getElementById('trailer-url-input').value,
            art_url: window.lastUploadedArtUrl,
            track_ids: masterTrackIds, // SENDS LOADED TRACKS
            type: projectType,
            status: 'pending'
        });

        if (albumErr) throw albumErr;

        alert("Project submitted for review!");
        location.reload();
    } catch (err) {
        console.error(err);
        alert("Error: " + err.message);
    }
};

// Clean strings for IDs: lowercase, spaces to "-", remove parentheses
const createSlug = (text) => {
    return text.toLowerCase()
        .replace(/\s+/g, '-')           // Spaces to -
        .replace(/[()]/g, '')           // Remove parentheses
        .replace(/[^a-z0-0-]/g, '');    // Remove other special chars
};

// Calculate project type based on track count (excluding discs/videos)
const calculateReleaseType = (items) => {
    const trackCount = items.filter(i => i.type === 'track').length;
    if (trackCount <= 2) return "Single";
    if (trackCount <= 6) return "EP";
    if (trackCount <= 10) return "Mixtape";
    return "Album";
};

// Get Audio Duration
const getDuration = (file) => {
    return new Promise((resolve) => {
        const audio = new Audio();
        audio.src = URL.createObjectURL(file);
        audio.onloadedmetadata = () => resolve(Math.floor(audio.duration).toString());
    });
};

// 1. GLOBAL DATE NORMALIZER (Needed for Sorting & Future Date Detection)
window.getNumericDateValue = (dateStr) => {
    if (!dateStr) return 0;

    const months = {
        jan: 0, feb: 1, mar: 2, apr: 3, may: 4, jun: 5,
        jul: 6, aug: 7, sep: 8, oct: 9, nov: 10, dec: 11
    };

    // Clean the string: lowercase and remove "st, nd, rd, th"
    const clean = dateStr.toLowerCase().replace(/(st|nd|rd|th)/g, "");
    const parts = clean.split(/[\s,]+/); 

    let year = 0, month = 0, day = 1;

    if (parts.length === 1 && /^\d{4}$/.test(parts[0])) {
        year = parseInt(parts[0]);
    } else {
        parts.forEach(p => {
            if (/^\d{4}$/.test(p)) year = parseInt(p);
            else if (months[p.substring(0, 3)] !== undefined) month = months[p.substring(0, 3)];
            else if (/^\d{1,2}$/.test(p)) day = parseInt(p);
        });
    }

    return new Date(year, month, day).getTime();
};

// 2. FUTURE DATE CHECKER
window.toggleSignupFields = (isChecked) => {
    const signupInput = document.getElementById('signup-link-input');
    if (signupInput) signupInput.style.display = isChecked ? 'block' : 'none';
};

// Also update your date checker to make sure the container shows up
window.checkFutureDate = (val) => {
    const container = document.getElementById('press-release-container');
    if (!container) return;
    
    const inputDate = getNumericDateValue(val);
    const today = new Date().getTime();
    
    // Show the press option only if the date is in the future
    container.style.display = (inputDate > today) ? 'flex' : 'none';
};

window.togglePressFields = (checked) => {
    const signupContainer = document.getElementById('signup-link-area');
    if (signupContainer) {
        signupContainer.style.display = checked ? 'block' : 'none';
    }
};

window.previewImage = async (input) => {
    const preview = document.getElementById('art-preview');
    const uploadTxt = document.getElementById('upload-txt');
    
    if (input.files && input.files[0]) {
        // 1. Show the local preview immediately (Current logic)
        const reader = new FileReader();
        reader.onload = (e) => {
            preview.src = e.target.result;
            preview.style.display = 'block';
            if (uploadTxt) uploadTxt.style.display = 'none';
        };
        reader.readAsDataURL(input.files[0]);

        // 2. Start the background upload to ImgBB
        // Show a "Uploading..." state if you have a label for it
        if (uploadTxt) {
            uploadTxt.innerText = "UPLOADING TO SERVER...";
            uploadTxt.style.display = 'block';
        }

        const uploadedUrl = await window.uploadToImgBB(input.files[0]);
        
        if (uploadedUrl && uploadTxt) {
            uploadTxt.style.display = 'none'; // Hide it once we have the link
        }
    }
};

window.addTrackItem = (type) => {
    if (trackItems.length >= 30) return;
    trackItems.push({ type: type, title: '', isBonus: false });
    renderTracklist();
};

window.removeTrackItem = (index) => {
    trackItems.splice(index, 1);
    renderTracklist();
};

window.toggleBonus = (index) => {
    trackItems[index].isBonus = !trackItems[index].isBonus;
    renderTracklist();
};

window.moveItem = (index, direction) => {
    const newIndex = index + direction;
    if (newIndex < 0 || newIndex >= trackItems.length) return; // Boundary check
    
    // Swap the items in the array
    const temp = trackItems[index];
    trackItems[index] = trackItems[newIndex];
    trackItems[newIndex] = temp;
    
    renderTracklist();
};

window.handleAudioPreview = (input, index) => {
    if (input.files && input.files[0]) {
        // Save the actual file object to our global array
        trackItems[index].audioFile = input.files[0];
        // Re-render to show the file name and the audio player
        renderTracklist();
    }
};

window.handleAudioSelect = (input, index) => {
    if (input.files && input.files[0]) {
        // Store the file object in our global array
        trackItems[index].audioFile = input.files[0];
        // Re-render the list to show the player and the "‚úì" status
        renderTracklist();
    }
};

function renderTracklist() {
    const list = document.getElementById('track-list-render');
    const counter = document.getElementById('item-counter');
    const btnContainer = document.getElementById('add-buttons-container');
    
    // Safety check to prevent the "null" error
    if (!list) return;

    list.innerHTML = '';
    let trackNum = 1;

    trackItems.forEach((item, index) => {
        const row = document.createElement('div');
        row.className = "track-row";
        row.style = `display: flex; gap: 15px; align-items: center; padding: 12px 20px; border-radius: 16px; border: 1px solid #111; background: ${item.type === 'track' ? '#0a0a0a' : '#111'}; margin-bottom: 10px;`;
        
        let contentHTML = '';
        let iconHTML = '';

if (item.type === 'track') {
    // Check if the primary button says "UPDATE" to determine if we are editing
    const actionBtn = document.querySelector('.modal-footer .btn-primary') || document.getElementById('publish-btn');
    const isEditing = actionBtn && actionBtn.innerText.includes("UPDATE");

    iconHTML = `<span style="color:#444; font-weight:900; width:20px; text-align:center;">${trackNum++}</span>`;
    
    contentHTML = `
        <div style="flex:1; display:flex; flex-direction:column; gap:8px;">
            <input type="text" placeholder="TRACK NAME" value="${item.title || ''}" 
                   oninput="trackItems[${index}].title = this.value" 
                   style="width:100%; background:transparent; border:none; color:white; font-size:14px; outline:none; font-weight:bold;">
            
            <div style="display:flex; align-items:center; gap:10px;">
                ${isEditing ? `
                    <label class="switch-sm" style="display:flex; align-items:center; gap:5px; cursor:pointer;">
                        <input type="checkbox" ${item.needsReview ? 'checked' : ''} 
                               onchange="trackItems[${index}].needsReview = this.checked; renderTracklist();"
                               style="width:12px; height:12px; accent-color:var(--accent-green);">
                        <span style="font-size:9px; color:#444; font-weight:900; text-transform:uppercase;">Edit Metadata</span>
                    </label>
                    <input type="text" placeholder="PASTE REVIEW LINK (YT/SC)" 
                           value="${item.reviewLink || ''}" 
                           oninput="trackItems[${index}].reviewLink = this.value" 
                           style="flex:1; background:rgba(0,255,136,0.05); border:1px solid rgba(114, 104, 255, 0.1); color:var(--accent-green); font-size:10px; padding:5px 10px; border-radius:4px; outline:none; display: ${item.needsReview ? 'block' : 'none'};">
                ` : `
                    <button onclick="document.getElementById('audio-input-${index}').click()" style="background:#111; border:1px solid #222; color:var(--accent-green); font-size:9px; font-weight:900; cursor:pointer; padding:5px 10px; border-radius:4px; text-transform:uppercase;">
                        ${item.audioFile ? '‚úì Change Audio' : '+ Local Preview'}
                    </button>
                    <input type="file" id="audio-input-${index}" hidden accept="audio/*" onchange="handleAudioSelect(this, ${index})">
                    
                    <input type="text" placeholder="PASTE REVIEW LINK (YT/SC)" value="${item.reviewLink || ''}" 
                           oninput="trackItems[${index}].reviewLink = this.value" 
                           style="flex:1; background:rgba(114, 104, 255, 0.05); border:1px solid rgba(114, 104, 255, 0.1); color:var(--accent-green); font-size:10px; padding:5px 10px; border-radius:4px; outline:none;">
                `}
            </div>
            
            ${item.audioFile ? `
                <audio controls src="${URL.createObjectURL(item.audioFile)}" style="height:20px; width:100%; filter:invert(1) grayscale(1); opacity:0.5; margin-top:5px;"></audio>
            ` : ''}
        </div>
    `;
        } else if (item.type === 'video') {
    iconHTML = `<i class="fa-solid fa-video" style="color:#444; width:20px; text-align:center;"></i>`;
    contentHTML = `
        <div style="flex:1; display:flex; flex-direction:column; gap:5px;">
            <input type="text" placeholder="VIDEO NAME" value="${item.title || ''}" 
                   oninput="trackItems[${index}].title = this.value" 
                   style="background:transparent; border:none; color:white; font-size:14px; outline:none; width:100%; font-weight:bold;">
            <input type="text" placeholder="PASTE VIDEO URL (YT/VIMEO)" value="${item.reviewLink || ''}" 
                   oninput="trackItems[${index}].reviewLink = this.value" 
                   style="width:100%; background:rgba(255,255,255,0.03); border:1px solid #222; color:#888; font-size:10px; padding:4px 8px; border-radius:4px; outline:none;">
        </div>`;
} else {
            iconHTML = `<i class="fa-solid fa-compact-disc" style="color:var(--accent-green); width:20px; text-align:center;"></i>`;
            contentHTML = `<div style="flex:1;"><input type="text" placeholder="DISC NAME" value="${item.title || ''}" oninput="trackItems[${index}].title = this.value" style="width:100%; background:transparent; border:none; color:white; font-size:14px; font-weight:900; outline:none;"></div>`;
        }

        row.innerHTML = `
            <div style="display: flex; flex-direction: column; gap: 2px;">
                <button onclick="moveItem(${index}, -1)" style="background:none; border:none; color:#222; cursor:pointer; font-size:10px;"><i class="fa-solid fa-chevron-up"></i></button>
                <button onclick="moveItem(${index}, 1)" style="background:none; border:none; color:#222; cursor:pointer; font-size:10px;"><i class="fa-solid fa-chevron-down"></i></button>
            </div>
            ${iconHTML}
            ${contentHTML}
            <button onclick="removeTrackItem(${index})" style="background:none; border:none; color:#333; cursor:pointer; margin-left: auto;"><i class="fa-solid fa-trash-can"></i></button>
        `;
        list.appendChild(row);
    });

    // Update Counter
    if (counter) {
        counter.innerText = `${trackItems.length} / 30 ITEMS USED`;
        const isFull = trackItems.length >= 30;
        counter.style.color = isFull ? 'var(--accent-green)' : '#444';
        if (btnContainer) {
            btnContainer.style.opacity = isFull ? '0.2' : '1';
            btnContainer.style.pointerEvents = isFull ? 'none' : 'auto';
        }
    }
}

window.generateSlug = (text) => {
    return text.toString().toLowerCase()
        .replace(/\s+/g, '-')           // Replace spaces with -
        .replace(/[()]/g, '')           // Remove parentheses
        .replace(/[^\w-]+/g, '')        // Remove all non-word chars
        .replace(/--+/g, '-')           // Replace multiple - with single -
        .replace(/^-+/, '')             // Trim - from start
        .replace(/-+$/, '');            // Trim - from end
};

window.publishProject = async () => {
    const publishBtn = document.querySelector('.btn-primary');
    const title = document.getElementById('project-title-input')?.value;
    const genre = document.getElementById('genre-input')?.value;
    const dateValue = document.getElementById('date-input')?.value;
    const artUrl = window.lastUploadedArtUrl || ""; 

    if (!title || !genre) return alert("Please enter a Title and Genre.");
    if (!artUrl) return alert("Please upload cover art before publishing.");

    try {
        publishBtn.disabled = true;
        publishBtn.innerText = "SUBMITTING...";

        const albumSlug = window.generateSlug(title);
        const artistId = window.currentArtistProfile?.id;

        if (!artistId || artistId === "anonymous") {
             alert("Error: Artist profile not detected. Please refresh.");
             return;
        }

        // --- NEW MULTI-TYPE LOGIC ---
        const masterTrackIds = [];
        const trackSubmissions = [];
        const videoSubmissions = [];

        window.trackItems.forEach((item) => {
            if (item.type === 'disc') {
                // For Discs, we only store the string in the master array
                const discString = `DISC_${item.title.toUpperCase().replace(/\s+/g, '_')}`;
                masterTrackIds.push(discString);
            } 
            else if (item.type === 'video') {
                // For Videos, generate ID and prepare for requestedvideos table
                const videoId = `video_${window.generateSlug(item.title)}`;
                masterTrackIds.push(videoId);
                videoSubmissions.push({
                    id: videoId,
                    title: item.title,
                    url: item.reviewLink || "" // reviewLink used as URL for videos
                });
            } 
            else {
                // For Tracks, generate ID and prepare for requestedtracks table
                const trackSlug = `${albumSlug}-${window.generateSlug(item.title)}`;
                masterTrackIds.push(trackSlug);
                trackSubmissions.push({
                    id: trackSlug,
                    album_id: albumSlug,
                    title: item.title,
                    bonus_track: item.isBonus || false,
                    review_link: item.reviewLink || ""
                });
            }
        });

        // --- CLASSIFICATION (Based only on actual tracks) ---
        const actualTrackCount = trackSubmissions.length;
        let projectType = "Album";
        if (actualTrackCount >= 1 && actualTrackCount <= 2) projectType = "Single";
        else if (actualTrackCount >= 3 && actualTrackCount <= 6) projectType = "EP";
        else if (actualTrackCount >= 7 && actualTrackCount <= 10) projectType = "Mixtape";

        // 1. Insert Album Request
        const { error: albumError } = await window.db.from('albumrequests').insert([{
            id: albumSlug,
            name: title,
            genre: genre,
            full_release_date: dateValue,
            artist_id: artistId,
            art_url: artUrl,
            track_ids: masterTrackIds, // Combined IDs (Tracks, video_ID, DISC_TITLE)
            type: projectType
        }]);
        if (albumError) throw albumError;

        // 2. Insert Individual Tracks (if any)
        if (trackSubmissions.length > 0) {
            const { error: tracksError } = await window.db.from('requestedtracks').insert(trackSubmissions);
            if (tracksError) throw tracksError;
        }

        // 3. Insert Video Requests (if any)
        if (videoSubmissions.length > 0) {
            const { error: videosError } = await window.db.from('requestedvideos').insert(videoSubmissions);
            if (videosError) throw videosError;
        }

        alert(`Release Published Successfully as a ${projectType}!`);
        location.reload();

    } catch (err) {
        console.error("Submission error:", err);
        alert(`Error: ${err.message}`);
    } finally {
        publishBtn.disabled = false;
        publishBtn.innerText = "PUBLISH";
    }
};

// 5. MODAL: APPLY FOR ARTIST
window.openApplyModal = (name, slug) => {
    const modal = document.createElement('div');
    modal.id = 'apply-modal-root';
    Object.assign(modal.style, {
        position:'fixed', inset:'0', zIndex:'99999', display:'flex', 
        alignItems:'center', justifyContent:'center', background:'rgba(0,0,0,0.9)', backdropFilter:'blur(10px)'
    });

    modal.innerHTML = `
        <div class="modal-animate-in" style="background:#0d0d0d; border:1px solid #222; width:90%; max-width:450px; padding:40px; border-radius:24px;">
            <h2 style="font-weight:900; margin-bottom:5px;">Claim ${name}</h2>
            <p style="color:#666; font-size:14px; margin-bottom:25px;">Provide details to verify ownership.</p>
            <div style="display:flex; flex-direction:column; gap:15px;">
                <input type="text" id="req-name" placeholder="Full Name" style="background:#111; border:1px solid #222; padding:15px; border-radius:10px; color:white;">
                <input type="date" id="req-dob" style="background:#111; border:1px solid #222; padding:15px; border-radius:10px; color:white;">
                <textarea id="req-proof" placeholder="Links to socials / Proof of identity" style="background:#111; border:1px solid #222; padding:15px; border-radius:10px; color:white; min-height:80px;"></textarea>
                <button onclick="submitRequest('${slug}')" class="btn-primary" style="margin-top:10px;">SUBMIT APPLICATION</button>
                <button onclick="document.getElementById('apply-modal-root').remove()" style="background:none; border:none; color:#444; cursor:pointer;">Cancel</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
};

window.submitRequest = async (slug) => {
const { data: { session } } = await client.auth.getSession();
    
    // DEBUG: Make sure this ID actually exists
    console.log("Submitting for User ID:", session?.user?.id);

    const payload = {
        user_id: session.user.id, // This MUST match the policy auth.uid()
        artist_slug: slug,
        full_name: document.getElementById('req-name').value,
        dob: document.getElementById('req-dob').value,
        proof_details: document.getElementById('req-proof').value,
        status: 'pending'
    };

    const { error } = await client.from('requests').insert([payload]);
    if (!error) {
        alert("Application sent successfully!");
        document.getElementById('apply-modal-root').remove();
    } else {
        alert("Error: " + error.message);
    }
};

// HELPERS
function debounce(func, timeout) {
    let timer;
    return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => { func.apply(this, args); }, timeout);
    };
}

init();
</script>
</body>
</html>