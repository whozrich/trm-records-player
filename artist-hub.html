<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRM ARTIST HUB</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        :root {
            --accent-green: #00ff88;
            --sidebar-width: 280px;
        }

        body { 
            margin: 0; 
            background: #000; 
            color: #fff; 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; 
            height: 100vh;
        }

        #dashboard-wrapper {
            display: flex; 
            flex-direction: column;
            height: 100vh;
        }

        .main-viewport {
            display: flex; 
            flex: 1; 
            overflow: hidden; 
        }

        /* SIDEBAR */
        #sidebar {
            width: var(--sidebar-width);
            background: #000;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #111;
            padding: 20px 0;
        }

        .sidebar-title {
            padding: 0 25px 20px 25px;
            font-size: 10px;
            font-weight: 900;
            color: #444;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 25px; 
            cursor: pointer; 
            transition: 0.2s; 
            color: #fff; 
            font-weight: 700;
            text-decoration: none;
            background: rgba(0, 255, 136, 0.05);
            border-right: 3px solid var(--accent-green);
        }

        /* Builder Specific Buttons */
.btn-builder-add {
    background: #fff; 
    color: #000; 
    border: none; 
    padding: 8px 15px; 
    border-radius: 8px; 
    font-size: 10px; 
    font-weight: 900; 
    cursor: pointer;
    transition: 0.2s;
    text-transform: uppercase;
}
.btn-builder-add:hover { opacity: 0.8; }

/* The Track Row Bonus Tag */
.bonus-tag {
    font-size: 9px;
    font-weight: 900;
    padding: 6px 12px;
    border-radius: 8px;
    border: 1px solid #222;
    color: #444;
    cursor: pointer;
    transition: 0.2s;
    background: #151515;
}
.bonus-tag.active {
    background: rgba(0, 255, 136, 0.1);
    border-color: var(--accent-green);
    color: var(--accent-green);
}

        #login-btn-container {
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid #111;
        }

        /* MAIN CONTENT */
        #content-view {
            flex: 1;
            overflow-y: auto;
            background: linear-gradient(to bottom, #121212, #000);
            padding: 60px;
        }

        .release-banner {
            background: #0a0a0a;
            border: 1px solid #222;
            border-radius: 24px;
            padding: 40px;
            display: flex;
            gap: 40px;
            align-items: center;
            max-width: 900px;
        }

        .release-art {
            width: 200px;
            height: 200px;
            background: #111;
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        .badge {
            background: var(--accent-green);
            color: #000;
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 10px;
            font-weight: 900;
            letter-spacing: 1px;
            margin-bottom: 15px;
            display: inline-block;
        }

        .btn-primary {
            background: var(--accent-green);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 900;
            cursor: pointer;
            transition: 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 12px;
        }

        .btn-primary:hover {
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
        }

        .search-result-item {
            background: #111;
            border: 1px solid #222;
            padding: 15px 20px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        /* MODAL ANIMATION */
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-animate-in { animation: modalIn 0.2s ease-out forwards; }
    </style>
</head>
<body>

<div id="dashboard-wrapper">
    <div class="main-viewport" id="viewport-container">
        </div>

    <div id="mini-player" style="height: 100px; background: #050505; border-top: 1px solid #111; display: flex; align-items: center; padding: 0 25px;">
        <div style="color: #444; font-size: 11px; font-weight: 900; letter-spacing: 1px;">STUDIO MONITOR OFF</div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.1500.0.min.js"></script>

<script>
// SUPABASE CONFIG
const SB_URL = 'https://sxagulxljpzftqfnllhv.supabase.co';
const SB_KEY = 'sb_publishable_GG1VzWph8ZCK2hCyZugMfA_qR6LZcRn';
window.db = window.supabase.createClient(SB_URL, SB_KEY);

let client;
const viewport = document.getElementById('viewport-container');

async function init() {
    client = supabase.createClient(SB_URL, SB_KEY);
    window.supabaseClient = client;
    window.db = client; 

    const { data: { session } } = await client.auth.getSession();

    if (!session) {
        renderLoginState();
        return;
    }

    const { data: profile } = await client
        .from('users')
        .select('userArtistId')
        .eq('id', session.user.id)
        .single();

    if (profile?.userArtistId?.trim()) {
        window.currentArtistProfile = { id: profile.userArtistId };
        
        // 1. Build the UI shell first
        await showArtistDashboard(profile.userArtistId); 
        
        // 2. Fetch all data (Live + Pending) into the global state
        await loadArtistData(); 
        
        // 3. Explicitly ensure we start on the Home view
        switchView('home'); 
    } else {
        showArtistSearchUI();
    }
}

// 2. STATE: LOGIN REQUIRED
function renderLoginState() {
    viewport.innerHTML = `
        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; width:100%; gap:20px;">
            <i class="fa-solid fa-lock fa-3x" style="color:#222;"></i>
            <h1 style="font-weight:900;">Please Login</h1>
            <p style="color:#666;">Access the Artist Hub by logging into your account.</p>
            <button onclick="window.openAuthModal('login')" class="btn-primary">LOGIN TO ACCOUNT</button>
        </div>
    `;
}

// 3. STATE: SEARCH/CLAIM ARTIST
function showArtistSearchUI() {
    viewport.innerHTML = `
        <div style="flex:1; padding:60px; max-width:800px; margin:0 auto; overflow-y:auto;">
            <h1 style="font-weight:900; font-size:42px; letter-spacing:-1.5px;">Claim Your Artist Profile</h1>
            <p style="color:#666; margin-bottom:40px;">Search for your artist name to get started.</p>
            
            <input type="text" id="artist-search" placeholder="Type artist name..." 
                style="width:100%; background:#111; border:1px solid #222; padding:18px; border-radius:12px; color:white; font-size:16px; outline:none; margin-bottom:20px;">

            <div id="search-results"></div>

            <div style="border-top:1px solid #111; padding-top:30px; margin-top:20px;">
                <p style="color:#444; font-weight:700;">DON'T SEE YOURSELF?</p>
                <button class="btn-primary" style="background:transparent; border:1px solid #222; color:white;">CREATE NEW ARTIST ENTITY</button>
            </div>
        </div>
    `;

    document.getElementById('artist-search').addEventListener('input', debounce(handleArtistSearch, 400));
}

async function handleArtistSearch(e) {
    const query = e.target.value;
    const resultsContainer = document.getElementById('search-results');
    if (query.length < 2) { resultsContainer.innerHTML = ''; return; }

    const { data: artists } = await client
        .from('artists')
        .select('id, name')
        .ilike('name', `%${query}%`)
        .limit(5);

    if (artists && artists.length > 0) {
        resultsContainer.innerHTML = artists.map(a => `
            <div class="search-result-item">
                <span style="font-weight:700;">${a.name}</span>
                <button class="btn-primary" style="padding:8px 16px;" onclick="openApplyModal('${a.name}', '${a.id}')">APPLY</button>
            </div>
        `).join('');
    } else {
        resultsContainer.innerHTML = `<p style="color:#444;">No results found.</p>`;
    }
}

// 3. View Switcher Logic
function switchView(view) {
    const content = document.getElementById('content-view');
    const navHome = document.getElementById('nav-home');
    const navReleases = document.getElementById('nav-releases');

    // Reset Sidebar Styles
    [navHome, navReleases].forEach(el => {
        el.style.background = 'transparent';
        el.style.borderRight = 'none';
        el.style.color = '#888';
    });

    if (view === 'home') {
        navHome.style.background = 'rgba(0, 255, 136, 0.05)';
        navHome.style.borderRight = '3px solid var(--accent-green)';
        navHome.style.color = '#fff';
        renderHomeView();
    } else {
        navReleases.style.background = 'rgba(0, 255, 136, 0.05)';
        navReleases.style.borderRight = '3px solid var(--accent-green)';
        navReleases.style.color = '#fff';
        renderReleaseList();
    }
}

// 4. STATE: DASHBOARD (HOME)
// Variable to store albums globally for this session to avoid re-fetching
let artistAlbums = [];

async function showArtistDashboard(artistSlug) {
    console.log("ðŸš€ [DASHBOARD] Loading for:", artistSlug);
    
    // 1. Fetch BOTH Live and Pending at the same time
    const [liveRes, pendingRes] = await Promise.all([
        window.db.from('albums').select('*').eq('artist_id', artistSlug),
        window.db.from('albumrequests').select('*').eq('artist_id', artistSlug)
    ]);

    if (liveRes.error || pendingRes.error) {
        console.error("Fetch Error:", liveRes.error || pendingRes.error);
        return;
    }

    // 2. Merge them into the global artistAlbums array
    // We mark pending items so the UI can style them
    window.artistAlbums = [
        ...(liveRes.data || []).map(a => ({ ...a, isPending: false })),
        ...(pendingRes.data || []).map(r => ({ ...r, isPending: true, status: r.status || 'pending' }))
    ];

    // 3. Keep your window.combinedReleases synced for the debug render
    window.combinedReleases = window.artistAlbums;

    // 4. Render Sidebar and Main Shell
    viewport.innerHTML = `
        <nav id="sidebar">
            <div class="sidebar-title">Menu</div>
            <div class="sidebar-item active" id="nav-home" onclick="switchView('home')">
                <i class="fa-solid fa-house"></i><span>Home</span>
            </div>
            <div class="sidebar-item" id="nav-releases" onclick="switchView('releases')">
                <i class="fa-solid fa-compact-disc"></i><span>Releases</span>
            </div>
            <div id="login-btn-container"></div>
        </nav>
        <main id="content-view"></main>
    `;

    if (window.updateAuthUI) window.updateAuthUI();
    switchView('home');
}

function renderHomeView() {
    const content = document.getElementById('content-view');
    if (!content) return;

    // Pull from the merged global array
    const data = window.artistAlbums || window.combinedReleases || [];
    
    // Get the ID for the personalized greeting
    const artistId = window.currentArtistProfile?.id || "Artist";

    if (data.length === 0) {
        content.innerHTML = `
            <div style="padding: 60px; text-align: center;">
                <h1 style="font-size: 42px; font-weight: 900; letter-spacing: -1.5px; margin-bottom: 10px; text-transform: capitalize;">
                    Welcome back, ${artistId}
                </h1>
                <p style="color: #666; margin-bottom: 40px;">We're syncing your catalog...</p>
                <div class="loader"></div> 
            </div>
        `;
        // Re-check in 500ms in case data is still fetching
        setTimeout(() => { if(window.artistAlbums?.length > 0) renderHomeView(); }, 500);
        return;
    }

    // Identify latest or upcoming release
    const now = new Date();
    const sorted = [...data].sort((a, b) => {
        const dateA = new Date(a.full_release_date || a.release_date || 0);
        const dateB = new Date(b.full_release_date || b.release_date || 0);
        return dateB - dateA;
    });

    const featured = sorted[0];
    const isUpcoming = new Date(featured.full_release_date) > now || featured.coming_soon;

    content.innerHTML = `
        <h1 style="font-size: 42px; font-weight: 900; letter-spacing: -1.5px; margin-bottom: 5px; text-transform: capitalize;">
            Welcome back, ${artistId}
        </h1>
        <p style="color: #666; margin-bottom: 40px;">Dashboard Overview</p>
        
        <div class="release-banner" style="background: linear-gradient(45deg, #050505, #111); border: 1px solid #222; border-radius: 24px; display: flex; padding: 30px; gap: 30px; align-items: center;">
            <img src="${featured.art_url}" style="width: 200px; height: 200px; border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.5);">
            <div class="release-info">
                <span class="badge" style="background: ${isUpcoming ? '#fff' : 'var(--accent-green)'}; color: #000; padding: 4px 12px; border-radius: 20px; font-size: 10px; font-weight: 900;">
                    ${isUpcoming ? 'UPCOMING' : 'LATEST RELEASE'}
                </span>
                <h3 style="font-size: 32px; margin: 15px 0 5px 0; font-weight: 900;">${featured.name}</h3>
                <p style="color: #666; margin: 0;">${featured.full_release_date || featured.release_date}</p>
<div style="margin-top: 25px; display: flex; gap: 15px;">
    <button class="btn-primary" 
            onclick="window.openEditModal('${featured.id}')" 
            style="background: transparent; border: 1px solid #333; color: #fff; cursor: pointer;">
        EDIT PROJECT
    </button>
</div>
            </div>
        </div>
    `;
}

async function loadArtistData() {
    console.log("ðŸš€ [DEBUG] Starting loadArtistData...");
    try {
        const artistId = window.currentArtistProfile?.id;
        console.log("ðŸ‘¤ [DEBUG] Current Artist ID:", artistId);

        if (!artistId) {
            console.error("âŒ [DEBUG] No Artist Profile ID found. Check window.currentArtistProfile");
            return;
        }

        // 1. Get Live Albums
        console.log("ðŸ“¡ [DEBUG] Fetching Live Albums...");
        const { data: liveAlbums, error: liveErr } = await window.db
            .from('albums')
            .select('*')
            .eq('artist_id', artistId);

        if (liveErr) console.error("âŒ [DEBUG] Live Albums Error:", liveErr);
        console.log("ðŸ“¦ [DEBUG] Live Albums Found:", liveAlbums?.length || 0, liveAlbums);

        // 2. Get Pending Requests
        console.log("ðŸ“¡ [DEBUG] Fetching Pending Requests...");
        const { data: pendingRequests, error: pendErr } = await window.db
            .from('albumrequests')
            .select('*')
            .eq('artist_id', artistId);

        if (pendErr) console.error("âŒ [DEBUG] Pending Requests Error:", pendErr);
        console.log("ðŸ“¦ [DEBUG] Pending Requests Found:", pendingRequests?.length || 0, pendingRequests);

        // 3. Combine
        window.combinedReleases = [
            ...(liveAlbums || []).map(a => ({ ...a, isPending: false })),
            ...(pendingRequests || []).map(r => ({ ...r, isPending: r.status === 'pending' }))
        ];

        console.log("ðŸ”— [DEBUG] Combined Releases Array:", window.combinedReleases);

        renderReleaseList();

    } catch (err) {
        console.error("ðŸ’€ [DEBUG] Fatal Load Error:", err);
    }
}

// Wrap the whole thing in an async IIFE (Immediately Invoked Function Expression)
(async () => {
    console.log("ðŸ•µï¸ [DEBUG] Running Schema/RLS Diagnosis...");
    
    try {
        // 1. Check if we can see ANY albums at all (Testing 'Allow public read' policy)
        const { data: allAlbums, error: checkErr } = await window.db
            .from('albums')
            .select('name, artist_id')
            .limit(5);

        if (checkErr) {
            console.error("âŒ [DEBUG] RLS Blocked 'SELECT' on albums:", checkErr.message);
        } else {
            console.log("ðŸ•µï¸ [DEBUG] Database Sample (Is RLS open?):", allAlbums);
        }

        // 2. Re-trigger the main load
        await loadArtistData();
        
    } catch (err) {
        console.error("ðŸ’€ [DEBUG] Diagnosis Failed:", err);
    }
})();

function renderReleaseList() {
    const content = document.getElementById('content-view');
    // Ensure we are using the merged data
    const list = window.artistAlbums || [];

    const sorted = [...list].sort((a, b) => {
        const dateA = a.full_release_date || a.release_date || "0";
        const dateB = b.full_release_date || b.release_date || "0";
        return getNumericDateValue(dateB) - getNumericDateValue(dateA);
    });

content.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:40px;">
        <h1 style="font-size: 42px; font-weight: 900; letter-spacing: -1.5px; margin:0;">Releases</h1>
        <button onclick="openCreateReleaseModal()" class="btn-primary" style="font-size:11px;">+ NEW RELEASE</button>
    </div>
    <div style="display:grid; gap:15px;">
        ${sorted.map(album => `
            <div class="release-list-item" style="display:flex; align-items:center; background:#0a0a0a; border:1px solid #111; padding:15px; border-radius:16px; ${album.isPending ? 'opacity:0.6;' : ''}">
                <img src="${album.art_url}" style="width:60px; height:60px; border-radius:8px; object-fit:cover; margin-right:20px; ${album.isPending ? 'filter:grayscale(1);' : ''}">
                <div style="flex:1;">
                    <h4 style="margin:0;">${album.name} ${album.isPending ? '<span style="font-size:8px; background:var(--accent-green); color:#000; padding:2px 6px; border-radius:4px; margin-left:10px;">UNDER REVIEW</span>' : ''}</h4>
                    <p style="font-size:12px; color:#666; margin:4px 0 0 0;">${album.full_release_date || album.release_date}</p>
                </div>
                <div>
                    ${album.isPending ? 
                        '<button class="btn-primary" style="background:transparent; border:1px solid #222; color:#444; cursor:not-allowed;" disabled>LOCKED</button>' : 
                        `<button class="btn-primary" onclick="window.openEditModal('${album.id}')">EDIT</button>`
                    }
                </div>
            </div>
        `).join('')}
    </div>
`;

let trackItems = [];
}

window.openCreateReleaseModal = () => {
    const modal = document.createElement('div');
    modal.id = 'create-release-modal';
    Object.assign(modal.style, {
        position: 'fixed', inset: '0', zIndex: '100000',
        display: 'flex', alignItems: 'center', justifyContent: 'center',
        background: 'rgba(0,0,0,0.9)', backdropFilter: 'blur(20px)', padding: '40px'
    });

    modal.innerHTML = `
        <div class="modal-animate-in" style="background: #080808; border: 1px solid #111; width: 100%; max-width: 900px; max-height: 95vh; border-radius: 32px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 30px 60px rgba(0,0,0,0.5);">
            
            <div style="padding: 30px 40px; border-bottom: 1px solid #111; display:flex; justify-content:space-between; align-items:center; background: #0a0a0a;">
                <div style="flex:1; margin-right: 40px;">
                    <input type="text" id="project-title-input" placeholder="Project Title" 
                           style="background: transparent; border: none; font-size: 28px; font-weight: 900; letter-spacing: -1px; color: white; width: 100%; outline: none; padding: 0;">
                    <p id="item-counter" style="color: #444; font-size: 10px; font-weight: 800; margin-top: 5px; letter-spacing: 1px; text-transform: uppercase;">0 / 30 ITEMS USED</p>
                </div>
                <button onclick="document.getElementById('create-release-modal').remove()" style="background:none; border:none; color:#333; cursor:pointer; transition: 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#333'"><i class="fa-solid fa-circle-xmark fa-2x"></i></button>
            </div>

            <div style="flex: 1; overflow-y: auto; padding: 40px; scrollbar-width: thin; scrollbar-color: #222 transparent;">
                
                <div style="display: grid; grid-template-columns: 200px 1fr; gap: 30px; margin-bottom: 30px;">
                    <div id="drop-zone" onclick="document.getElementById('art-upload').click()" style="width: 200px; height: 200px; background: #000; border: 2px dashed #111; border-radius: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden; transition: 0.3s;">
                        <span id="upload-txt" style="font-size: 9px; color: #333; font-weight: 900; text-align: center; letter-spacing: 1px;">UPLOAD ART</span>
                        <input type="file" id="art-upload" hidden accept="image/*" onchange="previewImage(this)">
                        <img id="art-preview" style="position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; display: none;">
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <textarea id="project-desc-input" placeholder="Add a description for this project..." 
                                  style="width: 100%; height: 100px; background: #000; border: 1px solid #111; padding: 15px; border-radius: 12px; color: white; font-size: 13px; resize: none; outline: none;"></textarea>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="display:flex; flex-direction:column; gap:10px;">
                                <input type="text" id="date-input" placeholder="Release Date" oninput="checkFutureDate(this.value)" 
                                       style="background: #000; border: 1px solid #111; padding: 14px; border-radius: 12px; color: white; font-size: 13px;">
                                
                                <div id="press-release-container" style="display:none; flex-direction:column; gap:10px; background: #050505; padding: 10px; border-radius: 12px; border: 1px solid #111;">
                                    <div style="display:flex; align-items:center; gap:8px;">
                                        <input type="checkbox" id="press-toggle" onchange="window.toggleSignupFields(this.checked)" style="accent-color:var(--accent-green);">
                                        <label for="press-toggle" style="font-size:9px; font-weight:900; color:var(--accent-green); text-transform:uppercase;">Press Release</label>
                                    </div>
                                    <input type="text" id="signup-link-input" placeholder="SIGNUP / PRE-SAVE URL" 
                                           style="display:none; background:#000; border:1px solid #1a1a1a; padding:10px; border-radius:8px; color:white; font-size:11px; width: 75%;">
                                </div>
                            </div>
                            <input type="text" id="genre-input" placeholder="Genre" 
                                   style="background: #000; border: 1px solid #111; padding: 14px; border-radius: 12px; color: white; font-size: 13px; height: fit-content;">
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 30px;">
                    <label style="display: block; font-size: 9px; font-weight: 900; color: #444; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 1px;">Featured Trailer/Video</label>
                    <input type="text" id="trailer-url-input" placeholder="YouTube URL" style="width: 100%; background: #000; border: 1px solid #111; padding: 14px; border-radius: 12px; color: white; font-size: 13px;">
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 16px; font-weight: 900; margin: 0; letter-spacing: -0.5px;">Tracklist Content</h3>
                    <div id="add-buttons-container" style="display: flex; gap: 8px;">
                        <button onclick="addTrackItem('disc')" class="btn-builder-add">+ DISC</button>
                        <button onclick="addTrackItem('video')" class="btn-builder-add">+ VIDEO</button>
                        <button onclick="addTrackItem('track')" class="btn-builder-add" style="background:var(--accent-green); color:#000; border-color:var(--accent-green);">+ TRACK</button>
                    </div>
                </div>

                <div id="track-list-render" style="display: flex; flex-direction: column; gap: 10px;"></div>
            </div>

            <div style="padding: 20px 40px; background: #050505; border-top: 1px solid #111; text-align: right;">
                <button onclick="publishProject()" class="btn-primary" style="padding: 14px 60px; font-weight: 900; border-radius: 12px;">PUBLISH</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    trackItems = []; 
    renderTracklist();
};

window.openEditModal = async (input) => {
    let albumData = null;

    // 1. DATA CHECK: If we only have an ID string, we MUST fetch the full object first
    if (typeof input === 'string') {
        console.log("Fetching full metadata for ID:", input);
        const { data, error } = await window.db.from('albums').select('*').eq('id', input).single();
        albumData = data;
        
        // If not in live albums, check pending requests
        if (!albumData) {
            const { data: reqData } = await window.db.from('albumrequests').select('*').eq('id', input).single();
            albumData = reqData;
        }
    } else {
        albumData = input;
    }

    if (!albumData) {
        console.error("Hydration failed: No album data found.");
        return;
    }

    // 2. BUILD THE UI
    window.openCreateReleaseModal();
    
    // 3. FORCE THE METADATA INTO THE UI
    // We use a slightly longer timeout to ensure the DOM is fully interactive
    setTimeout(async () => {
        const modal = document.getElementById('create-release-modal');
        if (!modal) return;

        console.log("Injecting Metadata into Modal:", albumData);

        // Update Button Setup
        const publishBtn = modal.querySelector('.btn-primary');
        if (publishBtn) {
            publishBtn.innerText = "UPDATE RELEASE";
            publishBtn.onclick = () => window.updateProject(albumData.id, true);
        }

        // Standard Fields - Explicit Selection
        const titleInput = document.getElementById('project-title-input');
        const genreInput = document.getElementById('genre-input');
        const dateInput = document.getElementById('date-input');
        const descInput = document.getElementById('project-desc-input');
        const trailerInput = document.getElementById('trailer-url-input');

        if (titleInput) titleInput.value = albumData.name || "";
        if (genreInput) genreInput.value = albumData.genre || "";
        if (dateInput) dateInput.value = albumData.full_release_date || "";
        if (descInput) descInput.value = albumData.description || "";
        if (trailerInput) trailerInput.value = albumData.trailer_url || "";

        // Art Preview
        if (albumData.art_url) {
            window.lastUploadedArtUrl = albumData.art_url;
            const preview = document.getElementById('art-preview');
            const uploadTxt = document.getElementById('upload-txt');
            if (preview) {
                preview.src = albumData.art_url;
                preview.style.display = 'block';
                if (uploadTxt) uploadTxt.style.display = 'none';
            }
        }

        // 4. FETCH AND RENDER CONTENT (Tracks/Videos/Discs)
        try {
            // Get the list of IDs we need for THIS specific view
            const trackIds = Array.isArray(albumData.track_ids) ? albumData.track_ids : [];

            // MULTI-ALBUM PARITY FIX: Fetch tracks where ID is in our list, regardless of album_id
            const { data: liveTracks } = await window.db
                .from('tracks')
                .select('*')
                .in('id', trackIds); 

            const videoIds = trackIds.filter(id => typeof id === 'string' && id.startsWith('video_'));
            let liveVideos = [];
            if (videoIds.length > 0) {
                const { data: vData } = await window.db.from('videos').select('*').in('id', videoIds);
                liveVideos = vData || [];
            }

            // 5. Rebuild the internal list
            window.trackItems = [];
            trackIds.forEach(id => {
                if (typeof id !== 'string') return;

                if (id.startsWith('DISC_')) {
                    window.trackItems.push({ 
                        type: 'disc', 
                        title: id.replace('DISC_', '').replace(/_/g, ' ') 
                    });
                } else if (id.startsWith('video_')) {
                    const vid = liveVideos.find(v => v.id === id);
                    window.trackItems.push({ 
                        type: 'video', 
                        title: vid?.title || "Video", 
                        reviewLink: vid?.url || "" 
                    });
                } else {
                    // Track Logic with fuzzy repair for single/album suffix issues
                    let trk = liveTracks?.find(t => t.id === id);
                    if (!trk) {
                        const altId = id.endsWith('-single') ? id.replace('-single', '') : `${id}-single`;
                        trk = liveTracks?.find(t => t.id === altId);
                    }

                    if (trk) {
                        window.trackItems.push({ 
                            type: 'track', 
                            id: trk.id, 
                            title: trk.title, 
                            isBonus: trk.bonus_track, 
                            reviewLink: trk.review_link || "" 
                        });
                    } else {
                        console.warn(`Could not find track data for ID: ${id}`);
                    }
                }
            });

            renderTracklist();
        } catch (err) {
            console.error("Content Hydration Error:", err);
            renderTracklist(); // Render empty list so the UI doesn't hang
        }
    }, 150); 
};

window.toggleTrackReview = (trackId) => {
    const track = window.trackItems.find(t => t.id === trackId);
    if (track) {
        track.needsReview = !track.needsReview;
        // If they toggle it off, clear the link
        if (!track.needsReview) track.reviewLink = "";
        window.renderTracklist(); // Refresh the list to show/hide the input
    }
};

window.updateTrackLink = (trackId, value) => {
    const track = window.trackItems.find(t => t.id === trackId);
    if (track) track.reviewLink = value;
};

window.loadProjectForEdit = async (album) => {
    // 1. Clear current items
    window.trackItems = [];

    // 2. Fetch all possible data sources
    const { data: tracks } = await window.db.from('tracks').select('*').eq('album_id', album.id);
    const { data: videos } = await window.db.from('videos').select('*').filter('id', 'in', `(${album.track_ids.join(',')})`);

    // 3. REBUILD window.trackItems based on the order in album.track_ids
    album.track_ids.forEach(id => {
        if (id.startsWith('DISC_')) {
            window.trackItems.push({
                type: 'disc',
                title: id.replace('DISC_', '').replace(/_/g, ' '),
                id: id
            });
        } else if (id.startsWith('video_')) {
            const vData = videos?.find(v => v.id === id);
            window.trackItems.push({
                type: 'video',
                title: vData ? vData.title : 'Unknown Video',
                reviewLink: vData ? vData.url : '',
                id: id
            });
        } else {
            const tData = tracks?.find(t => t.id === id);
            if (tData) {
                window.trackItems.push({
                    type: 'track',
                    title: tData.title,
                    id: tData.id,
                    isBonus: tData.bonus_track,
                    needsReview: false // For metadata editing
                });
            }
        }
    });

    renderTracklist();
};

window.updateProject = async (releaseId, isPending) => {
    try {
        const trackCount = window.trackItems.filter(i => i.type === 'track').length;
        let projectType = trackCount <= 2 ? "Single" : trackCount <= 6 ? "EP" : "Album";

        // 1. Map the Master track_ids array
        // DISC items become "DISC_Title", Videos "video_id", Tracks "track_id"
        const masterTrackIds = window.trackItems.map(item => {
            if (item.type === 'disc') return `DISC_${item.title.toUpperCase().replace(/\s+/g, '_')}`;
            if (item.type === 'video') return `video_${item.title.toLowerCase().replace(/\s+/g, '-')}`;
            return item.id;
        });

        // 2. Filter data for different tables
        const tracksToUpsert = window.trackItems
            .filter(i => i.type === 'track')
            .map(item => ({
                id: item.id,
                album_id: releaseId,
                title: item.title,
                bonus_track: item.isBonus || false,
                review_link: item.reviewLink || ""
            }));

        const videosToUpsert = window.trackItems
            .filter(i => i.type === 'video')
            .map(item => ({
                id: `video_${item.title.toLowerCase().replace(/\s+/g, '-')}`,
                title: item.title,
                url: item.reviewLink || "" // Using the same review link input for URL
            }));

        // 3. Perform the Upserts
        const { error: albumErr } = await window.db.from('albumrequests').upsert({
            id: releaseId,
            artist_id: window.currentArtistProfile.id,
            name: document.getElementById('project-title-input').value,
            genre: document.getElementById('genre-input').value,
            full_release_date: document.getElementById('date-input').value,
            art_url: window.lastUploadedArtUrl,
            track_ids: masterTrackIds,
            type: projectType,
            status: 'pending'
        });
        if (albumErr) throw albumErr;

        if (tracksToUpsert.length > 0) {
            const { error: tErr } = await window.db.from('requestedtracks').upsert(tracksToUpsert);
            if (tErr) throw tErr;
        }

        if (videosToUpsert.length > 0) {
            const { error: vErr } = await window.db.from('requestedvideos').upsert(videosToUpsert);
            if (vErr) throw vErr;
        }

        alert("Project submitted with tracks, videos, and headers!");
        location.reload();
    } catch (err) {
        console.error(err);
        alert("Error: " + err.message);
    }
};

// Clean strings for IDs: lowercase, spaces to "-", remove parentheses
const createSlug = (text) => {
    return text.toLowerCase()
        .replace(/\s+/g, '-')           // Spaces to -
        .replace(/[()]/g, '')           // Remove parentheses
        .replace(/[^a-z0-0-]/g, '');    // Remove other special chars
};

// Calculate project type based on track count (excluding discs/videos)
const calculateReleaseType = (items) => {
    const trackCount = items.filter(i => i.type === 'track').length;
    if (trackCount <= 2) return "Single";
    if (trackCount <= 6) return "EP";
    if (trackCount <= 10) return "Mixtape";
    return "Album";
};

// Get Audio Duration
const getDuration = (file) => {
    return new Promise((resolve) => {
        const audio = new Audio();
        audio.src = URL.createObjectURL(file);
        audio.onloadedmetadata = () => resolve(Math.floor(audio.duration).toString());
    });
};

// 1. GLOBAL DATE NORMALIZER (Needed for Sorting & Future Date Detection)
window.getNumericDateValue = (dateStr) => {
    if (!dateStr) return 0;

    const months = {
        jan: 0, feb: 1, mar: 2, apr: 3, may: 4, jun: 5,
        jul: 6, aug: 7, sep: 8, oct: 9, nov: 10, dec: 11
    };

    // Clean the string: lowercase and remove "st, nd, rd, th"
    const clean = dateStr.toLowerCase().replace(/(st|nd|rd|th)/g, "");
    const parts = clean.split(/[\s,]+/); 

    let year = 0, month = 0, day = 1;

    if (parts.length === 1 && /^\d{4}$/.test(parts[0])) {
        year = parseInt(parts[0]);
    } else {
        parts.forEach(p => {
            if (/^\d{4}$/.test(p)) year = parseInt(p);
            else if (months[p.substring(0, 3)] !== undefined) month = months[p.substring(0, 3)];
            else if (/^\d{1,2}$/.test(p)) day = parseInt(p);
        });
    }

    return new Date(year, month, day).getTime();
};

// 2. FUTURE DATE CHECKER
window.toggleSignupFields = (isChecked) => {
    const signupInput = document.getElementById('signup-link-input');
    if (signupInput) signupInput.style.display = isChecked ? 'block' : 'none';
};

// Also update your date checker to make sure the container shows up
window.checkFutureDate = (val) => {
    const container = document.getElementById('press-release-container');
    if (!container) return;
    
    const inputDate = getNumericDateValue(val);
    const today = new Date().getTime();
    
    // Show the press option only if the date is in the future
    container.style.display = (inputDate > today) ? 'flex' : 'none';
};

window.togglePressFields = (checked) => {
    const signupContainer = document.getElementById('signup-link-area');
    if (signupContainer) {
        signupContainer.style.display = checked ? 'block' : 'none';
    }
};

window.previewImage = async (input) => {
    const preview = document.getElementById('art-preview');
    const uploadTxt = document.getElementById('upload-txt');
    
    if (input.files && input.files[0]) {
        // 1. Show the local preview immediately (Current logic)
        const reader = new FileReader();
        reader.onload = (e) => {
            preview.src = e.target.result;
            preview.style.display = 'block';
            if (uploadTxt) uploadTxt.style.display = 'none';
        };
        reader.readAsDataURL(input.files[0]);

        // 2. Start the background upload to ImgBB
        // Show a "Uploading..." state if you have a label for it
        if (uploadTxt) {
            uploadTxt.innerText = "UPLOADING TO SERVER...";
            uploadTxt.style.display = 'block';
        }

        const uploadedUrl = await window.uploadToImgBB(input.files[0]);
        
        if (uploadedUrl && uploadTxt) {
            uploadTxt.style.display = 'none'; // Hide it once we have the link
        }
    }
};

window.addTrackItem = (type) => {
    if (trackItems.length >= 30) return;
    trackItems.push({ type: type, title: '', isBonus: false });
    renderTracklist();
};

window.removeTrackItem = (index) => {
    trackItems.splice(index, 1);
    renderTracklist();
};

window.toggleBonus = (index) => {
    trackItems[index].isBonus = !trackItems[index].isBonus;
    renderTracklist();
};

window.moveItem = (index, direction) => {
    const newIndex = index + direction;
    if (newIndex < 0 || newIndex >= trackItems.length) return; // Boundary check
    
    // Swap the items in the array
    const temp = trackItems[index];
    trackItems[index] = trackItems[newIndex];
    trackItems[newIndex] = temp;
    
    renderTracklist();
};

window.handleAudioPreview = (input, index) => {
    if (input.files && input.files[0]) {
        // Save the actual file object to our global array
        trackItems[index].audioFile = input.files[0];
        // Re-render to show the file name and the audio player
        renderTracklist();
    }
};

window.handleAudioSelect = (input, index) => {
    if (input.files && input.files[0]) {
        // Store the file object in our global array
        trackItems[index].audioFile = input.files[0];
        // Re-render the list to show the player and the "âœ“" status
        renderTracklist();
    }
};

function renderTracklist() {
    const list = document.getElementById('track-list-render');
    const counter = document.getElementById('item-counter');
    const btnContainer = document.getElementById('add-buttons-container');
    
    // Safety check to prevent the "null" error
    if (!list) return;

    list.innerHTML = '';
    let trackNum = 1;

    trackItems.forEach((item, index) => {
        const row = document.createElement('div');
        row.className = "track-row";
        row.style = `display: flex; gap: 15px; align-items: center; padding: 12px 20px; border-radius: 16px; border: 1px solid #111; background: ${item.type === 'track' ? '#0a0a0a' : '#111'}; margin-bottom: 10px;`;
        
        let contentHTML = '';
        let iconHTML = '';

if (item.type === 'track') {
    // Check if the primary button says "UPDATE" to determine if we are editing
    const actionBtn = document.querySelector('.modal-footer .btn-primary') || document.getElementById('publish-btn');
    const isEditing = actionBtn && actionBtn.innerText.includes("UPDATE");

    iconHTML = `<span style="color:#444; font-weight:900; width:20px; text-align:center;">${trackNum++}</span>`;
    
    contentHTML = `
        <div style="flex:1; display:flex; flex-direction:column; gap:8px;">
            <input type="text" placeholder="TRACK NAME" value="${item.title || ''}" 
                   oninput="trackItems[${index}].title = this.value" 
                   style="width:100%; background:transparent; border:none; color:white; font-size:14px; outline:none; font-weight:bold;">
            
            <div style="display:flex; align-items:center; gap:10px;">
                ${isEditing ? `
                    <label class="switch-sm" style="display:flex; align-items:center; gap:5px; cursor:pointer;">
                        <input type="checkbox" ${item.needsReview ? 'checked' : ''} 
                               onchange="trackItems[${index}].needsReview = this.checked; renderTracklist();"
                               style="width:12px; height:12px; accent-color:var(--accent-green);">
                        <span style="font-size:9px; color:#444; font-weight:900; text-transform:uppercase;">Edit Metadata</span>
                    </label>
                    <input type="text" placeholder="PASTE REVIEW LINK (YT/SC)" 
                           value="${item.reviewLink || ''}" 
                           oninput="trackItems[${index}].reviewLink = this.value" 
                           style="flex:1; background:rgba(0,255,136,0.05); border:1px solid rgba(0,255,136,0.1); color:var(--accent-green); font-size:10px; padding:5px 10px; border-radius:4px; outline:none; display: ${item.needsReview ? 'block' : 'none'};">
                ` : `
                    <button onclick="document.getElementById('audio-input-${index}').click()" style="background:#111; border:1px solid #222; color:var(--accent-green); font-size:9px; font-weight:900; cursor:pointer; padding:5px 10px; border-radius:4px; text-transform:uppercase;">
                        ${item.audioFile ? 'âœ“ Change Audio' : '+ Local Preview'}
                    </button>
                    <input type="file" id="audio-input-${index}" hidden accept="audio/*" onchange="handleAudioSelect(this, ${index})">
                    
                    <input type="text" placeholder="PASTE REVIEW LINK (YT/SC)" value="${item.reviewLink || ''}" 
                           oninput="trackItems[${index}].reviewLink = this.value" 
                           style="flex:1; background:rgba(0,255,136,0.05); border:1px solid rgba(0,255,136,0.1); color:var(--accent-green); font-size:10px; padding:5px 10px; border-radius:4px; outline:none;">
                `}
            </div>
            
            ${item.audioFile ? `
                <audio controls src="${URL.createObjectURL(item.audioFile)}" style="height:20px; width:100%; filter:invert(1) grayscale(1); opacity:0.5; margin-top:5px;"></audio>
            ` : ''}
        </div>
    `;
        } else if (item.type === 'video') {
    iconHTML = `<i class="fa-solid fa-video" style="color:#444; width:20px; text-align:center;"></i>`;
    contentHTML = `
        <div style="flex:1; display:flex; flex-direction:column; gap:5px;">
            <input type="text" placeholder="VIDEO NAME" value="${item.title || ''}" 
                   oninput="trackItems[${index}].title = this.value" 
                   style="background:transparent; border:none; color:white; font-size:14px; outline:none; width:100%; font-weight:bold;">
            <input type="text" placeholder="PASTE VIDEO URL (YT/VIMEO)" value="${item.reviewLink || ''}" 
                   oninput="trackItems[${index}].reviewLink = this.value" 
                   style="width:100%; background:rgba(255,255,255,0.03); border:1px solid #222; color:#888; font-size:10px; padding:4px 8px; border-radius:4px; outline:none;">
        </div>`;
} else {
            iconHTML = `<i class="fa-solid fa-compact-disc" style="color:var(--accent-green); width:20px; text-align:center;"></i>`;
            contentHTML = `<div style="flex:1;"><input type="text" placeholder="DISC NAME" value="${item.title || ''}" oninput="trackItems[${index}].title = this.value" style="width:100%; background:transparent; border:none; color:white; font-size:14px; font-weight:900; outline:none;"></div>`;
        }

        row.innerHTML = `
            <div style="display: flex; flex-direction: column; gap: 2px;">
                <button onclick="moveItem(${index}, -1)" style="background:none; border:none; color:#222; cursor:pointer; font-size:10px;"><i class="fa-solid fa-chevron-up"></i></button>
                <button onclick="moveItem(${index}, 1)" style="background:none; border:none; color:#222; cursor:pointer; font-size:10px;"><i class="fa-solid fa-chevron-down"></i></button>
            </div>
            ${iconHTML}
            ${contentHTML}
            <button onclick="removeTrackItem(${index})" style="background:none; border:none; color:#333; cursor:pointer; margin-left: auto;"><i class="fa-solid fa-trash-can"></i></button>
        `;
        list.appendChild(row);
    });

    // Update Counter
    if (counter) {
        counter.innerText = `${trackItems.length} / 30 ITEMS USED`;
        const isFull = trackItems.length >= 30;
        counter.style.color = isFull ? 'var(--accent-green)' : '#444';
        if (btnContainer) {
            btnContainer.style.opacity = isFull ? '0.2' : '1';
            btnContainer.style.pointerEvents = isFull ? 'none' : 'auto';
        }
    }
}

const IMGBB_API_KEY = 'e403a366e471b218bd958732a550add8';

window.uploadToImgBB = async (file) => {
    const formData = new FormData();
    formData.append('image', file);

    try {
        const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (data.success) {
            window.lastUploadedArtUrl = data.data.url;
            console.log("âœ… Art uploaded to ImgBB:", window.lastUploadedArtUrl);
            return data.data.url;
        } else {
            throw new Error(data.error.message);
        }
    } catch (err) {
        console.error("âŒ ImgBB Upload Failed:", err);
        return null;
    }
};

window.generateSlug = (text) => {
    return text.toString().toLowerCase()
        .replace(/\s+/g, '-')           // Replace spaces with -
        .replace(/[()]/g, '')           // Remove parentheses
        .replace(/[^\w-]+/g, '')        // Remove all non-word chars
        .replace(/--+/g, '-')           // Replace multiple - with single -
        .replace(/^-+/, '')             // Trim - from start
        .replace(/-+$/, '');            // Trim - from end
};

window.publishProject = async () => {
    const publishBtn = document.querySelector('.btn-primary');
    const title = document.getElementById('project-title-input')?.value;
    const genre = document.getElementById('genre-input')?.value;
    const dateValue = document.getElementById('date-input')?.value;
    const artUrl = window.lastUploadedArtUrl || ""; 

    if (!title || !genre) return alert("Please enter a Title and Genre.");
    if (!artUrl) return alert("Please upload cover art before publishing.");

    try {
        publishBtn.disabled = true;
        publishBtn.innerText = "SUBMITTING...";

        const albumSlug = window.generateSlug(title);
        const artistId = window.currentArtistProfile?.id;

        if (!artistId || artistId === "anonymous") {
             alert("Error: Artist profile not detected. Please refresh.");
             return;
        }

        // --- NEW MULTI-TYPE LOGIC ---
        const masterTrackIds = [];
        const trackSubmissions = [];
        const videoSubmissions = [];

        window.trackItems.forEach((item) => {
            if (item.type === 'disc') {
                // For Discs, we only store the string in the master array
                const discString = `DISC_${item.title.toUpperCase().replace(/\s+/g, '_')}`;
                masterTrackIds.push(discString);
            } 
            else if (item.type === 'video') {
                // For Videos, generate ID and prepare for requestedvideos table
                const videoId = `video_${window.generateSlug(item.title)}`;
                masterTrackIds.push(videoId);
                videoSubmissions.push({
                    id: videoId,
                    title: item.title,
                    url: item.reviewLink || "" // reviewLink used as URL for videos
                });
            } 
            else {
                // For Tracks, generate ID and prepare for requestedtracks table
                const trackSlug = `${albumSlug}-${window.generateSlug(item.title)}`;
                masterTrackIds.push(trackSlug);
                trackSubmissions.push({
                    id: trackSlug,
                    album_id: albumSlug,
                    title: item.title,
                    bonus_track: item.isBonus || false,
                    review_link: item.reviewLink || ""
                });
            }
        });

        // --- CLASSIFICATION (Based only on actual tracks) ---
        const actualTrackCount = trackSubmissions.length;
        let projectType = "Album";
        if (actualTrackCount >= 1 && actualTrackCount <= 2) projectType = "Single";
        else if (actualTrackCount >= 3 && actualTrackCount <= 6) projectType = "EP";
        else if (actualTrackCount >= 7 && actualTrackCount <= 10) projectType = "Mixtape";

        // 1. Insert Album Request
        const { error: albumError } = await window.db.from('albumrequests').insert([{
            id: albumSlug,
            name: title,
            genre: genre,
            full_release_date: dateValue,
            artist_id: artistId,
            art_url: artUrl,
            track_ids: masterTrackIds, // Combined IDs (Tracks, video_ID, DISC_TITLE)
            type: projectType
        }]);
        if (albumError) throw albumError;

        // 2. Insert Individual Tracks (if any)
        if (trackSubmissions.length > 0) {
            const { error: tracksError } = await window.db.from('requestedtracks').insert(trackSubmissions);
            if (tracksError) throw tracksError;
        }

        // 3. Insert Video Requests (if any)
        if (videoSubmissions.length > 0) {
            const { error: videosError } = await window.db.from('requestedvideos').insert(videoSubmissions);
            if (videosError) throw videosError;
        }

        alert(`Release Published Successfully as a ${projectType}!`);
        location.reload();

    } catch (err) {
        console.error("Submission error:", err);
        alert(`Error: ${err.message}`);
    } finally {
        publishBtn.disabled = false;
        publishBtn.innerText = "PUBLISH";
    }
};

// 5. MODAL: APPLY FOR ARTIST
window.openApplyModal = (name, slug) => {
    const modal = document.createElement('div');
    modal.id = 'apply-modal-root';
    Object.assign(modal.style, {
        position:'fixed', inset:'0', zIndex:'99999', display:'flex', 
        alignItems:'center', justifyContent:'center', background:'rgba(0,0,0,0.9)', backdropFilter:'blur(10px)'
    });

    modal.innerHTML = `
        <div class="modal-animate-in" style="background:#0d0d0d; border:1px solid #222; width:90%; max-width:450px; padding:40px; border-radius:24px;">
            <h2 style="font-weight:900; margin-bottom:5px;">Claim ${name}</h2>
            <p style="color:#666; font-size:14px; margin-bottom:25px;">Provide details to verify ownership.</p>
            <div style="display:flex; flex-direction:column; gap:15px;">
                <input type="text" id="req-name" placeholder="Full Name" style="background:#111; border:1px solid #222; padding:15px; border-radius:10px; color:white;">
                <input type="date" id="req-dob" style="background:#111; border:1px solid #222; padding:15px; border-radius:10px; color:white;">
                <textarea id="req-proof" placeholder="Links to socials / Proof of identity" style="background:#111; border:1px solid #222; padding:15px; border-radius:10px; color:white; min-height:80px;"></textarea>
                <button onclick="submitRequest('${slug}')" class="btn-primary" style="margin-top:10px;">SUBMIT APPLICATION</button>
                <button onclick="document.getElementById('apply-modal-root').remove()" style="background:none; border:none; color:#444; cursor:pointer;">Cancel</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
};

window.submitRequest = async (slug) => {
const { data: { session } } = await client.auth.getSession();
    
    // DEBUG: Make sure this ID actually exists
    console.log("Submitting for User ID:", session?.user?.id);

    const payload = {
        user_id: session.user.id, // This MUST match the policy auth.uid()
        artist_slug: slug,
        full_name: document.getElementById('req-name').value,
        dob: document.getElementById('req-dob').value,
        proof_details: document.getElementById('req-proof').value,
        status: 'pending'
    };

    const { error } = await client.from('requests').insert([payload]);
    if (!error) {
        alert("Application sent successfully!");
        document.getElementById('apply-modal-root').remove();
    } else {
        alert("Error: " + error.message);
    }
};

// HELPERS
function debounce(func, timeout) {
    let timer;
    return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => { func.apply(this, args); }, timeout);
    };
}

init();
</script>
</body>
</html>